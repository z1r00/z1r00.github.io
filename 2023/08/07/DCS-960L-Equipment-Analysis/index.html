<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="DCS-960L Equipment Analysis[toc] Preliminary AnalysisI came into contact with this device during security research, and I took time to briefly study this device in depth. LinksThe firmware used in thi">
<meta property="og:type" content="article">
<meta property="og:title" content="DCS-960L Equipment Analysis">
<meta property="og:url" content="http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/index.html">
<meta property="og:site_name" content="z1r0's blog">
<meta property="og:description" content="DCS-960L Equipment Analysis[toc] Preliminary AnalysisI came into contact with this device during security research, and I took time to briefly study this device in depth. LinksThe firmware used in thi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-08-07T08:12:03.000Z">
<meta property="article:modified_time" content="2023-08-29T08:09:17.649Z">
<meta property="article:author" content="z1r0">
<meta property="article:tag" content="IOT">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>DCS-960L Equipment Analysis</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="z1r0's blog" type="application/atom+xml">
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.1.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/29/DIR-823G-Equipment-Analysis/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/19/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E6%98%A5%E5%AD%A3%E8%B5%9BPWN-AK/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;text=DCS-960L Equipment Analysis"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;is_video=false&amp;description=DCS-960L Equipment Analysis"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DCS-960L Equipment Analysis&amp;body=Check out this article: http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;name=DCS-960L Equipment Analysis&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;t=DCS-960L Equipment Analysis"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DCS-960L-Equipment-Analysis"><span class="toc-number">1.</span> <span class="toc-text">DCS-960L Equipment Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preliminary-Analysis"><span class="toc-number">1.1.</span> <span class="toc-text">Preliminary Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Links"><span class="toc-number">1.1.1.</span> <span class="toc-text">Links</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Service-Architecture-Analysis"><span class="toc-number">1.1.2.</span> <span class="toc-text">Web Service Architecture Analysis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">Vulnerability</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unauthenticated-Information-Disclosure"><span class="toc-number">1.2.1.</span> <span class="toc-text">Unauthenticated Information Disclosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-Overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">Stack Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-Format-String"><span class="toc-number">1.2.3.</span> <span class="toc-text">Cookie Format String</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypass"><span class="toc-number">1.2.4.</span> <span class="toc-text">Authentication Bypass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Affected-Models"><span class="toc-number">1.3.</span> <span class="toc-text">Affected Models</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        DCS-960L Equipment Analysis
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">z1r0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-07T08:12:03.000Z" itemprop="datePublished">2023-08-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/IOT/" rel="tag">IOT</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="DCS-960L-Equipment-Analysis"><a href="#DCS-960L-Equipment-Analysis" class="headerlink" title="DCS-960L Equipment Analysis"></a>DCS-960L Equipment Analysis</h1><p>[toc]</p>
<h2 id="Preliminary-Analysis"><a href="#Preliminary-Analysis" class="headerlink" title="Preliminary Analysis"></a>Preliminary Analysis</h2><p>I came into contact with this device during security research, and I took time to briefly study this device in depth.</p>
<h3 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h3><p>The firmware used in this analysis is <code>1.09</code>, and the download address is</p>
<p><a target="_blank" rel="noopener" href="https://www.dlinktw.com.tw/techsupport/ProductInfo.aspx?m=DCS-960L">https://www.dlinktw.com.tw/techsupport/ProductInfo.aspx?m=DCS-960L</a></p>
<h3 id="Web-Service-Architecture-Analysis"><a href="#Web-Service-Architecture-Analysis" class="headerlink" title="Web Service Architecture Analysis"></a>Web Service Architecture Analysis</h3><p>We can directly use binwalk to unpack this firmware package.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">10264         0x2818          LZMA compressed data, properties: 0x5D, dictionary size: 16777216 bytes, uncompressed size: 5230012 bytes</span><br><span class="line">1565730       0x17E422        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 8614736 bytes, 1569 inodes, blocksize: 131072 bytes, created: 2038-04-24 08:06:24</span><br></pre></td></tr></tbody></table></figure>

<p>After unpacking, you can see following things.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">17:53:04 z1r0@z1r0deMBP.lan squashfs-root l</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x@ 20 z1r0  staff   640B  7 19 12:32 .</span><br><span class="line">drwxr-xr-x  10 z1r0  staff   320B  7 18 16:32 ..</span><br><span class="line">drwxr-xr-x@ 54 z1r0  staff   1.7K 11 28  2019 bin</span><br><span class="line">drwxr-xr-x@  4 z1r0  staff   128B 11 28  2019 dev</span><br><span class="line">drwxr-xr-x@ 50 z1r0  staff   1.6K 11 28  2019 etc</span><br><span class="line">drwxr-xr-x@ 11 z1r0  staff   352B 11 28  2019 home</span><br><span class="line">drwxr-xr-x@ 46 z1r0  staff   1.4K 11 28  2019 lib</span><br><span class="line">drwxr-xr-x@  6 z1r0  staff   192B 11 27  2019 mnt</span><br><span class="line">drwxr-xr-x@ 13 z1r0  staff   416B 11 27  2019 mydlink</span><br><span class="line">drwxr-xr-x@  2 z1r0  staff    64B 11 27  2019 proc</span><br><span class="line">drwxr-xr-x@  2 z1r0  staff    64B 11 27  2019 root</span><br><span class="line">drwxr-xr-x@ 29 z1r0  staff   928B 11 28  2019 sbin</span><br><span class="line">drwxr-xr-x@ 24 z1r0  staff   768B 11 28  2019 server</span><br><span class="line">drwxr-xr-x@  2 z1r0  staff    64B 11 27  2019 share</span><br><span class="line">drwxr-xr-x@  2 z1r0  staff    64B 11 27  2019 sys</span><br><span class="line">lrwxr-xr-x@  1 z1r0  staff     7B 11 28  2019 tmp -&gt; var/tmp</span><br><span class="line">drwxr-xr-x@  6 z1r0  staff   192B 11 27  2019 usr</span><br><span class="line">drwxr-xr-x@  2 z1r0  staff    64B 11 27  2019 var</span><br><span class="line">drwxr-xr-x@ 14 z1r0  staff   448B  7 19 16:54 web</span><br></pre></td></tr></tbody></table></figure>

<p>In <code>etc/passwd_default</code> I found the default user and password. user name is admin, password is empty.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin::0:0:root:/:/bin/sh</span><br></pre></td></tr></tbody></table></figure>

<p>After analyzing the rcS startup scripts (<code>etc/init.d/rcS</code></p>
<p>I found out that it starts the httpd program.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># httpd: This starts and stops http server.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 90 10</span></span><br><span class="line"><span class="comment"># description: httpd</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># processname: /web/httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># automatically export variables to the environment</span></span><br><span class="line"><span class="built_in">set</span> -a</span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">http_port=`/usr/sbin/userconfig -<span class="built_in">read</span> HTTP Port`</span><br><span class="line">https_enable=`/usr/sbin/userconfig -<span class="built_in">read</span> HTTPS Enable`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() {</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">"Starting httpd ... "</span></span><br><span class="line">	<span class="built_in">cd</span> /web; ./httpd <span class="variable">$http_port</span> 1&amp;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"."</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() {</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">"Stopping httpd ... "</span></span><br><span class="line">	<span class="built_in">kill</span> `pidof httpd`</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"."</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() {</span><br><span class="line">	stop</span><br><span class="line">	<span class="built_in">sleep</span> 1</span><br><span class="line">	start</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() {</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">"Reloading httpd ... "</span></span><br><span class="line">	<span class="built_in">kill</span> -USR1 `pidof httpd` </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">	start)</span><br><span class="line">		start</span><br><span class="line">		;;</span><br><span class="line">	stop)</span><br><span class="line">		stop</span><br><span class="line">		;;</span><br><span class="line">	restart)</span><br><span class="line">		restart</span><br><span class="line">		;;</span><br><span class="line">	reload)</span><br><span class="line">		reload</span><br><span class="line">		;;</span><br><span class="line">	*)</span><br><span class="line">		<span class="built_in">echo</span> $<span class="string">"Usage <span class="variable">$0</span> {start|stop|restart}"</span></span><br><span class="line">		<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></tbody></table></figure>

<p>The httpd is a small web server, so I decided to analyze it, the relevant code is as follows.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *Peer6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">__pid_t</span> v11; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">__pid_t</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [sp+20h] [-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v14[<span class="number">7</span>]; <span class="comment">// [sp+21h] [-17h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [sp+28h] [-10h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *port; <span class="comment">// [sp+2Ch] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+30h] [-8h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [sp+34h] [-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(argc - <span class="number">2</span>) &gt;= <span class="number">4</span> )</span><br><span class="line">  {</span><br><span class="line">    sub_401A40(<span class="string">"httpd"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  v13 = <span class="number">1</span>;</span><br><span class="line">  v14[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( argc &gt;= <span class="number">2</span> )</span><br><span class="line">    port = argv[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    port = <span class="string">"80"</span>;</span><br><span class="line">  <span class="keyword">if</span> ( argc &lt; <span class="number">3</span> )</span><br><span class="line">    v4 = AuthType;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4 = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">  AuthType = v4;</span><br><span class="line">  v5 = skOpen6(<span class="number">0</span>, port, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> )</span><br><span class="line">    logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"main"</span>, <span class="number">1275</span>);</span><br><span class="line">  setpgrp();</span><br><span class="line">  signal(<span class="number">13</span>, (<span class="type">__sighandler_t</span>)<span class="number">1</span>);</span><br><span class="line">  signal(<span class="number">18</span>, handler);</span><br><span class="line">  signal(<span class="number">2</span>, (<span class="type">__sighandler_t</span>)sub_401950);</span><br><span class="line">  signal(<span class="number">15</span>, (<span class="type">__sighandler_t</span>)sub_401950);</span><br><span class="line">  signal(<span class="number">16</span>, (<span class="type">__sighandler_t</span>)sub_402BF0);</span><br><span class="line">  signal(<span class="number">17</span>, (<span class="type">__sighandler_t</span>)sub_402BF0);</span><br><span class="line">  addr = mmap(<span class="number">0</span>, <span class="number">0x6590</span>u, <span class="number">3</span>, <span class="number">2049</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !addr )</span><br><span class="line">  {</span><br><span class="line">    fwrite(<span class="string">"httpd: mmap failed\\n"</span>, <span class="number">1u</span>, <span class="number">0x13</span>u, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  cfgRead(<span class="string">"HTTP"</span>, <span class="string">"SnapshotAuthentication"</span>, &amp;v13);</span><br><span class="line">  cfgRead(<span class="string">"HTTP"</span>, <span class="string">"LivevideoAuthentication"</span>, v14);</span><br><span class="line">  <span class="keyword">if</span> ( v13 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( v14[<span class="number">0</span>] )</span><br><span class="line">    {</span><br><span class="line">      fwrite(<span class="string">"httpd: Authentication Mode: Normal\\n"</span>, <span class="number">1u</span>, <span class="number">0x23</span>u, <span class="built_in">stderr</span>);</span><br><span class="line">      usrInit(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      fwrite(<span class="string">"httpd: Authentication Mode: Streaming pass\\n"</span>, <span class="number">1u</span>, <span class="number">0x2B</span>u, <span class="built_in">stderr</span>);</span><br><span class="line">      usrInit(<span class="number">3</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( v14[<span class="number">0</span>] )</span><br><span class="line">  {</span><br><span class="line">    fwrite(<span class="string">"httpd: Authentication Mode: Snapshot pass\\n"</span>, <span class="number">1u</span>, <span class="number">0x2A</span>u, <span class="built_in">stderr</span>);</span><br><span class="line">    usrInit(<span class="number">2</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    fwrite(<span class="string">"httpd: Authentication Mode: Snapshot and streaming pass\\n"</span>, <span class="number">1u</span>, <span class="number">0x38</span>u, <span class="built_in">stderr</span>);</span><br><span class="line">    usrInit(<span class="number">4</span>);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>First put httpd on port 80 for listening, then a series of signal processing mechanisms will be registered.</p>
<p>Call <code>mmap()</code> function to map a memory space with a size of 0x6590 bytes, and assign the returned mapped address to the variable addr.</p>
<p>If assign success, It will read  the SnapshotAuthentication and LivevideoAuthentication values from configuration file, and initialize the user authentication mode based on these two values.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">	sub_402BF0(<span class="number">17</span>);</span><br><span class="line">  AspInitial();</span><br><span class="line">  <span class="keyword">if</span> ( !dword_422C88 )</span><br><span class="line">  {</span><br><span class="line">    dest = (<span class="type">char</span> *)&amp;unk_4223D0;</span><br><span class="line">    v6 = v5;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    {</span><br><span class="line">      v7 = skSelect(v6, <span class="number">0</span>, <span class="number">500000</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="number">-1</span> )</span><br><span class="line">      {</span><br><span class="line">        logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"main"</span>, <span class="number">1324</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v7 )</span><br><span class="line">      {</span><br><span class="line">        v8 = skAccept(v5);</span><br><span class="line">        v9 = v8;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &lt; <span class="number">0</span> )</span><br><span class="line">          logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"main"</span>, <span class="number">1327</span>);</span><br><span class="line">        Peer6 = (<span class="type">const</span> <span class="type">char</span> *)skGetPeer6(v9, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(dest, Peer6);</span><br><span class="line">        v11 = fork();</span><br><span class="line">        <span class="keyword">if</span> ( v11 == <span class="number">-1</span> )</span><br><span class="line">        {</span><br><span class="line">LABEL_31:</span><br><span class="line">          logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"main"</span>, <span class="number">1337</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !v11 )</span><br><span class="line">        {</span><br><span class="line">          skClose(v5);</span><br><span class="line">          fd = v9;</span><br><span class="line">          v18 = dword_422414;</span><br><span class="line">          v17 = AuthType;</span><br><span class="line">          v12 = getpid();</span><br><span class="line">          sub_403038(v18, v17, v12, port);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">        }</span><br><span class="line">        skClose(v9);</span><br><span class="line">      }</span><br><span class="line">      usleep(<span class="number">0x30D40</span>u);</span><br><span class="line">      v6 = v5;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">while</span> ( !dword_422C88 );</span><br><span class="line">  }</span><br><span class="line">  skClose(v5);</span><br><span class="line">  munmap(addr, <span class="number">0x6590</span>u);</span><br><span class="line">  usrFree();</span><br><span class="line">  AspRelease();</span><br><span class="line">  kill(<span class="number">0</span>, <span class="number">15</span>);</span><br><span class="line">  waitpid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0x40000000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Call the <code>AspInitial()</code> function to initialize the corresponding ASP, enter the do while loop to monitor whether someone is connected.</p>
<p>If someone connects, fork a child process to call the <code>sub_403038</code> function to handle client requests.</p>
<p>Finally, call some function to close corresponding request. So then start analyzing <code>sub_403038</code> function</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_403038</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5, <span class="type">int</span> a6, <span class="type">int</span> a7, <span class="type">int</span> a8, <span class="type">const</span> <span class="type">char</span> *a9)</span></span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">v10</span>;</span> <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v11; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">bool</span> v14; <span class="comment">// dc</span></span><br><span class="line">  _BOOL4 v15; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v16; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v17; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $a3</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// $a2</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v24; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">size_t</span> v25; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v27; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v28; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v29; <span class="comment">// $s7</span></span><br><span class="line">  <span class="type">char</span> *v30; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v31; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *v32; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">char</span> *v33; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// $s7</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v35; <span class="comment">// [sp+20h] [-430h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v36[<span class="number">256</span>]; <span class="comment">// [sp+24h] [-42Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// [sp+124h] [-32Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v38; <span class="comment">// [sp+128h] [-328h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v39[<span class="number">256</span>]; <span class="comment">// [sp+12Ch] [-324h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v40[<span class="number">516</span>]; <span class="comment">// [sp+22Ch] [-224h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v41; <span class="comment">// [sp+430h] [-20h]</span></span><br><span class="line">  <span class="type">char</span> *v42; <span class="comment">// [sp+434h] [-1Ch]</span></span><br><span class="line">  <span class="type">char</span> *v43; <span class="comment">// [sp+438h] [-18h]</span></span><br><span class="line">  <span class="type">char</span> *v44; <span class="comment">// [sp+43Ch] [-14h]</span></span><br><span class="line">  <span class="type">char</span> *v45; <span class="comment">// [sp+440h] [-10h]</span></span><br><span class="line">  <span class="type">char</span> *v46; <span class="comment">// [sp+444h] [-Ch]</span></span><br><span class="line">  <span class="type">char</span> *v47; <span class="comment">// [sp+448h] [-8h]</span></span><br><span class="line">  <span class="type">char</span> *format; <span class="comment">// [sp+44Ch] [-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (dword_422C8C &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    v10 = <span class="built_in">stderr</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">  v11 = (<span class="type">const</span> <span class="type">char</span> **)reqInit(v10);</span><br><span class="line">  v35 = v11;</span><br><span class="line">  <span class="built_in">memset</span>(v36, <span class="number">0</span>, <span class="keyword">sizeof</span>(v36));</span><br><span class="line">  v37 = <span class="number">0</span>;</span><br><span class="line">  v38 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( dword_422C90 &amp;&amp; v11 )</span><br><span class="line">    v11[<span class="number">10</span>] = (<span class="type">const</span> <span class="type">char</span> *)<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (dword_422C8C &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: connected\\n"</span>, a9);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  v41 = <span class="string">".cgi"</span>;</span><br><span class="line">  v42 = <span class="string">"/fvcgi/storage/localstorage_download.ts"</span>;</span><br><span class="line">  v44 = <span class="string">"/onvif/onvif_service"</span>;</span><br><span class="line">  v45 = <span class="string">"/cam/webapi_service"</span>;</span><br><span class="line">  v46 = <span class="string">"/hnap/hnap_service"</span>;</span><br><span class="line">  v47 = <span class="string">"/localrecording/"</span>;</span><br><span class="line">  format = <span class="string">"%s"</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( !v35 || reqRead(v35, fd) &lt; <span class="number">0</span> )</span><br><span class="line">      {</span><br><span class="line">LABEL_75:</span><br><span class="line">        <span class="keyword">if</span> ( (dword_422C8C &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: disconnected\\n"</span>, a9);</span><br><span class="line">        sub_401950(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v35 )</span><br><span class="line">          reqFree(v35);</span><br><span class="line">        munmap(addr, <span class="number">0x6590</span>u);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      }</span><br><span class="line">      v12 = *v35;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">while</span> ( !**((_BYTE **)*v35 + <span class="number">6</span>) || !**((_BYTE **)v12 + <span class="number">5</span>) );</span><br><span class="line">    <span class="keyword">if</span> ( !a1 )</span><br><span class="line">      *(_DWORD *)v12 = <span class="number">0</span>;</span><br><span class="line">    v13 = sub_402B78();</span><br><span class="line">    v14 = v13 &gt;= <span class="number">1024</span>;</span><br><span class="line">    v15 = v13 &lt; <span class="number">3072</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( v15 )</span><br><span class="line">        sleep(<span class="number">1u</span>);</span><br><span class="line">      v38 = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      sleep(<span class="number">3u</span>);</span><br><span class="line">      v38 = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    readUpFwStatus(&amp;v38);</span><br><span class="line">    <span class="keyword">if</span> ( v38 == <span class="number">1</span> )</span><br><span class="line">    {</span><br><span class="line">      v16 = <span class="string">"503 Service Not Available\\r\\nFirmware Upgrading Please Wait\\r\\n"</span>;</span><br><span class="line">      v17 = v39;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      {</span><br><span class="line">        v18 = *((_DWORD *)v16 + <span class="number">1</span>);</span><br><span class="line">        v19 = *((_DWORD *)v16 + <span class="number">2</span>);</span><br><span class="line">        v20 = *((_DWORD *)v16 + <span class="number">3</span>);</span><br><span class="line">        *(_DWORD *)v17 = *(_DWORD *)v16;</span><br><span class="line">        *((_DWORD *)v17 + <span class="number">1</span>) = v18;</span><br><span class="line">        *((_DWORD *)v17 + <span class="number">2</span>) = v19;</span><br><span class="line">        *((_DWORD *)v17 + <span class="number">3</span>) = v20;</span><br><span class="line">        v16 += <span class="number">16</span>;</span><br><span class="line">        v17 += <span class="number">16</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">while</span> ( v16 != <span class="string">"ease Wait\\r\\n"</span> );</span><br><span class="line">      v21 = *(_DWORD *)v16;</span><br><span class="line">      v22 = *((_DWORD *)v16 + <span class="number">1</span>);</span><br><span class="line">      v23 = *((_DWORD *)v16 + <span class="number">2</span>);</span><br><span class="line">      *(_DWORD *)v17 = v21;</span><br><span class="line">      *((_DWORD *)v17 + <span class="number">1</span>) = v22;</span><br><span class="line">      *((_DWORD *)v17 + <span class="number">2</span>) = v23;</span><br><span class="line">      <span class="built_in">memset</span>(&amp;v39[<span class="number">60</span>], <span class="number">0</span>, <span class="number">0xC4</span>u);</span><br><span class="line">      v24 = v35[<span class="number">8</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v24</span><br><span class="line">        &amp;&amp; (!<span class="built_in">strcmp</span>(v35[<span class="number">8</span>], <span class="string">"/cgi/finish.cgi"</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v24, <span class="string">"/cgi/admin/finish.cgi"</span>)</span><br><span class="line">         || !<span class="built_in">strcmp</span>(v24, <span class="string">"/cgi/maker/finish.cgi"</span>)) )</span><br><span class="line">      {</span><br><span class="line">        skPrint(fd, <span class="string">"HTTP/1.1 200\\r\\n"</span>);</span><br><span class="line">        skPrint(fd, <span class="string">"Content-Type: text/plain\\r\\n"</span>);</span><br><span class="line">        skPrint(fd, <span class="string">"Content-Length: %d\\r\\n\\r\\n"</span>, <span class="number">10</span>);</span><br><span class="line">        skPrint(fd, <span class="string">"finish=%d\\r\\n"</span>, v38);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"finish=%d (response by httpd)\\n"</span>, v38);</span><br><span class="line">        sub_401950(<span class="number">0</span>);</span><br><span class="line">        reqFree(v35);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      }</span><br><span class="line">      skPrint(fd, <span class="string">"HTTP/1.1 503\\r\\n"</span>);</span><br><span class="line">      skPrint(fd, <span class="string">"Content-Type: text/plain\\r\\n"</span>);</span><br><span class="line">      v25 = <span class="built_in">strlen</span>(v39);</span><br><span class="line">      skPrint(fd, <span class="string">"Content-Length: %d\\r\\n\\r\\n"</span>, v25);</span><br><span class="line">      skPrint(fd, <span class="string">"%s"</span>, v39);</span><br><span class="line">      sub_401950(<span class="number">0</span>);</span><br><span class="line">      reqFree(v35);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a9, <span class="string">"127.0.0.1"</span>) )</span><br><span class="line">      v26 = sub_401C2C(<span class="number">0</span>, v35, v36, a9) + <span class="number">414</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v26 = sub_401C2C(a2, v35, v36, a9);</span><br><span class="line">    v27 = a9;</span><br><span class="line">    <span class="keyword">switch</span> ( v26 )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-414</span>:</span><br><span class="line">        sub_402898(v35, <span class="string">"414.html"</span>, <span class="string">"414"</span>, *(_DWORD *)*v35);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-413</span>:</span><br><span class="line">        sub_402898(v35, <span class="string">"413.html"</span>, <span class="string">"413"</span>, *(_DWORD *)*v35);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-412</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-411</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-410</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-409</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-408</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-407</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-406</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-405</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-402</span>:</span><br><span class="line">        v27 = a9;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-404</span>:</span><br><span class="line">        sub_402898(v35, <span class="string">"404.html"</span>, <span class="string">"404"</span>, *(_DWORD *)*v35);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-403</span>:</span><br><span class="line">        sub_402898(v35, <span class="string">"403.html"</span>, <span class="string">"403"</span>, *(_DWORD *)*v35);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-401</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !**((_BYTE **)*v35 + <span class="number">8</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_61;</span><br><span class="line">        sub_402E20(a9, <span class="number">1</span>);</span><br><span class="line">        sub_401B6C(a9, &amp;v37);</span><br><span class="line">        <span class="keyword">if</span> ( v37 &lt; <span class="number">4</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_61;</span><br><span class="line">        sub_402898(v35, <span class="string">"401.html"</span>, <span class="string">"200"</span>, *(_DWORD *)*v35);</span><br><span class="line">        sub_402E20(a9, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">LABEL_42:</span><br><span class="line">        sub_402E20(v27, <span class="number">0</span>);</span><br><span class="line">        v28 = v35;</span><br><span class="line">        v43 = (<span class="type">char</span> *)v35[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v43, v41) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_64;</span><br><span class="line">        v29 = v28[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v29, v42)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v29, v44)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v29, v45)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v29, v46)</span><br><span class="line">          || !<span class="built_in">strncmp</span>(v29, v47, <span class="number">0x10</span>u) )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">goto</span> LABEL_64;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(v29, <span class="string">"/videostorage/"</span>, <span class="number">0xE</span>u) )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(v29, <span class="string">"/greece/"</span>, <span class="number">8u</span>) )</span><br><span class="line">          {</span><br><span class="line">            <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v43, <span class="string">".asp"</span>) )</span><br><span class="line">            {</span><br><span class="line">              sub_402898(v28, v28[<span class="number">7</span>], <span class="string">"200"</span>, *(_DWORD *)*v28);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">              v34 = hoInit(v28);</span><br><span class="line">              <span class="keyword">if</span> ( aspLoad(v28[<span class="number">7</span>], v34, v28[<span class="number">1</span>], v36) &gt;= <span class="number">0</span> )</span><br><span class="line">              {</span><br><span class="line">                sub_4025F8(*(_DWORD *)*v28, <span class="string">"200"</span>, <span class="string">".asp"</span>, v28[<span class="number">8</span>]);</span><br><span class="line">                hoFree(v34, fd, dword_422C8C &amp; <span class="number">4</span>);</span><br><span class="line">              }</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              {</span><br><span class="line">                sub_402898(v28, <span class="string">"404.html"</span>, <span class="string">"404"</span>, *(_DWORD *)*v28);</span><br><span class="line">                hoFree(v34, <span class="number">0</span>, dword_422C8C &amp; <span class="number">4</span>);</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          {</span><br><span class="line">LABEL_64:</span><br><span class="line">            sub_402040(&amp;v35, a4, v36);</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">memset</span>(v39, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v35[<span class="number">1</span>] )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_57;</span><br><span class="line">        <span class="built_in">memset</span>(v40, <span class="number">0</span>, <span class="number">512</span>);</span><br><span class="line">        <span class="built_in">snprintf</span>(v40, <span class="number">0x200</span>u, format, v35[<span class="number">1</span>]);</span><br><span class="line">        v30 = <span class="built_in">strstr</span>(v40, <span class="string">"access_token="</span>);</span><br><span class="line">        v31 = a9;</span><br><span class="line">        <span class="keyword">if</span> ( v30 )</span><br><span class="line">        {</span><br><span class="line">          v32 = v30 + <span class="number">13</span>;</span><br><span class="line">          v33 = <span class="built_in">strchr</span>(v30 + <span class="number">13</span>, <span class="number">38</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v33 )</span><br><span class="line">            *v33 = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">snprintf</span>(v39, <span class="number">0x10</span>u, format, v32);</span><br><span class="line">LABEL_57:</span><br><span class="line">          v31 = a9;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v31, <span class="string">"127.0.0.1"</span>)</span><br><span class="line">          &amp;&amp; checkToken_localrecording(a9, v39) == <span class="number">-1</span></span><br><span class="line">          &amp;&amp; checkToken_localrecording(a9, *((_DWORD *)*v35 + <span class="number">16</span>)) == <span class="number">-1</span> )</span><br><span class="line">        {</span><br><span class="line">LABEL_61:</span><br><span class="line">          sub_402898(v35, <span class="string">"401.html"</span>, <span class="string">"401"</span>, *(_DWORD *)*v35);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">          sub_402898(v35, v35[<span class="number">7</span>], <span class="string">"200"</span>, *(_DWORD *)*v35);</span><br><span class="line">        }</span><br><span class="line">LABEL_70:</span><br><span class="line">        <span class="keyword">if</span> ( byte_422418[<span class="number">0</span>] &amp;&amp; !*(_DWORD *)*v35 &amp;&amp; <span class="built_in">strstr</span>(v35[<span class="number">8</span>], byte_422418) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_75;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The function is very long and important, it does a lot of things.</p>
<p>First call the <code>reqInit()</code> function to initialize the request, then call the <code>sub_401C2C()</code> function to handle requests, and do different processing according to the return value.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_401C2C</span><span class="params">(<span class="type">int</span> a1, <span class="type">const</span> <span class="type">char</span> **a2, <span class="type">int</span> a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">bool</span> v6; <span class="comment">// dc</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">size_t</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v11; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">size_t</span> v13; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v14; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v15; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $s3</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">v18</span>;</span> <span class="comment">// [sp+20h] [-124h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [sp+B8h] [-8Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v20[<span class="number">64</span>]; <span class="comment">// [sp+BCh] [-88h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v21[<span class="number">72</span>]; <span class="comment">// [sp+FCh] [-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v6 = atoi(*((<span class="type">const</span> <span class="type">char</span> **)*a2 + <span class="number">12</span>)) &gt;= <span class="number">0xD00001</span>;<span class="comment">// Content-Length</span></span><br><span class="line">  result = <span class="number">-414</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  v8 = a2[<span class="number">7</span>];                                   <span class="comment">// url</span></span><br><span class="line">  result = <span class="number">-404</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v8 )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  v9 = <span class="built_in">strlen</span>(a2[<span class="number">5</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(v8, a2[<span class="number">5</span>], v9) &amp;&amp; <span class="built_in">strncmp</span>(v8, <span class="string">"/mnt/storage"</span>, <span class="number">0xC</span>u) &amp;&amp; <span class="built_in">strncmp</span>(v8, <span class="string">"/var/tmp/device"</span>, <span class="number">0xF</span>u) )</span><br><span class="line">  {</span><br><span class="line">    v10 = <span class="built_in">strncmp</span>(v8, <span class="string">"/var/tmp/mpegts"</span>, <span class="number">0xF</span>u);</span><br><span class="line">    v11 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( !v10 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    v6 = <span class="built_in">strncmp</span>(v8, <span class="string">"/mnt/storage/local_recording"</span>, <span class="number">0x1C</span>u) != <span class="number">0</span>;</span><br><span class="line">    result = <span class="number">-404</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  }</span><br><span class="line">  v11 = v8;</span><br><span class="line">LABEL_9:</span><br><span class="line">  v6 = stat(v11, &amp;v18) != <span class="number">0</span>;</span><br><span class="line">  result = <span class="number">-404</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  <span class="keyword">if</span> ( v18.st_blocks &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-404</span>;</span><br><span class="line">  v12 = v18.st_nlink &amp; <span class="number">0xF000</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v12 == <span class="number">0x8000</span> || (v6 = v12 != <span class="number">40960</span>, result = <span class="number">-404</span>, !v6) )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">memset</span>(v20, <span class="number">0</span>, <span class="keyword">sizeof</span>(v20));</span><br><span class="line">        <span class="built_in">memset</span>(v21, <span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">        cfgRead(<span class="string">"USER_ADMIN"</span>, <span class="string">"Username1"</span>, v20);</span><br><span class="line">        cfgRead(<span class="string">"USER_ADMIN"</span>, <span class="string">"Password1"</span>, v21);</span><br><span class="line">        usrEncBasic(v20, v21, a3);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    v13 = <span class="built_in">strlen</span>(a2[<span class="number">5</span>]);</span><br><span class="line">    v14 = a2[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v14, <span class="string">"/var/tmp/device"</span>, <span class="number">0xF</span>u) || !<span class="built_in">strncmp</span>(v14, <span class="string">"/mnt/storage/local_recording"</span>, <span class="number">0x1C</span>u) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(v14, <span class="string">"/var/tmp/mpegts"</span>, <span class="number">0xF</span>u) )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v14, <span class="string">"/mnt/storage"</span>, <span class="number">0xC</span>u) )</span><br><span class="line">        v13 = <span class="number">12</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      v13 = <span class="number">15</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( dword_422C90 &amp;&amp; (v15 = a2[<span class="number">9</span>]) != <span class="number">0</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">return</span> usrAuth(v15, &amp;v14[v13], *((_DWORD *)*a2 + <span class="number">5</span>), a3);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      v19 = <span class="number">0</span>;</span><br><span class="line">      v16 = <span class="number">0</span>;</span><br><span class="line">      v17 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      {</span><br><span class="line">        ++v17;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a2[<span class="number">8</span>], &amp;aImage2JpegCgi[<span class="number">128</span> * v16]) )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v16 = v17;</span><br><span class="line">        <span class="keyword">if</span> ( v17 == <span class="number">11</span> )</span><br><span class="line">        {</span><br><span class="line">          usrAuth(*((_DWORD *)*a2 + <span class="number">8</span>), &amp;a2[<span class="number">7</span>][v13], *((_DWORD *)*a2 + <span class="number">5</span>), a3);</span><br><span class="line">          v19 = <span class="number">0</span>;</span><br><span class="line">          cfgRead(<span class="string">"HTTP"</span>, <span class="string">"Authenticate"</span>, &amp;v19);</span><br><span class="line">          <span class="keyword">return</span> usrAuthByAuthenticate(*((_DWORD *)*a2 + <span class="number">8</span>), &amp;a2[<span class="number">7</span>][v13], *((_DWORD *)*a2 + <span class="number">5</span>), a3);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> usrAuthByAuthenticate(*((_DWORD *)*a2 + <span class="number">8</span>), &amp;a2[<span class="number">7</span>][v13], *((_DWORD *)*a2 + <span class="number">5</span>), a3);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>If requested Content-Length ≥ 13631489, return 414.</p>
<p>If url is empty, return 404.</p>
<p>If it is a whitelist, return 0.</p>
<p>If file does not exist, return 404.</p>
<p>Different validations are determined according to the values of a1 and a3.</p>
<ul>
<li>If a1 == 0 &amp;&amp; a3 ≠ 0<ul>
<li>Encrypt username and password with base64</li>
</ul>
</li>
<li>if a1 == 0 &amp;&amp; a3 == 0<ul>
<li>return 0</li>
</ul>
</li>
</ul>
<p>If url is not whitelist.</p>
<ul>
<li>Authenticate</li>
<li>return status code</li>
</ul>
<p>Call the corresponding case according to the return status code.</p>
<p>If the status code is equal to 200.</p>
<ul>
<li><p>if request is scheduled</p>
<ul>
<li>execute <code>sub_402040</code> function</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_402040</span><span class="params">(_DWORD *a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> *<span class="type">const</span> *Env; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">char</span> *<span class="type">const</span> *Arg; <span class="comment">// $s3</span></span><br><span class="line"></span><br><span class="line">  Env = (<span class="type">char</span> *<span class="type">const</span> *)reqMakeEnv(*a1, fd, a2, a3);</span><br><span class="line">  Arg = (<span class="type">char</span> *<span class="type">const</span> *)reqMakeArg(*a1);</span><br><span class="line">  <span class="keyword">if</span> ( dup(fd) || dup(fd) != <span class="number">1</span> )</span><br><span class="line">    logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"runcgi"</span>, <span class="number">823</span>);</span><br><span class="line">  fcntl(fd, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">  execve(*(<span class="type">const</span> <span class="type">char</span> **)(*a1 + <span class="number">28</span>), Arg, Env);</span><br><span class="line">  sub_401950();</span><br><span class="line">  reqFree(*a1);</span><br><span class="line">  <span class="keyword">return</span> logx(<span class="number">3</span>, <span class="string">"%s %s %d"</span>, <span class="string">"httpd.c"</span>, <span class="string">"runcgi"</span>, <span class="number">830</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>call the execve function to execute</p>
</li>
<li><p>if request is .asp</p>
<ul>
<li>execute asp function</li>
</ul>
</li>
</ul>
<p>During the response, the <code>access_token</code> will be checked, if the access_token is wrong, it will be 401. Call <code>checkToken_localrecording()</code> for access control.</p>
<p>In the above analysis, it was found that there is a hnap service.</p>
<p>hnap service is a very old protocol, d-link began to deprecate this protocol in 2016, so many bugs happen here.</p>
<h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><h3 id="Unauthenticated-Information-Disclosure"><a href="#Unauthenticated-Information-Disclosure" class="headerlink" title="Unauthenticated Information Disclosure"></a>Unauthenticated Information Disclosure</h3><p>In the above analysis, there is a very interesting code snippet.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">sub_403038</span><span class="params">(<span class="type">int</span> live, <span class="type">int</span> authtype, <span class="type">int</span> pid, <span class="type">int</span> port)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">v37 = <span class="string">"/fvcgi/storage/localstorage_download.ts"</span>;</span><br><span class="line">v39 = <span class="string">"/onvif/onvif_service"</span>;</span><br><span class="line">v40 = <span class="string">"/cam/webapi_service"</span>;</span><br><span class="line">v41 = <span class="string">"/hnap/hnap_service"</span>;</span><br><span class="line">v42 = <span class="string">"/localrecording/"</span>;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v24, v37)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v24, v39)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v24, v40)</span><br><span class="line">          || !<span class="built_in">strcmp</span>(v24, v41)</span><br><span class="line">          || !<span class="built_in">strncmp</span>(v24, v42, <span class="number">0x10</span>u) )</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">goto</span> LABEL_64;</span><br><span class="line">        }</span><br><span class="line">......</span><br><span class="line">LABEL_64:</span><br><span class="line">            sub_402040((<span class="type">char</span> *)&amp;v6 + <span class="number">5</span>, port, v31);</span><br><span class="line">          }</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v26, <span class="string">"127.0.0.1"</span>)</span><br><span class="line">          &amp;&amp; checkToken_localrecording(v46, v34) == <span class="number">-1</span></span><br><span class="line">          &amp;&amp; checkToken_localrecording(v46, *(_DWORD *)(*(_DWORD *)v6 + <span class="number">64</span>)) == <span class="number">-1</span> )</span><br><span class="line">        {</span><br><span class="line">.......</span><br></pre></td></tr></tbody></table></figure>

<p>If url is <code>/hnap/hnap_service</code> , it will go to LABEL_64, LABEL_64 call <code>sub_402040</code> function,  <code>sub_402040</code> function use execve function to call <code>hnap_service</code> cgi program.</p>
<p>But after execution is over,  <code>checkToken_localrecording()</code> will be called for access control. So <code>hnap_service</code> can be used without authentication.</p>
<p>If you access <code>hnap_service</code> with a GET request, the <code>GetDeviceSettings</code> function will be called.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">{</span><br><span class="line">....</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v8, <span class="string">"GET"</span>) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">memset</span>(v25, <span class="number">0</span>, <span class="keyword">sizeof</span>(v25));</span><br><span class="line">    v18 = sub_4021EC(<span class="number">0</span>, <span class="string">"GetDeviceSettings"</span>, <span class="number">0</span>);</span><br><span class="line">    v14 = v18;</span><br><span class="line">    <span class="keyword">if</span> ( !v18 )</span><br><span class="line">    {</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">    }</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>The <code>GetDeviceSettings</code> function will output import informations such as  <code>FirmwareVersion/MacAddr</code> and so on.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">GetDeviceSettings</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> Document; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> Element; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> appended; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">512</span>]; <span class="comment">// [sp+28h] [-450h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">256</span>]; <span class="comment">// [sp+228h] [-250h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v11[<span class="number">256</span>]; <span class="comment">// [sp+328h] [-150h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">68</span>]; <span class="comment">// [sp+428h] [-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [sp+46Ch] [-Ch]</span></span><br><span class="line">  __int16 v14; <span class="comment">// [sp+470h] [-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 v15; <span class="comment">// [sp+472h] [-6h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 v16; <span class="comment">// [sp+474h] [-4h] BYREF</span></span><br><span class="line">  __int16 v17; <span class="comment">// [sp+476h] [-2h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;v9[<span class="number">1</span>], <span class="number">0</span>, <span class="number">0x1FF</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">  <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="keyword">sizeof</span>(v11));</span><br><span class="line">  <span class="built_in">memset</span>(v12, <span class="number">0</span>, <span class="number">65</span>);</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  Document = ixmlDocument_createDocument();</span><br><span class="line">  Element = ixmlDocument_createElement(Document, <span class="string">"GetDeviceSettingsResponse"</span>);</span><br><span class="line">  ixmlElement_setAttribute(Element, <span class="string">"xmlns"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/&gt;"</span>);</span><br><span class="line">  ixmlNode_appendChild(Document, Element);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"GetDeviceSettingsResult"</span>, <span class="string">"OK"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"Type"</span>, <span class="string">"ConnectedHomeClient"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="keyword">sizeof</span>(v11));</span><br><span class="line">  cfgRead(<span class="string">"System"</span>, <span class="string">"ModelName"</span>, v11);</span><br><span class="line">  <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line">  <span class="built_in">memset</span>(v12, <span class="number">0</span>, <span class="number">0x41</span>u);</span><br><span class="line">  cfgRead(<span class="string">"CAMSYSTEM"</span>, <span class="string">"CameraName"</span>, v9);</span><br><span class="line">  cfgRead(<span class="string">"CAMSYSTEM"</span>, <span class="string">"CameraName"</span>, v12);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(v9) &gt;= <span class="number">0x21</span> )</span><br><span class="line">    v9[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"DeviceName"</span>, v9);</span><br><span class="line">  <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line">  cfgRead(<span class="string">"INFO"</span>, <span class="string">"BrandName"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"VendorName"</span>, v9);</span><br><span class="line">  <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line">  cfgRead(<span class="string">"INFO"</span>, <span class="string">"Product"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"ModelDescription"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"ModelName"</span>, v11);</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  net_get_hwaddr(<span class="string">"br0"</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(</span><br><span class="line">    v9,</span><br><span class="line">    <span class="string">"%02X:%02X:%02X:%02X:%02X:%02X"</span>,</span><br><span class="line">    HIBYTE(v13),</span><br><span class="line">    BYTE1(v13),</span><br><span class="line">    BYTE2(v13),</span><br><span class="line">    (<span class="type">unsigned</span> __int8)v13,</span><br><span class="line">    HIBYTE(v14),</span><br><span class="line">    (<span class="type">unsigned</span> __int8)v14);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"DeviceMacId"</span>, v9);</span><br><span class="line">  cfgRead(<span class="string">"System"</span>, <span class="string">"MainVersion"</span>, &amp;v15);</span><br><span class="line">  cfgRead(<span class="string">"System"</span>, <span class="string">"FirmwareVersion"</span>, &amp;v16);</span><br><span class="line">  cfgRead(<span class="string">"System"</span>, <span class="string">"CustomerVersion"</span>, &amp;v17);</span><br><span class="line">  <span class="built_in">sprintf</span>(v9, <span class="string">"%d.%02d"</span>, v15, v16);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"FirmwareVersion"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"FirmwareRegion"</span>, <span class="string">"Default"</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(v9, <span class="string">"%d.%02d"</span>, v15, v16);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"LatestFirmwareVersion"</span>, v9);</span><br><span class="line">  <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="keyword">sizeof</span>(v9));</span><br><span class="line">  cfgRead(<span class="string">"INFO"</span>, <span class="string">"HWVersion"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"HardwareVersion"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"HNAPVersion"</span>, <span class="string">"0111"</span>);</span><br><span class="line">  cfgRead(<span class="string">"Bonjour"</span>, <span class="string">"PresentationURL"</span>, v10);</span><br><span class="line">  <span class="keyword">if</span> ( v10[<span class="number">0</span>] )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">sprintf</span>(v9, <span class="string">"http://%s.local./"</span>, v10);</span><br><span class="line">    v2 = v9;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( v12[<span class="number">0</span>] )</span><br><span class="line">      <span class="built_in">sprintf</span>(v9, <span class="string">"http://%s.local./"</span>, v12);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">sprintf</span>(v9, <span class="string">"http://%s.local./"</span>, v11);</span><br><span class="line">    v2 = v9;</span><br><span class="line">  }</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v3++ &lt; <span class="built_in">strlen</span>(v9) )</span><br><span class="line">  {</span><br><span class="line">    *v2 = *(_WORD *)(_ctype_tolower + <span class="number">2</span> * *v2);</span><br><span class="line">    ++v2;</span><br><span class="line">  }</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"PresentationURL"</span>, v9);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"CAPTCHA"</span>, <span class="string">"false"</span>);</span><br><span class="line">  appended = ixmlAppendNewElement(Document, Element, <span class="string">"ModuleTypes"</span>, <span class="number">0</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, appended, <span class="string">"string"</span>, <span class="string">"Optical Recognition"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, appended, <span class="string">"string"</span>, <span class="string">"Environmental Sensor"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, appended, <span class="string">"string"</span>, <span class="string">"Camera"</span>);</span><br><span class="line">  v6 = ixmlAppendNewElement(Document, Element, <span class="string">"SOAPActions"</span>, <span class="number">0</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/Login&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetDCHPolicy&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetDCHPolicy&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetNotifierSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetNotifierSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetEventSupportList&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetActionSupportList&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/PushDCHEvent&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetmydlinkSupportStatus&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetmydlinkRegInfo&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetmydlinkReg&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetmydlinkUnregistration&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetDeviceSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetDeviceSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetDeviceSettings2&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetDeviceSettings2&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetModuleProfile&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetModuleProfile&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetTriggerWirelessSiteSurvey&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetSiteSurvey&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetWLanRadios&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetAPClientSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/SetAPClientSettings&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, v6, <span class="string">"string"</span>, <span class="string">"&lt;http://purenetworks.com/HNAP1/GetMultipleHNAPs&gt;"</span>);</span><br><span class="line">  ixmlAppendNewElement(Document, Element, <span class="string">"SubDeviceURLs"</span>, <span class="number">0</span>);</span><br><span class="line">  v7 = ixmlNode_cloneNode(Document, <span class="number">1</span>);</span><br><span class="line">  ixmlDocument_free(Document);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Stack-Overflow"><a href="#Stack-Overflow" class="headerlink" title="Stack Overflow"></a>Stack Overflow</h3><p>In the Login function, I can enter Action, the Action will strcpy to v42, but program do not check size, resulting in stack overflow.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">Login</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">	ElementByTag = ixmlGetElementByTag(a1, <span class="string">"Login"</span>);</span><br><span class="line">  v5 = ElementByTag;</span><br><span class="line">  <span class="keyword">if</span> ( !ElementByTag )</span><br><span class="line">  {</span><br><span class="line">    ixmlAppendNewElement(Document, Element, <span class="string">"LoginResult"</span>, <span class="string">"failed"</span>);</span><br><span class="line">    v15 = Document;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">  }</span><br><span class="line">  ElementValueByTag = (<span class="type">const</span> <span class="type">char</span> *)ixmlGetElementValueByTag(ElementByTag, <span class="string">"Action"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ElementValueByTag )</span><br><span class="line">    <span class="built_in">strcpy</span>(v42, ElementValueByTag);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>In the Login function, I can enter Username and LoginPassword, the username&amp;password will strcpy to v36&amp;v38, but program do not check the size, resulting in stack overflow.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">Login</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">				v16 = (<span class="type">const</span> <span class="type">char</span> *)ixmlGetElementValueByTag(v5, <span class="string">"Username"</span>);</span><br><span class="line">        v17 = (<span class="type">const</span> <span class="type">char</span> *)ixmlGetElementValueByTag(v5, <span class="string">"LoginPassword"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v16 )</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">strcpy</span>((<span class="type">char</span> *)v36, v16);</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)v36, <span class="string">"Admin"</span>) )</span><br><span class="line">            <span class="built_in">snprintf</span>((<span class="type">char</span> *)v36, <span class="number">0x20</span>u, <span class="string">"%s"</span>, <span class="string">"admin"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ( v17 )</span><br><span class="line">          <span class="built_in">strcpy</span>(v38, v17);</span><br><span class="line">        v53 = (<span class="type">const</span> <span class="type">char</span> *)v36;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"username: %s\\n"</span>, (<span class="type">const</span> <span class="type">char</span> *)v36);</span><br><span class="line">        v55 = v38;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"loginPassword: %s\\n"</span>, v38);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Cookie-Format-String"><a href="#Cookie-Format-String" class="headerlink" title="Cookie Format String"></a>Cookie Format String</h3><p>In the Login function, the program use the getenv function to obtain COOKIE value, and use the snprintf function to put the value into v39, without %s, resulting format string vuln</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">Login</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">	v7 = getenv(<span class="string">"COOKIE"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v7 &amp;&amp; *v7 )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">memset</span>(v43, <span class="number">0</span>, <span class="keyword">sizeof</span>(v43));</span><br><span class="line">    v9 = getenv(<span class="string">"COOKIE"</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(v43, <span class="number">0x80</span>u, <span class="string">"%s"</span>, v9);</span><br><span class="line">    v10 = <span class="built_in">strstr</span>(v43, <span class="string">"uid="</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v10 )</span><br><span class="line">    {</span><br><span class="line">      v11 = v10 + <span class="number">4</span>;</span><br><span class="line">      v12 = <span class="built_in">strchr</span>(v10 + <span class="number">4</span>, <span class="number">59</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v12 )</span><br><span class="line">        *v12 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)v39, <span class="number">0xB</span>u, v11);</span><br><span class="line">      v13 = (<span class="type">const</span> <span class="type">char</span> *)&amp;v52[<span class="number">18</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)v39, <span class="number">0xB</span>u, v43);</span><br><span class="line">      v13 = (<span class="type">const</span> <span class="type">char</span> *)&amp;v52[<span class="number">18</span>];</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h3><p>In the Login function, Enter the Username and LoginPassword, then call usrGetPass function to obtain the password corresponding to the Username.</p>
<p><code>challenge + challenge length + public_key+password + public_key length+password length</code> performs hmac_md5 function to get private key.</p>
<p>Then, <code>challenge + challenge length + private_key + private_key length</code> performs hmac_md5 function to get <code>login_password</code>.</p>
<p>If <code>login_password</code> equal to save password, then login successful.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">Login</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">				v16 = (<span class="type">const</span> <span class="type">char</span> *)ixmlGetElementValueByTag(v5, <span class="string">"Username"</span>);</span><br><span class="line">        v17 = (<span class="type">const</span> <span class="type">char</span> *)ixmlGetElementValueByTag(v5, <span class="string">"LoginPassword"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v16 )</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">strcpy</span>((<span class="type">char</span> *)v36, v16);</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)v36, <span class="string">"Admin"</span>) )</span><br><span class="line">            <span class="built_in">snprintf</span>((<span class="type">char</span> *)v36, <span class="number">0x20</span>u, <span class="string">"%s"</span>, <span class="string">"admin"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ( v17 )</span><br><span class="line">          <span class="built_in">strcpy</span>(v38, v17);</span><br><span class="line">        v53 = (<span class="type">const</span> <span class="type">char</span> *)v36;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"username: %s\\n"</span>, (<span class="type">const</span> <span class="type">char</span> *)v36);</span><br><span class="line">        v55 = v38;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"loginPassword: %s\\n"</span>, v38);</span><br><span class="line">        <span class="built_in">memset</span>(v51, <span class="number">0</span>, <span class="number">53</span>);</span><br><span class="line">        <span class="built_in">memset</span>(v49, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">        <span class="built_in">memset</span>(v50, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">        v45 = <span class="number">0</span>;</span><br><span class="line">        v46 = <span class="number">0</span>;</span><br><span class="line">        v47 = <span class="number">0</span>;</span><br><span class="line">        v48 = <span class="number">0</span>;</span><br><span class="line">        usrInit(<span class="number">0</span>);</span><br><span class="line">        usrGetPass(v53, v50, <span class="number">33</span>);</span><br><span class="line">        usrFree();</span><br><span class="line">        v54 = (<span class="type">const</span> <span class="type">char</span> *)v52;</span><br><span class="line">        <span class="built_in">sprintf</span>(v51, <span class="string">"%s%s"</span>, (<span class="type">const</span> <span class="type">char</span> *)v52, v50);</span><br><span class="line">        v53 = (<span class="type">const</span> <span class="type">char</span> *)&amp;v52[<span class="number">9</span>];</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"My challenge: %s\\n"</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;v52[<span class="number">9</span>]);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"My public_key: %s\\n"</span>, v54);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"My password: %s\\n"</span>, v50);</span><br><span class="line">        v18 = <span class="built_in">strlen</span>(v53);</span><br><span class="line">        v19 = <span class="built_in">strlen</span>(v51);</span><br><span class="line">        hmac_md5(v53, v18, v51, v19);</span><br><span class="line">        <span class="built_in">sprintf</span>(v44, <span class="string">"%08X%08X%08X%08X"</span>, v45, v46, v47, v48);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"My private_key: %s\\n"</span>, v44);</span><br><span class="line">        v45 = <span class="number">0</span>;</span><br><span class="line">        v46 = <span class="number">0</span>;</span><br><span class="line">        v47 = <span class="number">0</span>;</span><br><span class="line">        v48 = <span class="number">0</span>;</span><br><span class="line">        v54 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">strlen</span>(v53);</span><br><span class="line">        v20 = <span class="built_in">strlen</span>(v44);</span><br><span class="line">        hmac_md5(v53, v54, v44, v20);</span><br><span class="line">        <span class="built_in">sprintf</span>(v49, <span class="string">"%08X%08X%08X%08X"</span>, v45, v46, v47, v48);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"My login_password: %s\\n"</span>, v49);</span><br><span class="line">        v21 = <span class="built_in">strcmp</span>(v55, v49) == <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Check authStatus: %d\\n"</span>, v21);</span><br><span class="line">        v22 = Document;</span><br><span class="line">        <span class="keyword">if</span> ( v21 )</span><br><span class="line">        {</span><br><span class="line">          v23 = time(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( HIBYTE(v52[<span class="number">3018</span>]) &amp;&amp; HIBYTE(v52[<span class="number">3027</span>]) &amp;&amp; v23 - v52[<span class="number">3031</span>] &lt; <span class="number">301</span> &amp;&amp; (v24 = &amp;v52[<span class="number">3048</span>], v23 &gt;= v52[<span class="number">3031</span>]) )</span><br><span class="line">          {</span><br><span class="line">            v25 = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            {</span><br><span class="line">              v26 = v24[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">if</span> ( !HIBYTE(v52[<span class="number">18</span> * v25 + <span class="number">3018</span>]) )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !HIBYTE(v52[<span class="number">18</span> * v25 + <span class="number">3027</span>]) )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              v27 = v23 - v26 &gt;= <span class="number">301</span>;</span><br><span class="line">              v28 = v23 &lt; v26;</span><br><span class="line">              <span class="keyword">if</span> ( v27 )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              ++v25;</span><br><span class="line">              <span class="keyword">if</span> ( v28 )</span><br><span class="line">              {</span><br><span class="line">                --v25;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              }</span><br><span class="line">              v24 += <span class="number">18</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v25 == <span class="number">1000</span> )</span><br><span class="line">              {</span><br><span class="line">                ixmlAppendNewElement(Document, Element, <span class="string">"LoginResult"</span>, <span class="string">"failed"</span>);</span><br><span class="line">                v15 = Document;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          {</span><br><span class="line">            v25 = <span class="number">0</span>;</span><br><span class="line">          }</span><br><span class="line">          <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;v52[<span class="number">18</span> * v25 + <span class="number">3018</span>], <span class="number">0x23</span>u, <span class="string">"%s"</span>, v44);</span><br><span class="line">          <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;v52[<span class="number">18</span> * v25 + <span class="number">3027</span>], <span class="number">0xB</span>u, <span class="string">"%s"</span>, (<span class="type">const</span> <span class="type">char</span> *)v39);</span><br><span class="line">          v29 = &amp;v36[<span class="number">9</span> * v25];</span><br><span class="line">          v29[<span class="number">1566</span>] = v23;</span><br><span class="line">          *((_BYTE *)v29 + <span class="number">12544</span>) = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)v36, <span class="string">"admin"</span>) )</span><br><span class="line">            BYTE1(v52[<span class="number">18</span> * v25 + <span class="number">3034</span>]) = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            BYTE1(v52[<span class="number">18</span> * v25 + <span class="number">3034</span>]) = <span class="number">0</span>;</span><br><span class="line">          SIWriteBin(<span class="number">63</span>, v52, <span class="number">84072</span>);</span><br><span class="line">          ixmlAppendNewElement(Document, Element, <span class="string">"LoginResult"</span>, <span class="string">"success"</span>);</span><br><span class="line">          v15 = Document;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      v30 = Element;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>But in the <code>usrGetPass</code> function, if the username I enter is not in the user list, <code>v6=21</code>, <code>result = -1</code> and <code>a2 = null</code> . So I just need to get the challenge and public key, and then follow the above hmac_md5 calculation go get the correct passwod.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">usrGetPass</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">char</span> *a2, <span class="type">size_t</span> a3)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v7; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [sp+18h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !*a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = (<span class="type">const</span> <span class="type">char</span> **)&amp;dword_21DC8;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    v8 = *v7;</span><br><span class="line">    v7 += <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    {</span><br><span class="line">      n = a3;</span><br><span class="line">      v9 = <span class="built_in">strcmp</span>(v8, a1);</span><br><span class="line">      a3 = n;</span><br><span class="line">      <span class="keyword">if</span> ( !v9 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    ++v6;</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">21</span> )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">strncpy</span>(a2, *((<span class="type">const</span> <span class="type">char</span> **)&amp;unk_21DC4 + <span class="number">3</span> * v6 + <span class="number">2</span>), n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Affected-Models"><a href="#Affected-Models" class="headerlink" title="Affected Models"></a><strong>Affected Models</strong></h2><table>
<thead>
<tr>
<th>Model</th>
<th>Download Links</th>
</tr>
</thead>
<tbody><tr>
<td>DCS-960L</td>
<td><a target="_blank" rel="noopener" href="https://d2okd4tdjucp2n.cloudfront.net/DCS-960L/DCS-960L_A1_FW_1.09.02.zip">https://d2okd4tdjucp2n.cloudfront.net/DCS-960L/DCS-960L_A1_FW_1.09.02.zip</a></td>
</tr>
<tr>
<td>DCS-935L</td>
<td><a target="_blank" rel="noopener" href="https://d2okd4tdjucp2n.cloudfront.net/DCS-935L/DCS-935L_A1_FW_1.13.01_r4589.zip">https://d2okd4tdjucp2n.cloudfront.net/DCS-935L/DCS-935L_A1_FW_1.13.01_r4589.zip</a></td>
</tr>
<tr>
<td>DCS-8200LH</td>
<td><a target="_blank" rel="noopener" href="https://www.dlinktw.com.tw/techsupport/download.ashx?file=11557">https://www.dlinktw.com.tw/techsupport/download.ashx?file=11557</a></td>
</tr>
</tbody></table>
<p>I only analyzed a very small part, there may be other vulnerabilities</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li>
         
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DCS-960L-Equipment-Analysis"><span class="toc-number">1.</span> <span class="toc-text">DCS-960L Equipment Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preliminary-Analysis"><span class="toc-number">1.1.</span> <span class="toc-text">Preliminary Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Links"><span class="toc-number">1.1.1.</span> <span class="toc-text">Links</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Service-Architecture-Analysis"><span class="toc-number">1.1.2.</span> <span class="toc-text">Web Service Architecture Analysis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">Vulnerability</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unauthenticated-Information-Disclosure"><span class="toc-number">1.2.1.</span> <span class="toc-text">Unauthenticated Information Disclosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-Overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">Stack Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-Format-String"><span class="toc-number">1.2.3.</span> <span class="toc-text">Cookie Format String</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypass"><span class="toc-number">1.2.4.</span> <span class="toc-text">Authentication Bypass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Affected-Models"><span class="toc-number">1.3.</span> <span class="toc-text">Affected Models</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;text=DCS-960L Equipment Analysis"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;is_video=false&amp;description=DCS-960L Equipment Analysis"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DCS-960L Equipment Analysis&amp;body=Check out this article: http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;title=DCS-960L Equipment Analysis"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;name=DCS-960L Equipment Analysis&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/08/07/DCS-960L-Equipment-Analysis/&amp;t=DCS-960L Equipment Analysis"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2021-2023
    z1r0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/z1r00?tab=repositories">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->



<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>